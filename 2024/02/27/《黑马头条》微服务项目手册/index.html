

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Peter Xu">
  <meta name="keywords" content="">
  
    <meta name="description" content="1 环境搭建、SpringCloud微服务(注册发现、服务调用、网关)1)课程对比 2)项目概述2.1)能让你收获什么 2.2)项目课程大纲 2.3)项目概述随着智能手机的普及，人们更加习惯于通过手机来看新闻。由于生活节奏的加快，很多人只能利用碎片时间来获取信息，因此，对于移动资讯客户端的需求也越来越高。黑马头条项目正是在这样背景下开发出来。黑马头条项目采用当下火热的微服务+大数据技术架构实现。本">
<meta property="og:type" content="article">
<meta property="og:title" content="《黑马头条》微服务项目手册">
<meta property="og:url" content="http://example.com/2024/02/27/%E3%80%8A%E9%BB%91%E9%A9%AC%E5%A4%B4%E6%9D%A1%E3%80%8B%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%A1%B9%E7%9B%AE%E6%89%8B%E5%86%8C/index.html">
<meta property="og:site_name" content="XT-CODE-WORLD">
<meta property="og:description" content="1 环境搭建、SpringCloud微服务(注册发现、服务调用、网关)1)课程对比 2)项目概述2.1)能让你收获什么 2.2)项目课程大纲 2.3)项目概述随着智能手机的普及，人们更加习惯于通过手机来看新闻。由于生活节奏的加快，很多人只能利用碎片时间来获取信息，因此，对于移动资讯客户端的需求也越来越高。黑马头条项目正是在这样背景下开发出来。黑马头条项目采用当下火热的微服务+大数据技术架构实现。本">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/images/image-20210407203818808.png">
<meta property="og:image" content="http://example.com/images/image-20210407203902473.png">
<meta property="og:image" content="http://example.com/images/image-20210407203935383.png">
<meta property="og:image" content="http://example.com/images/image-20210407204320559.png">
<meta property="og:image" content="http://example.com/images/image-20210407204345614.png">
<meta property="og:image" content="http://example.com/images/image-20210407204405774.png">
<meta property="og:image" content="http://example.com/images/image-20210407204213963.png">
<meta property="og:image" content="http://example.com/images/f3accd2ba01c41b0a9ac98370241eba3.png">
<meta property="og:image" content="http://example.com/images/image-20210407205305080.png">
<meta property="og:image" content="http://example.com/images/image-20210407205325182.png">
<meta property="og:image" content="http://example.com/images/image-20210407205431849.png">
<meta property="og:image" content="http://example.com/images/image-20210407205502305.png">
<meta property="og:image" content="http://example.com/images/image-20210412141353694.png">
<meta property="og:image" content="http://example.com/images/image-20210412141517519.png">
<meta property="og:image" content="http://example.com/images/image-20210412141601018.png">
<meta property="og:image" content="http://example.com/images/image-20210412141631441.png">
<meta property="og:image" content="http://example.com/images/image-20210412141711919.png">
<meta property="og:image" content="http://example.com/images/image-20210412141809919.png">
<meta property="og:image" content="http://example.com/images/image-20210412142006558.png">
<meta property="og:image" content="http://example.com/images/image-20210412142055047.png">
<meta property="og:image" content="http://example.com/images/image-20210412142315248.png">
<meta property="og:image" content="http://example.com/images/image-20210412142428499.png">
<meta property="og:image" content="http://example.com/images/image-20210412142536782.png">
<meta property="og:image" content="http://example.com/images/image-20210412142706443.png">
<meta property="og:image" content="http://example.com/images/image-20210412143121648.png">
<meta property="og:image" content="http://example.com/images/image-20210413162511873-1708967437164.png">
<meta property="og:image" content="http://example.com/images/image-20210413162558657-1708967437164.png">
<meta property="og:image" content="http://example.com/images/image-20210728140447647.png">
<meta property="og:image" content="http://example.com/images/image-20210705110434492.png">
<meta property="og:image" content="http://example.com/images/image-20210416095950485.png">
<meta property="og:image" content="http://example.com/images/image-20210419151801252.png">
<meta property="og:image" content="http://example.com/images/image-20210419151839634.png">
<meta property="og:image" content="http://example.com/images/image-20210419151854868.png">
<meta property="og:image" content="http://example.com/images/image-20210419151912063.png">
<meta property="og:image" content="http://example.com/images/image-20210419151938103.png">
<meta property="og:image" content="http://example.com/images/image-20210419152011931.png">
<meta property="og:image" content="http://example.com/images/image-20210420000326669.png">
<meta property="og:image" content="http://example.com/images/image-20210420001037992.png">
<meta property="og:image" content="http://example.com/images/1528820943975.png">
<meta property="og:image" content="http://example.com/images/1576129529361.png">
<meta property="og:image" content="http://example.com/images/1539947776259.png">
<meta property="og:image" content="http://example.com/images/image-20210422163843108.png">
<meta property="og:image" content="http://example.com/images/image-20210417102204739.png">
<meta property="og:image" content="http://example.com/images/image-20210417102356582.png">
<meta property="og:image" content="http://example.com/images/image-20210417102435088.png">
<meta property="og:image" content="http://example.com/images/image-20210602180753705.png">
<meta property="og:image" content="http://example.com/images/image-20210602180824202.png">
<meta property="og:image" content="http://example.com/images/image-20210602180856833.png">
<meta property="og:image" content="http://example.com/images/image-20210602180931839.png">
<meta property="og:image" content="http://example.com/images/image-20210602180957787.png">
<meta property="og:image" content="http://example.com/images/image-20210426110728659.png">
<meta property="og:image" content="http://example.com/images/image-20210426110913007.png">
<meta property="og:image" content="http://example.com/images/image-20210426111329136.png">
<meta property="og:image" content="http://example.com/images/image-20210426144327206.png">
<meta property="og:image" content="http://example.com/images/image-20210426144500239.png">
<meta property="og:image" content="http://example.com/images/image-20210426144603541.png">
<meta property="og:image" content="http://example.com/images/image-20210426205631708.png">
<meta property="og:image" content="http://example.com/images/image-20210426210148580.png">
<meta property="og:image" content="http://example.com/images/image-20210426210402672.png">
<meta property="og:image" content="http://example.com/images/image-20210426210434861.png">
<meta property="og:image" content="http://example.com/images/image-20210427014931255.png">
<meta property="og:image" content="http://example.com/images/image-20210427015037964.png">
<meta property="og:image" content="http://example.com/images/image-20210427015054428.png">
<meta property="og:image" content="http://example.com/images/image-20210427015114994.png">
<meta property="og:image" content="http://example.com/images/image-20210427015326728.png">
<meta property="og:image" content="http://example.com/images/image-20210504211635199.png">
<meta property="og:image" content="http://example.com/images/image-20210504213452171.png">
<meta property="og:image" content="http://example.com/images/image-20210504213510896.png">
<meta property="og:image" content="http://example.com/images/image-20210504213530641.png">
<meta property="og:image" content="http://example.com/images/image-20210504213547219.png">
<meta property="og:image" content="http://example.com/images/image-20210504213605004.png">
<meta property="og:image" content="http://example.com/images/image-20210504213640667.png">
<meta property="og:image" content="http://example.com/images/image-20210504213719323.png">
<meta property="og:image" content="http://example.com/images/image-20210504213812303.png">
<meta property="og:image" content="http://example.com/images/image-20210504214013276.png">
<meta property="og:image" content="http://example.com/images/image-20210505005300287.png">
<meta property="og:image" content="http://example.com/images/image-20210505005353286.png">
<meta property="og:image" content="http://example.com/images/image-20210505005407987.png">
<meta property="og:image" content="http://example.com/images/image-20210505005448995.png">
<meta property="og:image" content="http://example.com/images/image-20210505005509258.png">
<meta property="og:image" content="http://example.com/images/image-20210505005733405.png">
<meta property="og:image" content="http://example.com/images/image-20210505010728156.png">
<meta property="og:image" content="http://example.com/images/image-20210505010755954.png">
<meta property="og:image" content="http://example.com/images/image-20210505010938575.png">
<meta property="og:image" content="http://example.com/images/image-20210507160209926.png">
<meta property="og:image" content="http://example.com/images/image-20210507160329016.png">
<meta property="og:image" content="http://example.com/images/image-20210507160912993.png">
<meta property="og:image" content="http://example.com/images/image-20210524160517744.png">
<meta property="og:image" content="http://example.com/images/image-20210524160549596.png">
<meta property="og:image" content="http://example.com/images/image-20210524160611338.png">
<meta property="og:image" content="http://example.com/images/image-20210524161243572.png">
<meta property="og:image" content="http://example.com/images/image-20210524161406081.png">
<meta property="og:image" content="http://example.com/images/image-20210709110852966.png">
<meta property="og:image" content="http://example.com/images/image-20210709111445360.png">
<meta property="og:image" content="http://example.com/images/image-20210513145942962.png">
<meta property="og:image" content="http://example.com/images/image-20210513150058814.png">
<meta property="og:image" content="http://example.com/images/image-20210513150319742.png">
<meta property="og:image" content="http://example.com/images/image-20210513150352211.png">
<meta property="og:image" content="http://example.com/images/image-20210513150440342.png">
<meta property="og:image" content="http://example.com/images/image-20210513151649297.png">
<meta property="og:image" content="http://example.com/images/image-20210513151812858.png">
<meta property="og:image" content="http://example.com/images/image-20210513151835752.png">
<meta property="og:image" content="http://example.com/images/image-20210513152138388.png">
<meta property="og:image" content="http://example.com/images/image-20210514181214681.png">
<meta property="og:image" content="http://example.com/images/image-20210515162329679.png">
<meta property="og:image" content="http://example.com/images/image-20210515162419548.png">
<meta property="og:image" content="http://example.com/images/image-20210515162537224.png">
<meta property="og:image" content="http://example.com/images/image-20210515162604410.png">
<meta property="og:image" content="http://example.com/images/image-20210515162621928.png">
<meta property="og:image" content="http://example.com/images/image-20210516112243712.png">
<meta property="og:image" content="http://example.com/images/image-20210516112457413.png">
<meta property="og:image" content="http://example.com/images/image-20210516112612399.png">
<meta property="og:image" content="http://example.com/images/image-20210721013255332.png">
<meta property="og:image" content="http://example.com/images/image-20210525180731705.png">
<meta property="og:image" content="http://example.com/images/image-20210525180757907.png">
<meta property="og:image" content="http://example.com/images/image-20210525181028436.png">
<meta property="og:image" content="http://example.com/images/image-20210525181100793.png">
<meta property="og:image" content="http://example.com/images/image-20210525181412230.png">
<meta property="og:image" content="http://example.com/images/image-20210530223101568.png">
<meta property="og:image" content="http://example.com/images/image-20210530223218580.png">
<meta property="og:image" content="http://example.com/images/image-20210530223316815.png">
<meta property="og:image" content="http://example.com/images/image-20210530224302935.png">
<meta property="og:image" content="http://example.com/images/image-20210530224406689.png">
<meta property="og:image" content="http://example.com/images/image-20210530224706747.png">
<meta property="og:image" content="http://example.com/images/image-20210530224903891.png">
<meta property="og:image" content="http://example.com/images/image-20210530225021266.png">
<meta property="og:image" content="http://example.com/images/image-20210530224959350.png">
<meta property="og:image" content="http://example.com/images/image-20210530225215337.png">
<meta property="og:image" content="http://example.com/images/image-20210530225239897.png">
<meta property="og:image" content="http://example.com/images/image-20210528111736003.png">
<meta property="og:image" content="http://example.com/images/image-20210528111853271.png">
<meta property="og:image" content="http://example.com/images/image-20210528111956504.png">
<meta property="og:image" content="http://example.com/images/image-20210528112150495.png">
<meta property="og:image" content="http://example.com/images/image-20210709140539138.png">
<meta property="og:image" content="http://example.com/images/image-20210709140935410.png">
<meta property="og:image" content="http://example.com/images/image-20210709141502366.png">
<meta property="og:image" content="http://example.com/images/image-20210709141558811.png">
<meta property="og:image" content="http://example.com/images/1606653927638.png">
<meta property="og:image" content="http://example.com/images/image-20210709142215818.png">
<meta property="og:image" content="http://example.com/images/image-20210709142339535.png">
<meta property="og:image" content="http://example.com/images/image-20210709142616797.png">
<meta property="og:image" content="http://example.com/images/image-20210709143151781.png">
<meta property="og:image" content="http://example.com/images/1587366878895.png">
<meta property="og:image" content="http://example.com/images/image-20210709153428259.png">
<meta property="og:image" content="http://example.com/images/image-20210709153935904.png">
<meta property="og:image" content="http://example.com/images/image-20210709154053892.png">
<meta property="og:image" content="http://example.com/images/image-20210709154841113.png">
<meta property="og:image" content="http://example.com/images/1587366921085.png">
<meta property="og:image" content="http://example.com/images/image-20210709160036983.png">
<meta property="og:image" content="http://example.com/images/image-20210729224950851.png">
<meta property="og:image" content="http://example.com/images/image-20210729225206299.png">
<meta property="og:image" content="http://example.com/images/image-20210729230059884.png">
<meta property="og:image" content="http://example.com/images/image-20210730001433997.png">
<meta property="og:image" content="http://example.com/images/image-20210729230502703.png">
<meta property="og:image" content="http://example.com/images/image-20210729230630495.png">
<meta property="og:image" content="http://example.com/images/image-20210729232146585.png">
<meta property="og:image" content="http://example.com/images/image-20210729232926534.png">
<meta property="og:image" content="http://example.com/images/image-20210729232825564.png">
<meta property="og:image" content="http://example.com/images/image-20210729233016355.png">
<meta property="og:image" content="http://example.com/images/image-20210729233926457.png">
<meta property="og:image" content="http://example.com/images/image-20210729234009010.png">
<meta property="og:image" content="http://example.com/images/image-20210729234114283.png">
<meta property="og:image" content="http://example.com/images/image-20210729234219162.png">
<meta property="og:image" content="http://example.com/images/image-20210729234256062.png">
<meta property="og:image" content="http://example.com/images/image-20210729234409132.png">
<meta property="og:image" content="http://example.com/images/image-20210729234513775.png">
<meta property="og:image" content="http://example.com/images/image-20210729234536483.png">
<meta property="og:image" content="http://example.com/images/image-20210729234756221.png">
<meta property="og:image" content="http://example.com/images/image-20210729234822935.png">
<meta property="og:image" content="http://example.com/images/image-20210729234930218.png">
<meta property="og:image" content="http://example.com/images/image-20210729234948571.png">
<meta property="og:image" content="http://example.com/images/image-20210729235644605.png">
<meta property="og:image" content="http://example.com/images/image-20210729235731309.png">
<meta property="og:image" content="http://example.com/images/image-20210730000549587.png">
<meta property="og:image" content="http://example.com/images/image-20210730000626824.png">
<meta property="og:image" content="http://example.com/images/image-20210613110712894.png">
<meta property="og:image" content="http://example.com/images/image-20210730201509223.png">
<meta property="og:image" content="http://example.com/images/image-20210731090637590.png">
<meta property="og:image" content="http://example.com/images/image-20210731090700382.png">
<meta property="og:image" content="http://example.com/images/image-20210730201706437.png">
<meta property="og:image" content="http://example.com/images/image-20210731090727323.png">
<meta property="og:image" content="http://example.com/images/image-20210731090746415.png">
<meta property="og:image" content="http://example.com/images/image-20210730201817959.png">
<meta property="og:image" content="http://example.com/images/image-20210730201911566.png">
<meta property="og:image" content="http://example.com/images/image-20210621235620854.png">
<meta property="og:image" content="http://example.com/images/image-20210802000658790.png">
<meta property="og:image" content="http://example.com/images/image-20210802000829722.png">
<meta property="og:image" content="http://example.com/images/image-20210802011508487.png">
<meta property="og:image" content="http://example.com/images/image-20210802011525024.png">
<meta property="og:image" content="http://example.com/images/image-20210802011540379.png">
<meta property="og:image" content="http://example.com/images/image-20210802011553923.png">
<meta property="og:image" content="http://example.com/images/image-20210802011607894.png">
<meta property="og:image" content="http://example.com/images/image-20210802011625800.png">
<meta property="og:image" content="http://example.com/images/image-20210802011638639.png">
<meta property="og:image" content="http://example.com/images/image-20210802011653454.png">
<meta property="og:image" content="http://example.com/images/image-20210802011707013.png">
<meta property="og:image" content="http://example.com/images/image-20210802011723835.png">
<meta property="og:image" content="http://example.com/images/image-20210802011740056.png">
<meta property="og:image" content="http://example.com/images/image-20210802011758588.png">
<meta property="og:image" content="http://example.com/images/image-20210802013808080.png">
<meta property="og:image" content="http://example.com/images/image-20210802013533421.png">
<meta property="og:image" content="http://example.com/images/image-20210802011944005.png">
<meta property="og:image" content="http://example.com/images/image-20210802011956261.png">
<meta property="og:image" content="http://example.com/images/image-20210802012010244.png">
<meta property="og:image" content="http://example.com/images/image-20210802012026476.png">
<meta property="og:image" content="http://example.com/images/image-20210802012038581.png">
<meta property="og:image" content="http://example.com/images/image-20210623143417530.png">
<meta property="og:image" content="http://example.com/images/image-20210623143557710.png">
<meta property="og:image" content="http://example.com/images/image-20210802003955971.png">
<meta property="og:image" content="http://example.com/images/image-20210802004007699.png">
<meta property="og:image" content="http://example.com/images/image-20210802004133439.png">
<meta property="og:image" content="http://example.com/images/image-20210802004744531.png">
<meta property="og:image" content="http://example.com/images/image-20210802004803711.png">
<meta property="og:image" content="http://example.com/images/image-20210802004818581.png">
<meta property="og:image" content="http://example.com/images/image-20210802004838998.png">
<meta property="og:image" content="http://example.com/images/image-20210802004858057.png">
<meta property="og:image" content="http://example.com/images/image-20210802004915042.png">
<meta property="og:image" content="http://example.com/images/image-20210802004942366.png">
<meta property="og:image" content="http://example.com/images/image-20210802005000376.png">
<meta property="og:image" content="http://example.com/images/image-20210802005018020.png">
<meta property="og:image" content="http://example.com/images/image-20210802005027229.png">
<meta property="og:image" content="http://example.com/images/image-20210802005318464.png">
<meta property="og:image" content="http://example.com/images/image-20210802005329034.png">
<meta property="og:image" content="http://example.com/images/image-20210802005404751.png">
<meta property="og:image" content="http://example.com/images/image-20210802005417489.png">
<meta property="og:image" content="http://example.com/images/image-20210802005438400.png">
<meta property="og:image" content="http://example.com/images/image-20210802005452184.png">
<meta property="og:image" content="http://example.com/images/image-20210802005538404.png">
<meta property="og:image" content="http://example.com/images/image-20210802005839314.png">
<meta property="og:image" content="http://example.com/images/image-20210802005913026.png">
<meta property="og:image" content="http://example.com/images/image-20210802005937966.png">
<meta property="og:image" content="http://example.com/images/image-20210802010324224.png">
<meta property="og:image" content="http://example.com/images/image-20210802010525665.png">
<meta property="og:image" content="http://example.com/images/image-20210802010429136.png">
<meta property="og:image" content="http://example.com/images/image-20210802010201146.png">
<meta property="og:image" content="http://example.com/images/image-20210802010650039.png">
<meta property="og:image" content="http://example.com/images/image-20210802010720937.png">
<meta property="og:image" content="http://example.com/images/image-20210802010750809.png">
<meta property="og:image" content="http://example.com/images/image-20210802010824088.png">
<meta property="og:image" content="http://example.com/images/image-20210802010835702.png">
<meta property="og:image" content="http://example.com/images/image-20210802011202642.png">
<meta property="og:image" content="http://example.com/images/image-20210802011225737.png">
<meta property="og:image" content="http://example.com/images/image-20210802011245118.png">
<meta property="og:image" content="http://example.com/images/image-20210802011431941.png">
<meta property="article:published_time" content="2024-02-26T17:09:09.000Z">
<meta property="article:modified_time" content="2024-02-26T17:21:28.704Z">
<meta property="article:author" content="Peter Xu">
<meta property="article:tag" content="黑马头条">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/images/image-20210407203818808.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>《黑马头条》微服务项目手册 - XT-CODE-WORLD</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  

  

  



  
<meta name="generator" content="Hexo 5.4.2"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>XT的代码空间</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://w.wallhaven.cc/full/wq/wallhaven-wq8ylp.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="《黑马头条》微服务项目手册"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-02-27 01:09" pubdate>
          2024年2月27日 凌晨
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          280k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          2334 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">《黑马头条》微服务项目手册</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="1-环境搭建、SpringCloud微服务-注册发现、服务调用、网关"><a href="#1-环境搭建、SpringCloud微服务-注册发现、服务调用、网关" class="headerlink" title="1 环境搭建、SpringCloud微服务(注册发现、服务调用、网关)"></a>1 环境搭建、SpringCloud微服务(注册发现、服务调用、网关)</h1><h2 id="1-课程对比"><a href="#1-课程对比" class="headerlink" title="1)课程对比"></a>1)课程对比</h2><p><img src="/../images/image-20210407203818808.png" srcset="/img/loading.gif" lazyload alt="image-20210407203818808"></p>
<h2 id="2-项目概述"><a href="#2-项目概述" class="headerlink" title="2)项目概述"></a>2)项目概述</h2><h3 id="2-1-能让你收获什么"><a href="#2-1-能让你收获什么" class="headerlink" title="2.1)能让你收获什么"></a>2.1)能让你收获什么</h3><p><img src="/../images/image-20210407203902473.png" srcset="/img/loading.gif" lazyload alt="image-20210407203902473"></p>
<h3 id="2-2-项目课程大纲"><a href="#2-2-项目课程大纲" class="headerlink" title="2.2)项目课程大纲"></a>2.2)项目课程大纲</h3><p><img src="/../images/image-20210407203935383.png" srcset="/img/loading.gif" lazyload alt="image-20210407203935383"></p>
<h3 id="2-3-项目概述"><a href="#2-3-项目概述" class="headerlink" title="2.3)项目概述"></a>2.3)项目概述</h3><p>随着智能手机的普及，人们更加习惯于通过手机来看新闻。由于生活节奏的加快，很多人只能利用碎片时间来获取信息，因此，对于移动资讯客户端的需求也越来越高。黑马头条项目正是在这样背景下开发出来。黑马头条项目采用当下火热的微服务+大数据技术架构实现。本项目主要着手于获取最新最热新闻资讯，通过大数据分析用户喜好精确推送咨询新闻</p>
<p><img src="/../images/image-20210407204320559.png" srcset="/img/loading.gif" lazyload alt="image-20210407204320559"></p>
<h3 id="2-4-项目术语"><a href="#2-4-项目术语" class="headerlink" title="2.4)项目术语"></a>2.4)项目术语</h3><p><img src="/../images/image-20210407204345614.png" srcset="/img/loading.gif" lazyload alt="image-20210407204345614"></p>
<h3 id="2-5-业务说明"><a href="#2-5-业务说明" class="headerlink" title="2.5)业务说明"></a>2.5)业务说明</h3><p><img src="/../images/image-20210407204405774.png" srcset="/img/loading.gif" lazyload alt="image-20210407204405774"></p>
<p>项目演示地址：</p>
<ul>
<li><p>平台管理：<a target="_blank" rel="noopener" href="http://heima-admin-java.research.itcast.cn/">http://heima-admin-java.research.itcast.cn</a> </p>
</li>
<li><p>自媒体：<a target="_blank" rel="noopener" href="http://heime-media-java.research.itcast.cn/">http://heime-media-java.research.itcast.cn</a> </p>
</li>
<li><p>app端：<a target="_blank" rel="noopener" href="http://heima-app-java.research.itcast.cn/">http://heima-app-java.research.itcast.cn</a> </p>
</li>
</ul>
<p>平台管理与自媒体为PC端，用电脑浏览器打开即可。</p>
<p>其中app端为移动端，打开方式有两种：                                                 </p>
<ul>
<li><p>谷歌浏览器打开，调成移动端模式                      </p>
</li>
<li><p>手机浏览器打开或扫描右侧二维码</p>
<p>  <img src="/../images/image-20210407204213963.png" srcset="/img/loading.gif" lazyload alt="image-20210407204213963"></p>
</li>
</ul>
<h2 id="3-技术栈"><a href="#3-技术栈" class="headerlink" title="3)技术栈"></a>3)技术栈</h2><p><img src="/../images/f3accd2ba01c41b0a9ac98370241eba3.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<ul>
<li>Spring-Cloud-Gateway : 微服务之前架设的网关服务，实现服务注册中的API请求路由，以及控制流速控制和熔断处理都是常用的架构手段，而这些功能Gateway天然支持</li>
<li>运用Spring Boot快速开发框架，构建项目工程；并结合Spring Cloud全家桶技术，实现后端个人中心、自媒体、管理中心等微服务。</li>
<li>运用Spring Cloud Alibaba Nacos作为项目中的注册中心和配置中心</li>
<li>运用mybatis-plus作为持久层提升开发效率</li>
<li>运用Kafka完成内部系统消息通知；与客户端系统消息通知；以及实时数据计算</li>
<li>运用Redis缓存技术，实现热数据的计算，提升系统性能指标</li>
<li>使用Mysql存储用户数据，以保证上层数据查询的高性能</li>
<li>使用Mongo存储用户热数据，以保证用户热数据高扩展和高性能指标</li>
<li>使用FastDFS作为静态资源存储器，在其上实现热静态资源缓存、淘汰等功能</li>
<li>运用Hbase技术，存储系统中的冷数据，保证系统数据的可靠性</li>
<li>运用ES搜索技术，对冷数据、文章数据建立索引，以保证冷数据、文章查询性能</li>
<li>运用AI技术，来完成系统自动化功能，以提升效率及节省成本。比如实名认证自动化</li>
<li>PMD&amp;P3C : 静态代码扫描工具，在项目中扫描项目代码，检查异常点、优化点、代码规范等，为开发团队提供规范统一，提升项目代码质量</li>
</ul>
<h2 id="4-nacos环境搭建"><a href="#4-nacos环境搭建" class="headerlink" title="4)nacos环境搭建"></a>4)nacos环境搭建</h2><h3 id="4-1-虚拟机镜像准备"><a href="#4-1-虚拟机镜像准备" class="headerlink" title="4.1)虚拟机镜像准备"></a>4.1)虚拟机镜像准备</h3><p>1)打开当天资料文件中的镜像，拷贝到一个地方，然后解压</p>
<p>2)解压后，双击ContOS7-hmtt.vmx文件，前提是电脑上已经安装了VMware</p>
<p><img src="/../images/image-20210407205305080.png" srcset="/img/loading.gif" lazyload alt="image-20210407205305080"></p>
<ol start="3">
<li>修改虚拟网络地址（NAT）</li>
</ol>
<p><img src="/../images/image-20210407205325182.png" srcset="/img/loading.gif" lazyload alt="image-20210407205325182"></p>
<p>​                                                                ①，选中VMware中的编辑</p>
<p>​                                                                ②，选择虚拟网络编辑器</p>
<p>​                                                                ③，找到NAT网卡，把网段改为200（当前挂载的虚拟机已固定ip地址）</p>
<p>4)修改虚拟机的网络模式为NAT</p>
<p><img src="/../images/image-20210407205431849.png" srcset="/img/loading.gif" lazyload alt="image-20210407205431849"></p>
<p>5)启动虚拟机，<strong>用户名：root  密码：itcast</strong>，当前虚拟机的ip已手动固定（静态IP）, 地址为：<strong>192.168.200.130</strong></p>
<p>6)使用FinalShell客户端链接</p>
<p><img src="/../images/image-20210407205502305.png" srcset="/img/loading.gif" lazyload alt="image-20210407205502305"></p>
<h3 id="4-2-nacos安装"><a href="#4-2-nacos安装" class="headerlink" title="4.2)nacos安装"></a>4.2)nacos安装</h3><p>①：docker拉取镜像 </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker pull nacos/nacos-server:1.2.0<br></code></pre></td></tr></table></figure>

<p>②：创建容器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker run --env MODE=standalone --name nacos --restart=always  -d -p 8848:8848 nacos/nacos-server:1.2.0<br></code></pre></td></tr></table></figure>

<ul>
<li><p>MODE=standalone 单机版</p>
</li>
<li><p>–restart=always 开机启动</p>
</li>
<li><p>-p 8848:8848  映射端口</p>
</li>
<li><p>-d 创建一个守护式容器在后台运行</p>
</li>
</ul>
<p>③：访问地址：<a target="_blank" rel="noopener" href="http://192.168.200.130:8848/nacos">http://192.168.200.130:8848/nacos</a> </p>
<p><img src="/../images/image-20210412141353694.png" srcset="/img/loading.gif" lazyload alt="image-20210412141353694"></p>
<h2 id="5-初始工程搭建"><a href="#5-初始工程搭建" class="headerlink" title="5)初始工程搭建"></a>5)初始工程搭建</h2><h3 id="5-1-环境准备"><a href="#5-1-环境准备" class="headerlink" title="5.1)环境准备"></a>5.1)环境准备</h3><p>①：项目依赖环境（需提前安装好）</p>
<ul>
<li><p>JDK1.8</p>
</li>
<li><p>Intellij Idea</p>
</li>
<li><p>maven-3.6.1</p>
</li>
<li><p>Git</p>
</li>
</ul>
<p>②：在当天资料中解压heima-leadnews.zip文件，拷贝到一个没有中文和空格的目录，使用idea打开即可</p>
<p><img src="/../images/image-20210412141517519.png" srcset="/img/loading.gif" lazyload alt="image-20210412141517519"></p>
<p>③：IDEA开发工具配置</p>
<p><img src="/../images/image-20210412141601018.png" srcset="/img/loading.gif" lazyload alt="image-20210412141601018"></p>
<p>设置本地仓库，建议使用资料中提供好的仓库</p>
<p>④：设置项目编码格式</p>
<p><img src="/../images/image-20210412141631441.png" srcset="/img/loading.gif" lazyload alt="image-20210412141631441"></p>
<h3 id="5-2-主体结构"><a href="#5-2-主体结构" class="headerlink" title="5.2)主体结构"></a>5.2)主体结构</h3><p><img src="/../images/image-20210412141711919.png" srcset="/img/loading.gif" lazyload alt="image-20210412141711919"></p>
<h2 id="6-登录"><a href="#6-登录" class="headerlink" title="6)登录"></a>6)登录</h2><h3 id="6-1-需求分析"><a href="#6-1-需求分析" class="headerlink" title="6.1)需求分析"></a>6.1)需求分析</h3><p><img src="/../images/image-20210412141809919.png" srcset="/img/loading.gif" lazyload alt="image-20210412141809919"></p>
<ul>
<li><p>用户点击<strong>开始使用</strong></p>
<p>  登录后的用户权限较大，可以查看，也可以操作（点赞，关注，评论）</p>
</li>
<li><p>用户点击<strong>不登录，先看看</strong></p>
</li>
</ul>
<p>​       游客只有查看的权限</p>
<h3 id="6-2-表结构分析"><a href="#6-2-表结构分析" class="headerlink" title="6.2)表结构分析"></a>6.2)表结构分析</h3><p>关于app端用户相关的内容较多，可以单独设置一个库leadnews_user</p>
<table>
<thead>
<tr>
<th><strong>表名称</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>ap_user</td>
<td>APP用户信息表</td>
</tr>
<tr>
<td>ap_user_fan</td>
<td>APP用户粉丝信息表</td>
</tr>
<tr>
<td>ap_user_follow</td>
<td>APP用户关注信息表</td>
</tr>
<tr>
<td>ap_user_realname</td>
<td>APP实名认证信息表</td>
</tr>
</tbody></table>
<p>从当前资料中找到对应数据库并导入到mysql中</p>
<p>登录需要用到的是ap_user表，表结构如下：</p>
<p><img src="/../images/image-20210412142006558.png" srcset="/img/loading.gif" lazyload alt="image-20210412142006558"></p>
<p><img src="/../images/image-20210412142055047.png" srcset="/img/loading.gif" lazyload alt="image-20210412142055047"></p>
<p>项目中的持久层使用的mybatis-plus，一般都使用mybais-plus逆向生成对应的实体类</p>
<p>app_user表对应的实体类如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.model.user.pojos;<br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.IdType;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.TableField;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.TableId;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.TableName;<br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><span class="hljs-keyword">import</span> java.util.Date;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * &lt;p&gt;</span><br><span class="hljs-comment"> * APP用户信息表</span><br><span class="hljs-comment"> * &lt;/p&gt;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> itheima</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@TableName(&quot;ap_user&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApUser</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 主键</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableId(value = &quot;id&quot;, type = IdType.AUTO)</span><br>    <span class="hljs-keyword">private</span> Integer id;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 密码、通信等加密盐</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;salt&quot;)</span><br>    <span class="hljs-keyword">private</span> String salt;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 用户名</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;name&quot;)</span><br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 密码,md5加密</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;password&quot;)</span><br>    <span class="hljs-keyword">private</span> String password;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 手机号</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;phone&quot;)</span><br>    <span class="hljs-keyword">private</span> String phone;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 头像</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;image&quot;)</span><br>    <span class="hljs-keyword">private</span> String image;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 0 男</span><br><span class="hljs-comment">            1 女</span><br><span class="hljs-comment">            2 未知</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;sex&quot;)</span><br>    <span class="hljs-keyword">private</span> Boolean sex;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 0 未</span><br><span class="hljs-comment">            1 是</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;is_certification&quot;)</span><br>    <span class="hljs-keyword">private</span> Boolean certification;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 是否身份认证</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;is_identity_authentication&quot;)</span><br>    <span class="hljs-keyword">private</span> Boolean identityAuthentication;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 0正常</span><br><span class="hljs-comment">            1锁定</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;status&quot;)</span><br>    <span class="hljs-keyword">private</span> Boolean status;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 0 普通用户</span><br><span class="hljs-comment">            1 自媒体人</span><br><span class="hljs-comment">            2 大V</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;flag&quot;)</span><br>    <span class="hljs-keyword">private</span> Short flag;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 注册时间</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;created_time&quot;)</span><br>    <span class="hljs-keyword">private</span> Date createdTime;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>手动加密（md5+随机字符串）</p>
<p>md5是不可逆加密，md5相同的密码每次加密都一样，不太安全。在md5的基础上手动加盐（salt）处理</p>
<p>注册-&gt;生成盐</p>
<p><img src="/../images/image-20210412142315248.png" srcset="/img/loading.gif" lazyload alt="image-20210412142315248"></p>
<p>登录-&gt;使用盐来配合验证</p>
<p><img src="/../images/image-20210412142428499.png" srcset="/img/loading.gif" lazyload alt="image-20210412142428499"></p>
<h3 id="6-3-思路分析"><a href="#6-3-思路分析" class="headerlink" title="6.3)思路分析"></a>6.3)思路分析</h3><p><img src="/../images/image-20210412142536782.png" srcset="/img/loading.gif" lazyload alt="image-20210412142536782"></p>
<p>1，用户输入了用户名和密码进行登录，校验成功后返回jwt(基于当前用户的id生成)</p>
<p>2，用户游客登录，生成jwt返回(基于默认值0生成)‘</p>
<h3 id="6-4-运营端微服务搭建"><a href="#6-4-运营端微服务搭建" class="headerlink" title="6.4)运营端微服务搭建"></a>6.4)<strong>运营端微服务搭建</strong></h3><p>在heima-leadnews-service下创建工程heima-leadnews-user</p>
<p><img src="/../images/image-20210412142706443.png" srcset="/img/loading.gif" lazyload alt="image-20210412142706443"></p>
<p>引导类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.user;<br><br><span class="hljs-keyword">import</span> org.mybatis.spring.annotation.MapperScan;<br><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br><span class="hljs-keyword">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient;<br><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableDiscoveryClient</span><br><span class="hljs-meta">@MapperScan(&quot;com.heima.user.mapper&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserApplication</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(UserApplication.class,args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>bootstrap.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">51801</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">leadnews-user</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">discovery:</span><br>        <span class="hljs-attr">server-addr:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.130</span><span class="hljs-string">:8848</span><br>      <span class="hljs-attr">config:</span><br>        <span class="hljs-attr">server-addr:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.130</span><span class="hljs-string">:8848</span><br>        <span class="hljs-attr">file-extension:</span> <span class="hljs-string">yml</span><br></code></pre></td></tr></table></figure>

<p>在nacos中创建配置文件</p>
<p><img src="/../images/image-20210412143121648.png" srcset="/img/loading.gif" lazyload alt="image-20210412143121648"></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">datasource:</span><br>    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.jdbc.Driver</span><br>    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/leadnews_user?useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=UTC</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">root</span><br><span class="hljs-comment"># 设置Mapper接口所对应的XML文件位置，如果你在Mapper接口中有自定义方法，需要进行该配置</span><br><span class="hljs-attr">mybatis-plus:</span><br>  <span class="hljs-attr">mapper-locations:</span> <span class="hljs-string">classpath*:mapper/*.xml</span><br>  <span class="hljs-comment"># 设置别名包扫描路径，通过该属性可以给包中的类注册别名</span><br>  <span class="hljs-attr">type-aliases-package:</span> <span class="hljs-string">com.heima.model.user.pojos</span><br></code></pre></td></tr></table></figure>

<p>logback.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--定义日志文件的存储地址,使用绝对路径--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;LOG_HOME&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;e:/logs&quot;</span>/&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- Console 输出设置 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">appender</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;CONSOLE&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">encoder</span>&gt;</span><br>            <span class="hljs-comment">&lt;!--格式化输出：%d表示日期，%thread表示线程名，%-5level：级别从左显示5个字符宽度%msg：日志消息，%n是换行符--&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">pattern</span>&gt;</span>%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;36&#125; - %msg%n<span class="hljs-tag">&lt;/<span class="hljs-name">pattern</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">charset</span>&gt;</span>utf8<span class="hljs-tag">&lt;/<span class="hljs-name">charset</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">encoder</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">appender</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 按照每天生成日志文件 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">appender</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;FILE&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">rollingPolicy</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span>&gt;</span><br>            <span class="hljs-comment">&lt;!--日志文件输出的文件名--&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">fileNamePattern</span>&gt;</span>$&#123;LOG_HOME&#125;/leadnews.%d&#123;yyyy-MM-dd&#125;.log<span class="hljs-tag">&lt;/<span class="hljs-name">fileNamePattern</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">rollingPolicy</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">encoder</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">pattern</span>&gt;</span>%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;36&#125; - %msg%n<span class="hljs-tag">&lt;/<span class="hljs-name">pattern</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">encoder</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">appender</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 异步输出 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">appender</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;ASYNC&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;ch.qos.logback.classic.AsyncAppender&quot;</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 不丢失日志.默认的,如果队列的80%已满,则会丢弃TRACT、DEBUG、INFO级别的日志 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">discardingThreshold</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">discardingThreshold</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 更改默认的队列的深度,该值会影响性能.默认值为256 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">queueSize</span>&gt;</span>512<span class="hljs-tag">&lt;/<span class="hljs-name">queueSize</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 添加附加的appender,最多只能添加一个 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">appender-ref</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;FILE&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">appender</span>&gt;</span><br><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">logger</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;org.apache.ibatis.cache.decorators.LoggingCache&quot;</span> <span class="hljs-attr">level</span>=<span class="hljs-string">&quot;DEBUG&quot;</span> <span class="hljs-attr">additivity</span>=<span class="hljs-string">&quot;false&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">appender-ref</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;CONSOLE&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">logger</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">logger</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;org.springframework.boot&quot;</span> <span class="hljs-attr">level</span>=<span class="hljs-string">&quot;debug&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">root</span> <span class="hljs-attr">level</span>=<span class="hljs-string">&quot;info&quot;</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--&lt;appender-ref ref=&quot;ASYNC&quot;/&gt;--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">appender-ref</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;FILE&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">appender-ref</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;CONSOLE&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">root</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br></code></pre></td></tr></table></figure>



<h3 id="6-4-登录功能实现"><a href="#6-4-登录功能实现" class="headerlink" title="6.4)登录功能实现"></a>6.4)登录功能实现</h3><p>①：接口定义</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/api/v1/login&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApUserLoginController</span> &#123;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/login_auth&quot;)</span><br>    <span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">login</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> LoginDto dto)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>②：持久层mapper</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.user.mapper;<br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.mapper.BaseMapper;<br><span class="hljs-keyword">import</span> com.heima.model.user.pojos.ApUser;<br><span class="hljs-keyword">import</span> org.apache.ibatis.annotations.Mapper;<br><br><span class="hljs-meta">@Mapper</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ApUserMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseMapper</span>&lt;ApUser&gt; &#123;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>③：业务层service</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.user.service;<br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.extension.service.IService;<br><span class="hljs-keyword">import</span> com.heima.model.common.dtos.ResponseResult;<br><span class="hljs-keyword">import</span> com.heima.model.user.dtos.LoginDto;<br><span class="hljs-keyword">import</span> com.heima.model.user.pojos.ApUser;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ApUserService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IService</span>&lt;ApUser&gt;&#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * app端登录</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> dto</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">login</span><span class="hljs-params">(LoginDto dto)</span>;<br>    <br>&#125;<br></code></pre></td></tr></table></figure>

<p>实现类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.user.service.impl;<br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.toolkit.Wrappers;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;<br><span class="hljs-keyword">import</span> com.heima.model.common.dtos.ResponseResult;<br><span class="hljs-keyword">import</span> com.heima.model.common.enums.AppHttpCodeEnum;<br><span class="hljs-keyword">import</span> com.heima.model.user.dtos.LoginDto;<br><span class="hljs-keyword">import</span> com.heima.model.user.pojos.ApUser;<br><span class="hljs-keyword">import</span> com.heima.user.mapper.ApUserMapper;<br><span class="hljs-keyword">import</span> com.heima.user.service.ApUserService;<br><span class="hljs-keyword">import</span> com.heima.utils.common.AppJwtUtil;<br><span class="hljs-keyword">import</span> org.apache.commons.lang3.StringUtils;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><span class="hljs-keyword">import</span> org.springframework.util.DigestUtils;<br><br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApUserServiceImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ServiceImpl</span>&lt;ApUserMapper, ApUser&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ApUserService</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">login</span><span class="hljs-params">(LoginDto dto)</span> &#123;<br><br>        <span class="hljs-comment">//1.正常登录（手机号+密码登录）</span><br>        <span class="hljs-keyword">if</span> (!StringUtils.isBlank(dto.getPhone()) &amp;&amp; !StringUtils.isBlank(dto.getPassword())) &#123;<br>            <span class="hljs-comment">//1.1查询用户</span><br>            <span class="hljs-type">ApUser</span> <span class="hljs-variable">apUser</span> <span class="hljs-operator">=</span> getOne(Wrappers.&lt;ApUser&gt;lambdaQuery().eq(ApUser::getPhone, dto.getPhone()));<br>            <span class="hljs-keyword">if</span> (apUser == <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">return</span> ResponseResult.errorResult(AppHttpCodeEnum.DATA_NOT_EXIST,<span class="hljs-string">&quot;用户不存在&quot;</span>);<br>            &#125;<br><br>            <span class="hljs-comment">//1.2 比对密码</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">salt</span> <span class="hljs-operator">=</span> apUser.getSalt();<br>            <span class="hljs-type">String</span> <span class="hljs-variable">pswd</span> <span class="hljs-operator">=</span> dto.getPassword();<br>            pswd = DigestUtils.md5DigestAsHex((pswd + salt).getBytes());<br>            <span class="hljs-keyword">if</span> (!pswd.equals(apUser.getPassword())) &#123;<br>                <span class="hljs-keyword">return</span> ResponseResult.errorResult(AppHttpCodeEnum.LOGIN_PASSWORD_ERROR);<br>            &#125;<br>            <span class="hljs-comment">//1.3 返回数据  jwt</span><br>            Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>            map.put(<span class="hljs-string">&quot;token&quot;</span>, AppJwtUtil.getToken(apUser.getId().longValue()));<br>            apUser.setSalt(<span class="hljs-string">&quot;&quot;</span>);<br>            apUser.setPassword(<span class="hljs-string">&quot;&quot;</span>);<br>            map.put(<span class="hljs-string">&quot;user&quot;</span>, apUser);<br>            <span class="hljs-keyword">return</span> ResponseResult.okResult(map);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">//2.游客  同样返回token  id = 0</span><br>            Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>            map.put(<span class="hljs-string">&quot;token&quot;</span>, AppJwtUtil.getToken(<span class="hljs-number">0l</span>));<br>            <span class="hljs-keyword">return</span> ResponseResult.okResult(map);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>④：控制层controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.user.controller.v1;<br><br><span class="hljs-keyword">import</span> com.heima.model.common.dtos.ResponseResult;<br><span class="hljs-keyword">import</span> com.heima.model.user.dtos.LoginDto;<br><span class="hljs-keyword">import</span> com.heima.user.service.ApUserService;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PostMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestBody;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/api/v1/login&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApUserLoginController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ApUserService apUserService;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/login_auth&quot;)</span><br>    <span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">login</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> LoginDto dto)</span> &#123;<br>        <span class="hljs-keyword">return</span> apUserService.login(dto);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="7-接口工具postman、swagger、knife4j"><a href="#7-接口工具postman、swagger、knife4j" class="headerlink" title="7)接口工具postman、swagger、knife4j"></a>7)接口工具postman、swagger、knife4j</h2><h3 id="7-1-postman"><a href="#7-1-postman" class="headerlink" title="7.1)postman"></a>7.1)postman</h3><p>Postman是一款功能强大的网页调试与发送网页HTTP请求的Chrome插件。postman被500万开发者和超100,000家公司用于每月访问1.3亿个API。</p>
<p>官方网址：<a target="_blank" rel="noopener" href="https://www.postman.com/">https://www.postman.com/</a></p>
<p>解压资料文件夹中的软件，安装即可</p>
<p><img src="/../images/image-20210413162511873-1708967437164.png" srcset="/img/loading.gif" lazyload alt="image-20210413162511873"></p>
<p>通常的接口测试查看请求和响应，下面是登录请求的测试</p>
<p><img src="/../images/image-20210413162558657-1708967437164.png" srcset="/img/loading.gif" lazyload alt="image-20210413162558657"></p>
<h3 id="7-2-swagger"><a href="#7-2-swagger" class="headerlink" title="7.2)swagger"></a>7.2)swagger</h3><p>(1)简介</p>
<p>Swagger 是一个规范和完整的框架，用于生成、描述、调用和可视化 RESTful 风格的 Web 服务(<a target="_blank" rel="noopener" href="https://swagger.io/">https://swagger.io/</a>)。 它的主要作用是：</p>
<ol>
<li><p>使得前后端分离开发更加方便，有利于团队协作</p>
</li>
<li><p>接口的文档在线自动生成，降低后端开发人员编写接口文档的负担</p>
</li>
<li><p>功能测试 </p>
<p> Spring已经将Swagger纳入自身的标准，建立了Spring-swagger项目，现在叫Springfox。通过在项目中引入Springfox ，即可非常简单快捷的使用Swagger。</p>
</li>
</ol>
<p>(2)SpringBoot集成Swagger</p>
<ul>
<li><p>引入依赖,在heima-leadnews-model和heima-leadnews-common模块中引入该依赖</p>
  <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.springfox<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>springfox-swagger2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.springfox<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>springfox-swagger-ui<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li>
</ul>
<p>只需要在heima-leadnews-common中进行配置即可，因为其他微服务工程都直接或间接依赖即可。</p>
<ul>
<li>在heima-leadnews-common工程中添加一个配置类</li>
</ul>
<p>新增：com.heima.common.swagger.SwaggerConfiguration</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.common.swagger;<br><br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> springfox.documentation.builders.ApiInfoBuilder;<br><span class="hljs-keyword">import</span> springfox.documentation.builders.PathSelectors;<br><span class="hljs-keyword">import</span> springfox.documentation.builders.RequestHandlerSelectors;<br><span class="hljs-keyword">import</span> springfox.documentation.service.ApiInfo;<br><span class="hljs-keyword">import</span> springfox.documentation.service.Contact;<br><span class="hljs-keyword">import</span> springfox.documentation.spi.DocumentationType;<br><span class="hljs-keyword">import</span> springfox.documentation.spring.web.plugins.Docket;<br><span class="hljs-keyword">import</span> springfox.documentation.swagger2.annotations.EnableSwagger2;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableSwagger2</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SwaggerConfiguration</span> &#123;<br><br>   <span class="hljs-meta">@Bean</span><br>   <span class="hljs-keyword">public</span> Docket <span class="hljs-title function_">buildDocket</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Docket</span>(DocumentationType.SWAGGER_2)<br>              .apiInfo(buildApiInfo())<br>              .select()<br>              <span class="hljs-comment">// 要扫描的API(Controller)基础包</span><br>              .apis(RequestHandlerSelectors.basePackage(<span class="hljs-string">&quot;com.heima&quot;</span>))<br>              .paths(PathSelectors.any())<br>              .build();<br>   &#125;<br><br>   <span class="hljs-keyword">private</span> ApiInfo <span class="hljs-title function_">buildApiInfo</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-type">Contact</span> <span class="hljs-variable">contact</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Contact</span>(<span class="hljs-string">&quot;黑马程序员&quot;</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;&quot;</span>);<br>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApiInfoBuilder</span>()<br>              .title(<span class="hljs-string">&quot;黑马头条-平台管理API文档&quot;</span>)<br>              .description(<span class="hljs-string">&quot;黑马头条后台api&quot;</span>)<br>              .contact(contact)<br>              .version(<span class="hljs-string">&quot;1.0.0&quot;</span>).build();<br>   &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在heima-leadnews-common模块中的resources目录中新增以下目录和文件</p>
<p>文件：resources/META-INF/Spring.factories</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">org.springframework.boot.autoconfigure.EnableAutoConfiguration=\<br>  com.heima.common.swagger.SwaggerConfiguration<br></code></pre></td></tr></table></figure>

<p>（3）Swagger常用注解</p>
<p>在Java类中添加Swagger的注解即可生成Swagger接口文档，常用Swagger注解如下：</p>
<p>@Api：修饰整个类，描述Controller的作用  </p>
<p>@ApiOperation：描述一个类的一个方法，或者说一个接口  </p>
<p>@ApiParam：单个参数的描述信息  </p>
<p>@ApiModel：用对象来接收参数  </p>
<p>@ApiModelProperty：用对象接收参数时，描述对象的一个字段  </p>
<p>@ApiResponse：HTTP响应其中1个描述  </p>
<p>@ApiResponses：HTTP响应整体描述  </p>
<p>@ApiIgnore：使用该注解忽略这个API  </p>
<p>@ApiError ：发生错误返回的信息  </p>
<p>@ApiImplicitParam：一个请求参数  </p>
<p>@ApiImplicitParams：多个请求参数的描述信息</p>
<p> @ApiImplicitParam属性：</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>取值</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>paramType</td>
<td></td>
<td>查询参数类型</td>
</tr>
<tr>
<td></td>
<td>path</td>
<td>以地址的形式提交数据</td>
</tr>
<tr>
<td></td>
<td>query</td>
<td>直接跟参数完成自动映射赋值</td>
</tr>
<tr>
<td></td>
<td>body</td>
<td>以流的形式提交 仅支持POST</td>
</tr>
<tr>
<td></td>
<td>header</td>
<td>参数在request headers 里边提交</td>
</tr>
<tr>
<td></td>
<td>form</td>
<td>以form表单的形式提交 仅支持POST</td>
</tr>
<tr>
<td>dataType</td>
<td></td>
<td>参数的数据类型 只作为标志说明，并没有实际验证</td>
</tr>
<tr>
<td></td>
<td>Long</td>
<td></td>
</tr>
<tr>
<td></td>
<td>String</td>
<td></td>
</tr>
<tr>
<td>name</td>
<td></td>
<td>接收参数名</td>
</tr>
<tr>
<td>value</td>
<td></td>
<td>接收参数的意义描述</td>
</tr>
<tr>
<td>required</td>
<td></td>
<td>参数是否必填</td>
</tr>
<tr>
<td></td>
<td>true</td>
<td>必填</td>
</tr>
<tr>
<td></td>
<td>false</td>
<td>非必填</td>
</tr>
<tr>
<td>defaultValue</td>
<td></td>
<td>默认值</td>
</tr>
</tbody></table>
<p>我们在ApUserLoginController中添加Swagger注解，代码如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/api/v1/login&quot;)</span><br><span class="hljs-meta">@Api(value = &quot;app端用户登录&quot;, tags = &quot;ap_user&quot;, description = &quot;app端用户登录API&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApUserLoginController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ApUserService apUserService;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/login_auth&quot;)</span><br>    <span class="hljs-meta">@ApiOperation(&quot;用户登录&quot;)</span><br>    <span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">login</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> LoginDto dto)</span>&#123;<br>        <span class="hljs-keyword">return</span> apUserService.login(dto);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>LoginDto</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginDto</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 手机号</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@ApiModelProperty(value=&quot;手机号&quot;,required = true)</span><br>    <span class="hljs-keyword">private</span> String phone;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 密码</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@ApiModelProperty(value=&quot;密码&quot;,required = true)</span><br>    <span class="hljs-keyword">private</span> String password;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>启动user微服务，访问地址：<a target="_blank" rel="noopener" href="http://localhost:51801/swagger-ui.html">http://localhost:51801/swagger-ui.html</a></p>
<h3 id="7-3-knife4j"><a href="#7-3-knife4j" class="headerlink" title="7.3)knife4j"></a>7.3)knife4j</h3><p>(1)简介</p>
<p>knife4j是为Java MVC框架集成Swagger生成Api文档的增强解决方案,前身是swagger-bootstrap-ui,取名kni4j是希望它能像一把匕首一样小巧,轻量,并且功能强悍!</p>
<p>gitee地址：<a target="_blank" rel="noopener" href="https://gitee.com/xiaoym/knife4j">https://gitee.com/xiaoym/knife4j</a></p>
<p>官方文档：<a target="_blank" rel="noopener" href="https://doc.xiaominfo.com/">https://doc.xiaominfo.com/</a></p>
<p>效果演示：<a target="_blank" rel="noopener" href="http://knife4j.xiaominfo.com/doc.html">http://knife4j.xiaominfo.com/doc.html</a></p>
<p>(2)核心功能</p>
<p>该UI增强包主要包括两大核心功能：文档说明 和 在线调试</p>
<ul>
<li>文档说明：根据Swagger的规范说明，详细列出接口文档的说明，包括接口地址、类型、请求示例、请求参数、响应示例、响应参数、响应码等信息，使用swagger-bootstrap-ui能根据该文档说明，对该接口的使用情况一目了然。</li>
<li>在线调试：提供在线接口联调的强大功能，自动解析当前接口参数,同时包含表单验证，调用参数可返回接口响应内容、headers、Curl请求命令实例、响应时间、响应状态码等信息，帮助开发者在线调试，而不必通过其他测试工具测试接口是否正确,简介、强大。</li>
<li>个性化配置：通过个性化ui配置项，可自定义UI的相关显示信息</li>
<li>离线文档：根据标准规范，生成的在线markdown离线文档，开发者可以进行拷贝生成markdown接口文档，通过其他第三方markdown转换工具转换成html或pdf，这样也可以放弃swagger2markdown组件</li>
<li>接口排序：自1.8.5后，ui支持了接口排序功能，例如一个注册功能主要包含了多个步骤,可以根据swagger-bootstrap-ui提供的接口排序规则实现接口的排序，step化接口操作，方便其他开发者进行接口对接</li>
</ul>
<p>(3)快速集成</p>
<ul>
<li>在heima-leadnews-common模块中的<code>pom.xml</code>文件中引入<code>knife4j</code>的依赖,如下：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.github.xiaoymin<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>knife4j-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<ul>
<li>创建Swagger配置文件</li>
</ul>
<p>在heima-leadnews-common模块中新建配置类</p>
<p>新建Swagger的配置文件<code>SwaggerConfiguration.java</code>文件,创建springfox提供的Docket分组对象,代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.common.knife4j;<br><br><span class="hljs-keyword">import</span> com.github.xiaoymin.knife4j.spring.annotations.EnableKnife4j;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Import;<br><span class="hljs-keyword">import</span> springfox.bean.validators.configuration.BeanValidatorPluginsConfiguration;<br><span class="hljs-keyword">import</span> springfox.documentation.builders.ApiInfoBuilder;<br><span class="hljs-keyword">import</span> springfox.documentation.builders.PathSelectors;<br><span class="hljs-keyword">import</span> springfox.documentation.builders.RequestHandlerSelectors;<br><span class="hljs-keyword">import</span> springfox.documentation.service.ApiInfo;<br><span class="hljs-keyword">import</span> springfox.documentation.spi.DocumentationType;<br><span class="hljs-keyword">import</span> springfox.documentation.spring.web.plugins.Docket;<br><span class="hljs-keyword">import</span> springfox.documentation.swagger2.annotations.EnableSwagger2;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableSwagger2</span><br><span class="hljs-meta">@EnableKnife4j</span><br><span class="hljs-meta">@Import(BeanValidatorPluginsConfiguration.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Swagger2Configuration</span> &#123;<br><br>    <span class="hljs-meta">@Bean(value = &quot;defaultApi2&quot;)</span><br>    <span class="hljs-keyword">public</span> Docket <span class="hljs-title function_">defaultApi2</span><span class="hljs-params">()</span> &#123;<br>        Docket docket=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Docket</span>(DocumentationType.SWAGGER_2)<br>                .apiInfo(apiInfo())<br>                <span class="hljs-comment">//分组名称</span><br>                .groupName(<span class="hljs-string">&quot;1.0&quot;</span>)<br>                .select()<br>                <span class="hljs-comment">//这里指定Controller扫描包路径</span><br>                .apis(RequestHandlerSelectors.basePackage(<span class="hljs-string">&quot;com.heima&quot;</span>))<br>                .paths(PathSelectors.any())<br>                .build();<br>        <span class="hljs-keyword">return</span> docket;<br>    &#125;<br>    <span class="hljs-keyword">private</span> ApiInfo <span class="hljs-title function_">apiInfo</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApiInfoBuilder</span>()<br>                .title(<span class="hljs-string">&quot;黑马头条API文档&quot;</span>)<br>                .description(<span class="hljs-string">&quot;黑马头条API文档&quot;</span>)<br>                .version(<span class="hljs-string">&quot;1.0&quot;</span>)<br>                .build();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>以上有两个注解需要特别说明，如下表：</p>
<table>
<thead>
<tr>
<th>注解</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>@EnableSwagger2</code></td>
<td>该注解是Springfox-swagger框架提供的使用Swagger注解，该注解必须加</td>
</tr>
<tr>
<td><code>@EnableKnife4j</code></td>
<td>该注解是<code>knife4j</code>提供的增强注解,Ui提供了例如动态参数、参数过滤、接口排序等增强功能,如果你想使用这些增强功能就必须加该注解，否则可以不用加</td>
</tr>
</tbody></table>
<ul>
<li>添加配置</li>
</ul>
<p>在Spring.factories中新增配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">org.springframework.boot.autoconfigure.EnableAutoConfiguration=\<br>  com.heima.common.swagger.Swagger2Configuration, \<br>  com.heima.common.swagger.SwaggerConfiguration<br></code></pre></td></tr></table></figure>

<ul>
<li>访问</li>
</ul>
<p>在浏览器输入地址：<code>http://host:port/doc.html</code></p>
<h2 id="8-网关"><a href="#8-网关" class="headerlink" title="8)网关"></a>8)网关</h2><p>（1）在heima-leadnews-gateway导入以下依赖</p>
<p>pom文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.jsonwebtoken<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jjwt<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>（2）在heima-leadnews-gateway下创建heima-leadnews-app-gateway微服务</p>
<p>引导类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.app.gateway;<br><br><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br><span class="hljs-keyword">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient;<br><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableDiscoveryClient</span>  <span class="hljs-comment">//开启注册中心</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppGatewayApplication</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(AppGatewayApplication.class,args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>bootstrap.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">51601</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">leadnews-app-gateway</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">discovery:</span><br>        <span class="hljs-attr">server-addr:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.130</span><span class="hljs-string">:8848</span><br>      <span class="hljs-attr">config:</span><br>        <span class="hljs-attr">server-addr:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.130</span><span class="hljs-string">:8848</span><br>        <span class="hljs-attr">file-extension:</span> <span class="hljs-string">yml</span><br></code></pre></td></tr></table></figure>

<p>在nacos的配置中心创建dataid为leadnews-app-gateway的yml配置</p>
<p><img src="/../images/image-20210728140447647.png" srcset="/img/loading.gif" lazyload alt="image-20210728140447647"></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">gateway:</span><br>      <span class="hljs-attr">globalcors:</span><br>        <span class="hljs-attr">add-to-simple-url-handler-mapping:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">corsConfigurations:</span><br>          <span class="hljs-string">&#x27;[/**]&#x27;</span><span class="hljs-string">:</span><br>            <span class="hljs-attr">allowedHeaders:</span> <span class="hljs-string">&quot;*&quot;</span><br>            <span class="hljs-attr">allowedOrigins:</span> <span class="hljs-string">&quot;*&quot;</span><br>            <span class="hljs-attr">allowedMethods:</span><br>              <span class="hljs-bullet">-</span> <span class="hljs-string">GET</span><br>              <span class="hljs-bullet">-</span> <span class="hljs-string">POST</span><br>              <span class="hljs-bullet">-</span> <span class="hljs-string">DELETE</span><br>              <span class="hljs-bullet">-</span> <span class="hljs-string">PUT</span><br>              <span class="hljs-bullet">-</span> <span class="hljs-string">OPTION</span><br>      <span class="hljs-attr">routes:</span><br>        <span class="hljs-comment"># 平台管理</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">user</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://leadnews-user</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/user/**</span><br>          <span class="hljs-attr">filters:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">StripPrefix=</span> <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure>



<p>环境搭建完成以后，启动项目网关和用户两个服务，使用postman进行测试</p>
<p>请求地址：<a target="_blank" rel="noopener" href="http://localhost:51601/user/api/v1/login/login_auth">http://localhost:51601/user/api/v1/login/login_auth</a>   </p>
<h3 id="1-3-全局过滤器实现jwt校验"><a href="#1-3-全局过滤器实现jwt校验" class="headerlink" title="1.3 全局过滤器实现jwt校验"></a>1.3 全局过滤器实现jwt校验</h3><p><img src="/../images/image-20210705110434492.png" srcset="/img/loading.gif" lazyload alt="image-20210705110434492"></p>
<p>思路分析：</p>
<ol>
<li>用户进入网关开始登陆，网关过滤器进行判断，如果是登录，则路由到后台管理微服务进行登录</li>
<li>用户登录成功，后台管理微服务签发JWT TOKEN信息返回给用户</li>
<li>用户再次进入网关开始访问，网关过滤器接收用户携带的TOKEN </li>
<li>网关过滤器解析TOKEN ，判断是否有权限，如果有，则放行，如果没有则返回未认证错误</li>
</ol>
<p>具体实现：</p>
<p>第一：</p>
<p>​    在认证过滤器中需要用到jwt的解析，所以需要把工具类拷贝一份到网关微服务</p>
<p>第二：</p>
<p>在网关微服务中新建全局过滤器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.app.gateway.filter;<br><br><br><span class="hljs-keyword">import</span> com.heima.app.gateway.util.AppJwtUtil;<br><span class="hljs-keyword">import</span> io.jsonwebtoken.Claims;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.apache.commons.lang.StringUtils;<br><span class="hljs-keyword">import</span> org.springframework.cloud.gateway.filter.GatewayFilterChain;<br><span class="hljs-keyword">import</span> org.springframework.cloud.gateway.filter.GlobalFilter;<br><span class="hljs-keyword">import</span> org.springframework.core.Ordered;<br><span class="hljs-keyword">import</span> org.springframework.http.HttpStatus;<br><span class="hljs-keyword">import</span> org.springframework.http.server.reactive.ServerHttpRequest;<br><span class="hljs-keyword">import</span> org.springframework.http.server.reactive.ServerHttpResponse;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><span class="hljs-keyword">import</span> org.springframework.web.server.ServerWebExchange;<br><span class="hljs-keyword">import</span> reactor.core.publisher.Mono;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthorizeFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Ordered</span>, GlobalFilter &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Mono&lt;Void&gt; <span class="hljs-title function_">filter</span><span class="hljs-params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;<br>        <span class="hljs-comment">//1.获取request和response对象</span><br>        <span class="hljs-type">ServerHttpRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> exchange.getRequest();<br>        <span class="hljs-type">ServerHttpResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> exchange.getResponse();<br><br>        <span class="hljs-comment">//2.判断是否是登录</span><br>        <span class="hljs-keyword">if</span>(request.getURI().getPath().contains(<span class="hljs-string">&quot;/login&quot;</span>))&#123;<br>            <span class="hljs-comment">//放行</span><br>            <span class="hljs-keyword">return</span> chain.filter(exchange);<br>        &#125;<br><br><br>        <span class="hljs-comment">//3.获取token</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> request.getHeaders().getFirst(<span class="hljs-string">&quot;token&quot;</span>);<br><br>        <span class="hljs-comment">//4.判断token是否存在</span><br>        <span class="hljs-keyword">if</span>(StringUtils.isBlank(token))&#123;<br>            response.setStatusCode(HttpStatus.UNAUTHORIZED);<br>            <span class="hljs-keyword">return</span> response.setComplete();<br>        &#125;<br><br>        <span class="hljs-comment">//5.判断token是否有效</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Claims</span> <span class="hljs-variable">claimsBody</span> <span class="hljs-operator">=</span> AppJwtUtil.getClaimsBody(token);<br>            <span class="hljs-comment">//是否是过期</span><br>            <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> AppJwtUtil.verifyToken(claimsBody);<br>            <span class="hljs-keyword">if</span>(result == <span class="hljs-number">1</span> || result  == <span class="hljs-number">2</span>)&#123;<br>                response.setStatusCode(HttpStatus.UNAUTHORIZED);<br>                <span class="hljs-keyword">return</span> response.setComplete();<br>            &#125;<br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            e.printStackTrace();<br>            response.setStatusCode(HttpStatus.UNAUTHORIZED);<br>            <span class="hljs-keyword">return</span> response.setComplete();<br>        &#125;<br><br>        <span class="hljs-comment">//6.放行</span><br>        <span class="hljs-keyword">return</span> chain.filter(exchange);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 优先级设置  值越小  优先级越高</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getOrder</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>测试：</p>
<p>启动user服务，继续访问其他微服务，会提示需要认证才能访问，这个时候需要在heads中设置设置token才能正常访问。</p>
<h2 id="9-前端集成"><a href="#9-前端集成" class="headerlink" title="9)前端集成"></a>9)前端集成</h2><h3 id="9-1-前端项目部署思路"><a href="#9-1-前端项目部署思路" class="headerlink" title="9.1)前端项目部署思路"></a>9.1)前端项目部署思路</h3><p><img src="/../images/image-20210416095950485.png" srcset="/img/loading.gif" lazyload alt="image-20210416095950485"></p>
<p>通过nginx来进行配置，功能如下</p>
<ul>
<li>通过nginx的反向代理功能访问后台的网关资源</li>
<li>通过nginx的静态服务器功能访问前端静态页面</li>
</ul>
<h3 id="9-2-配置nginx"><a href="#9-2-配置nginx" class="headerlink" title="9.2)配置nginx"></a>9.2)配置nginx</h3><p>①：解压资料文件夹中的压缩包nginx-1.18.0.zip</p>
<p>②：解压资料文件夹中的前端项目app-web.zip</p>
<p>③：配置nginx.conf文件</p>
<p>在nginx安装的conf目录下新建一个文件夹<code>leadnews.conf</code>,在当前文件夹中新建<code>heima-leadnews-app.conf</code>文件</p>
<p>heima-leadnews-app.conf配置如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs javascript">upstream  heima-app-gateway&#123;<br>    server <span class="hljs-attr">localhost</span>:<span class="hljs-number">51601</span>;<br>&#125;<br><br>server &#123;<br>	listen <span class="hljs-number">8801</span>;<br>	location / &#123;<br>		root <span class="hljs-attr">D</span>:<span class="hljs-regexp">/workspace/</span>app-web/;<br>		index index.<span class="hljs-property">html</span>;<br>	&#125;<br>	<br>	location ~<span class="hljs-regexp">/app/</span>(.*) &#123;<br>		proxy_pass <span class="hljs-attr">http</span>:<span class="hljs-comment">//heima-app-gateway/$1;</span><br>		proxy_set_header <span class="hljs-variable constant_">HOST</span> $host;  # 不改变源请求头的值<br>		proxy_pass_request_body on;  #开启获取请求体<br>		proxy_pass_request_headers on;  #开启获取请求头<br>		proxy_set_header X-<span class="hljs-title class_">Real</span>-<span class="hljs-variable constant_">IP</span> $remote_addr;   # 记录真实发出请求的客户端<span class="hljs-variable constant_">IP</span><br>		proxy_set_header X-<span class="hljs-title class_">Forwarded</span>-<span class="hljs-title class_">For</span> $proxy_add_x_forwarded_for;  #记录代理信息<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>nginx.conf   把里面注释的内容和静态资源配置相关删除，引入heima-leadnews-app.conf文件加载</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs javascript">#user  nobody;<br>worker_processes  <span class="hljs-number">1</span>;<br><br>events &#123;<br>    worker_connections  <span class="hljs-number">1024</span>;<br>&#125;<br>http &#123;<br>    include       mime.<span class="hljs-property">types</span>;<br>    default_type  application/octet-stream;<br>    sendfile        on;<br>    keepalive_timeout  <span class="hljs-number">65</span>;<br>	# 引入自定义配置文件<br>	include leadnews.<span class="hljs-property">conf</span><span class="hljs-comment">/*.conf;</span><br><span class="hljs-comment">&#125;</span><br></code></pre></td></tr></table></figure>

<p>④ ：启动nginx</p>
<p>​    在nginx安装包中使用命令提示符打开，输入命令nginx启动项目</p>
<p>​    可查看进程，检查nginx是否启动</p>
<p>​    重新加载配置文件：<code>nginx -s reload</code></p>
<p>⑤：打开前端项目进行测试  – &gt;  <a target="_blank" rel="noopener" href="http://localhost:8801/">http://localhost:8801</a></p>
<p>​     用谷歌浏览器打开，调试移动端模式进行访问</p>
<h1 id="2-app端文章查看，静态化freemarker-分布式文件系统minIO"><a href="#2-app端文章查看，静态化freemarker-分布式文件系统minIO" class="headerlink" title="2 app端文章查看，静态化freemarker,分布式文件系统minIO"></a>2 app端文章查看，静态化freemarker,分布式文件系统minIO</h1><h2 id="1-文章列表加载"><a href="#1-文章列表加载" class="headerlink" title="1)文章列表加载"></a>1)文章列表加载</h2><h3 id="1-1-需求分析"><a href="#1-1-需求分析" class="headerlink" title="1.1)需求分析"></a>1.1)需求分析</h3><p>文章布局展示</p>
<p><img src="/../images/image-20210419151801252.png" srcset="/img/loading.gif" lazyload alt="image-20210419151801252"></p>
<h3 id="1-2-表结构分析"><a href="#1-2-表结构分析" class="headerlink" title="1.2)表结构分析"></a>1.2)表结构分析</h3><p>ap_article  文章基本信息表</p>
<p><img src="/../images/image-20210419151839634.png" srcset="/img/loading.gif" lazyload alt="image-20210419151839634"></p>
<p>ap_article_config  文章配置表</p>
<p><img src="/../images/image-20210419151854868.png" srcset="/img/loading.gif" lazyload alt="image-20210419151854868"></p>
<p>ap_article_content 文章内容表</p>
<p><img src="/../images/image-20210419151912063.png" srcset="/img/loading.gif" lazyload alt="image-20210419151912063"></p>
<p>三张表关系分析</p>
<p><img src="/../images/image-20210419151938103.png" srcset="/img/loading.gif" lazyload alt="image-20210419151938103"></p>
<h3 id="1-3-导入文章数据库"><a href="#1-3-导入文章数据库" class="headerlink" title="1.3)导入文章数据库"></a>1.3)导入文章数据库</h3><h4 id="1-3-1-导入数据库"><a href="#1-3-1-导入数据库" class="headerlink" title="1.3.1)导入数据库"></a>1.3.1)导入数据库</h4><p>查看当天资料文件夹，在数据库连接工具中执行leadnews_article.sql</p>
<h4 id="1-3-2-导入对应的实体类"><a href="#1-3-2-导入对应的实体类" class="headerlink" title="1.3.2)导入对应的实体类"></a>1.3.2)导入对应的实体类</h4><p>ap_article文章表对应实体</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.model.article.pojos;<br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.IdType;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.TableField;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.TableId;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.TableName;<br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><span class="hljs-keyword">import</span> java.util.Date;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * &lt;p&gt;</span><br><span class="hljs-comment"> * 文章信息表，存储已发布的文章</span><br><span class="hljs-comment"> * &lt;/p&gt;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> itheima</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@TableName(&quot;ap_article&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApArticle</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-meta">@TableId(value = &quot;id&quot;,type = IdType.ID_WORKER)</span><br>    <span class="hljs-keyword">private</span> Long id;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 标题</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String title;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 作者id</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;author_id&quot;)</span><br>    <span class="hljs-keyword">private</span> Long authorId;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 作者名称</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;author_name&quot;)</span><br>    <span class="hljs-keyword">private</span> String authorName;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 频道id</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;channel_id&quot;)</span><br>    <span class="hljs-keyword">private</span> Integer channelId;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 频道名称</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;channel_name&quot;)</span><br>    <span class="hljs-keyword">private</span> String channelName;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 文章布局  0 无图文章   1 单图文章    2 多图文章</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Short layout;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 文章标记  0 普通文章   1 热点文章   2 置顶文章   3 精品文章   4 大V 文章</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Byte flag;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 文章封面图片 多张逗号分隔</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String images;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 标签</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String labels;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 点赞数量</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Integer likes;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 收藏数量</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Integer collection;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 评论数量</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Integer comment;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 阅读数量</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Integer views;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 省市</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;province_id&quot;)</span><br>    <span class="hljs-keyword">private</span> Integer provinceId;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 市区</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;city_id&quot;)</span><br>    <span class="hljs-keyword">private</span> Integer cityId;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 区县</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;county_id&quot;)</span><br>    <span class="hljs-keyword">private</span> Integer countyId;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 创建时间</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;created_time&quot;)</span><br>    <span class="hljs-keyword">private</span> Date createdTime;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 发布时间</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;publish_time&quot;)</span><br>    <span class="hljs-keyword">private</span> Date publishTime;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 同步状态</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;sync_status&quot;)</span><br>    <span class="hljs-keyword">private</span> Boolean syncStatus;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 来源</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Boolean origin;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 静态页面地址</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;static_url&quot;)</span><br>    <span class="hljs-keyword">private</span> String staticUrl;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ap_article_config文章配置对应实体类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.model.article.pojos;<br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.IdType;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.TableField;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.TableId;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.TableName;<br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * &lt;p&gt;</span><br><span class="hljs-comment"> * APP已发布文章配置表</span><br><span class="hljs-comment"> * &lt;/p&gt;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> itheima</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@TableName(&quot;ap_article_config&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApArticleConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-meta">@TableId(value = &quot;id&quot;,type = IdType.ID_WORKER)</span><br>    <span class="hljs-keyword">private</span> Long id;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 文章id</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;article_id&quot;)</span><br>    <span class="hljs-keyword">private</span> Long articleId;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 是否可评论</span><br><span class="hljs-comment">     * true: 可以评论   1</span><br><span class="hljs-comment">     * false: 不可评论  0</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;is_comment&quot;)</span><br>    <span class="hljs-keyword">private</span> Boolean isComment;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 是否转发</span><br><span class="hljs-comment">     * true: 可以转发   1</span><br><span class="hljs-comment">     * false: 不可转发  0</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;is_forward&quot;)</span><br>    <span class="hljs-keyword">private</span> Boolean isForward;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 是否下架</span><br><span class="hljs-comment">     * true: 下架   1</span><br><span class="hljs-comment">     * false: 没有下架  0</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;is_down&quot;)</span><br>    <span class="hljs-keyword">private</span> Boolean isDown;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 是否已删除</span><br><span class="hljs-comment">     * true: 删除   1</span><br><span class="hljs-comment">     * false: 没有删除  0</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;is_delete&quot;)</span><br>    <span class="hljs-keyword">private</span> Boolean isDelete;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ap_article_content 文章内容对应的实体类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.model.article.pojos;<br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.IdType;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.TableField;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.TableId;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.TableName;<br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@TableName(&quot;ap_article_content&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApArticleContent</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-meta">@TableId(value = &quot;id&quot;,type = IdType.ID_WORKER)</span><br>    <span class="hljs-keyword">private</span> Long id;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 文章id</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;article_id&quot;)</span><br>    <span class="hljs-keyword">private</span> Long articleId;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 文章内容</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String content;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="1-4-实现思路"><a href="#1-4-实现思路" class="headerlink" title="1.4)实现思路"></a>1.4)实现思路</h3><p><img src="/../images/image-20210419152011931.png" srcset="/img/loading.gif" lazyload alt="image-20210419152011931"></p>
<p>1,在默认频道展示10条文章信息</p>
<p>2,可以切换频道查看不同种类文章</p>
<p>3,当用户下拉可以加载最新的文章（分页）本页文章列表中发布时间为最大的时间为依据</p>
<p>4,当用户上拉可以加载更多的文章信息（按照发布时间）本页文章列表中发布时间最小的时间为依据</p>
<p>5，如果是当前频道的首页，前端传递默认参数：</p>
<ul>
<li><p>maxBehotTime：0（毫秒）</p>
</li>
<li><p>minBehotTime：20000000000000（毫秒）—&gt;2063年</p>
</li>
</ul>
<h3 id="1-5-接口定义"><a href="#1-5-接口定义" class="headerlink" title="1.5)接口定义"></a>1.5)接口定义</h3><table>
<thead>
<tr>
<th></th>
<th><strong>加载首页</strong></th>
<th><strong>加载更多</strong></th>
<th><strong>加载最新</strong></th>
</tr>
</thead>
<tbody><tr>
<td>接口路径</td>
<td>/api/v1/article/load</td>
<td>/api/v1/article/loadmore</td>
<td>/api/v1/article/loadnew</td>
</tr>
<tr>
<td>请求方式</td>
<td>POST</td>
<td>POST</td>
<td>POST</td>
</tr>
<tr>
<td>参数</td>
<td>ArticleHomeDto</td>
<td>ArticleHomeDto</td>
<td>ArticleHomeDto</td>
</tr>
<tr>
<td>响应结果</td>
<td>ResponseResult</td>
<td>ResponseResult</td>
<td>ResponseResult</td>
</tr>
</tbody></table>
<p>ArticleHomeDto</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.model.article.dtos;<br><br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.util.Date;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArticleHomeDto</span> &#123;<br><br>    <span class="hljs-comment">// 最大时间</span><br>    Date maxBehotTime;<br>    <span class="hljs-comment">// 最小时间</span><br>    Date minBehotTime;<br>    <span class="hljs-comment">// 分页size</span><br>    Integer size;<br>    <span class="hljs-comment">// 频道ID</span><br>    String tag;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="1-6-功能实现"><a href="#1-6-功能实现" class="headerlink" title="1.6)功能实现"></a>1.6)功能实现</h3><h4 id="1-6-1-：导入heima-leadnews-article微服务，资料在当天的文件夹中"><a href="#1-6-1-：导入heima-leadnews-article微服务，资料在当天的文件夹中" class="headerlink" title="1.6.1)：导入heima-leadnews-article微服务，资料在当天的文件夹中"></a>1.6.1)：导入heima-leadnews-article微服务，资料在当天的文件夹中</h4><p><img src="/../images/image-20210420000326669.png" srcset="/img/loading.gif" lazyload alt="image-20210420000326669"></p>
<p><font color='red'>注意：需要在heima-leadnews-service的pom文件夹中添加子模块信息，如下：</font></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">modules</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>heima-leadnews-user<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>heima-leadnews-article<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">modules</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>在idea中的maven中更新一下，如果工程还是灰色的，需要在重新添加文章微服务的pom文件，操作步骤如下：</p>
<p><img src="/../images/image-20210420001037992.png" srcset="/img/loading.gif" lazyload alt="image-20210420001037992"></p>
<p>需要在nacos中添加对应的配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">datasource:</span><br>    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.jdbc.Driver</span><br>    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/leadnews_article?useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=UTC</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">root</span><br><span class="hljs-comment"># 设置Mapper接口所对应的XML文件位置，如果你在Mapper接口中有自定义方法，需要进行该配置</span><br><span class="hljs-attr">mybatis-plus:</span><br>  <span class="hljs-attr">mapper-locations:</span> <span class="hljs-string">classpath*:mapper/*.xml</span><br>  <span class="hljs-comment"># 设置别名包扫描路径，通过该属性可以给包中的类注册别名</span><br>  <span class="hljs-attr">type-aliases-package:</span> <span class="hljs-string">com.heima.model.article.pojos</span><br></code></pre></td></tr></table></figure>

<h4 id="1-6-2-：定义接口"><a href="#1-6-2-：定义接口" class="headerlink" title="1.6.2)：定义接口"></a>1.6.2)：定义接口</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.article.controller.v1;<br><br><span class="hljs-keyword">import</span> com.heima.model.article.dtos.ArticleHomeDto;<br><span class="hljs-keyword">import</span> com.heima.model.common.dtos.ResponseResult;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PostMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestBody;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/api/v1/article&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArticleHomeController</span> &#123;<br><br><br>    <span class="hljs-meta">@PostMapping(&quot;/load&quot;)</span><br>    <span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">load</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> ArticleHomeDto dto)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/loadmore&quot;)</span><br>    <span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">loadMore</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> ArticleHomeDto dto)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/loadnew&quot;)</span><br>    <span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">loadNew</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> ArticleHomeDto dto)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="1-6-3-：编写mapper文件"><a href="#1-6-3-：编写mapper文件" class="headerlink" title="1.6.3)：编写mapper文件"></a>1.6.3)：编写mapper文件</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.article.mapper;<br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.mapper.BaseMapper;<br><span class="hljs-keyword">import</span> com.heima.model.article.dtos.ArticleHomeDto;<br><span class="hljs-keyword">import</span> com.heima.model.article.pojos.ApArticle;<br><span class="hljs-keyword">import</span> org.apache.ibatis.annotations.Mapper;<br><span class="hljs-keyword">import</span> org.apache.ibatis.annotations.Param;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-meta">@Mapper</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ApArticleMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseMapper</span>&lt;ApArticle&gt; &#123;<br><br>    <span class="hljs-keyword">public</span> List&lt;ApArticle&gt; <span class="hljs-title function_">loadArticleList</span><span class="hljs-params">(<span class="hljs-meta">@Param(&quot;dto&quot;)</span> ArticleHomeDto dto, <span class="hljs-meta">@Param(&quot;type&quot;)</span> Short type)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>对应的映射文件</p>
<p>在resources中新建mapper/ApArticleMapper.xml     如下配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">mapper</span> <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span> <span class="hljs-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">&quot;com.heima.article.mapper.ApArticleMapper&quot;</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">resultMap</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;resultMap&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;com.heima.model.article.pojos.ApArticle&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;id&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;id&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;title&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;title&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;author_id&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;authorId&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;author_name&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;authorName&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;channel_id&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;channelId&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;channel_name&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;channelName&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;layout&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;layout&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;flag&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;flag&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;images&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;images&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;labels&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;labels&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;likes&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;likes&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;collection&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;collection&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;comment&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;comment&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;views&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;views&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;province_id&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;provinceId&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;city_id&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;cityId&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;county_id&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;countyId&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;created_time&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;createdTime&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;publish_time&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;publishTime&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;sync_status&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;syncStatus&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;static_url&quot;</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;staticUrl&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">resultMap</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;loadArticleList&quot;</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">&quot;resultMap&quot;</span>&gt;</span><br>        SELECT<br>        aa.*<br>        FROM<br>        `ap_article` aa<br>        LEFT JOIN ap_article_config aac ON aa.id = aac.article_id<br>        <span class="hljs-tag">&lt;<span class="hljs-name">where</span>&gt;</span><br>            and aac.is_delete != 1<br>            and aac.is_down != 1<br>            <span class="hljs-comment">&lt;!-- loadmore --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;type != null and type == 1&quot;</span>&gt;</span><br>                and aa.publish_time &lt;![CDATA[&lt;]]&gt; #&#123;dto.minBehotTime&#125;<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;type != null and type == 2&quot;</span>&gt;</span><br>                and aa.publish_time &lt;![CDATA[&gt;]]&gt; #&#123;dto.maxBehotTime&#125;<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;dto.tag != &#x27;__all__&#x27;&quot;</span>&gt;</span><br>                and aa.channel_id = #&#123;dto.tag&#125;<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">where</span>&gt;</span><br>        order by aa.publish_time desc<br>        limit #&#123;dto.size&#125;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h4 id="1-6-4-：编写业务层代码"><a href="#1-6-4-：编写业务层代码" class="headerlink" title="1.6.4)：编写业务层代码"></a>1.6.4)：编写业务层代码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.article.service;<br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.extension.service.IService;<br><span class="hljs-keyword">import</span> com.heima.model.article.dtos.ArticleHomeDto;<br><span class="hljs-keyword">import</span> com.heima.model.article.pojos.ApArticle;<br><span class="hljs-keyword">import</span> com.heima.model.common.dtos.ResponseResult;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ApArticleService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IService</span>&lt;ApArticle&gt; &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据参数加载文章列表</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> loadtype 1为加载更多  2为加载最新</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> dto</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    ResponseResult <span class="hljs-title function_">load</span><span class="hljs-params">(Short loadtype, ArticleHomeDto dto)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>实现类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.article.service.impl;<br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;<br><span class="hljs-keyword">import</span> com.heima.article.mapper.ApArticleMapper;<br><span class="hljs-keyword">import</span> com.heima.article.service.ApArticleService;<br><span class="hljs-keyword">import</span> com.heima.common.constants.ArticleConstants;<br><span class="hljs-keyword">import</span> com.heima.model.article.dtos.ArticleHomeDto;<br><br><span class="hljs-keyword">import</span> com.heima.model.article.pojos.ApArticle;<br><span class="hljs-keyword">import</span> com.heima.model.common.dtos.ResponseResult;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.apache.commons.lang3.StringUtils;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><span class="hljs-keyword">import</span> org.springframework.transaction.annotation.Transactional;<br><br><span class="hljs-keyword">import</span> java.util.Date;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><br><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@Transactional</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApArticleServiceImpl</span>  <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ServiceImpl</span>&lt;ApArticleMapper, ApArticle&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ApArticleService</span> &#123;<br><br>    <span class="hljs-comment">// 单页最大加载的数字</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">short</span> <span class="hljs-variable">MAX_PAGE_SIZE</span> <span class="hljs-operator">=</span> <span class="hljs-number">50</span>;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ApArticleMapper apArticleMapper;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据参数加载文章列表</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> loadtype 1为加载更多  2为加载最新</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> dto</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">load</span><span class="hljs-params">(Short loadtype, ArticleHomeDto dto)</span> &#123;<br>        <span class="hljs-comment">//1.校验参数</span><br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> dto.getSize();<br>        <span class="hljs-keyword">if</span>(size == <span class="hljs-literal">null</span> || size == <span class="hljs-number">0</span>)&#123;<br>            size = <span class="hljs-number">10</span>;<br>        &#125;<br>        size = Math.min(size,MAX_PAGE_SIZE);<br>        dto.setSize(size);<br><br>        <span class="hljs-comment">//类型参数检验</span><br>        <span class="hljs-keyword">if</span>(!loadtype.equals(ArticleConstants.LOADTYPE_LOAD_MORE)&amp;&amp;!loadtype.equals(ArticleConstants.LOADTYPE_LOAD_NEW))&#123;<br>            loadtype = ArticleConstants.LOADTYPE_LOAD_MORE;<br>        &#125;<br>        <span class="hljs-comment">//文章频道校验</span><br>        <span class="hljs-keyword">if</span>(StringUtils.isEmpty(dto.getTag()))&#123;<br>            dto.setTag(ArticleConstants.DEFAULT_TAG);<br>        &#125;<br><br>        <span class="hljs-comment">//时间校验</span><br>        <span class="hljs-keyword">if</span>(dto.getMaxBehotTime() == <span class="hljs-literal">null</span>) dto.setMaxBehotTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>        <span class="hljs-keyword">if</span>(dto.getMinBehotTime() == <span class="hljs-literal">null</span>) dto.setMinBehotTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>        <span class="hljs-comment">//2.查询数据</span><br>        List&lt;ApArticle&gt; apArticles = apArticleMapper.loadArticleList(dto, loadtype);<br><br>        <span class="hljs-comment">//3.结果封装</span><br>        <span class="hljs-type">ResponseResult</span> <span class="hljs-variable">responseResult</span> <span class="hljs-operator">=</span> ResponseResult.okResult(apArticles);<br>        <span class="hljs-keyword">return</span> responseResult;<br>    &#125;<br>    <br>&#125;<br></code></pre></td></tr></table></figure>

<p>定义常量类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.common.constants;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArticleConstants</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Short</span> <span class="hljs-variable">LOADTYPE_LOAD_MORE</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Short</span> <span class="hljs-variable">LOADTYPE_LOAD_NEW</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_TAG</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;__all__&quot;</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="1-6-5-：编写控制器代码"><a href="#1-6-5-：编写控制器代码" class="headerlink" title="1.6.5)：编写控制器代码"></a>1.6.5)：编写控制器代码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.article.controller.v1;<br><br><span class="hljs-keyword">import</span> com.heima.article.service.ApArticleService;<br><span class="hljs-keyword">import</span> com.heima.common.constants.ArticleConstants;<br><span class="hljs-keyword">import</span> com.heima.model.article.dtos.ArticleHomeDto;<br><span class="hljs-keyword">import</span> com.heima.model.common.dtos.ResponseResult;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PostMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestBody;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/api/v1/article&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArticleHomeController</span> &#123;<br><br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ApArticleService apArticleService;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/load&quot;)</span><br>    <span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">load</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> ArticleHomeDto dto)</span> &#123;<br>        <span class="hljs-keyword">return</span> apArticleService.load(ArticleConstants.LOADTYPE_LOAD_MORE,dto);<br>    &#125;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/loadmore&quot;)</span><br>    <span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">loadMore</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> ArticleHomeDto dto)</span> &#123;<br>        <span class="hljs-keyword">return</span> apArticleService.load(ArticleConstants.LOADTYPE_LOAD_MORE,dto);<br>    &#125;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/loadnew&quot;)</span><br>    <span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">loadNew</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> ArticleHomeDto dto)</span> &#123;<br>        <span class="hljs-keyword">return</span> apArticleService.load(ArticleConstants.LOADTYPE_LOAD_NEW,dto);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="1-6-6-：swagger测试或前后端联调测试"><a href="#1-6-6-：swagger测试或前后端联调测试" class="headerlink" title="1.6.6)：swagger测试或前后端联调测试"></a>1.6.6)：swagger测试或前后端联调测试</h4><p>第一：在app网关的微服务的nacos的配置中心添加文章微服务的路由，完整配置如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">gateway:</span><br>      <span class="hljs-attr">globalcors:</span><br>        <span class="hljs-attr">cors-configurations:</span><br>          <span class="hljs-string">&#x27;[/**]&#x27;</span><span class="hljs-string">:</span> <span class="hljs-comment"># 匹配所有请求</span><br>            <span class="hljs-attr">allowedOrigins:</span> <span class="hljs-string">&quot;*&quot;</span> <span class="hljs-comment">#跨域处理 允许所有的域</span><br>            <span class="hljs-attr">allowedMethods:</span> <span class="hljs-comment"># 支持的方法</span><br>              <span class="hljs-bullet">-</span> <span class="hljs-string">GET</span><br>              <span class="hljs-bullet">-</span> <span class="hljs-string">POST</span><br>              <span class="hljs-bullet">-</span> <span class="hljs-string">PUT</span><br>              <span class="hljs-bullet">-</span> <span class="hljs-string">DELETE</span><br>      <span class="hljs-attr">routes:</span><br>        <span class="hljs-comment"># 用户微服务</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">user</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://leadnews-user</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/user/**</span><br>          <span class="hljs-attr">filters:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">StripPrefix=</span> <span class="hljs-number">1</span><br>        <span class="hljs-comment"># 文章微服务</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">article</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://leadnews-article</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/article/**</span><br>          <span class="hljs-attr">filters:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">StripPrefix=</span> <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure>

<p>第二：启动nginx，直接使用前端项目测试，启动文章微服务，用户微服务、app网关微服务</p>
<h2 id="2-freemarker"><a href="#2-freemarker" class="headerlink" title="2)freemarker"></a>2)freemarker</h2><h3 id="2-1-freemarker-介绍"><a href="#2-1-freemarker-介绍" class="headerlink" title="2.1) freemarker 介绍"></a>2.1) freemarker 介绍</h3><p>​    FreeMarker 是一款 模板引擎： 即一种基于模板和要改变的数据， 并用来生成输出文本(HTML网页，电子邮件，配置文件，源代码等)的通用工具。 它不是面向最终用户的，而是一个Java类库，是一款程序员可以嵌入他们所开发产品的组件。</p>
<p>​    模板编写为FreeMarker Template Language (FTL)。它是简单的，专用的语言， <em>不是</em> 像PHP那样成熟的编程语言。 那就意味着要准备数据在真实编程语言中来显示，比如数据库查询和业务运算， 之后模板显示已经准备好的数据。在模板中，你可以专注于如何展现数据， 而在模板之外可以专注于要展示什么数据。 </p>
<p><img src="/../images/1528820943975.png" srcset="/img/loading.gif" lazyload alt="1528820943975"></p>
<p>常用的java模板引擎还有哪些？</p>
<p>Jsp、Freemarker、Thymeleaf 、Velocity 等。</p>
<p>1.Jsp 为 Servlet 专用，不能单独进行使用。</p>
<p>2.Thymeleaf 为新技术，功能较为强大，但是执行的效率比较低。</p>
<p>3.Velocity从2010年更新完 2.0 版本后，便没有在更新。Spring Boot 官方在 1.4 版本后对此也不在支持，虽然 Velocity 在 2017 年版本得到迭代，但为时已晚。 </p>
<h3 id="2-2-环境搭建-amp-amp-快速入门"><a href="#2-2-环境搭建-amp-amp-快速入门" class="headerlink" title="2.2) 环境搭建&amp;&amp;快速入门"></a>2.2) 环境搭建&amp;&amp;快速入门</h3><p>freemarker作为springmvc一种视图格式，默认情况下SpringMVC支持freemarker视图格式。</p>
<p>需要创建Spring Boot+Freemarker工程用于测试模板。</p>
<h4 id="2-2-1-创建测试工程"><a href="#2-2-1-创建测试工程" class="headerlink" title="2.2.1) 创建测试工程"></a>2.2.1) 创建测试工程</h4><p>创建一个freemarker-demo 的测试工程专门用于freemarker的功能测试与模板的测试。</p>
<p>pom.xml如下</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>heima-leadnews-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.heima<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>freemarker-demo<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.source</span>&gt;</span>8<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.source</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.target</span>&gt;</span>8<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.target</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-freemarker<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- lombok --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-comment">&lt;!-- apache 对 java io 的封装工具库 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.commons<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-io<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.3.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h4 id="2-2-2-配置文件"><a href="#2-2-2-配置文件" class="headerlink" title="2.2.2) 配置文件"></a>2.2.2) 配置文件</h4><p>配置application.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8881</span> <span class="hljs-comment">#服务端口</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">freemarker-demo</span> <span class="hljs-comment">#指定服务名</span><br>  <span class="hljs-attr">freemarker:</span><br>    <span class="hljs-attr">cache:</span> <span class="hljs-literal">false</span>  <span class="hljs-comment">#关闭模板缓存，方便测试</span><br>    <span class="hljs-attr">settings:</span><br>      <span class="hljs-attr">template_update_delay:</span> <span class="hljs-number">0</span> <span class="hljs-comment">#检查模板更新延迟时间，设置为0表示立即检查，如果时间大于0会有缓存不方便进行模板测试</span><br>    <span class="hljs-attr">suffix:</span> <span class="hljs-string">.ftl</span>               <span class="hljs-comment">#指定Freemarker模板文件的后缀名</span><br></code></pre></td></tr></table></figure>



<h4 id="2-2-3-创建模型类"><a href="#2-2-3-创建模型类" class="headerlink" title="2.2.3) 创建模型类"></a>2.2.3) 创建模型类</h4><p>在freemarker的测试工程下创建模型类型用于测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.freemarker.entity;<br><br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.util.Date;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> &#123;<br>    <span class="hljs-keyword">private</span> String name;<span class="hljs-comment">//姓名</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;<span class="hljs-comment">//年龄</span><br>    <span class="hljs-keyword">private</span> Date birthday;<span class="hljs-comment">//生日</span><br>    <span class="hljs-keyword">private</span> Float money;<span class="hljs-comment">//钱包</span><br>&#125;<br></code></pre></td></tr></table></figure>





<h4 id="2-2-4-创建模板"><a href="#2-2-4-创建模板" class="headerlink" title="2.2.4) 创建模板"></a>2.2.4) 创建模板</h4><p>在resources下创建templates，此目录为freemarker的默认模板存放目录。</p>
<p>在templates下创建模板文件 01-basic.ftl ，模板中的插值表达式最终会被freemarker替换成具体的数据。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;utf-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Hello World!<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">b</span>&gt;</span>普通文本 String 展示：<span class="hljs-tag">&lt;/<span class="hljs-name">b</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br>Hello $&#123;name&#125; <span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">hr</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">b</span>&gt;</span>对象Student中的数据展示：<span class="hljs-tag">&lt;/<span class="hljs-name">b</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><br>姓名：$&#123;stu.name&#125;<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><br>年龄：$&#123;stu.age&#125;<br><span class="hljs-tag">&lt;<span class="hljs-name">hr</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure>



<h4 id="2-2-5-创建controller"><a href="#2-2-5-创建controller" class="headerlink" title="2.2.5) 创建controller"></a>2.2.5) 创建controller</h4><p>创建Controller类，向Map中添加name，最后返回模板文件。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.test.freemarker.controller;<br><br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Controller;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.client.RestTemplate;<br><br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloController</span> &#123;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/basic&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">test</span><span class="hljs-params">(Model model)</span> &#123;<br><br><br>        <span class="hljs-comment">//1.纯文本形式的参数</span><br>        model.addAttribute(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;freemarker&quot;</span>);<br>        <span class="hljs-comment">//2.实体类相关的参数</span><br>        <br>        <span class="hljs-type">Student</span> <span class="hljs-variable">student</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>();<br>        student.setName(<span class="hljs-string">&quot;小明&quot;</span>);<br>        student.setAge(<span class="hljs-number">18</span>);<br>        model.addAttribute(<span class="hljs-string">&quot;stu&quot;</span>, student);<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;01-basic&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>01-basic.ftl，使用插值表达式填充数据</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;utf-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Hello World!<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">b</span>&gt;</span>普通文本 String 展示：<span class="hljs-tag">&lt;/<span class="hljs-name">b</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br>Hello $&#123;name&#125; <span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">hr</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">b</span>&gt;</span>对象Student中的数据展示：<span class="hljs-tag">&lt;/<span class="hljs-name">b</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><br>姓名：$&#123;stu.name&#125;<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><br>年龄：$&#123;stu.age&#125;<br><span class="hljs-tag">&lt;<span class="hljs-name">hr</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure>



<h4 id="2-2-6-创建启动类"><a href="#2-2-6-创建启动类" class="headerlink" title="2.2.6) 创建启动类"></a>2.2.6) 创建启动类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.freemarker;<br><br><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FreemarkerDemotApplication</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(FreemarkerDemotApplication.class,args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="2-2-7-测试"><a href="#2-2-7-测试" class="headerlink" title="2.2.7) 测试"></a>2.2.7) 测试</h4><p>请求：<a target="_blank" rel="noopener" href="http://localhost:8881/basic">http://localhost:8881/basic</a></p>
<p><img src="/../images/1576129529361.png" srcset="/img/loading.gif" lazyload alt="1576129529361"></p>
<h3 id="2-3-freemarker基础"><a href="#2-3-freemarker基础" class="headerlink" title="2.3) freemarker基础"></a>2.3) freemarker基础</h3><h4 id="2-3-1-基础语法种类"><a href="#2-3-1-基础语法种类" class="headerlink" title="2.3.1) 基础语法种类"></a>2.3.1) 基础语法种类</h4><p>  1、注释，即&lt;#–  –&gt;，介于其之间的内容会被freemarker忽略</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs velocity">&lt;#--我是一个freemarker注释--&gt;<br></code></pre></td></tr></table></figure>

<p>  2、插值（Interpolation）：即 <strong><code>$&#123;..&#125;</code></strong> 部分,freemarker会用真实的值代替**<code>$&#123;..&#125;</code>**</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs velocity">Hello $&#123;name&#125;<br></code></pre></td></tr></table></figure>

<p>  3、FTL指令：和HTML标记类似，名字前加#予以区分，Freemarker会解析标签中的表达式或逻辑。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs velocity">&lt;# &gt;FTL指令&lt;/#&gt; <br></code></pre></td></tr></table></figure>

<p>  4、文本，仅文本信息，这些不是freemarker的注释、插值、FTL指令的内容会被freemarker忽略解析，直接输出内容。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs velocity">&lt;#--freemarker中的普通文本--&gt;<br>我是一个普通的文本<br></code></pre></td></tr></table></figure>

<h4 id="2-3-2-集合指令（List和Map）"><a href="#2-3-2-集合指令（List和Map）" class="headerlink" title="2.3.2) 集合指令（List和Map）"></a>2.3.2) 集合指令（List和Map）</h4><p>1、数据模型：</p>
<p>在HelloController中新增如下方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/list&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">list</span><span class="hljs-params">(Model model)</span>&#123;<br><br>    <span class="hljs-comment">//------------------------------------</span><br>    <span class="hljs-type">Student</span> <span class="hljs-variable">stu1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>();<br>    stu1.setName(<span class="hljs-string">&quot;小强&quot;</span>);<br>    stu1.setAge(<span class="hljs-number">18</span>);<br>    stu1.setMoney(<span class="hljs-number">1000.86f</span>);<br>    stu1.setBirthday(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br><br>    <span class="hljs-comment">//小红对象模型数据</span><br>    <span class="hljs-type">Student</span> <span class="hljs-variable">stu2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>();<br>    stu2.setName(<span class="hljs-string">&quot;小红&quot;</span>);<br>    stu2.setMoney(<span class="hljs-number">200.1f</span>);<br>    stu2.setAge(<span class="hljs-number">19</span>);<br><br>    <span class="hljs-comment">//将两个对象模型数据存放到List集合中</span><br>    List&lt;Student&gt; stus = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    stus.add(stu1);<br>    stus.add(stu2);<br><br>    <span class="hljs-comment">//向model中存放List集合数据</span><br>    model.addAttribute(<span class="hljs-string">&quot;stus&quot;</span>,stus);<br><br>    <span class="hljs-comment">//------------------------------------</span><br><br>    <span class="hljs-comment">//创建Map数据</span><br>    HashMap&lt;String,Student&gt; stuMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>    stuMap.put(<span class="hljs-string">&quot;stu1&quot;</span>,stu1);<br>    stuMap.put(<span class="hljs-string">&quot;stu2&quot;</span>,stu2);<br>    <span class="hljs-comment">// 3.1 向model中存放Map数据</span><br>    model.addAttribute(<span class="hljs-string">&quot;stuMap&quot;</span>, stuMap);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;02-list&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>2、模板：</p>
<p>在templates中新增<code>02-list.ftl</code>文件</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;utf-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Hello World!<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <br>&lt;#-- list 数据的展示 --&gt;<br><span class="hljs-tag">&lt;<span class="hljs-name">b</span>&gt;</span>展示list中的stu数据:<span class="hljs-tag">&lt;/<span class="hljs-name">b</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">table</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>序号<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>姓名<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>年龄<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>钱包<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">table</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">hr</span>&gt;</span><br>    <br>&lt;#-- Map 数据的展示 --&gt;<br><span class="hljs-tag">&lt;<span class="hljs-name">b</span>&gt;</span>map数据的展示：<span class="hljs-tag">&lt;/<span class="hljs-name">b</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;###&quot;</span>&gt;</span>方式一：通过map[&#x27;keyname&#x27;].property<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><br>输出stu1的学生信息：<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><br>姓名：<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><br>年龄：<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;###&quot;</span>&gt;</span>方式二：通过map.keyname.property<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><br>输出stu2的学生信息：<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><br>姓名：<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><br>年龄：<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;###&quot;</span>&gt;</span>遍历map中两个学生信息：<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">table</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>序号<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>姓名<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>年龄<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>钱包<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span> <br>    <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">table</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">hr</span>&gt;</span><br> <br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>实例代码：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;utf-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Hello World!<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <br>&lt;#-- list 数据的展示 --&gt;<br><span class="hljs-tag">&lt;<span class="hljs-name">b</span>&gt;</span>展示list中的stu数据:<span class="hljs-tag">&lt;/<span class="hljs-name">b</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">table</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>序号<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>姓名<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>年龄<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>钱包<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span><br>    &lt;#list stus as stu&gt;<br>        <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>$&#123;stu_index+1&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>$&#123;stu.name&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>$&#123;stu.age&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>$&#123;stu.money&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span><br>    &lt;/#list&gt;<br><br><span class="hljs-tag">&lt;/<span class="hljs-name">table</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">hr</span>&gt;</span><br>    <br>&lt;#-- Map 数据的展示 --&gt;<br><span class="hljs-tag">&lt;<span class="hljs-name">b</span>&gt;</span>map数据的展示：<span class="hljs-tag">&lt;/<span class="hljs-name">b</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;###&quot;</span>&gt;</span>方式一：通过map[&#x27;keyname&#x27;].property<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><br>输出stu1的学生信息：<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><br>姓名：$&#123;stuMap[&#x27;stu1&#x27;].name&#125;<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><br>年龄：$&#123;stuMap[&#x27;stu1&#x27;].age&#125;<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;###&quot;</span>&gt;</span>方式二：通过map.keyname.property<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><br>输出stu2的学生信息：<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><br>姓名：$&#123;stuMap.stu2.name&#125;<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><br>年龄：$&#123;stuMap.stu2.age&#125;<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;###&quot;</span>&gt;</span>遍历map中两个学生信息：<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">table</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>序号<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>姓名<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>年龄<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>钱包<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span><br>    &lt;#list stuMap?keys as key &gt;<br>        <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>$&#123;key_index&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>$&#123;stuMap[key].name&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>$&#123;stuMap[key].age&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>$&#123;stuMap[key].money&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span><br>    &lt;/#list&gt;<br><span class="hljs-tag">&lt;/<span class="hljs-name">table</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">hr</span>&gt;</span><br> <br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>👆上面代码解释：</p>
<p>${k_index}：<br>    index：得到循环的下标，使用方法是在stu后边加”_index”，它的值是从0开始</p>
<h4 id="2-3-3-if指令"><a href="#2-3-3-if指令" class="headerlink" title="2.3.3) if指令"></a>2.3.3) if指令</h4><p>​     if 指令即判断指令，是常用的FTL指令，freemarker在解析时遇到if会进行判断，条件为真则输出if中间的内容，否则跳过内容不再输出。</p>
<ul>
<li>指令格式</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html">&lt;#if &gt;<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br></code></pre></td></tr></table></figure>



<p>1、数据模型：</p>
<p>使用list指令中测试数据模型，判断名称为小红的数据字体显示为红色。</p>
<p>2、模板：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs velocity">&lt;table&gt;<br>    &lt;tr&gt;<br>        &lt;td&gt;姓名&lt;/td&gt;<br>        &lt;td&gt;年龄&lt;/td&gt;<br>        &lt;td&gt;钱包&lt;/td&gt;<br>    &lt;/tr&gt;<br>    &lt;#list stus as stu&gt;<br>        &lt;tr&gt;<br>            &lt;td &gt;$&#123;stu.name&#125;&lt;/td&gt;<br>            &lt;td&gt;$&#123;stu.age&#125;&lt;/td&gt;<br>            &lt;td &gt;$&#123;stu.mondy&#125;&lt;/td&gt;<br>        &lt;/tr&gt;<br>    &lt;/#list&gt;<br><br>&lt;/table&gt;<br></code></pre></td></tr></table></figure>



<p>实例代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs velocity">&lt;table&gt;<br>    &lt;tr&gt;<br>        &lt;td&gt;姓名&lt;/td&gt;<br>        &lt;td&gt;年龄&lt;/td&gt;<br>        &lt;td&gt;钱包&lt;/td&gt;<br>    &lt;/tr&gt;<br>    &lt;#list stus as stu &gt;<br>        &lt;#if stu.name=&#x27;小红&#x27;&gt;<br>            &lt;tr style=&quot;color: red&quot;&gt;<br>                &lt;td&gt;$&#123;stu_index&#125;&lt;/td&gt;<br>                &lt;td&gt;$&#123;stu.name&#125;&lt;/td&gt;<br>                &lt;td&gt;$&#123;stu.age&#125;&lt;/td&gt;<br>                &lt;td&gt;$&#123;stu.money&#125;&lt;/td&gt;<br>            &lt;/tr&gt;<br>            &lt;#else &gt;<br>            &lt;tr&gt;<br>                &lt;td&gt;$&#123;stu_index&#125;&lt;/td&gt;<br>                &lt;td&gt;$&#123;stu.name&#125;&lt;/td&gt;<br>                &lt;td&gt;$&#123;stu.age&#125;&lt;/td&gt;<br>                &lt;td&gt;$&#123;stu.money&#125;&lt;/td&gt;<br>            &lt;/tr&gt;<br>        &lt;/#if&gt;<br>    &lt;/#list&gt;<br>&lt;/table&gt;<br></code></pre></td></tr></table></figure>





<p>3、输出：</p>
<p>姓名为“小强”则字体颜色显示为红色。</p>
<p><img src="/../images/1539947776259.png" srcset="/img/loading.gif" lazyload alt="1539947776259"></p>
<h4 id="2-3-4-运算符"><a href="#2-3-4-运算符" class="headerlink" title="2.3.4)  运算符"></a>2.3.4)  运算符</h4><p><strong>1、算数运算符</strong></p>
<p>FreeMarker表达式中完全支持算术运算,FreeMarker支持的算术运算符包括:</p>
<ul>
<li>加法： <code>+</code></li>
<li>减法： <code>-</code></li>
<li>乘法： <code>*</code></li>
<li>除法： <code>/</code></li>
<li>求模 (求余)： <code>%</code></li>
</ul>
<p>模板代码</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">b</span>&gt;</span>算数运算符<span class="hljs-tag">&lt;/<span class="hljs-name">b</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><br>    100+5 运算：  $&#123;100 + 5 &#125;<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><br>    100 - 5 * 5运算：$&#123;100 - 5 * 5&#125;<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><br>    5 / 2运算：$&#123;5 / 2&#125;<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><br>    12 % 10运算：$&#123;12 % 10&#125;<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">hr</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>除了 + 运算以外，其他的运算只能和 number 数字类型的计算。</p>
<p><strong>2、比较运算符</strong></p>
<ul>
<li><strong><code>=</code><strong>或者</strong><code>==</code></strong>:判断两个值是否相等. </li>
<li><strong><code>!=</code></strong>:判断两个值是否不等. </li>
<li><strong><code>&gt;</code><strong>或者</strong><code>gt</code></strong>:判断左边值是否大于右边值 </li>
<li><strong><code>&gt;=</code><strong>或者</strong><code>gte</code></strong>:判断左边值是否大于等于右边值 </li>
<li><strong><code>&lt;</code><strong>或者</strong><code>lt</code></strong>:判断左边值是否小于右边值 </li>
<li><strong><code>&lt;=</code><strong>或者</strong><code>lte</code></strong>:判断左边值是否小于等于右边值 </li>
</ul>
<p>= 和 == 模板代码</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;utf-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Hello World!<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">b</span>&gt;</span>比较运算符<span class="hljs-tag">&lt;/<span class="hljs-name">b</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dl</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dt</span>&gt;</span> =/== 和 != 比较：<span class="hljs-tag">&lt;/<span class="hljs-name">dt</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dd</span>&gt;</span><br>            &lt;#if &quot;xiaoming&quot; == &quot;xiaoming&quot;&gt;<br>                字符串的比较 &quot;xiaoming&quot; == &quot;xiaoming&quot;<br>            &lt;/#if&gt;<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dd</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dd</span>&gt;</span><br>            &lt;#if 10 != 100&gt;<br>                数值的比较 10 != 100<br>            &lt;/#if&gt;<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dd</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dl</span>&gt;</span><br><br><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dl</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dt</span>&gt;</span>其他比较<span class="hljs-tag">&lt;/<span class="hljs-name">dt</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dd</span>&gt;</span><br>            &lt;#if 10 gt 5 &gt;<br>                形式一：使用特殊字符比较数值 10 gt 5<br>            &lt;/#if&gt;<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dd</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dd</span>&gt;</span><br>            &lt;#-- 日期的比较需要通过?date将属性转为data类型才能进行比较 --&gt;<br>            &lt;#if (date1?date &gt;= date2?date)&gt;<br>                形式二：使用括号形式比较时间 date1?date &gt;= date2?date<br>            &lt;/#if&gt;<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dd</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dl</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">hr</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>Controller 的 数据模型代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;operation&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">testOperation</span><span class="hljs-params">(Model model)</span> &#123;<br>    <span class="hljs-comment">//构建 Date 数据</span><br>    <span class="hljs-type">Date</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>();<br>    model.addAttribute(<span class="hljs-string">&quot;date1&quot;</span>, now);<br>    model.addAttribute(<span class="hljs-string">&quot;date2&quot;</span>, now);<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;03-operation&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<p><strong>比较运算符注意</strong></p>
<ul>
<li>**<code>=</code><strong>和</strong><code>!=</code>**可以用于字符串、数值和日期来比较是否相等</li>
<li>**<code>=</code><strong>和</strong><code>!=</code>**两边必须是相同类型的值,否则会产生错误</li>
<li>字符串 <strong><code>&quot;x&quot;</code></strong> 、**<code>&quot;x &quot;</code>** 、**<code>&quot;X&quot;</code>**比较是不等的.因为FreeMarker是精确比较</li>
<li>其它的运行符可以作用于数字和日期,但不能作用于字符串</li>
<li>使用**<code>gt</code><strong>等字母运算符代替</strong><code>&gt;</code><strong>会有更好的效果,因为 FreeMarker会把</strong><code>&gt;</code>**解释成FTL标签的结束字符</li>
<li>可以使用括号来避免这种情况,如:<strong><code>&lt;#if (x&gt;y)&gt;</code></strong></li>
</ul>
<p><strong>3、逻辑运算符</strong></p>
<ul>
<li>逻辑与:&amp;&amp; </li>
<li>逻辑或:|| </li>
<li>逻辑非:! </li>
</ul>
<p>逻辑运算符只能作用于布尔值,否则将产生错误 。</p>
<p>模板代码</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">b</span>&gt;</span>逻辑运算符<span class="hljs-tag">&lt;/<span class="hljs-name">b</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><br>    &lt;#if (10 lt 12 )&amp;&amp;( 10  gt  5 )  &gt;<br>        (10 lt 12 )&amp;&amp;( 10  gt  5 )  显示为 true<br>    &lt;/#if&gt;<br>    <span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><br>    &lt;#if !false&gt;<br>        false 取反为true<br>    &lt;/#if&gt;<br><span class="hljs-tag">&lt;<span class="hljs-name">hr</span>&gt;</span><br></code></pre></td></tr></table></figure>



<h4 id="2-3-5-空值处理"><a href="#2-3-5-空值处理" class="headerlink" title="2.3.5) 空值处理"></a>2.3.5) 空值处理</h4><p><strong>1、判断某变量是否存在使用 “??”</strong></p>
<p>用法为:variable??,如果该变量存在,返回true,否则返回false </p>
<p>例：为防止stus为空报错可以加上判断如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs velocity">&lt;#if stus??&gt;<br>&lt;#list stus as stu&gt;<br>	......<br>&lt;/#list&gt;<br>&lt;/#if&gt;<br></code></pre></td></tr></table></figure>



<p><strong>2、缺失变量默认值使用 “!”</strong></p>
<ul>
<li><p>使用!要以指定一个默认值，当变量为空时显示默认值</p>
<p>  例：  ${name!’’}表示如果name为空显示空字符串。</p>
</li>
</ul>
<ul>
<li><p>如果是嵌套对象则建议使用（）括起来</p>
<p>  例： ${(stu.bestFriend.name)!’’}表示，如果stu或bestFriend或name为空默认显示空字符串。</p>
</li>
</ul>
<h4 id="2-3-6-内建函数"><a href="#2-3-6-内建函数" class="headerlink" title="2.3.6) 内建函数"></a>2.3.6) 内建函数</h4><p>内建函数语法格式： <strong><code>变量+?+函数名称</code></strong>  </p>
<p><strong>1、和到某个集合的大小</strong></p>
<p><strong><code>$&#123;集合名?size&#125;</code></strong></p>
<p><strong>2、日期格式化</strong></p>
<p>显示年月日: <strong><code>$&#123;today?date&#125;</code></strong><br>显示时分秒：**<code>$&#123;today?time&#125;</code>**<br>显示日期+时间：**<code>$&#123;today?datetime&#125;</code>**<br>自定义格式化：  <strong><code>$&#123;today?string(&quot;yyyy年MM月&quot;)&#125;</code></strong></p>
<p><strong>3、内建函数<code>c</code></strong></p>
<p>model.addAttribute(“point”, 102920122);</p>
<p>point是数字型，使用${point}会显示这个数字的值，每三位使用逗号分隔。</p>
<p>如果不想显示为每三位分隔的数字，可以使用c函数将数字型转成字符串输出</p>
<p><strong><code>$&#123;point?c&#125;</code></strong></p>
<p><strong>4、将json字符串转成对象</strong></p>
<p>一个例子：</p>
<p>其中用到了 assign标签，assign的作用是定义一个变量。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs velocity">&lt;#assign text=&quot;&#123;&#x27;bank&#x27;:&#x27;工商银行&#x27;,&#x27;account&#x27;:&#x27;10101920201920212&#x27;&#125;&quot; /&gt;<br>&lt;#assign data=text?eval /&gt;<br>开户行：$&#123;data.bank&#125;  账号：$&#123;data.account&#125;<br></code></pre></td></tr></table></figure>



<p>模板代码：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs HTML"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;utf-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>inner Function<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">b</span>&gt;</span>获得集合大小<span class="hljs-tag">&lt;/<span class="hljs-name">b</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br><br>    集合大小：<br>    <span class="hljs-tag">&lt;<span class="hljs-name">hr</span>&gt;</span><br><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">b</span>&gt;</span>获得日期<span class="hljs-tag">&lt;/<span class="hljs-name">b</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br><br>    显示年月日:      <span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br><br>    显示时分秒：<span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br><br>    显示日期+时间：<span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br><br>    自定义格式化：  <span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">hr</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">b</span>&gt;</span>内建函数C<span class="hljs-tag">&lt;/<span class="hljs-name">b</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br>    没有C函数显示的数值： <span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br><br>    有C函数显示的数值：<br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">hr</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">b</span>&gt;</span>声明变量assign<span class="hljs-tag">&lt;/<span class="hljs-name">b</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br><br><br><span class="hljs-tag">&lt;<span class="hljs-name">hr</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure>





<p>内建函数模板页面：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs velocity">&lt;!DOCTYPE html&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>    &lt;meta charset=&quot;utf-8&quot;&gt;<br>    &lt;title&gt;inner Function&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br><br>    &lt;b&gt;获得集合大小&lt;/b&gt;&lt;br&gt;<br><br>    集合大小：$&#123;stus?size&#125;<br>    &lt;hr&gt;<br><br><br>    &lt;b&gt;获得日期&lt;/b&gt;&lt;br&gt;<br><br>    显示年月日: $&#123;today?date&#125;       &lt;br&gt;<br><br>    显示时分秒：$&#123;today?time&#125;&lt;br&gt;<br><br>    显示日期+时间：$&#123;today?datetime&#125;&lt;br&gt;<br><br>    自定义格式化：  $&#123;today?string(&quot;yyyy年MM月&quot;)&#125;&lt;br&gt;<br><br>    &lt;hr&gt;<br><br>    &lt;b&gt;内建函数C&lt;/b&gt;&lt;br&gt;<br>    没有C函数显示的数值：$&#123;point&#125; &lt;br&gt;<br><br>    有C函数显示的数值：$&#123;point?c&#125;<br><br>    &lt;hr&gt;<br><br>    &lt;b&gt;声明变量assign&lt;/b&gt;&lt;br&gt;<br>    &lt;#assign text=&quot;&#123;&#x27;bank&#x27;:&#x27;工商银行&#x27;,&#x27;account&#x27;:&#x27;10101920201920212&#x27;&#125;&quot; /&gt;<br>    &lt;#assign data=text?eval /&gt;<br>    开户行：$&#123;data.bank&#125;  账号：$&#123;data.account&#125;<br><br>&lt;hr&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure>

<p>内建函数Controller数据模型：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;innerFunc&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">testInnerFunc</span><span class="hljs-params">(Model model)</span> &#123;<br>    <span class="hljs-comment">//1.1 小强对象模型数据</span><br>    <span class="hljs-type">Student</span> <span class="hljs-variable">stu1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>();<br>    stu1.setName(<span class="hljs-string">&quot;小强&quot;</span>);<br>    stu1.setAge(<span class="hljs-number">18</span>);<br>    stu1.setMoney(<span class="hljs-number">1000.86f</span>);<br>    stu1.setBirthday(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>    <span class="hljs-comment">//1.2 小红对象模型数据</span><br>    <span class="hljs-type">Student</span> <span class="hljs-variable">stu2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>();<br>    stu2.setName(<span class="hljs-string">&quot;小红&quot;</span>);<br>    stu2.setMoney(<span class="hljs-number">200.1f</span>);<br>    stu2.setAge(<span class="hljs-number">19</span>);<br>    <span class="hljs-comment">//1.3 将两个对象模型数据存放到List集合中</span><br>    List&lt;Student&gt; stus = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    stus.add(stu1);<br>    stus.add(stu2);<br>    model.addAttribute(<span class="hljs-string">&quot;stus&quot;</span>, stus);<br>    <span class="hljs-comment">// 2.1 添加日期</span><br>    <span class="hljs-type">Date</span> <span class="hljs-variable">date</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>();<br>    model.addAttribute(<span class="hljs-string">&quot;today&quot;</span>, date);<br>    <span class="hljs-comment">// 3.1 添加数值</span><br>    model.addAttribute(<span class="hljs-string">&quot;point&quot;</span>, <span class="hljs-number">102920122</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;04-innerFunc&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>







<h3 id="2-4-静态化测试"><a href="#2-4-静态化测试" class="headerlink" title="2.4) 静态化测试"></a>2.4) 静态化测试</h3><p>之前的测试都是SpringMVC将Freemarker作为视图解析器（ViewReporter）来集成到项目中，工作中，有的时候需要使用Freemarker原生Api来生成静态内容，下面一起来学习下原生Api生成文本文件。</p>
<h4 id="2-4-1-需求分析"><a href="#2-4-1-需求分析" class="headerlink" title="2.4.1) 需求分析"></a>2.4.1) 需求分析</h4><p>使用freemarker原生Api将页面生成html文件，本节测试html文件生成的方法：</p>
<p><img src="/../images/image-20210422163843108.png" srcset="/img/loading.gif" lazyload alt="image-20210422163843108"></p>
<h4 id="2-4-2-静态化测试"><a href="#2-4-2-静态化测试" class="headerlink" title="2.4.2) 静态化测试"></a>2.4.2) 静态化测试</h4><p>根据模板文件生成html文件</p>
<p>①：修改application.yml文件，添加以下模板存放位置的配置信息，完整配置如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8881</span> <span class="hljs-comment">#服务端口</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">freemarker-demo</span> <span class="hljs-comment">#指定服务名</span><br>  <span class="hljs-attr">freemarker:</span><br>    <span class="hljs-attr">cache:</span> <span class="hljs-literal">false</span>  <span class="hljs-comment">#关闭模板缓存，方便测试</span><br>    <span class="hljs-attr">settings:</span><br>      <span class="hljs-attr">template_update_delay:</span> <span class="hljs-number">0</span> <span class="hljs-comment">#检查模板更新延迟时间，设置为0表示立即检查，如果时间大于0会有缓存不方便进行模板测试</span><br>    <span class="hljs-attr">suffix:</span> <span class="hljs-string">.ftl</span>               <span class="hljs-comment">#指定Freemarker模板文件的后缀名</span><br>    <span class="hljs-attr">template-loader-path:</span> <span class="hljs-string">classpath:/templates</span>   <span class="hljs-comment">#模板存放位置</span><br></code></pre></td></tr></table></figure>

<p>②：在test下创建测试类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.freemarker.test;<br><br><br><span class="hljs-keyword">import</span> com.heima.freemarker.FreemarkerDemoApplication;<br><span class="hljs-keyword">import</span> com.heima.freemarker.entity.Student;<br><span class="hljs-keyword">import</span> freemarker.template.Configuration;<br><span class="hljs-keyword">import</span> freemarker.template.Template;<br><span class="hljs-keyword">import</span> freemarker.template.TemplateException;<br><span class="hljs-keyword">import</span> org.junit.Test;<br><span class="hljs-keyword">import</span> org.junit.runner.RunWith;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;<br><span class="hljs-keyword">import</span> org.springframework.test.context.junit4.SpringRunner;<br><br><span class="hljs-keyword">import</span> java.io.FileWriter;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.*;<br><br><span class="hljs-meta">@SpringBootTest(classes = FreemarkerDemoApplication.class)</span><br><span class="hljs-meta">@RunWith(SpringRunner.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FreemarkerTest</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> Configuration configuration;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException, TemplateException &#123;<br>        <span class="hljs-comment">//freemarker的模板对象，获取模板</span><br>        <span class="hljs-type">Template</span> <span class="hljs-variable">template</span> <span class="hljs-operator">=</span> configuration.getTemplate(<span class="hljs-string">&quot;02-list.ftl&quot;</span>);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">params</span> <span class="hljs-operator">=</span> getData();<br>        <span class="hljs-comment">//合成</span><br>        <span class="hljs-comment">//第一个参数 数据模型</span><br>        <span class="hljs-comment">//第二个参数  输出流</span><br>        template.process(params, <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileWriter</span>(<span class="hljs-string">&quot;d:/list.html&quot;</span>));<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> Map <span class="hljs-title function_">getData</span><span class="hljs-params">()</span> &#123;<br>        Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br><br>        <span class="hljs-comment">//小强对象模型数据</span><br>        <span class="hljs-type">Student</span> <span class="hljs-variable">stu1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>();<br>        stu1.setName(<span class="hljs-string">&quot;小强&quot;</span>);<br>        stu1.setAge(<span class="hljs-number">18</span>);<br>        stu1.setMoney(<span class="hljs-number">1000.86f</span>);<br>        stu1.setBirthday(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br><br>        <span class="hljs-comment">//小红对象模型数据</span><br>        <span class="hljs-type">Student</span> <span class="hljs-variable">stu2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>();<br>        stu2.setName(<span class="hljs-string">&quot;小红&quot;</span>);<br>        stu2.setMoney(<span class="hljs-number">200.1f</span>);<br>        stu2.setAge(<span class="hljs-number">19</span>);<br><br>        <span class="hljs-comment">//将两个对象模型数据存放到List集合中</span><br>        List&lt;Student&gt; stus = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        stus.add(stu1);<br>        stus.add(stu2);<br><br>        <span class="hljs-comment">//向map中存放List集合数据</span><br>        map.put(<span class="hljs-string">&quot;stus&quot;</span>, stus);<br><br><br>        <span class="hljs-comment">//创建Map数据</span><br>        HashMap&lt;String, Student&gt; stuMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        stuMap.put(<span class="hljs-string">&quot;stu1&quot;</span>, stu1);<br>        stuMap.put(<span class="hljs-string">&quot;stu2&quot;</span>, stu2);<br>        <span class="hljs-comment">//向map中存放Map数据</span><br>        map.put(<span class="hljs-string">&quot;stuMap&quot;</span>, stuMap);<br><br>        <span class="hljs-comment">//返回Map</span><br>        <span class="hljs-keyword">return</span> map;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="3-对象存储服务MinIO"><a href="#3-对象存储服务MinIO" class="headerlink" title="3) 对象存储服务MinIO"></a>3) 对象存储服务MinIO</h2><h3 id="3-1-MinIO简介"><a href="#3-1-MinIO简介" class="headerlink" title="3.1 MinIO简介"></a>3.1 MinIO简介</h3><p>MinIO基于Apache License v2.0开源协议的对象存储服务，可以做为云存储的解决方案用来保存海量的图片，视频，文档。由于采用Golang实现，服务端可以工作在Windows,Linux, OS X和FreeBSD上。配置简单，基本是复制可执行程序，单行命令可以运行起来。</p>
<p>MinIO兼容亚马逊S3云存储服务接口，非常适合于存储大容量非结构化的数据，例如图片、视频、日志文件、备份数据和容器/虚拟机镜像等，而一个对象文件可以是任意大小，从几kb到最大5T不等。</p>
<p><strong>S3 （ Simple Storage Service简单存储服务）</strong></p>
<p>基本概念</p>
<ul>
<li>bucket – 类比于文件系统的目录</li>
<li>Object – 类比文件系统的文件</li>
<li>Keys – 类比文件名</li>
</ul>
<p>官网文档：<a target="_blank" rel="noopener" href="http://docs.minio.org.cn/docs/">http://docs.minio.org.cn/docs/</a></p>
<h3 id="3-2-MinIO特点"><a href="#3-2-MinIO特点" class="headerlink" title="3.2 MinIO特点"></a>3.2 MinIO特点</h3><ul>
<li><p>数据保护</p>
<p>  Minio使用Minio Erasure Code（纠删码）来防止硬件故障。即便损坏一半以上的driver，但是仍然可以从中恢复。</p>
</li>
<li><p>高性能</p>
<p>  作为高性能对象存储，在标准硬件条件下它能达到55GB/s的读、35GB/s的写速率</p>
</li>
<li><p>可扩容</p>
<p>  不同MinIO集群可以组成联邦，并形成一个全局的命名空间，并跨越多个数据中心</p>
</li>
<li><p>SDK支持</p>
<p>  基于Minio轻量的特点，它得到类似Java、Python或Go等语言的sdk支持</p>
</li>
<li><p>有操作页面</p>
<p>  面向用户友好的简单操作界面，非常方便的管理Bucket及里面的文件资源</p>
</li>
<li><p>功能简单</p>
<p>  这一设计原则让MinIO不容易出错、更快启动</p>
</li>
<li><p>丰富的API</p>
<p>  支持文件资源的分享连接及分享链接的过期策略、存储桶操作、文件列表访问及文件上传下载的基本功能等。</p>
</li>
<li><p>文件变化主动通知</p>
<p>  存储桶（Bucket）如果发生改变,比如上传对象和删除对象，可以使用存储桶事件通知机制进行监控，并通过以下方式发布出去:AMQP、MQTT、Elasticsearch、Redis、NATS、MySQL、Kafka、Webhooks等。</p>
</li>
</ul>
<h3 id="3-3-开箱使用"><a href="#3-3-开箱使用" class="headerlink" title="3.3 开箱使用"></a>3.3 开箱使用</h3><h4 id="3-3-1-安装启动"><a href="#3-3-1-安装启动" class="headerlink" title="3.3.1 安装启动"></a>3.3.1 安装启动</h4><p>我们提供的镜像中已经有minio的环境</p>
<p>我们可以使用docker进行环境部署和启动</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">docker</span> <span class="hljs-string">run</span> <span class="hljs-string">-p</span> <span class="hljs-number">9000</span><span class="hljs-string">:9000</span> <span class="hljs-string">--name</span> <span class="hljs-string">minio</span> <span class="hljs-string">-d</span> <span class="hljs-string">--restart=always</span> <span class="hljs-string">-e</span> <span class="hljs-string">&quot;MINIO_ACCESS_KEY=minio&quot;</span> <span class="hljs-string">-e</span> <span class="hljs-string">&quot;MINIO_SECRET_KEY=minio123&quot;</span> <span class="hljs-string">-v</span> <span class="hljs-string">/home/data:/data</span> <span class="hljs-string">-v</span> <span class="hljs-string">/home/config:/root/.minio</span> <span class="hljs-string">minio/minio</span> <span class="hljs-string">server</span> <span class="hljs-string">/data</span><br></code></pre></td></tr></table></figure>

<h4 id="3-3-2-管理控制台"><a href="#3-3-2-管理控制台" class="headerlink" title="3.3.2 管理控制台"></a>3.3.2 管理控制台</h4><p>假设我们的服务器地址为<a href="http://192.168.200.130:9000，我们在地址栏输入：http://http://192.168.200.130:9000/">http://192.168.200.130:9000，我们在地址栏输入：http://http://192.168.200.130:9000/</a> 即可进入登录界面。</p>
<p><img src="/../images/image-20210417102204739.png" srcset="/img/loading.gif" lazyload alt="image-20210417102204739"></p>
<p>Access Key为minio   Secret_key 为minio123    进入系统后可以看到主界面</p>
<p><img src="/../images/image-20210417102356582.png" srcset="/img/loading.gif" lazyload alt="image-20210417102356582"></p>
<p>点击右下角的“+”号 ，点击下面的图标，创建一个桶</p>
<p><img src="/../images/image-20210417102435088.png" srcset="/img/loading.gif" lazyload alt="image-20210417102435088"></p>
<h3 id="3-4-快速入门"><a href="#3-4-快速入门" class="headerlink" title="3.4 快速入门"></a>3.4 快速入门</h3><h4 id="3-4-1-创建工程，导入pom依赖"><a href="#3-4-1-创建工程，导入pom依赖" class="headerlink" title="3.4.1 创建工程，导入pom依赖"></a>3.4.1 创建工程，导入pom依赖</h4><p>创建minio-demo,对应pom如下</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>heima-leadnews-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.heima<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>minio-demo<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.source</span>&gt;</span>8<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.source</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.target</span>&gt;</span>8<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.target</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.minio<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>minio<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>7.1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>引导类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.minio;<br><br><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br><br><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MinIOApplication</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(MinIOApplication.class,args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>创建测试类，上传html文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.minio.test;<br><br><span class="hljs-keyword">import</span> io.minio.MinioClient;<br><span class="hljs-keyword">import</span> io.minio.PutObjectArgs;<br><br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MinIOTest</span> &#123;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br><br>        <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fileInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br><br>            fileInputStream =  <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;D:\\list.html&quot;</span>);;<br><br>            <span class="hljs-comment">//1.创建minio链接客户端</span><br>            <span class="hljs-type">MinioClient</span> <span class="hljs-variable">minioClient</span> <span class="hljs-operator">=</span> MinioClient.builder().credentials(<span class="hljs-string">&quot;minio&quot;</span>, <span class="hljs-string">&quot;minio123&quot;</span>).endpoint(<span class="hljs-string">&quot;http://192.168.200.130:9000&quot;</span>).build();<br>            <span class="hljs-comment">//2.上传</span><br>            <span class="hljs-type">PutObjectArgs</span> <span class="hljs-variable">putObjectArgs</span> <span class="hljs-operator">=</span> PutObjectArgs.builder()<br>                    .object(<span class="hljs-string">&quot;list.html&quot;</span>)<span class="hljs-comment">//文件名</span><br>                    .contentType(<span class="hljs-string">&quot;text/html&quot;</span>)<span class="hljs-comment">//文件类型</span><br>                    .bucket(<span class="hljs-string">&quot;leadnews&quot;</span>)<span class="hljs-comment">//桶名词  与minio创建的名词一致</span><br>                    .stream(fileInputStream, fileInputStream.available(), -<span class="hljs-number">1</span>) <span class="hljs-comment">//文件流</span><br>                    .build();<br>            minioClient.putObject(putObjectArgs);<br><br>            System.out.println(<span class="hljs-string">&quot;http://192.168.200.130:9000/leadnews/ak47.jpg&quot;</span>);<br><br>        &#125; <span class="hljs-keyword">catch</span> (Exception ex) &#123;<br>            ex.printStackTrace();<br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="3-5-封装MinIO为starter"><a href="#3-5-封装MinIO为starter" class="headerlink" title="3.5 封装MinIO为starter"></a>3.5 封装MinIO为starter</h3><h4 id="3-5-1-创建模块heima-file-starter"><a href="#3-5-1-创建模块heima-file-starter" class="headerlink" title="3.5.1 创建模块heima-file-starter"></a>3.5.1 创建模块heima-file-starter</h4><p>导入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-autoconfigure<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.minio<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>minio<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>7.1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h4 id="3-5-2-配置类"><a href="#3-5-2-配置类" class="headerlink" title="3.5.2 配置类"></a>3.5.2 配置类</h4><p>MinIOConfigProperties</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.file.config;<br><br><br><span class="hljs-keyword">import</span> lombok.Data;<br><span class="hljs-keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@ConfigurationProperties(prefix = &quot;minio&quot;)</span>  <span class="hljs-comment">// 文件上传 配置前缀file.oss</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MinIOConfigProperties</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-keyword">private</span> String accessKey;<br>    <span class="hljs-keyword">private</span> String secretKey;<br>    <span class="hljs-keyword">private</span> String bucket;<br>    <span class="hljs-keyword">private</span> String endpoint;<br>    <span class="hljs-keyword">private</span> String readPath;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>MinIOConfig</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.file.config;<br><br><span class="hljs-keyword">import</span> com.heima.file.service.FileStorageService;<br><span class="hljs-keyword">import</span> io.minio.MinioClient;<br><span class="hljs-keyword">import</span> lombok.Data;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnClass;<br><span class="hljs-keyword">import</span> org.springframework.boot.context.properties.EnableConfigurationProperties;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><br><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableConfigurationProperties(&#123;MinIOConfigProperties.class&#125;)</span><br><span class="hljs-comment">//当引入FileStorageService接口时</span><br><span class="hljs-meta">@ConditionalOnClass(FileStorageService.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MinIOConfig</span> &#123;<br><br>   <span class="hljs-meta">@Autowired</span><br>   <span class="hljs-keyword">private</span> MinIOConfigProperties minIOConfigProperties;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> MinioClient <span class="hljs-title function_">buildMinioClient</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> MinioClient<br>                .builder()<br>                .credentials(minIOConfigProperties.getAccessKey(), minIOConfigProperties.getSecretKey())<br>                .endpoint(minIOConfigProperties.getEndpoint())<br>                .build();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="3-5-3-封装操作minIO类"><a href="#3-5-3-封装操作minIO类" class="headerlink" title="3.5.3 封装操作minIO类"></a>3.5.3 封装操作minIO类</h4><p>FileStorageService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.file.service;<br><br><span class="hljs-keyword">import</span> java.io.InputStream;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> itheima</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">FileStorageService</span> &#123;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     *  上传图片文件</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> prefix  文件前缀</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> filename  文件名</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> inputStream 文件流</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span>  文件全路径</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">uploadImgFile</span><span class="hljs-params">(String prefix, String filename,InputStream inputStream)</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     *  上传html文件</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> prefix  文件前缀</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> filename   文件名</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> inputStream  文件流</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span>  文件全路径</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">uploadHtmlFile</span><span class="hljs-params">(String prefix, String filename,InputStream inputStream)</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 删除文件</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> pathUrl  文件全路径</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">delete</span><span class="hljs-params">(String pathUrl)</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 下载文件</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> pathUrl  文件全路径</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[]  downLoadFile(String pathUrl);<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>MinIOFileStorageService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.file.service.impl;<br><br><br><span class="hljs-keyword">import</span> com.heima.file.config.MinIOConfig;<br><span class="hljs-keyword">import</span> com.heima.file.config.MinIOConfigProperties;<br><span class="hljs-keyword">import</span> com.heima.file.service.FileStorageService;<br><span class="hljs-keyword">import</span> io.minio.GetObjectArgs;<br><span class="hljs-keyword">import</span> io.minio.MinioClient;<br><span class="hljs-keyword">import</span> io.minio.PutObjectArgs;<br><span class="hljs-keyword">import</span> io.minio.RemoveObjectArgs;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.boot.context.properties.EnableConfigurationProperties;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Import;<br><span class="hljs-keyword">import</span> org.springframework.util.StringUtils;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.InputStream;<br><span class="hljs-keyword">import</span> java.text.SimpleDateFormat;<br><span class="hljs-keyword">import</span> java.util.Date;<br><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@EnableConfigurationProperties(MinIOConfigProperties.class)</span><br><span class="hljs-meta">@Import(MinIOConfig.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MinIOFileStorageService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">FileStorageService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> MinioClient minioClient;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> MinIOConfigProperties minIOConfigProperties;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">separator</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;/&quot;</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> dirPath</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> filename  yyyy/mm/dd/file.jpg</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">builderFilePath</span><span class="hljs-params">(String dirPath,String filename)</span> &#123;<br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">stringBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-number">50</span>);<br>        <span class="hljs-keyword">if</span>(!StringUtils.isEmpty(dirPath))&#123;<br>            stringBuilder.append(dirPath).append(separator);<br>        &#125;<br>        <span class="hljs-type">SimpleDateFormat</span> <span class="hljs-variable">sdf</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleDateFormat</span>(<span class="hljs-string">&quot;yyyy/MM/dd&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">todayStr</span> <span class="hljs-operator">=</span> sdf.format(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>        stringBuilder.append(todayStr).append(separator);<br>        stringBuilder.append(filename);<br>        <span class="hljs-keyword">return</span> stringBuilder.toString();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     *  上传图片文件</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> prefix  文件前缀</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> filename  文件名</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> inputStream 文件流</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span>  文件全路径</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">uploadImgFile</span><span class="hljs-params">(String prefix, String filename,InputStream inputStream)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">filePath</span> <span class="hljs-operator">=</span> builderFilePath(prefix, filename);<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">PutObjectArgs</span> <span class="hljs-variable">putObjectArgs</span> <span class="hljs-operator">=</span> PutObjectArgs.builder()<br>                    .object(filePath)<br>                    .contentType(<span class="hljs-string">&quot;image/jpg&quot;</span>)<br>                    .bucket(minIOConfigProperties.getBucket()).stream(inputStream,inputStream.available(),-<span class="hljs-number">1</span>)<br>                    .build();<br>            minioClient.putObject(putObjectArgs);<br>            <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">urlPath</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(minIOConfigProperties.getReadPath());<br>            urlPath.append(separator+minIOConfigProperties.getBucket());<br>            urlPath.append(separator);<br>            urlPath.append(filePath);<br>            <span class="hljs-keyword">return</span> urlPath.toString();<br>        &#125;<span class="hljs-keyword">catch</span> (Exception ex)&#123;<br>            log.error(<span class="hljs-string">&quot;minio put file error.&quot;</span>,ex);<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;上传文件失败&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     *  上传html文件</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> prefix  文件前缀</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> filename   文件名</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> inputStream  文件流</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span>  文件全路径</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">uploadHtmlFile</span><span class="hljs-params">(String prefix, String filename,InputStream inputStream)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">filePath</span> <span class="hljs-operator">=</span> builderFilePath(prefix, filename);<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">PutObjectArgs</span> <span class="hljs-variable">putObjectArgs</span> <span class="hljs-operator">=</span> PutObjectArgs.builder()<br>                    .object(filePath)<br>                    .contentType(<span class="hljs-string">&quot;text/html&quot;</span>)<br>                    .bucket(minIOConfigProperties.getBucket()).stream(inputStream,inputStream.available(),-<span class="hljs-number">1</span>)<br>                    .build();<br>            minioClient.putObject(putObjectArgs);<br>            <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">urlPath</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(minIOConfigProperties.getReadPath());<br>            urlPath.append(separator+minIOConfigProperties.getBucket());<br>            urlPath.append(separator);<br>            urlPath.append(filePath);<br>            <span class="hljs-keyword">return</span> urlPath.toString();<br>        &#125;<span class="hljs-keyword">catch</span> (Exception ex)&#123;<br>            log.error(<span class="hljs-string">&quot;minio put file error.&quot;</span>,ex);<br>            ex.printStackTrace();<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;上传文件失败&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 删除文件</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> pathUrl  文件全路径</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">delete</span><span class="hljs-params">(String pathUrl)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> pathUrl.replace(minIOConfigProperties.getEndpoint()+<span class="hljs-string">&quot;/&quot;</span>,<span class="hljs-string">&quot;&quot;</span>);<br>        <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> key.indexOf(separator);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">bucket</span> <span class="hljs-operator">=</span> key.substring(<span class="hljs-number">0</span>,index);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">filePath</span> <span class="hljs-operator">=</span> key.substring(index+<span class="hljs-number">1</span>);<br>        <span class="hljs-comment">// 删除Objects</span><br>        <span class="hljs-type">RemoveObjectArgs</span> <span class="hljs-variable">removeObjectArgs</span> <span class="hljs-operator">=</span> RemoveObjectArgs.builder().bucket(bucket).object(filePath).build();<br>        <span class="hljs-keyword">try</span> &#123;<br>            minioClient.removeObject(removeObjectArgs);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            log.error(<span class="hljs-string">&quot;minio remove file error.  pathUrl:&#123;&#125;&quot;</span>,pathUrl);<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 下载文件</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> pathUrl  文件全路径</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span>  文件流</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] downLoadFile(String pathUrl)  &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> pathUrl.replace(minIOConfigProperties.getEndpoint()+<span class="hljs-string">&quot;/&quot;</span>,<span class="hljs-string">&quot;&quot;</span>);<br>        <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> key.indexOf(separator);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">bucket</span> <span class="hljs-operator">=</span> key.substring(<span class="hljs-number">0</span>,index);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">filePath</span> <span class="hljs-operator">=</span> key.substring(index+<span class="hljs-number">1</span>);<br>        <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            inputStream = minioClient.getObject(GetObjectArgs.builder().bucket(minIOConfigProperties.getBucket()).object(filePath).build());<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            log.error(<span class="hljs-string">&quot;minio down file error.  pathUrl:&#123;&#125;&quot;</span>,pathUrl);<br>            e.printStackTrace();<br>        &#125;<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">byteArrayOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">byte</span>[] buff = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">100</span>];<br>        <span class="hljs-type">int</span> <span class="hljs-variable">rc</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">if</span> (!((rc = inputStream.read(buff, <span class="hljs-number">0</span>, <span class="hljs-number">100</span>)) &gt; <span class="hljs-number">0</span>)) <span class="hljs-keyword">break</span>;<br>            &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>            byteArrayOutputStream.write(buff, <span class="hljs-number">0</span>, rc);<br>        &#125;<br>        <span class="hljs-keyword">return</span> byteArrayOutputStream.toByteArray();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="3-5-4-对外加入自动配置"><a href="#3-5-4-对外加入自动配置" class="headerlink" title="3.5.4 对外加入自动配置"></a>3.5.4 对外加入自动配置</h4><p>在resources中新建<code>META-INF/spring.factories</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">org.springframework.boot.autoconfigure.EnableAutoConfiguration=\<br>  com.heima.file.service.impl.MinIOFileStorageService<br></code></pre></td></tr></table></figure>



<h4 id="3-5-5-其他微服务使用"><a href="#3-5-5-其他微服务使用" class="headerlink" title="3.5.5 其他微服务使用"></a>3.5.5 其他微服务使用</h4><p>第一，导入heima-file-starter的依赖</p>
<p>第二，在微服务中添加minio所需要的配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">minio:</span><br>  <span class="hljs-attr">accessKey:</span> <span class="hljs-string">minio</span><br>  <span class="hljs-attr">secretKey:</span> <span class="hljs-string">minio123</span><br>  <span class="hljs-attr">bucket:</span> <span class="hljs-string">leadnews</span><br>  <span class="hljs-attr">endpoint:</span> <span class="hljs-string">http://192.168.200.130:9000</span><br>  <span class="hljs-attr">readPath:</span> <span class="hljs-string">http://192.168.200.130:9000</span><br></code></pre></td></tr></table></figure>

<p>第三，在对应使用的业务类中注入FileStorageService，样例如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.minio.test;<br><br><br><span class="hljs-keyword">import</span> com.heima.file.service.FileStorageService;<br><span class="hljs-keyword">import</span> com.heima.minio.MinioApplication;<br><span class="hljs-keyword">import</span> org.junit.Test;<br><span class="hljs-keyword">import</span> org.junit.runner.RunWith;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;<br><span class="hljs-keyword">import</span> org.springframework.test.context.junit4.SpringRunner;<br><br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.FileNotFoundException;<br><br><span class="hljs-meta">@SpringBootTest(classes = MinioApplication.class)</span><br><span class="hljs-meta">@RunWith(SpringRunner.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MinioTest</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> FileStorageService fileStorageService;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testUpdateImgFile</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fileInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;E:\\tmp\\ak47.jpg&quot;</span>);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">filePath</span> <span class="hljs-operator">=</span> fileStorageService.uploadImgFile(<span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;ak47.jpg&quot;</span>, fileInputStream);<br>            System.out.println(filePath);<br>        &#125; <span class="hljs-keyword">catch</span> (FileNotFoundException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="4-文章详情"><a href="#4-文章详情" class="headerlink" title="4)文章详情"></a>4)文章详情</h2><h3 id="4-1-需求分析"><a href="#4-1-需求分析" class="headerlink" title="4.1)需求分析"></a>4.1)需求分析</h3><p><img src="/../images/image-20210602180753705.png" srcset="/img/loading.gif" lazyload alt="image-20210602180753705"></p>
<h3 id="4-2-实现方案"><a href="#4-2-实现方案" class="headerlink" title="4.2)实现方案"></a>4.2)实现方案</h3><p>方案一</p>
<p>用户某一条文章，根据文章的id去查询文章内容表，返回渲染页面</p>
<p><img src="/../images/image-20210602180824202.png" srcset="/img/loading.gif" lazyload alt="image-20210602180824202"></p>
<p>方案二</p>
<p><img src="/../images/image-20210602180856833.png" srcset="/img/loading.gif" lazyload alt="image-20210602180856833"></p>
<h3 id="4-3-实现步骤"><a href="#4-3-实现步骤" class="headerlink" title="4.3)实现步骤"></a>4.3)实现步骤</h3><p>1.在artile微服务中添加MinIO和freemarker的支持，参考测试项目</p>
<p>2.资料中找到模板文件（article.ftl）拷贝到article微服务下</p>
<p><img src="/../images/image-20210602180931839.png" srcset="/img/loading.gif" lazyload alt="image-20210602180931839"></p>
<p>3.资料中找到index.js和index.css两个文件手动上传到MinIO中</p>
<p><img src="/../images/image-20210602180957787.png" srcset="/img/loading.gif" lazyload alt="image-20210602180957787"></p>
<p>4.在文章微服务中导入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-freemarker<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.heima<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>heima-file-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>5.新建ApArticleContentMapper</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.article.mapper;<br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.mapper.BaseMapper;<br><span class="hljs-keyword">import</span> com.heima.model.article.pojos.ApArticleContent;<br><span class="hljs-keyword">import</span> org.apache.ibatis.annotations.Mapper;<br><br><span class="hljs-meta">@Mapper</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ApArticleContentMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseMapper</span>&lt;ApArticleContent&gt; &#123;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>6.在artile微服务中新增测试类（后期新增文章的时候创建详情静态页，目前暂时手动生成）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.article.test;<br><br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSONArray;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.toolkit.Wrappers;<br><span class="hljs-keyword">import</span> com.heima.article.ArticleApplication;<br><span class="hljs-keyword">import</span> com.heima.article.mapper.ApArticleContentMapper;<br><span class="hljs-keyword">import</span> com.heima.article.mapper.ApArticleMapper;<br><span class="hljs-keyword">import</span> com.heima.file.service.FileStorageService;<br><span class="hljs-keyword">import</span> com.heima.model.article.pojos.ApArticle;<br><span class="hljs-keyword">import</span> com.heima.model.article.pojos.ApArticleContent;<br><span class="hljs-keyword">import</span> freemarker.template.Configuration;<br><span class="hljs-keyword">import</span> freemarker.template.Template;<br><span class="hljs-keyword">import</span> org.apache.commons.lang3.StringUtils;<br><span class="hljs-keyword">import</span> org.junit.Test;<br><span class="hljs-keyword">import</span> org.junit.runner.RunWith;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;<br><span class="hljs-keyword">import</span> org.springframework.test.context.junit4.SpringRunner;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.InputStream;<br><span class="hljs-keyword">import</span> java.io.StringWriter;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-meta">@SpringBootTest(classes = ArticleApplication.class)</span><br><span class="hljs-meta">@RunWith(SpringRunner.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArticleFreemarkerTest</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> Configuration configuration;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> FileStorageService fileStorageService;<br><br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ApArticleMapper apArticleMapper;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ApArticleContentMapper apArticleContentMapper;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createStaticUrlTest</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//1.获取文章内容</span><br>        <span class="hljs-type">ApArticleContent</span> <span class="hljs-variable">apArticleContent</span> <span class="hljs-operator">=</span> apArticleContentMapper.selectOne(Wrappers.&lt;ApArticleContent&gt;lambdaQuery().eq(ApArticleContent::getArticleId, <span class="hljs-number">1390536764510310401L</span>));<br>        <span class="hljs-keyword">if</span>(apArticleContent != <span class="hljs-literal">null</span> &amp;&amp; StringUtils.isNotBlank(apArticleContent.getContent()))&#123;<br>            <span class="hljs-comment">//2.文章内容通过freemarker生成html文件</span><br>            <span class="hljs-type">StringWriter</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringWriter</span>();<br>            <span class="hljs-type">Template</span> <span class="hljs-variable">template</span> <span class="hljs-operator">=</span> configuration.getTemplate(<span class="hljs-string">&quot;article.ftl&quot;</span>);<br><br>            Map&lt;String, Object&gt; params = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>            params.put(<span class="hljs-string">&quot;content&quot;</span>, JSONArray.parseArray(apArticleContent.getContent()));<br><br>            template.process(params, out);<br>            <span class="hljs-type">InputStream</span> <span class="hljs-variable">is</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(out.toString().getBytes());<br><br>            <span class="hljs-comment">//3.把html文件上传到minio中</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> fileStorageService.uploadHtmlFile(<span class="hljs-string">&quot;&quot;</span>, apArticleContent.getArticleId() + <span class="hljs-string">&quot;.html&quot;</span>, is);<br><br>            <span class="hljs-comment">//4.修改ap_article表，保存static_url字段</span><br>            <span class="hljs-type">ApArticle</span> <span class="hljs-variable">article</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApArticle</span>();<br>            article.setId(apArticleContent.getArticleId());<br>            article.setStaticUrl(path);<br>            apArticleMapper.updateById(article);<br><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h1 id="3-自媒体文章发布"><a href="#3-自媒体文章发布" class="headerlink" title="3 自媒体文章发布"></a>3 自媒体文章发布</h1><h3 id="1-自媒体前后端搭建"><a href="#1-自媒体前后端搭建" class="headerlink" title="1)自媒体前后端搭建"></a>1)自媒体前后端搭建</h3><h4 id="1-1-后台搭建"><a href="#1-1-后台搭建" class="headerlink" title="1.1)后台搭建"></a>1.1)后台搭建</h4><p><img src="/../images/image-20210426110728659.png" srcset="/img/loading.gif" lazyload alt="image-20210426110728659"></p>
<p>①：资料中找到heima-leadnews-wemedia.zip解压</p>
<p> 拷贝到heima-leadnews-service工程下，并指定子模块</p>
<p> 执行leadnews-wemedia.sql脚本</p>
<p> 添加对应的nacos配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">datasource:</span><br>    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.jdbc.Driver</span><br>    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/leadnews_wemedia?useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=UTC</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">root</span><br><span class="hljs-comment"># 设置Mapper接口所对应的XML文件位置，如果你在Mapper接口中有自定义方法，需要进行该配置</span><br><span class="hljs-attr">mybatis-plus:</span><br>  <span class="hljs-attr">mapper-locations:</span> <span class="hljs-string">classpath*:mapper/*.xml</span><br>  <span class="hljs-comment"># 设置别名包扫描路径，通过该属性可以给包中的类注册别名</span><br>  <span class="hljs-attr">type-aliases-package:</span> <span class="hljs-string">com.heima.model.media.pojos</span><br></code></pre></td></tr></table></figure>



<p>②：资料中找到heima-leadnews-wemedia-gateway.zip解压</p>
<p> 拷贝到heima-leadnews-gateway工程下，并指定子模块</p>
<p> 添加对应的nacos配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">gateway:</span><br>      <span class="hljs-attr">globalcors:</span><br>        <span class="hljs-attr">cors-configurations:</span><br>          <span class="hljs-string">&#x27;[/**]&#x27;</span><span class="hljs-string">:</span> <span class="hljs-comment"># 匹配所有请求</span><br>            <span class="hljs-attr">allowedOrigins:</span> <span class="hljs-string">&quot;*&quot;</span> <span class="hljs-comment">#跨域处理 允许所有的域</span><br>            <span class="hljs-attr">allowedMethods:</span> <span class="hljs-comment"># 支持的方法</span><br>              <span class="hljs-bullet">-</span> <span class="hljs-string">GET</span><br>              <span class="hljs-bullet">-</span> <span class="hljs-string">POST</span><br>              <span class="hljs-bullet">-</span> <span class="hljs-string">PUT</span><br>              <span class="hljs-bullet">-</span> <span class="hljs-string">DELETE</span><br>      <span class="hljs-attr">routes:</span><br>        <span class="hljs-comment"># 平台管理</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">wemedia</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://leadnews-wemedia</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/wemedia/**</span><br>          <span class="hljs-attr">filters:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">StripPrefix=</span> <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure>



<p>③：在资料中找到类文件夹</p>
<p> 拷贝wemedia文件夹到heima-leadnews-model模块下的com.heima.model</p>
<h4 id="1-2-前台搭建"><a href="#1-2-前台搭建" class="headerlink" title="1.2)前台搭建"></a>1.2)前台搭建</h4><p><img src="/../images/image-20210426110913007.png" srcset="/img/loading.gif" lazyload alt="image-20210426110913007"></p>
<p>通过nginx的虚拟主机功能，使用同一个nginx访问多个项目</p>
<p>搭建步骤：</p>
<p>①：资料中找到wemedia-web.zip解压</p>
<p>②：在nginx中leadnews.conf目录中新增heima-leadnews-wemedia.conf文件</p>
<ul>
<li><p>网关地址修改（localhost:51602）</p>
</li>
<li><p>前端项目目录修改（wemedia-web解压的目录）</p>
</li>
<li><p>访问端口修改(8802)</p>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs javascript">upstream  heima-wemedia-gateway&#123;<br>    server <span class="hljs-attr">localhost</span>:<span class="hljs-number">51602</span>;<br>&#125;<br><br>server &#123;<br>	listen <span class="hljs-number">8802</span>;<br>	location / &#123;<br>		root <span class="hljs-attr">D</span>:<span class="hljs-regexp">/workspace/</span>wemedia-web/;<br>		index index.<span class="hljs-property">html</span>;<br>	&#125;<br>	<br>	location ~<span class="hljs-regexp">/wemedia/</span><span class="hljs-variable constant_">MEDIA</span>/(.*) &#123;<br>		proxy_pass <span class="hljs-attr">http</span>:<span class="hljs-comment">//heima-wemedia-gateway/$1;</span><br>		proxy_set_header <span class="hljs-variable constant_">HOST</span> $host;  # 不改变源请求头的值<br>		proxy_pass_request_body on;  #开启获取请求体<br>		proxy_pass_request_headers on;  #开启获取请求头<br>		proxy_set_header X-<span class="hljs-title class_">Real</span>-<span class="hljs-variable constant_">IP</span> $remote_addr;   # 记录真实发出请求的客户端<span class="hljs-variable constant_">IP</span><br>		proxy_set_header X-<span class="hljs-title class_">Forwarded</span>-<span class="hljs-title class_">For</span> $proxy_add_x_forwarded_for;  #记录代理信息<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>③：启动nginx，启动自媒体微服务和对应网关</p>
<p>④：联调测试登录功能</p>
<p><img src="/../images/image-20210426111329136.png" srcset="/img/loading.gif" lazyload alt="image-20210426111329136"></p>
<h3 id="2-自媒体素材管理"><a href="#2-自媒体素材管理" class="headerlink" title="2)自媒体素材管理"></a>2)自媒体素材管理</h3><h4 id="2-1-素材上传"><a href="#2-1-素材上传" class="headerlink" title="2.1)素材上传"></a>2.1)素材上传</h4><h5 id="2-2-1-需求分析"><a href="#2-2-1-需求分析" class="headerlink" title="2.2.1)需求分析"></a>2.2.1)需求分析</h5><p><img src="/../images/image-20210426144327206.png" srcset="/img/loading.gif" lazyload alt="image-20210426144327206"></p>
<p>图片上传的页面，首先是展示素材信息，可以点击图片上传，弹窗后可以上传图片</p>
<h5 id="2-2-2-素材管理-图片上传-表结构"><a href="#2-2-2-素材管理-图片上传-表结构" class="headerlink" title="2.2.2)素材管理-图片上传-表结构"></a>2.2.2)素材管理-图片上传-表结构</h5><p>媒体图文素材信息表wm_material</p>
<p><img src="/../images/image-20210426144500239.png" srcset="/img/loading.gif" lazyload alt="image-20210426144500239"></p>
<p>对应实体类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.model.wemedia.pojos;<br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.IdType;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.TableField;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.TableId;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.TableName;<br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><span class="hljs-keyword">import</span> java.util.Date;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * &lt;p&gt;</span><br><span class="hljs-comment"> * 自媒体图文素材信息表</span><br><span class="hljs-comment"> * &lt;/p&gt;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> itheima</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@TableName(&quot;wm_material&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WmMaterial</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 主键</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableId(value = &quot;id&quot;, type = IdType.AUTO)</span><br>    <span class="hljs-keyword">private</span> Integer id;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 自媒体用户ID</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;user_id&quot;)</span><br>    <span class="hljs-keyword">private</span> Integer userId;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 图片地址</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;url&quot;)</span><br>    <span class="hljs-keyword">private</span> String url;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 素材类型</span><br><span class="hljs-comment">            0 图片</span><br><span class="hljs-comment">            1 视频</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;type&quot;)</span><br>    <span class="hljs-keyword">private</span> Short type;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 是否收藏</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;is_collection&quot;)</span><br>    <span class="hljs-keyword">private</span> Short isCollection;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 创建时间</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;created_time&quot;)</span><br>    <span class="hljs-keyword">private</span> Date createdTime;<br><br>&#125;<br></code></pre></td></tr></table></figure>



<h5 id="2-2-3-实现思路"><a href="#2-2-3-实现思路" class="headerlink" title="2.2.3)实现思路"></a>2.2.3)实现思路</h5><p><img src="/../images/image-20210426144603541.png" srcset="/img/loading.gif" lazyload alt="image-20210426144603541"></p>
<p>①：前端发送上传图片请求，类型为MultipartFile</p>
<p>②：网关进行token解析后，把解析后的用户信息存储到header中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//获得token解析后中的用户信息</span><br><span class="hljs-type">Object</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> claimsBody.get(<span class="hljs-string">&quot;id&quot;</span>);<br><span class="hljs-comment">//在header中添加新的信息</span><br><span class="hljs-type">ServerHttpRequest</span> <span class="hljs-variable">serverHttpRequest</span> <span class="hljs-operator">=</span> request.mutate().headers(httpHeaders -&gt; &#123;<br>    httpHeaders.add(<span class="hljs-string">&quot;userId&quot;</span>, userId + <span class="hljs-string">&quot;&quot;</span>);<br>&#125;).build();<br><span class="hljs-comment">//重置header</span><br>exchange.mutate().request(serverHttpRequest).build();<br></code></pre></td></tr></table></figure>

<p>③：自媒体微服务使用拦截器获取到header中的的用户信息，并放入到threadlocal中</p>
<p>在heima-leadnews-utils中新增工具类</p>
<p>注意：需要从资料中找出WmUser实体类拷贝到model工程下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.utils.thread;<br><br><span class="hljs-keyword">import</span> com.heima.model.wemedia.pojos.WmUser;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WmThreadLocalUtil</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> ThreadLocal&lt;WmUser&gt; WM_USER_THREAD_LOCAL = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 添加用户</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> wmUser</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span>  <span class="hljs-title function_">setUser</span><span class="hljs-params">(WmUser wmUser)</span>&#123;<br>        WM_USER_THREAD_LOCAL.set(wmUser);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取用户</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> WmUser <span class="hljs-title function_">getUser</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> WM_USER_THREAD_LOCAL.get();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 清理用户</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clear</span><span class="hljs-params">()</span>&#123;<br>        WM_USER_THREAD_LOCAL.remove();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在heima-leadnews-wemedia中新增拦截器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.wemedia.interceptor;<br><br><span class="hljs-keyword">import</span> com.heima.model.wemedia.pojos.WmUser;<br><span class="hljs-keyword">import</span> com.heima.utils.thread.WmThreadLocalUtils;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.ModelAndView;<br><br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> java.util.Optional;<br><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WmTokenInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//得到header中的信息</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">&quot;userId&quot;</span>);<br>        Optional&lt;String&gt; optional = Optional.ofNullable(userId);<br>        <span class="hljs-keyword">if</span>(optional.isPresent())&#123;<br>            <span class="hljs-comment">//把用户id存入threadloacl中</span><br>            <span class="hljs-type">WmUser</span> <span class="hljs-variable">wmUser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WmUser</span>();<br>            wmUser.setId(Integer.valueOf(userId));<br>            WmThreadLocalUtils.setUser(wmUser);<br>            log.info(<span class="hljs-string">&quot;wmTokenFilter设置用户信息到threadlocal中...&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        log.info(<span class="hljs-string">&quot;清理threadlocal...&quot;</span>);<br>        WmThreadLocalUtils.clear();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>配置使拦截器生效，拦截所有的请求</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.wemedia.config;<br><br><span class="hljs-keyword">import</span> com.heima.wemedia.interceptor.WmTokenInterceptor;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.config.annotation.InterceptorRegistry;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebMvcConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebMvcConfigurer</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addInterceptors</span><span class="hljs-params">(InterceptorRegistry registry)</span> &#123;<br>        registry.addInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">WmTokenInterceptor</span>()).addPathPatterns(<span class="hljs-string">&quot;/**&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>④：先把图片上传到minIO中，获取到图片请求的路径——（2.2.5查看具体功能实现）</p>
<p>⑤：把用户id和图片上的路径保存到素材表中——（2.2.5查看具体功能实现）</p>
<h5 id="2-2-4-接口定义"><a href="#2-2-4-接口定义" class="headerlink" title="2.2.4)接口定义"></a>2.2.4)接口定义</h5><table>
<thead>
<tr>
<th></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>接口路径</td>
<td>/api/v1/material/upload_picture</td>
</tr>
<tr>
<td>请求方式</td>
<td>POST</td>
</tr>
<tr>
<td>参数</td>
<td>MultipartFile</td>
</tr>
<tr>
<td>响应结果</td>
<td>ResponseResult</td>
</tr>
</tbody></table>
<p>MultipartFile  ：Springmvc指定的文件接收类型</p>
<p>ResponseResult  ：</p>
<p>成功需要回显图片，返回素材对象</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;host&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;code&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">200</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;errorMessage&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;操作成功&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;data&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">52</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;userId&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">1102</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;url&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;http://192.168.200.130:9000/leadnews/2021/04/26/a73f5b60c0d84c32bfe175055aaaac40.jpg&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;isCollection&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;createdTime&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;2021-01-20T16:49:48.443+0000&quot;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>失败：</p>
<ul>
<li>参数失效</li>
<li>文章上传失败</li>
</ul>
<h5 id="2-2-5-自媒体微服务集成heima-file-starter"><a href="#2-2-5-自媒体微服务集成heima-file-starter" class="headerlink" title="2.2.5)自媒体微服务集成heima-file-starter"></a>2.2.5)自媒体微服务集成heima-file-starter</h5><p>①：导入heima-file-starter</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.heima<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>heima-file-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>②：在自媒体微服务的配置中心添加以下配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">minio:</span><br>  <span class="hljs-attr">accessKey:</span> <span class="hljs-string">minio</span><br>  <span class="hljs-attr">secretKey:</span> <span class="hljs-string">minio123</span><br>  <span class="hljs-attr">bucket:</span> <span class="hljs-string">leadnews</span><br>  <span class="hljs-attr">endpoint:</span> <span class="hljs-string">http://192.168.200.130:9000</span><br>  <span class="hljs-attr">readPath:</span> <span class="hljs-string">http://192.168.200.130:9000</span><br></code></pre></td></tr></table></figure>

<h5 id="2-2-6-具体实现"><a href="#2-2-6-具体实现" class="headerlink" title="2.2.6)具体实现"></a>2.2.6)具体实现</h5><p>①：创建WmMaterialController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/api/v1/material&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WmMaterialController</span> &#123;<br><br><br>    <span class="hljs-meta">@PostMapping(&quot;/upload_picture&quot;)</span><br>    <span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">uploadPicture</span><span class="hljs-params">(MultipartFile multipartFile)</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>②：mapper</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.wemedia.mapper;<br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.mapper.BaseMapper;<br><span class="hljs-keyword">import</span> com.heima.model.wemedia.pojos.WmMaterial;<br><span class="hljs-keyword">import</span> org.apache.ibatis.annotations.Mapper;<br><br><span class="hljs-meta">@Mapper</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">WmMaterialMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseMapper</span>&lt;WmMaterial&gt; &#123;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>③：业务层：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.wemedia.service;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">WmMaterialService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IService</span>&lt;WmMaterial&gt; &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 图片上传</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> multipartFile</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">uploadPicture</span><span class="hljs-params">(MultipartFile multipartFile)</span>;<br><br><br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>业务层实现类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.wemedia.service.impl;<br><br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;<br><span class="hljs-keyword">import</span> com.heima.file.service.FileStorageService;<br><span class="hljs-keyword">import</span> com.heima.model.common.dtos.ResponseResult;<br><span class="hljs-keyword">import</span> com.heima.model.common.enums.AppHttpCodeEnum;<br><span class="hljs-keyword">import</span> com.heima.model.wemedia.pojos.WmMaterial;<br><span class="hljs-keyword">import</span> com.heima.utils.thread.WmThreadLocalUtil;<br><span class="hljs-keyword">import</span> com.heima.wemedia.mapper.WmMaterialMapper;<br><span class="hljs-keyword">import</span> com.heima.wemedia.service.WmMaterialService;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><span class="hljs-keyword">import</span> org.springframework.transaction.annotation.Transactional;<br><span class="hljs-keyword">import</span> org.springframework.web.multipart.MultipartFile;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.Date;<br><span class="hljs-keyword">import</span> java.util.UUID;<br><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@Transactional</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WmMaterialServiceImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ServiceImpl</span>&lt;WmMaterialMapper, WmMaterial&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WmMaterialService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> FileStorageService fileStorageService;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 图片上传</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> multipartFile</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">uploadPicture</span><span class="hljs-params">(MultipartFile multipartFile)</span> &#123;<br><br>        <span class="hljs-comment">//1.检查参数</span><br>        <span class="hljs-keyword">if</span>(multipartFile == <span class="hljs-literal">null</span> || multipartFile.getSize() == <span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-keyword">return</span> ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID);<br>        &#125;<br><br>        <span class="hljs-comment">//2.上传图片到minIO中</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">fileName</span> <span class="hljs-operator">=</span> UUID.randomUUID().toString().replace(<span class="hljs-string">&quot;-&quot;</span>, <span class="hljs-string">&quot;&quot;</span>);<br>        <span class="hljs-comment">//aa.jpg</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">originalFilename</span> <span class="hljs-operator">=</span> multipartFile.getOriginalFilename();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">postfix</span> <span class="hljs-operator">=</span> originalFilename.substring(originalFilename.lastIndexOf(<span class="hljs-string">&quot;.&quot;</span>));<br>        <span class="hljs-type">String</span> <span class="hljs-variable">fileId</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            fileId = fileStorageService.uploadImgFile(<span class="hljs-string">&quot;&quot;</span>, fileName + postfix, multipartFile.getInputStream());<br>            log.info(<span class="hljs-string">&quot;上传图片到MinIO中，fileId:&#123;&#125;&quot;</span>,fileId);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>            log.error(<span class="hljs-string">&quot;WmMaterialServiceImpl-上传文件失败&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">//3.保存到数据库中</span><br>        <span class="hljs-type">WmMaterial</span> <span class="hljs-variable">wmMaterial</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WmMaterial</span>();<br>        wmMaterial.setUserId(WmThreadLocalUtil.getUser().getId());<br>        wmMaterial.setUrl(fileId);<br>        wmMaterial.setIsCollection((<span class="hljs-type">short</span>)<span class="hljs-number">0</span>);<br>        wmMaterial.setType((<span class="hljs-type">short</span>)<span class="hljs-number">0</span>);<br>        wmMaterial.setCreatedTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>        save(wmMaterial);<br><br>        <span class="hljs-comment">//4.返回结果</span><br><br>        <span class="hljs-keyword">return</span> ResponseResult.okResult(wmMaterial);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>④：控制器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/api/v1/material&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WmMaterialController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> WmMaterialService wmMaterialService;<br><br><br>    <span class="hljs-meta">@PostMapping(&quot;/upload_picture&quot;)</span><br>    <span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">uploadPicture</span><span class="hljs-params">(MultipartFile multipartFile)</span>&#123;<br>        <span class="hljs-keyword">return</span> wmMaterialService.uploadPicture(multipartFile);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>⑤：测试</p>
<p>启动自媒体微服务和自媒体网关，使用前端项目进行测试</p>
<h4 id="2-2-素材列表查询"><a href="#2-2-素材列表查询" class="headerlink" title="2.2)素材列表查询"></a>2.2)素材列表查询</h4><h5 id="2-2-1-接口定义"><a href="#2-2-1-接口定义" class="headerlink" title="2.2.1)接口定义"></a>2.2.1)接口定义</h5><table>
<thead>
<tr>
<th></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>接口路径</td>
<td>/api/v1/material/list</td>
</tr>
<tr>
<td>请求方式</td>
<td>POST</td>
</tr>
<tr>
<td>参数</td>
<td>WmMaterialDto</td>
</tr>
<tr>
<td>响应结果</td>
<td>ResponseResult</td>
</tr>
</tbody></table>
<p>WmMaterialDto  ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WmMaterialDto</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">PageRequestDto</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 1 收藏</span><br><span class="hljs-comment">     * 0 未收藏</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Short isCollection;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ResponseResult  :</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;host&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;code&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">200</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;errorMessage&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;操作成功&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;data&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><br>    <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">52</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;userId&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">1102</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;url&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;http://192.168.200.130:9000/leadnews/2021/04/26/ec893175f18c4261af14df14b83cb25f.jpg&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;isCollection&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;createdTime&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;2021-01-20T16:49:48.000+0000&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    ....<br>  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;currentPage&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;size&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">20</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;total&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">0</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<h5 id="2-2-2-功能实现"><a href="#2-2-2-功能实现" class="headerlink" title="2.2.2)功能实现"></a>2.2.2)功能实现</h5><p>①：在WmMaterialController类中新增方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@PostMapping(&quot;/list&quot;)</span><br><span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">findList</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> WmMaterialDto dto)</span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>②：mapper已定义</p>
<p>③：业务层</p>
<p>在WmMaterialService中新增方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 素材列表查询</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> dto</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br><span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">findList</span><span class="hljs-params">( WmMaterialDto dto)</span>;<br></code></pre></td></tr></table></figure>

<p>实现方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 素材列表查询</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> dto</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">findList</span><span class="hljs-params">(WmMaterialDto dto)</span> &#123;<br><br>    <span class="hljs-comment">//1.检查参数</span><br>    dto.checkParam();<br><br>    <span class="hljs-comment">//2.分页查询</span><br>    <span class="hljs-type">IPage</span> <span class="hljs-variable">page</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>(dto.getPage(),dto.getSize());<br>    LambdaQueryWrapper&lt;WmMaterial&gt; lambdaQueryWrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;&gt;();<br>    <span class="hljs-comment">//是否收藏</span><br>    <span class="hljs-keyword">if</span>(dto.getIsCollection() != <span class="hljs-literal">null</span> &amp;&amp; dto.getIsCollection() == <span class="hljs-number">1</span>)&#123;<br>        lambdaQueryWrapper.eq(WmMaterial::getIsCollection,dto.getIsCollection());<br>    &#125;<br><br>    <span class="hljs-comment">//按照用户查询</span><br>    lambdaQueryWrapper.eq(WmMaterial::getUserId,WmThreadLocalUtil.getUser().getId());<br><br>    <span class="hljs-comment">//按照时间倒序</span><br>    lambdaQueryWrapper.orderByDesc(WmMaterial::getCreatedTime);<br><br><br>    page = page(page,lambdaQueryWrapper);<br><br>    <span class="hljs-comment">//3.结果返回</span><br>    <span class="hljs-type">ResponseResult</span> <span class="hljs-variable">responseResult</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PageResponseResult</span>(dto.getPage(),dto.getSize(),(<span class="hljs-type">int</span>)page.getTotal());<br>    responseResult.setData(page.getRecords());<br>    <span class="hljs-keyword">return</span> responseResult;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>④：控制器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@PostMapping(&quot;/list&quot;)</span><br><span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">findList</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> WmMaterialDto dto)</span>&#123;<br>    <span class="hljs-keyword">return</span> wmMaterialService.findList(dto);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>⑤：在自媒体引导类中天mybatis-plus的分页拦截器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> MybatisPlusInterceptor <span class="hljs-title function_">mybatisPlusInterceptor</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">MybatisPlusInterceptor</span> <span class="hljs-variable">interceptor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MybatisPlusInterceptor</span>();<br>    interceptor.addInnerInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PaginationInnerInterceptor</span>(DbType.MYSQL));<br>    <span class="hljs-keyword">return</span> interceptor;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="3-自媒体文章管理"><a href="#3-自媒体文章管理" class="headerlink" title="3)自媒体文章管理"></a>3)自媒体文章管理</h3><h4 id="3-1-查询所有频道"><a href="#3-1-查询所有频道" class="headerlink" title="3.1)查询所有频道"></a>3.1)查询所有频道</h4><h5 id="3-1-1-需求分析"><a href="#3-1-1-需求分析" class="headerlink" title="3.1.1)需求分析"></a>3.1.1)需求分析</h5><p><img src="/../images/image-20210426205631708.png" srcset="/img/loading.gif" lazyload alt="image-20210426205631708"></p>
<h5 id="3-1-2-表结构"><a href="#3-1-2-表结构" class="headerlink" title="3.1.2)表结构"></a>3.1.2)表结构</h5><p>wm_channel 频道信息表</p>
<p><img src="/../images/image-20210426210148580.png" srcset="/img/loading.gif" lazyload alt="image-20210426210148580"></p>
<p>对应实体类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.model.wemedia.pojos;<br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.IdType;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.TableField;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.TableId;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.TableName;<br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><span class="hljs-keyword">import</span> java.util.Date;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * &lt;p&gt;</span><br><span class="hljs-comment"> * 频道信息表</span><br><span class="hljs-comment"> * &lt;/p&gt;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> itheima</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@TableName(&quot;wm_channel&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WmChannel</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;<br><br>    <span class="hljs-meta">@TableId(value = &quot;id&quot;, type = IdType.AUTO)</span><br>    <span class="hljs-keyword">private</span> Integer id;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 频道名称</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;name&quot;)</span><br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 频道描述</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;description&quot;)</span><br>    <span class="hljs-keyword">private</span> String description;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 是否默认频道</span><br><span class="hljs-comment">     * 1：默认     true</span><br><span class="hljs-comment">     * 0：非默认   false</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;is_default&quot;)</span><br>    <span class="hljs-keyword">private</span> Boolean isDefault;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 是否启用</span><br><span class="hljs-comment">     * 1：启用   true</span><br><span class="hljs-comment">     * 0：禁用   false</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;status&quot;)</span><br>    <span class="hljs-keyword">private</span> Boolean status;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 默认排序</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;ord&quot;)</span><br>    <span class="hljs-keyword">private</span> Integer ord;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 创建时间</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;created_time&quot;)</span><br>    <span class="hljs-keyword">private</span> Date createdTime;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="3-1-3-接口定义"><a href="#3-1-3-接口定义" class="headerlink" title="3.1.3)接口定义"></a>3.1.3)接口定义</h5><table>
<thead>
<tr>
<th></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>接口路径</td>
<td>/api/v1/channel/channels</td>
</tr>
<tr>
<td>请求方式</td>
<td>POST</td>
</tr>
<tr>
<td>参数</td>
<td>无</td>
</tr>
<tr>
<td>响应结果</td>
<td>ResponseResult</td>
</tr>
</tbody></table>
<p>ResponseResult  ：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;host&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;null&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;code&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;errorMessage&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;操作成功&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;data&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>    <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;java&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;java&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;isDefault&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;status&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;ord&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;createdTime&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2019-08-16T10:55:41.000+0000&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    Object <span class="hljs-punctuation">&#123;</span>  ... <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    Object <span class="hljs-punctuation">&#123;</span>  ... <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<h5 id="3-1-4-功能实现"><a href="#3-1-4-功能实现" class="headerlink" title="3.1.4)功能实现"></a>3.1.4)功能实现</h5><p>接口定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.wemedia.controller.v1;<br><br><span class="hljs-keyword">import</span> com.heima.model.common.dtos.ResponseResult;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/api/v1/channel&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WmchannelController</span> &#123;<br><br><br>    <span class="hljs-meta">@GetMapping(&quot;/channels&quot;)</span><br>    <span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">findAll</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>mapper</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.wemedia.mapper;<br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.mapper.BaseMapper;<br><span class="hljs-keyword">import</span> com.heima.model.wemedia.pojos.WmChannel;<br><span class="hljs-keyword">import</span> org.apache.ibatis.annotations.Mapper;<br><br><span class="hljs-meta">@Mapper</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">WmChannelMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseMapper</span>&lt;WmChannel&gt; &#123;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.wemedia.service;<br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.extension.service.IService;<br><span class="hljs-keyword">import</span> com.heima.model.common.dtos.ResponseResult;<br><span class="hljs-keyword">import</span> com.heima.model.wemedia.pojos.WmChannel;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">WmChannelService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IService</span>&lt;WmChannel&gt; &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 查询所有频道</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">findAll</span><span class="hljs-params">()</span>;<br><br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.wemedia.service.impl;<br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;<br><span class="hljs-keyword">import</span> com.heima.model.common.dtos.ResponseResult;<br><span class="hljs-keyword">import</span> com.heima.model.wemedia.pojos.WmChannel;<br><span class="hljs-keyword">import</span> com.heima.wemedia.mapper.WmChannelMapper;<br><span class="hljs-keyword">import</span> com.heima.wemedia.service.WmChannelService;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><span class="hljs-keyword">import</span> org.springframework.transaction.annotation.Transactional;<br><br><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@Transactional</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WmChannelServiceImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ServiceImpl</span>&lt;WmChannelMapper, WmChannel&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WmChannelService</span> &#123;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 查询所有频道</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">findAll</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> ResponseResult.okResult(list());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>控制层</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.wemedia.controller.v1;<br><br><span class="hljs-keyword">import</span> com.heima.model.common.dtos.ResponseResult;<br><span class="hljs-keyword">import</span> com.heima.wemedia.service.WmChannelService;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/api/v1/channel&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WmchannelController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> WmChannelService wmChannelService;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/channels&quot;)</span><br>    <span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">findAll</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> wmChannelService.findAll();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="3-1-5-测试"><a href="#3-1-5-测试" class="headerlink" title="3.1.5)测试"></a>3.1.5)测试</h5><h4 id="3-2-查询自媒体文章"><a href="#3-2-查询自媒体文章" class="headerlink" title="3.2)查询自媒体文章"></a>3.2)查询自媒体文章</h4><h5 id="3-2-1-需求说明"><a href="#3-2-1-需求说明" class="headerlink" title="3.2.1)需求说明"></a>3.2.1)需求说明</h5><p><img src="/../images/image-20210426210402672.png" srcset="/img/loading.gif" lazyload alt="image-20210426210402672"></p>
<h5 id="3-2-2-表结构分析"><a href="#3-2-2-表结构分析" class="headerlink" title="3.2.2)表结构分析"></a>3.2.2)表结构分析</h5><p>wm_news 自媒体文章表</p>
<p><img src="/../images/image-20210426210434861.png" srcset="/img/loading.gif" lazyload alt="image-20210426210434861"></p>
<p>对应实体类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.model.wemedia.pojos;<br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.IdType;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.TableField;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.TableId;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.TableName;<br><span class="hljs-keyword">import</span> lombok.Data;<br><span class="hljs-keyword">import</span> org.apache.ibatis.type.Alias;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><span class="hljs-keyword">import</span> java.util.Date;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * &lt;p&gt;</span><br><span class="hljs-comment"> * 自媒体图文内容信息表</span><br><span class="hljs-comment"> * &lt;/p&gt;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> itheima</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@TableName(&quot;wm_news&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WmNews</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 主键</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableId(value = &quot;id&quot;, type = IdType.AUTO)</span><br>    <span class="hljs-keyword">private</span> Integer id;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 自媒体用户ID</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;user_id&quot;)</span><br>    <span class="hljs-keyword">private</span> Integer userId;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 标题</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;title&quot;)</span><br>    <span class="hljs-keyword">private</span> String title;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 图文内容</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;content&quot;)</span><br>    <span class="hljs-keyword">private</span> String content;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 文章布局</span><br><span class="hljs-comment">            0 无图文章</span><br><span class="hljs-comment">            1 单图文章</span><br><span class="hljs-comment">            3 多图文章</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;type&quot;)</span><br>    <span class="hljs-keyword">private</span> Short type;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 图文频道ID</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;channel_id&quot;)</span><br>    <span class="hljs-keyword">private</span> Integer channelId;<br><br>    <span class="hljs-meta">@TableField(&quot;labels&quot;)</span><br>    <span class="hljs-keyword">private</span> String labels;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 创建时间</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;created_time&quot;)</span><br>    <span class="hljs-keyword">private</span> Date createdTime;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 提交时间</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;submited_time&quot;)</span><br>    <span class="hljs-keyword">private</span> Date submitedTime;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 当前状态</span><br><span class="hljs-comment">            0 草稿</span><br><span class="hljs-comment">            1 提交（待审核）</span><br><span class="hljs-comment">            2 审核失败</span><br><span class="hljs-comment">            3 人工审核</span><br><span class="hljs-comment">            4 人工审核通过</span><br><span class="hljs-comment">            8 审核通过（待发布）</span><br><span class="hljs-comment">            9 已发布</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;status&quot;)</span><br>    <span class="hljs-keyword">private</span> Short status;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 定时发布时间，不定时则为空</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;publish_time&quot;)</span><br>    <span class="hljs-keyword">private</span> Date publishTime;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 拒绝理由</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;reason&quot;)</span><br>    <span class="hljs-keyword">private</span> String reason;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 发布库文章ID</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;article_id&quot;)</span><br>    <span class="hljs-keyword">private</span> Long articleId;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * //图片用逗号分隔</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;images&quot;)</span><br>    <span class="hljs-keyword">private</span> String images;<br><br>    <span class="hljs-meta">@TableField(&quot;enable&quot;)</span><br>    <span class="hljs-keyword">private</span> Short enable;<br>    <br>     <span class="hljs-comment">//状态枚举类</span><br>    <span class="hljs-meta">@Alias(&quot;WmNewsStatus&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">Status</span>&#123;<br>        NORMAL((<span class="hljs-type">short</span>)<span class="hljs-number">0</span>),SUBMIT((<span class="hljs-type">short</span>)<span class="hljs-number">1</span>),FAIL((<span class="hljs-type">short</span>)<span class="hljs-number">2</span>),ADMIN_AUTH((<span class="hljs-type">short</span>)<span class="hljs-number">3</span>),ADMIN_SUCCESS((<span class="hljs-type">short</span>)<span class="hljs-number">4</span>),SUCCESS((<span class="hljs-type">short</span>)<span class="hljs-number">8</span>),PUBLISHED((<span class="hljs-type">short</span>)<span class="hljs-number">9</span>);<br>        <span class="hljs-type">short</span> code;<br>        Status(<span class="hljs-type">short</span> code)&#123;<br>            <span class="hljs-built_in">this</span>.code = code;<br>        &#125;<br>        <span class="hljs-keyword">public</span> <span class="hljs-type">short</span> <span class="hljs-title function_">getCode</span><span class="hljs-params">()</span>&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.code;<br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="3-2-3-接口定义"><a href="#3-2-3-接口定义" class="headerlink" title="3.2.3)接口定义"></a>3.2.3)接口定义</h5><table>
<thead>
<tr>
<th></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>接口路径</td>
<td>/api/v1/news/list</td>
</tr>
<tr>
<td>请求方式</td>
<td>POST</td>
</tr>
<tr>
<td>参数</td>
<td>WmNewsPageReqDto</td>
</tr>
<tr>
<td>响应结果</td>
<td>ResponseResult</td>
</tr>
</tbody></table>
<p>WmNewsPageReqDto  :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.model.wemedia.dtos;<br><br><span class="hljs-keyword">import</span> com.heima.model.common.dtos.PageRequestDto;<br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.util.Date;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WmNewsPageReqDto</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">PageRequestDto</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 状态</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Short status;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 开始时间</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Date beginPubDate;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 结束时间</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Date endPubDate;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 所属频道ID</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Integer channelId;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 关键字</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String keyword;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ResponseResult  :</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;host&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;null&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;code&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;errorMessage&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;操作成功&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;data&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>    Object <span class="hljs-punctuation">&#123;</span> ... <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    Object <span class="hljs-punctuation">&#123;</span> ... <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    Object <span class="hljs-punctuation">&#123;</span> ... <span class="hljs-punctuation">&#125;</span><br>    <br>  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;currentPage&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;size&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">10</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;total&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">21</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<h5 id="3-2-4-功能实现"><a href="#3-2-4-功能实现" class="headerlink" title="3.2.4)功能实现"></a>3.2.4)功能实现</h5><p>①：新增WmNewsController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.wemedia.controller.v1;<br><br><span class="hljs-keyword">import</span> com.heima.model.common.dtos.ResponseResult;<br><span class="hljs-keyword">import</span> com.heima.model.wemedia.dtos.WmNewsPageReqDto;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PostMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestBody;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/api/v1/news&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WmNewsController</span> &#123;<br><br><br>    <span class="hljs-meta">@PostMapping(&quot;/list&quot;)</span><br>    <span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">findAll</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> WmNewsPageReqDto dto)</span>&#123;<br>        <span class="hljs-keyword">return</span>  <span class="hljs-literal">null</span>;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>②：新增WmNewsMapper</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.wemedia.mapper;<br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.mapper.BaseMapper;<br><span class="hljs-keyword">import</span> com.heima.model.wemedia.pojos.WmNews;<br><span class="hljs-keyword">import</span> org.apache.ibatis.annotations.Mapper;<br><br><span class="hljs-meta">@Mapper</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">WmNewsMapper</span>  <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseMapper</span>&lt;WmNews&gt; &#123;<br>    <br>&#125;<br></code></pre></td></tr></table></figure>



<p>③：新增WmNewsService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.wemedia.service;<br><br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.extension.service.IService;<br><span class="hljs-keyword">import</span> com.heima.model.common.dtos.ResponseResult;<br><span class="hljs-keyword">import</span> com.heima.model.wemedia.dtos.WmNewsPageReqDto;<br><span class="hljs-keyword">import</span> com.heima.model.wemedia.pojos.WmNews;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">WmNewsService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IService</span>&lt;WmNews&gt; &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 查询文章</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> dto</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">findAll</span><span class="hljs-params">(WmNewsPageReqDto dto)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>实现类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.wemedia.service.impl;<br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.metadata.IPage;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.extension.plugins.pagination.Page;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;<br><span class="hljs-keyword">import</span> com.heima.model.common.dtos.PageResponseResult;<br><span class="hljs-keyword">import</span> com.heima.model.common.dtos.ResponseResult;<br><span class="hljs-keyword">import</span> com.heima.model.common.enums.AppHttpCodeEnum;<br><span class="hljs-keyword">import</span> com.heima.model.wemedia.dtos.WmNewsPageReqDto;<br><span class="hljs-keyword">import</span> com.heima.model.wemedia.pojos.WmNews;<br><span class="hljs-keyword">import</span> com.heima.model.wemedia.pojos.WmUser;<br><span class="hljs-keyword">import</span> com.heima.utils.thread.WmThreadLocalUtil;<br><span class="hljs-keyword">import</span> com.heima.wemedia.mapper.WmNewsMapper;<br><span class="hljs-keyword">import</span> com.heima.wemedia.service.WmNewsService;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.apache.commons.lang3.StringUtils;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><span class="hljs-keyword">import</span> org.springframework.transaction.annotation.Transactional;<br><br><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Transactional</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WmNewsServiceImpl</span>  <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ServiceImpl</span>&lt;WmNewsMapper, WmNews&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WmNewsService</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 查询文章</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> dto</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">findAll</span><span class="hljs-params">(WmNewsPageReqDto dto)</span> &#123;<br><br>        <span class="hljs-comment">//1.检查参数</span><br>        <span class="hljs-keyword">if</span>(dto == <span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-keyword">return</span> ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID);<br>        &#125;<br>        <span class="hljs-comment">//分页参数检查</span><br>        dto.checkParam();<br>        <span class="hljs-comment">//获取当前登录人的信息</span><br>        <span class="hljs-type">WmUser</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> WmThreadLocalUtil.getUser();<br>        <span class="hljs-keyword">if</span>(user == <span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-keyword">return</span> ResponseResult.errorResult(AppHttpCodeEnum.NEED_LOGIN);<br>        &#125;<br><br>        <span class="hljs-comment">//2.分页条件查询</span><br>        <span class="hljs-type">IPage</span> <span class="hljs-variable">page</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>(dto.getPage(),dto.getSize());<br>        LambdaQueryWrapper&lt;WmNews&gt; lambdaQueryWrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;&gt;();<br>        <span class="hljs-comment">//状态精确查询</span><br>        <span class="hljs-keyword">if</span>(dto.getStatus() != <span class="hljs-literal">null</span>)&#123;<br>            lambdaQueryWrapper.eq(WmNews::getStatus,dto.getStatus());<br>        &#125;<br><br>        <span class="hljs-comment">//频道精确查询</span><br>        <span class="hljs-keyword">if</span>(dto.getChannelId() != <span class="hljs-literal">null</span>)&#123;<br>            lambdaQueryWrapper.eq(WmNews::getChannelId,dto.getChannelId());<br>        &#125;<br><br>        <span class="hljs-comment">//时间范围查询</span><br>        <span class="hljs-keyword">if</span>(dto.getBeginPubDate()!=<span class="hljs-literal">null</span> &amp;&amp; dto.getEndPubDate()!=<span class="hljs-literal">null</span>)&#123;<br>            lambdaQueryWrapper.between(WmNews::getPublishTime,dto.getBeginPubDate(),dto.getEndPubDate());<br>        &#125;<br><br>        <span class="hljs-comment">//关键字模糊查询</span><br>        <span class="hljs-keyword">if</span>(StringUtils.isNotBlank(dto.getKeyword()))&#123;<br>            lambdaQueryWrapper.like(WmNews::getTitle,dto.getKeyword());<br>        &#125;<br><br>        <span class="hljs-comment">//查询当前登录用户的文章</span><br>        lambdaQueryWrapper.eq(WmNews::getUserId,user.getId());<br><br>        <span class="hljs-comment">//发布时间倒序查询</span><br>        lambdaQueryWrapper.orderByDesc(WmNews::getCreatedTime);<br><br>        page = page(page,lambdaQueryWrapper);<br><br>        <span class="hljs-comment">//3.结果返回</span><br>        <span class="hljs-type">ResponseResult</span> <span class="hljs-variable">responseResult</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PageResponseResult</span>(dto.getPage(),dto.getSize(),(<span class="hljs-type">int</span>)page.getTotal());<br>        responseResult.setData(page.getRecords());<br><br>        <span class="hljs-keyword">return</span> responseResult;<br>    &#125;<br>   <br>&#125;<br></code></pre></td></tr></table></figure>

<p>④：控制器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.wemedia.controller.v1;<br><br><span class="hljs-keyword">import</span> com.heima.model.common.dtos.ResponseResult;<br><span class="hljs-keyword">import</span> com.heima.model.wemedia.dtos.WmNewsPageReqDto;<br><span class="hljs-keyword">import</span> com.heima.wemedia.service.WmNewsService;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PostMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestBody;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/api/v1/news&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WmNewsController</span> &#123;<br><br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> WmNewsService wmNewsService;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/list&quot;)</span><br>    <span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">findAll</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> WmNewsPageReqDto dto)</span>&#123;<br>        <span class="hljs-keyword">return</span>  wmNewsService.findAll(dto);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="3-2-5-测试"><a href="#3-2-5-测试" class="headerlink" title="3.2.5)测试"></a>3.2.5)测试</h5><p>启动后端自媒体微服务和自媒体网关微服务，测试文章列表查询</p>
<h4 id="3-3-文章发布"><a href="#3-3-文章发布" class="headerlink" title="3.3)文章发布"></a>3.3)文章发布</h4><h5 id="3-3-1-需求分析"><a href="#3-3-1-需求分析" class="headerlink" title="3.3.1)需求分析"></a>3.3.1)需求分析</h5><p><img src="/../images/image-20210427014931255.png" srcset="/img/loading.gif" lazyload alt="image-20210427014931255"></p>
<h5 id="3-3-2-表结构分析"><a href="#3-3-2-表结构分析" class="headerlink" title="3.3.2)表结构分析"></a>3.3.2)表结构分析</h5><p>保存文章，除了需要wm_news表以外，还需要另外两张表</p>
<p>wm_material 素材表</p>
<p><img src="/../images/image-20210427015037964.png" srcset="/img/loading.gif" lazyload alt="image-20210427015037964"></p>
<p>wm_news_material 文章素材关系表</p>
<p><img src="/../images/image-20210427015054428.png" srcset="/img/loading.gif" lazyload alt="image-20210427015054428"></p>
<p><img src="/../images/image-20210427015114994.png" srcset="/img/loading.gif" lazyload alt="image-20210427015114994"></p>
<p>其中wm_material和wm_news表的实体类已经导入到了项目中，下面是wm_news_material表对应的实体类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.model.wemedia.pojos;<br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.IdType;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.TableField;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.TableId;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.TableName;<br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * &lt;p&gt;</span><br><span class="hljs-comment"> * 自媒体图文引用素材信息表</span><br><span class="hljs-comment"> * &lt;/p&gt;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> itheima</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@TableName(&quot;wm_news_material&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WmNewsMaterial</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 主键</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableId(value = &quot;id&quot;, type = IdType.AUTO)</span><br>    <span class="hljs-keyword">private</span> Integer id;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 素材ID</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;material_id&quot;)</span><br>    <span class="hljs-keyword">private</span> Integer materialId;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 图文ID</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;news_id&quot;)</span><br>    <span class="hljs-keyword">private</span> Integer newsId;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 引用类型</span><br><span class="hljs-comment">            0 内容引用</span><br><span class="hljs-comment">            1 主图引用</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;type&quot;)</span><br>    <span class="hljs-keyword">private</span> Short type;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 引用排序</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;ord&quot;)</span><br>    <span class="hljs-keyword">private</span> Short ord;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="3-3-3-实现思路分析"><a href="#3-3-3-实现思路分析" class="headerlink" title="3.3.3)实现思路分析"></a>3.3.3)实现思路分析</h5><p><img src="/../images/image-20210427015326728.png" srcset="/img/loading.gif" lazyload alt="image-20210427015326728"></p>
<p>1.前端提交发布或保存为草稿</p>
<p>2.后台判断请求中是否包含了文章id</p>
<p>3.如果不包含id,则为新增</p>
<p>​    3.1 执行新增文章的操作</p>
<p>​    3.2 关联文章内容图片与素材的关系</p>
<p>​    3.3 关联文章封面图片与素材的关系</p>
<p>4.如果包含了id，则为修改请求</p>
<p>​    4.1 删除该文章与素材的所有关系</p>
<p>​    4.2 执行修改操作</p>
<p>​    4.3 关联文章内容图片与素材的关系</p>
<p>​    4.4 关联文章封面图片与素材的关系</p>
<h5 id="3-3-4-接口定义"><a href="#3-3-4-接口定义" class="headerlink" title="3.3.4)接口定义"></a>3.3.4)接口定义</h5><table>
<thead>
<tr>
<th></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>接口路径</td>
<td>/api/v1/channel/submit</td>
</tr>
<tr>
<td>请求方式</td>
<td>POST</td>
</tr>
<tr>
<td>参数</td>
<td>WmNewsDto</td>
</tr>
<tr>
<td>响应结果</td>
<td>ResponseResult</td>
</tr>
</tbody></table>
<p>WmNewsDto  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.model.wemedia.dtos;<br><br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.util.Date;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WmNewsDto</span> &#123;<br>    <br>    <span class="hljs-keyword">private</span> Integer id;<br>     <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 标题</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String title;<br>     <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 频道id</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Integer channelId;<br>     <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 标签</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String labels;<br>     <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 发布时间</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Date publishTime;<br>     <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 文章内容</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String content;<br>     <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 文章封面类型  0 无图 1 单图 3 多图 -1 自动</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Short type;<br>     <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 提交时间</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Date submitedTime; <br>     <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 状态 提交为1  草稿为0</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Short status;<br>     <br>     <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 封面图片列表 多张图以逗号隔开</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> List&lt;String&gt; images;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>前端给传递过来的json数据格式为：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;黑马头条项目背景&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;1&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-comment">//这个 0 是无图  1 是单图  3 是多图  -1 是自动</span><br>    <span class="hljs-attr">&quot;labels&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;黑马头条&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;publishTime&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;2020-03-14T11:35:49.000Z&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;channelId&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;images&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><br>        <span class="hljs-string">&quot;http://192.168.200.130/group1/M00/00/00/wKjIgl5swbGATaSAAAEPfZfx6Iw790.png&quot;</span><br>    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;status&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;content&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;[</span><br><span class="hljs-string">    &#123;</span><br><span class="hljs-string">        &quot;</span>type<span class="hljs-string">&quot;:&quot;</span>text<span class="hljs-string">&quot;,</span><br><span class="hljs-string">        &quot;</span>value<span class="hljs-string">&quot;:&quot;</span>随着智能手机的普及，人们更加习惯于通过手机来看新闻。由于生活节奏的加快，很多人只能利用碎片时间来获取信息，因此，对于移动资讯客户端的需求也越来越高。黑马头条项目正是在这样背景下开发出来。黑马头条项目采用当下火热的微服务+大数据技术架构实现。本项目主要着手于获取最新最热新闻资讯，通过大数据分析用户喜好精确推送咨询新闻<span class="hljs-string">&quot;</span><br><span class="hljs-string">    &#125;,</span><br><span class="hljs-string">    &#123;</span><br><span class="hljs-string">        &quot;</span>type<span class="hljs-string">&quot;:&quot;</span>image<span class="hljs-string">&quot;,</span><br><span class="hljs-string">        &quot;</span>value<span class="hljs-string">&quot;:&quot;</span>http<span class="hljs-punctuation">:</span><span class="hljs-comment">//192.168.200.130/group1/M00/00/00/wKjIgl5swbGATaSAAAEPfZfx6Iw790.png&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">]</span><span class="hljs-string">&quot;</span><br><span class="hljs-string">&#125;</span><br></code></pre></td></tr></table></figure>

<p>ResponseResult:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    “code”<span class="hljs-punctuation">:</span><span class="hljs-number">501</span><span class="hljs-punctuation">,</span><br>    “errorMessage”<span class="hljs-punctuation">:</span>“参数失效<span class="hljs-string">&quot;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string">    “code”:200,</span><br><span class="hljs-string">    “errorMessage”:“操作成功&quot;</span><br><span class="hljs-punctuation">&#125;</span><br><br><span class="hljs-punctuation">&#123;</span><br>    “code”<span class="hljs-punctuation">:</span><span class="hljs-number">501</span><span class="hljs-punctuation">,</span><br>    “errorMessage”<span class="hljs-punctuation">:</span>“素材引用失效<span class="hljs-string">&quot;</span><br><span class="hljs-string">&#125;</span><br></code></pre></td></tr></table></figure>

<h5 id="3-3-5-功能实现"><a href="#3-3-5-功能实现" class="headerlink" title="3.3.5)功能实现"></a>3.3.5)功能实现</h5><p>①：在新增WmNewsController中新增方法</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs json">@PostMapping(<span class="hljs-string">&quot;/submit&quot;</span>)<br>public ResponseResult submitNews(@RequestBody WmNewsDto dto)<span class="hljs-punctuation">&#123;</span><br>    return <span class="hljs-literal"><span class="hljs-keyword">null</span></span>;<br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>②：新增WmNewsMaterialMapper类，文章与素材的关联关系需要批量保存，索引需要定义mapper文件和对应的映射文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.wemedia.mapper;<br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.mapper.BaseMapper;<br><span class="hljs-keyword">import</span> com.heima.model.wemedia.pojos.WmNewsMaterial;<br><span class="hljs-keyword">import</span> org.apache.ibatis.annotations.Mapper;<br><span class="hljs-keyword">import</span> org.apache.ibatis.annotations.Param;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-meta">@Mapper</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">WmNewsMaterialMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseMapper</span>&lt;WmNewsMaterial&gt; &#123;<br><br>     <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveRelations</span><span class="hljs-params">(<span class="hljs-meta">@Param(&quot;materialIds&quot;)</span> List&lt;Integer&gt; materialIds,<span class="hljs-meta">@Param(&quot;newsId&quot;)</span> Integer newsId, <span class="hljs-meta">@Param(&quot;type&quot;)</span>Short type)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>WmNewsMaterialMapper.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">mapper</span> <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span> <span class="hljs-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">&quot;com.heima.wemedia.mapper.WmNewsMaterialMapper&quot;</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">insert</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;saveRelations&quot;</span>&gt;</span><br>        insert into wm_news_material (material_id,news_id,type,ord)<br>        values<br>        <span class="hljs-tag">&lt;<span class="hljs-name">foreach</span> <span class="hljs-attr">collection</span>=<span class="hljs-string">&quot;materialIds&quot;</span> <span class="hljs-attr">index</span>=<span class="hljs-string">&quot;ord&quot;</span> <span class="hljs-attr">item</span>=<span class="hljs-string">&quot;mid&quot;</span> <span class="hljs-attr">separator</span>=<span class="hljs-string">&quot;,&quot;</span>&gt;</span><br>            (#&#123;mid&#125;,#&#123;newsId&#125;,#&#123;type&#125;,#&#123;ord&#125;)<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">foreach</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">insert</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>③：常量类准备</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.common.constants;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WemediaConstants</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Short</span> <span class="hljs-variable">COLLECT_MATERIAL</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<span class="hljs-comment">//收藏</span><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Short</span> <span class="hljs-variable">CANCEL_COLLECT_MATERIAL</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<span class="hljs-comment">//取消收藏</span><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">WM_NEWS_TYPE_IMAGE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;image&quot;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Short</span> <span class="hljs-variable">WM_NEWS_NONE_IMAGE</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Short</span> <span class="hljs-variable">WM_NEWS_SINGLE_IMAGE</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Short</span> <span class="hljs-variable">WM_NEWS_MANY_IMAGE</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Short</span> <span class="hljs-variable">WM_NEWS_TYPE_AUTO</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Short</span> <span class="hljs-variable">WM_CONTENT_REFERENCE</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Short</span> <span class="hljs-variable">WM_COVER_REFERENCE</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>④：在WmNewsService中新增方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *  发布文章或保存草稿</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> dto</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">submitNews</span><span class="hljs-params">(WmNewsDto dto)</span>;<br></code></pre></td></tr></table></figure>

<p>实现方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 发布修改文章或保存为草稿</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> dto</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">submitNews</span><span class="hljs-params">(WmNewsDto dto)</span> &#123;<br><br>    <span class="hljs-comment">//0.条件判断</span><br>    <span class="hljs-keyword">if</span>(dto == <span class="hljs-literal">null</span> || dto.getContent() == <span class="hljs-literal">null</span>)&#123;<br>        <span class="hljs-keyword">return</span> ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID);<br>    &#125;<br><br>    <span class="hljs-comment">//1.保存或修改文章</span><br><br>    <span class="hljs-type">WmNews</span> <span class="hljs-variable">wmNews</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WmNews</span>();<br>    <span class="hljs-comment">//属性拷贝 属性名词和类型相同才能拷贝</span><br>    BeanUtils.copyProperties(dto,wmNews);<br>    <span class="hljs-comment">//封面图片  list---&gt; string</span><br>    <span class="hljs-keyword">if</span>(dto.getImages() != <span class="hljs-literal">null</span> &amp;&amp; dto.getImages().size() &gt; <span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-comment">//[1dddfsd.jpg,sdlfjldk.jpg]--&gt;   1dddfsd.jpg,sdlfjldk.jpg</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">imageStr</span> <span class="hljs-operator">=</span> StringUtils.join(dto.getImages(), <span class="hljs-string">&quot;,&quot;</span>);<br>        wmNews.setImages(imageStr);<br>    &#125;<br>    <span class="hljs-comment">//如果当前封面类型为自动 -1</span><br>    <span class="hljs-keyword">if</span>(dto.getType().equals(WemediaConstants.WM_NEWS_TYPE_AUTO))&#123;<br>        wmNews.setType(<span class="hljs-literal">null</span>);<br>    &#125;<br><br>    saveOrUpdateWmNews(wmNews);<br><br>    <span class="hljs-comment">//2.判断是否为草稿  如果为草稿结束当前方法</span><br>    <span class="hljs-keyword">if</span>(dto.getStatus().equals(WmNews.Status.NORMAL.getCode()))&#123;<br>        <span class="hljs-keyword">return</span> ResponseResult.okResult(AppHttpCodeEnum.SUCCESS);<br>    &#125;<br><br>    <span class="hljs-comment">//3.不是草稿，保存文章内容图片与素材的关系</span><br>    <span class="hljs-comment">//获取到文章内容中的图片信息</span><br>    List&lt;String&gt; materials =  ectractUrlInfo(dto.getContent());<br>    saveRelativeInfoForContent(materials,wmNews.getId());<br><br>    <span class="hljs-comment">//4.不是草稿，保存文章封面图片与素材的关系，如果当前布局是自动，需要匹配封面图片</span><br>    saveRelativeInfoForCover(dto,wmNews,materials);<br><br>    <span class="hljs-keyword">return</span> ResponseResult.okResult(AppHttpCodeEnum.SUCCESS);<br><br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 第一个功能：如果当前封面类型为自动，则设置封面类型的数据</span><br><span class="hljs-comment">     * 匹配规则：</span><br><span class="hljs-comment">     * 1，如果内容图片大于等于1，小于3  单图  type 1</span><br><span class="hljs-comment">     * 2，如果内容图片大于等于3  多图  type 3</span><br><span class="hljs-comment">     * 3，如果内容没有图片，无图  type 0</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * 第二个功能：保存封面图片与素材的关系</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> dto</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> wmNews</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> materials</span><br><span class="hljs-comment">     */</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveRelativeInfoForCover</span><span class="hljs-params">(WmNewsDto dto, WmNews wmNews, List&lt;String&gt; materials)</span> &#123;<br><br>    List&lt;String&gt; images = dto.getImages();<br><br>    <span class="hljs-comment">//如果当前封面类型为自动，则设置封面类型的数据</span><br>    <span class="hljs-keyword">if</span>(dto.getType().equals(WemediaConstants.WM_NEWS_TYPE_AUTO))&#123;<br>        <span class="hljs-comment">//多图</span><br>        <span class="hljs-keyword">if</span>(materials.size() &gt;= <span class="hljs-number">3</span>)&#123;<br>            wmNews.setType(WemediaConstants.WM_NEWS_MANY_IMAGE);<br>            images = materials.stream().limit(<span class="hljs-number">3</span>).collect(Collectors.toList());<br>        &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(materials.size() &gt;= <span class="hljs-number">1</span> &amp;&amp; materials.size() &lt; <span class="hljs-number">3</span>)&#123;<br>            <span class="hljs-comment">//单图</span><br>            wmNews.setType(WemediaConstants.WM_NEWS_SINGLE_IMAGE);<br>            images = materials.stream().limit(<span class="hljs-number">1</span>).collect(Collectors.toList());<br>        &#125;<span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">//无图</span><br>            wmNews.setType(WemediaConstants.WM_NEWS_NONE_IMAGE);<br>        &#125;<br><br>        <span class="hljs-comment">//修改文章</span><br>        <span class="hljs-keyword">if</span>(images != <span class="hljs-literal">null</span> &amp;&amp; images.size() &gt; <span class="hljs-number">0</span>)&#123;<br>            wmNews.setImages(StringUtils.join(images,<span class="hljs-string">&quot;,&quot;</span>));<br>        &#125;<br>        updateById(wmNews);<br>    &#125;<br>    <span class="hljs-keyword">if</span>(images != <span class="hljs-literal">null</span> &amp;&amp; images.size() &gt; <span class="hljs-number">0</span>)&#123;<br>        saveRelativeInfo(images,wmNews.getId(),WemediaConstants.WM_COVER_REFERENCE);<br>    &#125;<br><br>&#125;<br><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 处理文章内容图片与素材的关系</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> materials</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> newsId</span><br><span class="hljs-comment">     */</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveRelativeInfoForContent</span><span class="hljs-params">(List&lt;String&gt; materials, Integer newsId)</span> &#123;<br>    saveRelativeInfo(materials,newsId,WemediaConstants.WM_CONTENT_REFERENCE);<br>&#125;<br><br><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> WmMaterialMapper wmMaterialMapper;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 保存文章图片与素材的关系到数据库中</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> materials</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> newsId</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> type</span><br><span class="hljs-comment">     */</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveRelativeInfo</span><span class="hljs-params">(List&lt;String&gt; materials, Integer newsId, Short type)</span> &#123;<br>    <span class="hljs-keyword">if</span>(materials!=<span class="hljs-literal">null</span> &amp;&amp; !materials.isEmpty())&#123;<br>        <span class="hljs-comment">//通过图片的url查询素材的id</span><br>        List&lt;WmMaterial&gt; dbMaterials = wmMaterialMapper.selectList(Wrappers.&lt;WmMaterial&gt;lambdaQuery().in(WmMaterial::getUrl, materials));<br><br>        <span class="hljs-comment">//判断素材是否有效</span><br>        <span class="hljs-keyword">if</span>(dbMaterials==<span class="hljs-literal">null</span> || dbMaterials.size() == <span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-comment">//手动抛出异常   第一个功能：能够提示调用者素材失效了，第二个功能，进行数据的回滚</span><br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomException</span>(AppHttpCodeEnum.MATERIASL_REFERENCE_FAIL);<br>        &#125;<br><br>        <span class="hljs-keyword">if</span>(materials.size() != dbMaterials.size())&#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomException</span>(AppHttpCodeEnum.MATERIASL_REFERENCE_FAIL);<br>        &#125;<br><br>        List&lt;Integer&gt; idList = dbMaterials.stream().map(WmMaterial::getId).collect(Collectors.toList());<br><br>        <span class="hljs-comment">//批量保存</span><br>        wmNewsMaterialMapper.saveRelations(idList,newsId,type);<br>    &#125;<br><br>&#125;<br><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 提取文章内容中的图片信息</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> content</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br><span class="hljs-keyword">private</span> List&lt;String&gt; <span class="hljs-title function_">ectractUrlInfo</span><span class="hljs-params">(String content)</span> &#123;<br>    List&lt;String&gt; materials = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><br>    List&lt;Map&gt; maps = JSON.parseArray(content, Map.class);<br>    <span class="hljs-keyword">for</span> (Map map : maps) &#123;<br>        <span class="hljs-keyword">if</span>(map.get(<span class="hljs-string">&quot;type&quot;</span>).equals(<span class="hljs-string">&quot;image&quot;</span>))&#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">imgUrl</span> <span class="hljs-operator">=</span> (String) map.get(<span class="hljs-string">&quot;value&quot;</span>);<br>            materials.add(imgUrl);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> materials;<br>&#125;<br><br><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> WmNewsMaterialMapper wmNewsMaterialMapper;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 保存或修改文章</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> wmNews</span><br><span class="hljs-comment">     */</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveOrUpdateWmNews</span><span class="hljs-params">(WmNews wmNews)</span> &#123;<br>    <span class="hljs-comment">//补全属性</span><br>    wmNews.setUserId(WmThreadLocalUtil.getUser().getId());<br>    wmNews.setCreatedTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>    wmNews.setSubmitedTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>    wmNews.setEnable((<span class="hljs-type">short</span>)<span class="hljs-number">1</span>);<span class="hljs-comment">//默认上架</span><br><br>    <span class="hljs-keyword">if</span>(wmNews.getId() == <span class="hljs-literal">null</span>)&#123;<br>        <span class="hljs-comment">//保存</span><br>        save(wmNews);<br>    &#125;<span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">//修改</span><br>        <span class="hljs-comment">//删除文章图片与素材的关系</span><br>        wmNewsMaterialMapper.delete(Wrappers.&lt;WmNewsMaterial&gt;lambdaQuery().eq(WmNewsMaterial::getNewsId,wmNews.getId()));<br>        updateById(wmNews);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>④：控制器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@PostMapping(&quot;/submit&quot;)</span><br><span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">submitNews</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> WmNewsDto dto)</span>&#123;<br>    <span class="hljs-keyword">return</span>  wmNewsService.submitNews(dto);<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="3-3-6-测试"><a href="#3-3-6-测试" class="headerlink" title="3.3.6)测试"></a>3.3.6)测试</h5><h1 id="4-自媒体文章-自动审核"><a href="#4-自媒体文章-自动审核" class="headerlink" title="4 自媒体文章-自动审核"></a>4 自媒体文章-自动审核</h1><h3 id="1-自媒体文章自动审核流程"><a href="#1-自媒体文章自动审核流程" class="headerlink" title="1)自媒体文章自动审核流程"></a>1)自媒体文章自动审核流程</h3><p><img src="/../images/image-20210504211635199.png" srcset="/img/loading.gif" lazyload alt="image-20210504211635199"></p>
<blockquote>
<p>1 自媒体端发布文章后，开始审核文章</p>
<p>2 审核的主要是审核文章的内容（文本内容和图片）</p>
<p>3 借助第三方提供的接口审核文本</p>
<p>4 借助第三方提供的接口审核图片，由于图片存储到minIO中，需要先下载才能审核</p>
<p>5 如果审核失败，则需要修改自媒体文章的状态，status:2  审核失败    status:3  转到人工审核</p>
<p>6 如果审核成功，则需要在文章微服务中创建app端需要的文章</p>
</blockquote>
<h3 id="2-内容安全第三方接口"><a href="#2-内容安全第三方接口" class="headerlink" title="2)内容安全第三方接口"></a>2)内容安全第三方接口</h3><h4 id="2-1-概述"><a href="#2-1-概述" class="headerlink" title="2.1)概述"></a>2.1)概述</h4><p>内容安全是识别服务，支持对图片、视频、文本、语音等对象进行多样化场景检测，有效降低内容违规风险。</p>
<p>目前很多平台都支持内容检测，如阿里云、腾讯云、百度AI、网易云等国内大型互联网公司都对外提供了API。</p>
<p>按照性能和收费来看，黑马头条项目使用的就是阿里云的内容安全接口，使用到了图片和文本的审核。</p>
<p>阿里云收费标准：<a target="_blank" rel="noopener" href="https://www.aliyun.com/price/product/?spm=a2c4g.11186623.2.10.4146401eg5oeu8">https://www.aliyun.com/price/product/?spm=a2c4g.11186623.2.10.4146401eg5oeu8#/lvwang/detail</a> </p>
<h4 id="2-2-准备工作"><a href="#2-2-准备工作" class="headerlink" title="2.2)准备工作"></a>2.2)准备工作</h4><p>您在使用内容检测API之前，需要先注册阿里云账号，添加Access Key并签约云盾内容安全。</p>
<p><strong>操作步骤</strong></p>
<ol>
<li><p>前往<a target="_blank" rel="noopener" href="https://www.aliyun.com/">阿里云官网</a>注册账号。如果已有注册账号，请跳过此步骤。</p>
<p> 进入阿里云首页后，如果没有阿里云的账户需要先进行注册，才可以进行登录。由于注册较为简单，课程和讲义不在进行体现（注册可以使用多种方式，如淘宝账号、支付宝账号、微博账号等…）。</p>
<p> 需要实名认证和活体认证。</p>
</li>
<li><p>打开<a target="_blank" rel="noopener" href="https://promotion.aliyun.com/ntms/act/lvwangdemo.html">云盾内容安全产品试用页面</a>，单击<strong>立即开通</strong>，正式开通服务。</p>
<p> <img src="/../images/image-20210504213452171.png" srcset="/img/loading.gif" lazyload alt="image-20210504213452171"></p>
<p> 内容安全控制台</p>
<p> <img src="/../images/image-20210504213510896.png" srcset="/img/loading.gif" lazyload alt="image-20210504213510896"></p>
</li>
<li><p>在<a target="_blank" rel="noopener" href="https://ak-console.aliyun.com/#/accesskey">AccessKey管理页面</a>管理您的AccessKeyID和AccessKeySecret。</p>
<p> <img src="/../images/image-20210504213530641.png" srcset="/img/loading.gif" lazyload alt="image-20210504213530641"></p>
<p> 管理自己的AccessKey,可以新建和删除AccessKey</p>
<p> <img src="/../images/image-20210504213547219.png" srcset="/img/loading.gif" lazyload alt="image-20210504213547219"></p>
<p> 查看自己的AccessKey，</p>
<p> AccessKey默认是隐藏的，第一次申请的时候可以保存AccessKey，点击显示，通过验证手机号后也可以查看</p>
<p> <img src="/../images/image-20210504213605004.png" srcset="/img/loading.gif" lazyload alt="image-20210504213605004"></p>
</li>
</ol>
<h4 id="2-3-文本内容审核接口"><a href="#2-3-文本内容审核接口" class="headerlink" title="2.3)文本内容审核接口"></a>2.3)文本内容审核接口</h4><p>文本垃圾内容检测：<a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/70439.html?spm=a2c4g.11186623.6.659.35ac3db3l0wV5k">https://help.aliyun.com/document_detail/70439.html?spm=a2c4g.11186623.6.659.35ac3db3l0wV5k</a> </p>
<p><img src="/../images/image-20210504213640667.png" srcset="/img/loading.gif" lazyload alt="image-20210504213640667"></p>
<p>文本垃圾内容Java SDK: <a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/53427.html?spm=a2c4g.11186623.6.717.466d7544QbU8Lr">https://help.aliyun.com/document_detail/53427.html?spm=a2c4g.11186623.6.717.466d7544QbU8Lr</a> </p>
<h4 id="2-4-图片审核接口"><a href="#2-4-图片审核接口" class="headerlink" title="2.4)图片审核接口"></a>2.4)图片审核接口</h4><p>图片垃圾内容检测：<a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/70292.html?spm=a2c4g.11186623.6.616.5d7d1e7f9vDRz4">https://help.aliyun.com/document_detail/70292.html?spm=a2c4g.11186623.6.616.5d7d1e7f9vDRz4</a> </p>
<p><img src="/../images/image-20210504213719323.png" srcset="/img/loading.gif" lazyload alt="image-20210504213719323"></p>
<p>图片垃圾内容Java SDK: <a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/53424.html?spm=a2c4g.11186623.6.715.c8f69b12ey35j4">https://help.aliyun.com/document_detail/53424.html?spm=a2c4g.11186623.6.715.c8f69b12ey35j4</a> </p>
<h4 id="2-5-项目集成"><a href="#2-5-项目集成" class="headerlink" title="2.5)项目集成"></a>2.5)项目集成</h4><p>①：拷贝资料文件夹中的类到common模块下面，并添加到自动配置</p>
<p> 包括了GreenImageScan和GreenTextScan及对应的工具类</p>
<p><img src="/../images/image-20210504213812303.png" srcset="/img/loading.gif" lazyload alt="image-20210504213812303"></p>
<p>添加到自动配置中</p>
<p><img src="/../images/image-20210504214013276.png" srcset="/img/loading.gif" lazyload alt="image-20210504214013276"></p>
<p>②： accessKeyId和secret（需自己申请）</p>
<p>在heima-leadnews-wemedia中的nacos配置中心添加以下配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">aliyun:</span><br> <span class="hljs-attr">accessKeyId:</span> <span class="hljs-string">LTAI5tCWHCcfvqQzu8k2oKmX</span><br> <span class="hljs-attr">secret:</span> <span class="hljs-string">auoKUFsghimbfVQHpy7gtRyBkoR4vc</span><br><span class="hljs-comment">#aliyun.scenes=porn,terrorism,ad,qrcode,live,logo</span><br> <span class="hljs-attr">scenes:</span> <span class="hljs-string">terrorism</span><br></code></pre></td></tr></table></figure>

<p>③：在自媒体微服务中测试类中注入审核文本和图片的bean进行测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.wemedia;<br><br><span class="hljs-keyword">import</span> com.heima.common.aliyun.GreenImageScan;<br><span class="hljs-keyword">import</span> com.heima.common.aliyun.GreenTextScan;<br><span class="hljs-keyword">import</span> com.heima.file.service.FileStorageService;<br><span class="hljs-keyword">import</span> org.junit.Test;<br><span class="hljs-keyword">import</span> org.junit.runner.RunWith;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;<br><span class="hljs-keyword">import</span> org.springframework.test.context.junit4.SpringRunner;<br><br><span class="hljs-keyword">import</span> java.util.Arrays;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-meta">@SpringBootTest(classes = WemediaApplication.class)</span><br><span class="hljs-meta">@RunWith(SpringRunner.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AliyunTest</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> GreenTextScan greenTextScan;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> GreenImageScan greenImageScan;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> FileStorageService fileStorageService;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testScanText</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> greenTextScan.greeTextScan(<span class="hljs-string">&quot;我是一个好人,冰毒&quot;</span>);<br>        System.out.println(map);<br>    &#125;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testScanImage</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">byte</span>[] bytes = fileStorageService.downLoadFile(<span class="hljs-string">&quot;http://192.168.200.130:9000/leadnews/2021/04/26/ef3cbe458db249f7bd6fb4339e593e55.jpg&quot;</span>);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> greenImageScan.imageScan(Arrays.asList(bytes));<br>        System.out.println(map);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="3-app端文章保存接口"><a href="#3-app端文章保存接口" class="headerlink" title="3)app端文章保存接口"></a>3)app端文章保存接口</h3><h4 id="3-1-表结构说明"><a href="#3-1-表结构说明" class="headerlink" title="3.1)表结构说明"></a>3.1)表结构说明</h4><p>ap_article 文章信息表</p>
<p><img src="/../images/image-20210505005300287.png" srcset="/img/loading.gif" lazyload alt="image-20210505005300287"></p>
<p>ap_article_config  文章配置表</p>
<p><img src="/../images/image-20210505005353286.png" srcset="/img/loading.gif" lazyload alt="image-20210505005353286"></p>
<p>ap_article_content 文章内容表</p>
<p><img src="/../images/image-20210505005407987.png" srcset="/img/loading.gif" lazyload alt="image-20210505005407987"></p>
<h4 id="3-2-分布式id"><a href="#3-2-分布式id" class="headerlink" title="3.2)分布式id"></a>3.2)分布式id</h4><p>随着业务的增长，文章表可能要占用很大的物理存储空间，为了解决该问题，后期使用数据库分片技术。将一个数据库进行拆分，通过数据库中间件连接。如果数据库中该表选用ID自增策略，则可能产生重复的ID，此时应该使用分布式ID生成策略来生成ID。</p>
<p><img src="/../images/image-20210505005448995.png" srcset="/img/loading.gif" lazyload alt="image-20210505005448995"></p>
<p>snowflake是Twitter开源的分布式ID生成算法，结果是一个long型的ID。其核心思想是：使用41bit作为毫秒数，10bit作为机器的ID（5个bit是数据中心，5个bit的机器ID），12bit作为毫秒内的流水号（意味着每个节点在每毫秒可以产生 4096 个 ID），最后还有一个符号位，永远是0</p>
<p><img src="/../images/image-20210505005509258.png" srcset="/img/loading.gif" lazyload alt="image-20210505005509258"></p>
<p>文章端相关的表都使用雪花算法生成id,包括ap_article、 ap_article_config、 ap_article_content</p>
<p>mybatis-plus已经集成了雪花算法，完成以下两步即可在项目中集成雪花算法</p>
<p>第一：在实体类中的id上加入如下配置，指定类型为id_worker</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@TableId(value = &quot;id&quot;,type = IdType.ID_WORKER)</span><br><span class="hljs-keyword">private</span> Long id;<br></code></pre></td></tr></table></figure>

<p>第二：在application.yml文件中配置数据中心id和机器id</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">mybatis-plus:</span><br>  <span class="hljs-attr">mapper-locations:</span> <span class="hljs-string">classpath*:mapper/*.xml</span><br>  <span class="hljs-comment"># 设置别名包扫描路径，通过该属性可以给包中的类注册别名</span><br>  <span class="hljs-attr">type-aliases-package:</span> <span class="hljs-string">com.heima.model.article.pojos</span><br>  <span class="hljs-attr">global-config:</span><br>    <span class="hljs-attr">datacenter-id:</span> <span class="hljs-number">1</span><br>    <span class="hljs-attr">workerId:</span> <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure>

<p>datacenter-id:数据中心id(取值范围：0-31)</p>
<p>workerId:机器id(取值范围：0-31)</p>
<h4 id="3-3-思路分析"><a href="#3-3-思路分析" class="headerlink" title="3.3)思路分析"></a>3.3)思路分析</h4><p>在文章审核成功以后需要在app的article库中新增文章数据</p>
<p>1.保存文章信息 ap_article</p>
<p>2.保存文章配置信息 ap_article_config</p>
<p>3.保存文章内容 ap_article_content</p>
<p>实现思路：</p>
<p><img src="/../images/image-20210505005733405.png" srcset="/img/loading.gif" lazyload alt="image-20210505005733405"></p>
<h4 id="3-4-feign接口"><a href="#3-4-feign接口" class="headerlink" title="3.4)feign接口"></a>3.4)feign接口</h4><table>
<thead>
<tr>
<th></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>接口路径</td>
<td>/api/v1/article/save</td>
</tr>
<tr>
<td>请求方式</td>
<td>POST</td>
</tr>
<tr>
<td>参数</td>
<td>ArticleDto</td>
</tr>
<tr>
<td>响应结果</td>
<td>ResponseResult</td>
</tr>
</tbody></table>
<p>ArticleDto</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.model.article.dtos;<br><br><span class="hljs-keyword">import</span> com.heima.model.article.pojos.ApArticle;<br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArticleDto</span>  <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ApArticle</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 文章内容</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String content;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>成功：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;code&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">200</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;errorMessage&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;操作成功&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;data&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;1302864436297442242&quot;</span><br> <span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>失败：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;code&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">501</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;errorMessage&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;参数失效&quot;</span><span class="hljs-punctuation">,</span><br> <span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;code&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">501</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;errorMessage&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;文章没有找到&quot;</span><span class="hljs-punctuation">,</span><br> <span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>功能实现：</p>
<p>①：在heima-leadnews-feign-api中新增接口</p>
<p>第一：线导入feign的依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>第二：定义文章端的接口</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs json">package com.heima.apis.article;<br><br>import com.heima.model.article.dtos.ArticleDto;<br>import com.heima.model.common.dtos.ResponseResult;<br>import org.springframework.cloud.openfeign.FeignClient;<br>import org.springframework.web.bind.annotation.PostMapping;<br>import org.springframework.web.bind.annotation.RequestBody;<br><br>import java.io.IOException;<br><br><br>@FeignClient(value = <span class="hljs-string">&quot;leadnews-article&quot;</span>)<br>public interface IArticleClient <span class="hljs-punctuation">&#123;</span><br><br>    @PostMapping(<span class="hljs-string">&quot;/api/v1/article/save&quot;</span>)<br>    public ResponseResult saveArticle(@RequestBody ArticleDto dto) ;<br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>②：在heima-leadnews-article中实现该方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.article.feign;<br><br><span class="hljs-keyword">import</span> com.heima.apis.article.IArticleClient;<br><span class="hljs-keyword">import</span> com.heima.article.service.ApArticleService;<br><span class="hljs-keyword">import</span> com.heima.model.article.dtos.ArticleDto;<br><span class="hljs-keyword">import</span> com.heima.model.common.dtos.ResponseResult;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.*;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArticleClient</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IArticleClient</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ApArticleService apArticleService;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-meta">@PostMapping(&quot;/api/v1/article/save&quot;)</span><br>    <span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">saveArticle</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> ArticleDto dto)</span> &#123;<br>        <span class="hljs-keyword">return</span> apArticleService.saveArticle(dto);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>③：拷贝mapper</p>
<p>在资料文件夹中拷贝ApArticleConfigMapper类到mapper文件夹中</p>
<p>同时，修改ApArticleConfig类，添加如下构造函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.model.article.pojos;<br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.IdType;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.TableField;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.TableId;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.TableName;<br><span class="hljs-keyword">import</span> lombok.Data;<br><span class="hljs-keyword">import</span> lombok.NoArgsConstructor;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * &lt;p&gt;</span><br><span class="hljs-comment"> * APP已发布文章配置表</span><br><span class="hljs-comment"> * &lt;/p&gt;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> itheima</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@NoArgsConstructor</span><br><span class="hljs-meta">@TableName(&quot;ap_article_config&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApArticleConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ApArticleConfig</span><span class="hljs-params">(Long articleId)</span>&#123;<br>        <span class="hljs-built_in">this</span>.articleId = articleId;<br>        <span class="hljs-built_in">this</span>.isComment = <span class="hljs-literal">true</span>;<br>        <span class="hljs-built_in">this</span>.isForward = <span class="hljs-literal">true</span>;<br>        <span class="hljs-built_in">this</span>.isDelete = <span class="hljs-literal">false</span>;<br>        <span class="hljs-built_in">this</span>.isDown = <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@TableId(value = &quot;id&quot;,type = IdType.ID_WORKER)</span><br>    <span class="hljs-keyword">private</span> Long id;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 文章id</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;article_id&quot;)</span><br>    <span class="hljs-keyword">private</span> Long articleId;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 是否可评论</span><br><span class="hljs-comment">     * true: 可以评论   1</span><br><span class="hljs-comment">     * false: 不可评论  0</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;is_comment&quot;)</span><br>    <span class="hljs-keyword">private</span> Boolean isComment;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 是否转发</span><br><span class="hljs-comment">     * true: 可以转发   1</span><br><span class="hljs-comment">     * false: 不可转发  0</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;is_forward&quot;)</span><br>    <span class="hljs-keyword">private</span> Boolean isForward;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 是否下架</span><br><span class="hljs-comment">     * true: 下架   1</span><br><span class="hljs-comment">     * false: 没有下架  0</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;is_down&quot;)</span><br>    <span class="hljs-keyword">private</span> Boolean isDown;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 是否已删除</span><br><span class="hljs-comment">     * true: 删除   1</span><br><span class="hljs-comment">     * false: 没有删除  0</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;is_delete&quot;)</span><br>    <span class="hljs-keyword">private</span> Boolean isDelete;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>④：在ApArticleService中新增方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 保存app端相关文章</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> dto</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>ResponseResult <span class="hljs-title function_">saveArticle</span><span class="hljs-params">(ArticleDto dto)</span> ;<br></code></pre></td></tr></table></figure>

<p>实现类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> ApArticleConfigMapper apArticleConfigMapper;<br><br><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> ApArticleContentMapper apArticleContentMapper;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 保存app端相关文章</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> dto</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">saveArticle</span><span class="hljs-params">(ArticleDto dto)</span> &#123;<br>    <span class="hljs-comment">//1.检查参数</span><br>    <span class="hljs-keyword">if</span>(dto == <span class="hljs-literal">null</span>)&#123;<br>        <span class="hljs-keyword">return</span> ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID);<br>    &#125;<br><br>    <span class="hljs-type">ApArticle</span> <span class="hljs-variable">apArticle</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApArticle</span>();<br>    BeanUtils.copyProperties(dto,apArticle);<br><br>    <span class="hljs-comment">//2.判断是否存在id</span><br>    <span class="hljs-keyword">if</span>(dto.getId() == <span class="hljs-literal">null</span>)&#123;<br>        <span class="hljs-comment">//2.1 不存在id  保存  文章  文章配置  文章内容</span><br><br>        <span class="hljs-comment">//保存文章</span><br>        save(apArticle);<br><br>        <span class="hljs-comment">//保存配置</span><br>        <span class="hljs-type">ApArticleConfig</span> <span class="hljs-variable">apArticleConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApArticleConfig</span>(apArticle.getId());<br>        apArticleConfigMapper.insert(apArticleConfig);<br><br>        <span class="hljs-comment">//保存 文章内容</span><br>        <span class="hljs-type">ApArticleContent</span> <span class="hljs-variable">apArticleContent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApArticleContent</span>();<br>        apArticleContent.setArticleId(apArticle.getId());<br>        apArticleContent.setContent(dto.getContent());<br>        apArticleContentMapper.insert(apArticleContent);<br><br>    &#125;<span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">//2.2 存在id   修改  文章  文章内容</span><br><br>        <span class="hljs-comment">//修改  文章</span><br>        updateById(apArticle);<br><br>        <span class="hljs-comment">//修改文章内容</span><br>        <span class="hljs-type">ApArticleContent</span> <span class="hljs-variable">apArticleContent</span> <span class="hljs-operator">=</span> apArticleContentMapper.selectOne(Wrappers.&lt;ApArticleContent&gt;lambdaQuery().eq(ApArticleContent::getArticleId, dto.getId()));<br>        apArticleContent.setContent(dto.getContent());<br>        apArticleContentMapper.updateById(apArticleContent);<br>    &#125;<br><br><br>    <span class="hljs-comment">//3.结果返回  文章的id</span><br>    <span class="hljs-keyword">return</span> ResponseResult.okResult(apArticle.getId());<br>&#125;<br></code></pre></td></tr></table></figure>

<p>⑤：测试</p>
<p>编写junit单元测试，或使用postman进行测试</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>	<span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">1390209114747047938</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;黑马头条项目背景22222222222222&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;authoId&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">1102</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;layout&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;labels&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;黑马头条&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;publishTime&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;2028-03-14T11:35:49.000Z&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;images&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;http://192.168.200.130:9000/leadnews/2021/04/26/5ddbdb5c68094ce393b08a47860da275.jpg&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;content&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;22222222222222222黑马头条项目背景,黑马头条项目背景,黑马头条项目背景,黑马头条项目背景，黑马头条项目背景&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>



<h3 id="4-自媒体文章自动审核功能实现"><a href="#4-自媒体文章自动审核功能实现" class="headerlink" title="4)自媒体文章自动审核功能实现"></a>4)自媒体文章自动审核功能实现</h3><h4 id="4-1-表结构说明"><a href="#4-1-表结构说明" class="headerlink" title="4.1)表结构说明"></a>4.1)表结构说明</h4><p>wm_news 自媒体文章表</p>
<p><img src="/../images/image-20210505010728156.png" srcset="/img/loading.gif" lazyload alt="image-20210505010728156"></p>
<p>status字段：0 草稿  1 待审核  2 审核失败  3 人工审核  4 人工审核通过  8 审核通过（待发布） 9 已发布</p>
<h4 id="4-2-实现"><a href="#4-2-实现" class="headerlink" title="4.2)实现"></a>4.2)实现</h4><p><img src="/../images/image-20210505010755954.png" srcset="/img/loading.gif" lazyload alt="image-20210505010755954"></p>
<p>在heima-leadnews-wemedia中的service新增接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.wemedia.service;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">WmNewsAutoScanService</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 自媒体文章审核</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> id  自媒体文章id</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">autoScanWmNews</span><span class="hljs-params">(Integer id)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>实现类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.wemedia.service.impl;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSONArray;<br><span class="hljs-keyword">import</span> com.heima.apis.article.IArticleClient;<br><span class="hljs-keyword">import</span> com.heima.common.aliyun.GreenImageScan;<br><span class="hljs-keyword">import</span> com.heima.common.aliyun.GreenTextScan;<br><span class="hljs-keyword">import</span> com.heima.file.service.FileStorageService;<br><span class="hljs-keyword">import</span> com.heima.model.article.dtos.ArticleDto;<br><span class="hljs-keyword">import</span> com.heima.model.common.dtos.ResponseResult;<br><span class="hljs-keyword">import</span> com.heima.model.wemedia.pojos.WmChannel;<br><span class="hljs-keyword">import</span> com.heima.model.wemedia.pojos.WmNews;<br><span class="hljs-keyword">import</span> com.heima.model.wemedia.pojos.WmUser;<br><span class="hljs-keyword">import</span> com.heima.wemedia.mapper.WmChannelMapper;<br><span class="hljs-keyword">import</span> com.heima.wemedia.mapper.WmNewsMapper;<br><span class="hljs-keyword">import</span> com.heima.wemedia.mapper.WmUserMapper;<br><span class="hljs-keyword">import</span> com.heima.wemedia.service.WmNewsAutoScanService;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.apache.commons.lang3.StringUtils;<br><span class="hljs-keyword">import</span> org.springframework.beans.BeanUtils;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><span class="hljs-keyword">import</span> org.springframework.transaction.annotation.Transactional;<br><br><span class="hljs-keyword">import</span> java.util.*;<br><span class="hljs-keyword">import</span> java.util.stream.Collectors;<br><br><br><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Transactional</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WmNewsAutoScanServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WmNewsAutoScanService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> WmNewsMapper wmNewsMapper;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 自媒体文章审核</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> id 自媒体文章id</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">autoScanWmNews</span><span class="hljs-params">(Integer id)</span> &#123;<br>        <span class="hljs-comment">//1.查询自媒体文章</span><br>        <span class="hljs-type">WmNews</span> <span class="hljs-variable">wmNews</span> <span class="hljs-operator">=</span> wmNewsMapper.selectById(id);<br>        <span class="hljs-keyword">if</span>(wmNews == <span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;WmNewsAutoScanServiceImpl-文章不存在&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">if</span>(wmNews.getStatus().equals(WmNews.Status.SUBMIT.getCode()))&#123;<br>            <span class="hljs-comment">//从内容中提取纯文本内容和图片</span><br>            Map&lt;String,Object&gt; textAndImages = handleTextAndImages(wmNews);<br><br>            <span class="hljs-comment">//2.审核文本内容  阿里云接口</span><br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">isTextScan</span> <span class="hljs-operator">=</span> handleTextScan((String) textAndImages.get(<span class="hljs-string">&quot;content&quot;</span>),wmNews);<br>            <span class="hljs-keyword">if</span>(!isTextScan)<span class="hljs-keyword">return</span>;<br><br>            <span class="hljs-comment">//3.审核图片  阿里云接口</span><br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">isImageScan</span> <span class="hljs-operator">=</span>  handleImageScan((List&lt;String&gt;) textAndImages.get(<span class="hljs-string">&quot;images&quot;</span>),wmNews);<br>            <span class="hljs-keyword">if</span>(!isImageScan)<span class="hljs-keyword">return</span>;<br><br>            <span class="hljs-comment">//4.审核成功，保存app端的相关的文章数据</span><br>            <span class="hljs-type">ResponseResult</span> <span class="hljs-variable">responseResult</span> <span class="hljs-operator">=</span> saveAppArticle(wmNews);<br>            <span class="hljs-keyword">if</span>(!responseResult.getCode().equals(<span class="hljs-number">200</span>))&#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;WmNewsAutoScanServiceImpl-文章审核，保存app端相关文章数据失败&quot;</span>);<br>            &#125;<br>            <span class="hljs-comment">//回填article_id</span><br>            wmNews.setArticleId((Long) responseResult.getData());<br>            updateWmNews(wmNews,(<span class="hljs-type">short</span>) <span class="hljs-number">9</span>,<span class="hljs-string">&quot;审核成功&quot;</span>);<br><br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> IArticleClient articleClient;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> WmChannelMapper wmChannelMapper;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> WmUserMapper wmUserMapper;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 保存app端相关的文章数据</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> wmNews</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> ResponseResult <span class="hljs-title function_">saveAppArticle</span><span class="hljs-params">(WmNews wmNews)</span> &#123;<br><br>        <span class="hljs-type">ArticleDto</span> <span class="hljs-variable">dto</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArticleDto</span>();<br>        <span class="hljs-comment">//属性的拷贝</span><br>        BeanUtils.copyProperties(wmNews,dto);<br>        <span class="hljs-comment">//文章的布局</span><br>        dto.setLayout(wmNews.getType());<br>        <span class="hljs-comment">//频道</span><br>        <span class="hljs-type">WmChannel</span> <span class="hljs-variable">wmChannel</span> <span class="hljs-operator">=</span> wmChannelMapper.selectById(wmNews.getChannelId());<br>        <span class="hljs-keyword">if</span>(wmChannel != <span class="hljs-literal">null</span>)&#123;<br>            dto.setChannelName(wmChannel.getName());<br>        &#125;<br><br>        <span class="hljs-comment">//作者</span><br>        dto.setAuthorId(wmNews.getUserId().longValue());<br>        <span class="hljs-type">WmUser</span> <span class="hljs-variable">wmUser</span> <span class="hljs-operator">=</span> wmUserMapper.selectById(wmNews.getUserId());<br>        <span class="hljs-keyword">if</span>(wmUser != <span class="hljs-literal">null</span>)&#123;<br>            dto.setAuthorName(wmUser.getName());<br>        &#125;<br><br>        <span class="hljs-comment">//设置文章id</span><br>        <span class="hljs-keyword">if</span>(wmNews.getArticleId() != <span class="hljs-literal">null</span>)&#123;<br>            dto.setId(wmNews.getArticleId());<br>        &#125;<br>        dto.setCreatedTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br><br>        <span class="hljs-type">ResponseResult</span> <span class="hljs-variable">responseResult</span> <span class="hljs-operator">=</span> articleClient.saveArticle(dto);<br>        <span class="hljs-keyword">return</span> responseResult;<br><br>    &#125;<br><br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> FileStorageService fileStorageService;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> GreenImageScan greenImageScan;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 审核图片</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> images</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> wmNews</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">handleImageScan</span><span class="hljs-params">(List&lt;String&gt; images, WmNews wmNews)</span> &#123;<br><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br><br>        <span class="hljs-keyword">if</span>(images == <span class="hljs-literal">null</span> || images.size() == <span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-keyword">return</span> flag;<br>        &#125;<br><br>        <span class="hljs-comment">//下载图片 minIO</span><br>        <span class="hljs-comment">//图片去重</span><br>        images = images.stream().distinct().collect(Collectors.toList());<br><br>        List&lt;<span class="hljs-type">byte</span>[]&gt; imageList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><br>        <span class="hljs-keyword">for</span> (String image : images) &#123;<br>            <span class="hljs-type">byte</span>[] bytes = fileStorageService.downLoadFile(image);<br>            imageList.add(bytes);<br>        &#125;<br><br><br>        <span class="hljs-comment">//审核图片</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> greenImageScan.imageScan(imageList);<br>            <span class="hljs-keyword">if</span>(map != <span class="hljs-literal">null</span>)&#123;<br>                <span class="hljs-comment">//审核失败</span><br>                <span class="hljs-keyword">if</span>(map.get(<span class="hljs-string">&quot;suggestion&quot;</span>).equals(<span class="hljs-string">&quot;block&quot;</span>))&#123;<br>                    flag = <span class="hljs-literal">false</span>;<br>                    updateWmNews(wmNews, (<span class="hljs-type">short</span>) <span class="hljs-number">2</span>, <span class="hljs-string">&quot;当前文章中存在违规内容&quot;</span>);<br>                &#125;<br><br>                <span class="hljs-comment">//不确定信息  需要人工审核</span><br>                <span class="hljs-keyword">if</span>(map.get(<span class="hljs-string">&quot;suggestion&quot;</span>).equals(<span class="hljs-string">&quot;review&quot;</span>))&#123;<br>                    flag = <span class="hljs-literal">false</span>;<br>                    updateWmNews(wmNews, (<span class="hljs-type">short</span>) <span class="hljs-number">3</span>, <span class="hljs-string">&quot;当前文章中存在不确定内容&quot;</span>);<br>                &#125;<br>            &#125;<br><br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            flag = <span class="hljs-literal">false</span>;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">return</span> flag;<br>    &#125;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> GreenTextScan greenTextScan;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 审核纯文本内容</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> content</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> wmNews</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">handleTextScan</span><span class="hljs-params">(String content, WmNews wmNews)</span> &#123;<br><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br><br>        <span class="hljs-keyword">if</span>((wmNews.getTitle()+<span class="hljs-string">&quot;-&quot;</span>+content).length() == <span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-keyword">return</span> flag;<br>        &#125;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> greenTextScan.greeTextScan((wmNews.getTitle()+<span class="hljs-string">&quot;-&quot;</span>+content));<br>            <span class="hljs-keyword">if</span>(map != <span class="hljs-literal">null</span>)&#123;<br>                <span class="hljs-comment">//审核失败</span><br>                <span class="hljs-keyword">if</span>(map.get(<span class="hljs-string">&quot;suggestion&quot;</span>).equals(<span class="hljs-string">&quot;block&quot;</span>))&#123;<br>                    flag = <span class="hljs-literal">false</span>;<br>                    updateWmNews(wmNews, (<span class="hljs-type">short</span>) <span class="hljs-number">2</span>, <span class="hljs-string">&quot;当前文章中存在违规内容&quot;</span>);<br>                &#125;<br><br>                <span class="hljs-comment">//不确定信息  需要人工审核</span><br>                <span class="hljs-keyword">if</span>(map.get(<span class="hljs-string">&quot;suggestion&quot;</span>).equals(<span class="hljs-string">&quot;review&quot;</span>))&#123;<br>                    flag = <span class="hljs-literal">false</span>;<br>                    updateWmNews(wmNews, (<span class="hljs-type">short</span>) <span class="hljs-number">3</span>, <span class="hljs-string">&quot;当前文章中存在不确定内容&quot;</span>);<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            flag = <span class="hljs-literal">false</span>;<br>            e.printStackTrace();<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> flag;<br><br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 修改文章内容</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> wmNews</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> status</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> reason</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateWmNews</span><span class="hljs-params">(WmNews wmNews, <span class="hljs-type">short</span> status, String reason)</span> &#123;<br>        wmNews.setStatus(status);<br>        wmNews.setReason(reason);<br>        wmNewsMapper.updateById(wmNews);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 1。从自媒体文章的内容中提取文本和图片</span><br><span class="hljs-comment">     * 2.提取文章的封面图片</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> wmNews</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Map&lt;String, Object&gt; <span class="hljs-title function_">handleTextAndImages</span><span class="hljs-params">(WmNews wmNews)</span> &#123;<br><br>        <span class="hljs-comment">//存储纯文本内容</span><br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">stringBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br><br>        List&lt;String&gt; images = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><br>        <span class="hljs-comment">//1。从自媒体文章的内容中提取文本和图片</span><br>        <span class="hljs-keyword">if</span>(StringUtils.isNotBlank(wmNews.getContent()))&#123;<br>            List&lt;Map&gt; maps = JSONArray.parseArray(wmNews.getContent(), Map.class);<br>            <span class="hljs-keyword">for</span> (Map map : maps) &#123;<br>                <span class="hljs-keyword">if</span> (map.get(<span class="hljs-string">&quot;type&quot;</span>).equals(<span class="hljs-string">&quot;text&quot;</span>))&#123;<br>                    stringBuilder.append(map.get(<span class="hljs-string">&quot;value&quot;</span>));<br>                &#125;<br><br>                <span class="hljs-keyword">if</span> (map.get(<span class="hljs-string">&quot;type&quot;</span>).equals(<span class="hljs-string">&quot;image&quot;</span>))&#123;<br>                    images.add((String) map.get(<span class="hljs-string">&quot;value&quot;</span>));<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">//2.提取文章的封面图片</span><br>        <span class="hljs-keyword">if</span>(StringUtils.isNotBlank(wmNews.getImages()))&#123;<br>            String[] split = wmNews.getImages().split(<span class="hljs-string">&quot;,&quot;</span>);<br>            images.addAll(Arrays.asList(split));<br>        &#125;<br><br>        Map&lt;String, Object&gt; resultMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        resultMap.put(<span class="hljs-string">&quot;content&quot;</span>,stringBuilder.toString());<br>        resultMap.put(<span class="hljs-string">&quot;images&quot;</span>,images);<br>        <span class="hljs-keyword">return</span> resultMap;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="4-3-单元测试"><a href="#4-3-单元测试" class="headerlink" title="4.3)单元测试"></a>4.3)单元测试</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.wemedia.service;<br><br><span class="hljs-keyword">import</span> com.heima.wemedia.WemediaApplication;<br><span class="hljs-keyword">import</span> org.junit.Test;<br><span class="hljs-keyword">import</span> org.junit.runner.RunWith;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;<br><span class="hljs-keyword">import</span> org.springframework.test.context.junit4.SpringRunner;<br><br><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> org.junit.Assert.*;<br><br><br><span class="hljs-meta">@SpringBootTest(classes = WemediaApplication.class)</span><br><span class="hljs-meta">@RunWith(SpringRunner.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WmNewsAutoScanServiceTest</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> WmNewsAutoScanService wmNewsAutoScanService;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">autoScanWmNews</span><span class="hljs-params">()</span> &#123;<br><br>        wmNewsAutoScanService.autoScanWmNews(<span class="hljs-number">6238</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="4-4-feign远程接口调用方式"><a href="#4-4-feign远程接口调用方式" class="headerlink" title="4.4)feign远程接口调用方式"></a>4.4)feign远程接口调用方式</h4><p><img src="/../images/image-20210505010938575.png" srcset="/img/loading.gif" lazyload alt="image-20210505010938575"></p>
<p>在heima-leadnews-wemedia服务中已经依赖了heima-leadnews-feign-apis工程，只需要在自媒体的引导类中开启feign的远程调用即可</p>
<p>注解为：<code>@EnableFeignClients(basePackages = &quot;com.heima.apis&quot;)</code> 需要指向apis这个包</p>
<p><img src="/../images/image-20210507160209926.png" srcset="/img/loading.gif" lazyload alt="image-20210507160209926"></p>
<h4 id="4-5-服务降级处理"><a href="#4-5-服务降级处理" class="headerlink" title="4.5)服务降级处理"></a>4.5)服务降级处理</h4><p><img src="/../images/image-20210507160329016.png" srcset="/img/loading.gif" lazyload alt="image-20210507160329016"></p>
<ul>
<li><p>服务降级是服务自我保护的一种方式，或者保护下游服务的一种方式，用于确保服务不会受请求突增影响变得不可用，确保服务不会崩溃</p>
</li>
<li><p>服务降级虽然会导致请求失败，但是不会导致阻塞。</p>
</li>
</ul>
<p>实现步骤：</p>
<p>①：在heima-leadnews-feign-api编写降级逻辑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.apis.article.fallback;<br><br><span class="hljs-keyword">import</span> com.heima.apis.article.IArticleClient;<br><span class="hljs-keyword">import</span> com.heima.model.article.dtos.ArticleDto;<br><span class="hljs-keyword">import</span> com.heima.model.common.dtos.ResponseResult;<br><span class="hljs-keyword">import</span> com.heima.model.common.enums.AppHttpCodeEnum;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * feign失败配置</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> itheima</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IArticleClientFallback</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IArticleClient</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">saveArticle</span><span class="hljs-params">(ArticleDto dto)</span>  &#123;<br>        <span class="hljs-keyword">return</span> ResponseResult.errorResult(AppHttpCodeEnum.SERVER_ERROR,<span class="hljs-string">&quot;获取数据失败&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在自媒体微服务中添加类，扫描降级代码类的包</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.wemedia.config;<br><br><span class="hljs-keyword">import</span> org.springframework.context.annotation.ComponentScan;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@ComponentScan(&quot;com.heima.apis.article.fallback&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InitConfig</span> &#123;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>②：远程接口中指向降级代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.apis.article;<br><br><span class="hljs-keyword">import</span> com.heima.apis.article.fallback.IArticleClientFallback;<br><span class="hljs-keyword">import</span> com.heima.model.article.dtos.ArticleDto;<br><span class="hljs-keyword">import</span> com.heima.model.common.dtos.ResponseResult;<br><span class="hljs-keyword">import</span> org.springframework.cloud.openfeign.FeignClient;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PostMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestBody;<br><br><span class="hljs-meta">@FeignClient(value = &quot;leadnews-article&quot;,fallback = IArticleClientFallback.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IArticleClient</span> &#123;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/api/v1/article/save&quot;)</span><br>    <span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">saveArticle</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> ArticleDto dto)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>③：客户端开启降级heima-leadnews-wemedia</p>
<p>在wemedia的nacos配置中心里添加如下内容，开启服务降级，也可以指定服务响应的超时的时间</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">feign:</span><br>  <span class="hljs-comment"># 开启feign对hystrix熔断降级的支持</span><br>  <span class="hljs-attr">hystrix:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-comment"># 修改调用超时时间</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">config:</span><br>      <span class="hljs-attr">default:</span><br>        <span class="hljs-attr">connectTimeout:</span> <span class="hljs-number">2000</span><br>        <span class="hljs-attr">readTimeout:</span> <span class="hljs-number">2000</span><br></code></pre></td></tr></table></figure>

<p>④：测试</p>
<p>在ApArticleServiceImpl类中saveArticle方法添加代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">try</span> &#123;<br>    Thread.sleep(<span class="hljs-number">3000</span>);<br>&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>    e.printStackTrace();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在自媒体端进行审核测试，会出现服务降级的现象</p>
<h3 id="5-发布文章提交审核集成"><a href="#5-发布文章提交审核集成" class="headerlink" title="5)发布文章提交审核集成"></a>5)发布文章提交审核集成</h3><h4 id="5-1-同步调用与异步调用"><a href="#5-1-同步调用与异步调用" class="headerlink" title="5.1)同步调用与异步调用"></a>5.1)同步调用与异步调用</h4><p>同步：就是在发出一个调用时，在没有得到结果之前， 该调用就不返回（实时处理）</p>
<p>异步：调用在发出之后，这个调用就直接返回了，没有返回结果（分时处理）</p>
<p><img src="/../images/image-20210507160912993.png" srcset="/img/loading.gif" lazyload alt="image-20210507160912993"></p>
<p>异步线程的方式审核文章</p>
<h4 id="5-2-Springboot集成异步线程调用"><a href="#5-2-Springboot集成异步线程调用" class="headerlink" title="5.2)Springboot集成异步线程调用"></a>5.2)Springboot集成异步线程调用</h4><p>①：在自动审核的方法上加上@Async注解（标明要异步调用）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-meta">@Async</span>  <span class="hljs-comment">//标明当前方法是一个异步方法</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">autoScanWmNews</span><span class="hljs-params">(Integer id)</span> &#123;<br>	<span class="hljs-comment">//代码略</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>②：在文章发布成功后调用审核的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> WmNewsAutoScanService wmNewsAutoScanService;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 发布修改文章或保存为草稿</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> dto</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">submitNews</span><span class="hljs-params">(WmNewsDto dto)</span> &#123;<br><br>    <span class="hljs-comment">//代码略</span><br><br>    <span class="hljs-comment">//审核文章</span><br>    wmNewsAutoScanService.autoScanWmNews(wmNews.getId());<br><br>    <span class="hljs-keyword">return</span> ResponseResult.okResult(AppHttpCodeEnum.SUCCESS);<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>③：在自媒体引导类中使用@EnableAsync注解开启异步调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableDiscoveryClient</span><br><span class="hljs-meta">@MapperScan(&quot;com.heima.wemedia.mapper&quot;)</span><br><span class="hljs-meta">@EnableFeignClients(basePackages = &quot;com.heima.apis&quot;)</span><br><span class="hljs-meta">@EnableAsync</span>  <span class="hljs-comment">//开启异步调用</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WemediaApplication</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(WemediaApplication.class,args);<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> MybatisPlusInterceptor <span class="hljs-title function_">mybatisPlusInterceptor</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">MybatisPlusInterceptor</span> <span class="hljs-variable">interceptor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MybatisPlusInterceptor</span>();<br>        interceptor.addInnerInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PaginationInnerInterceptor</span>(DbType.MYSQL));<br>        <span class="hljs-keyword">return</span> interceptor;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="6-文章审核功能-综合测试"><a href="#6-文章审核功能-综合测试" class="headerlink" title="6)文章审核功能-综合测试"></a>6)文章审核功能-综合测试</h3><h4 id="6-1-服务启动列表"><a href="#6-1-服务启动列表" class="headerlink" title="6.1)服务启动列表"></a>6.1)服务启动列表</h4><p>1，nacos服务端</p>
<p>2，article微服务</p>
<p>3，wemedia微服务</p>
<p>4，启动wemedia网关微服务</p>
<p>5，启动前端系统wemedia</p>
<h4 id="6-2-测试情况列表"><a href="#6-2-测试情况列表" class="headerlink" title="6.2)测试情况列表"></a>6.2)测试情况列表</h4><p>1，自媒体前端发布一篇正常的文章</p>
<p>   审核成功后，app端的article相关数据是否可以正常保存，自媒体文章状态和app端文章id是否回显</p>
<p>2，自媒体前端发布一篇包含敏感词的文章</p>
<p>   正常是审核失败， wm_news表中的状态是否改变，成功和失败原因正常保存</p>
<p>3，自媒体前端发布一篇包含敏感图片的文章</p>
<p>   正常是审核失败， wm_news表中的状态是否改变，成功和失败原因正常保存</p>
<h3 id="7-新需求-自管理敏感词"><a href="#7-新需求-自管理敏感词" class="headerlink" title="7)新需求-自管理敏感词"></a>7)新需求-自管理敏感词</h3><h4 id="7-1-需求分析"><a href="#7-1-需求分析" class="headerlink" title="7.1)需求分析"></a>7.1)需求分析</h4><p>文章审核功能已经交付了，文章也能正常发布审核。突然，产品经理过来说要开会。</p>
<p>会议的内容核心有以下内容：</p>
<ul>
<li><p>文章审核不能过滤一些敏感词：</p>
<p>  私人侦探、针孔摄象、信用卡提现、广告代理、代开发票、刻章办、出售答案、小额贷款…</p>
</li>
</ul>
<p>需要完成的功能：</p>
<p>需要自己维护一套敏感词，在文章审核的时候，需要验证文章是否包含这些敏感词</p>
<h4 id="7-2-敏感词-过滤"><a href="#7-2-敏感词-过滤" class="headerlink" title="7.2)敏感词-过滤"></a>7.2)敏感词-过滤</h4><p>技术选型</p>
<table>
<thead>
<tr>
<th><strong>方案</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>数据库模糊查询</td>
<td>效率太低</td>
</tr>
<tr>
<td>String.indexOf(“”)查找</td>
<td>数据库量大的话也是比较慢</td>
</tr>
<tr>
<td>全文检索</td>
<td>分词再匹配</td>
</tr>
<tr>
<td>DFA算法</td>
<td>确定有穷自动机(一种数据结构)</td>
</tr>
</tbody></table>
<h4 id="7-3-DFA实现原理"><a href="#7-3-DFA实现原理" class="headerlink" title="7.3)DFA实现原理"></a>7.3)DFA实现原理</h4><p>DFA全称为：Deterministic Finite Automaton,即确定有穷自动机。</p>
<p>存储：一次性的把所有的敏感词存储到了多个map中，就是下图表示这种结构</p>
<p>敏感词：冰毒、大麻、大坏蛋</p>
<p><img src="/../images/image-20210524160517744.png" srcset="/img/loading.gif" lazyload alt="image-20210524160517744"></p>
<p>检索的过程</p>
<p><img src="/../images/image-20210524160549596.png" srcset="/img/loading.gif" lazyload alt="image-20210524160549596"></p>
<h4 id="7-4-自管理敏感词集成到文章审核中"><a href="#7-4-自管理敏感词集成到文章审核中" class="headerlink" title="7.4)自管理敏感词集成到文章审核中"></a>7.4)自管理敏感词集成到文章审核中</h4><p>①：创建敏感词表，导入资料中wm_sensitive到leadnews_wemedia库中</p>
<p><img src="/../images/image-20210524160611338.png" srcset="/img/loading.gif" lazyload alt="image-20210524160611338"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.model.wemedia.pojos;<br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.IdType;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.TableField;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.TableId;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.TableName;<br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><span class="hljs-keyword">import</span> java.util.Date;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * &lt;p&gt;</span><br><span class="hljs-comment"> * 敏感词信息表</span><br><span class="hljs-comment"> * &lt;/p&gt;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> itheima</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@TableName(&quot;wm_sensitive&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WmSensitive</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 主键</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableId(value = &quot;id&quot;, type = IdType.AUTO)</span><br>    <span class="hljs-keyword">private</span> Integer id;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 敏感词</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;sensitives&quot;)</span><br>    <span class="hljs-keyword">private</span> String sensitives;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 创建时间</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;created_time&quot;)</span><br>    <span class="hljs-keyword">private</span> Date createdTime;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>②：拷贝对应的wm_sensitive的mapper到项目中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.wemedia.mapper;<br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.mapper.BaseMapper;<br><span class="hljs-keyword">import</span> com.heima.model.wemedia.pojos.WmSensitive;<br><span class="hljs-keyword">import</span> org.apache.ibatis.annotations.Mapper;<br><br><br><span class="hljs-meta">@Mapper</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">WmSensitiveMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseMapper</span>&lt;WmSensitive&gt; &#123;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>③：在文章审核的代码中添加自管理敏感词审核</p>
<p>第一：在WmNewsAutoScanServiceImpl中的autoScanWmNews方法上添加如下代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//从内容中提取纯文本内容和图片</span><br><span class="hljs-comment">//.....省略</span><br><br><span class="hljs-comment">//自管理的敏感词过滤</span><br><span class="hljs-type">boolean</span> <span class="hljs-variable">isSensitive</span> <span class="hljs-operator">=</span> handleSensitiveScan((String) textAndImages.get(<span class="hljs-string">&quot;content&quot;</span>), wmNews);<br><span class="hljs-keyword">if</span>(!isSensitive) <span class="hljs-keyword">return</span>;<br><br><span class="hljs-comment">//2.审核文本内容  阿里云接口</span><br><span class="hljs-comment">//.....省略</span><br></code></pre></td></tr></table></figure>

<p>新增自管理敏感词审核代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> WmSensitiveMapper wmSensitiveMapper;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 自管理的敏感词审核</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> content</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> wmNews</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">handleSensitiveScan</span><span class="hljs-params">(String content, WmNews wmNews)</span> &#123;<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br><br>    <span class="hljs-comment">//获取所有的敏感词</span><br>    List&lt;WmSensitive&gt; wmSensitives = wmSensitiveMapper.selectList(Wrappers.&lt;WmSensitive&gt;lambdaQuery().select(WmSensitive::getSensitives));<br>    List&lt;String&gt; sensitiveList = wmSensitives.stream().map(WmSensitive::getSensitives).collect(Collectors.toList());<br><br>    <span class="hljs-comment">//初始化敏感词库</span><br>    SensitiveWordUtil.initMap(sensitiveList);<br><br>    <span class="hljs-comment">//查看文章中是否包含敏感词</span><br>    Map&lt;String, Integer&gt; map = SensitiveWordUtil.matchWords(content);<br>    <span class="hljs-keyword">if</span>(map.size() &gt;<span class="hljs-number">0</span>)&#123;<br>        updateWmNews(wmNews,(<span class="hljs-type">short</span>) <span class="hljs-number">2</span>,<span class="hljs-string">&quot;当前文章中存在违规内容&quot;</span>+map);<br>        flag = <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> flag;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="8-新需求-图片识别文字审核敏感词"><a href="#8-新需求-图片识别文字审核敏感词" class="headerlink" title="8)新需求-图片识别文字审核敏感词"></a>8)新需求-图片识别文字审核敏感词</h3><h4 id="8-1-需求分析"><a href="#8-1-需求分析" class="headerlink" title="8.1)需求分析"></a>8.1)需求分析</h4><p>产品经理召集开会，文章审核功能已经交付了，文章也能正常发布审核。对于上次提出的自管理敏感词也很满意，这次会议核心的内容如下：</p>
<ul>
<li>文章中包含的图片要识别文字，过滤掉图片文字的敏感词</li>
</ul>
<p><img src="/../images/image-20210524161243572.png" srcset="/img/loading.gif" lazyload alt="image-20210524161243572"></p>
<h4 id="8-2-图片文字识别"><a href="#8-2-图片文字识别" class="headerlink" title="8.2)图片文字识别"></a>8.2)图片文字识别</h4><p>什么是OCR?</p>
<p>OCR （Optical Character Recognition，光学字符识别）是指电子设备（例如扫描仪或数码相机）检查纸上打印的字符，通过检测暗、亮的模式确定其形状，然后用字符识别方法将形状翻译成计算机文字的过程</p>
<table>
<thead>
<tr>
<th><strong>方案</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>百度OCR</td>
<td>收费</td>
</tr>
<tr>
<td>Tesseract-OCR</td>
<td>Google维护的开源OCR引擎，支持Java，Python等语言调用</td>
</tr>
<tr>
<td>Tess4J</td>
<td>封装了Tesseract-OCR  ，支持Java调用</td>
</tr>
</tbody></table>
<h4 id="8-3-Tess4j案例"><a href="#8-3-Tess4j案例" class="headerlink" title="8.3)Tess4j案例"></a>8.3)Tess4j案例</h4><p>①：创建项目导入tess4j对应的依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>net.sourceforge.tess4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>tess4j<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.1.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>②：导入中文字体库， 把资料中的tessdata文件夹拷贝到自己的工作空间下</p>
<p><img src="/../images/image-20210524161406081.png" srcset="/img/loading.gif" lazyload alt="image-20210524161406081"></p>
<p>③：编写测试类进行测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.tess4j;<br><br><span class="hljs-keyword">import</span> net.sourceforge.tess4j.ITesseract;<br><span class="hljs-keyword">import</span> net.sourceforge.tess4j.Tesseract;<br><br><span class="hljs-keyword">import</span> java.io.File;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Application</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//获取本地图片</span><br>            <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;D:\\26.png&quot;</span>);<br>            <span class="hljs-comment">//创建Tesseract对象</span><br>            <span class="hljs-type">ITesseract</span> <span class="hljs-variable">tesseract</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Tesseract</span>();<br>            <span class="hljs-comment">//设置字体库路径</span><br>            tesseract.setDatapath(<span class="hljs-string">&quot;D:\\workspace\\tessdata&quot;</span>);<br>            <span class="hljs-comment">//中文识别</span><br>            tesseract.setLanguage(<span class="hljs-string">&quot;chi_sim&quot;</span>);<br>            <span class="hljs-comment">//执行ocr识别</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> tesseract.doOCR(file);<br>            <span class="hljs-comment">//替换回车和tal键  使结果为一行</span><br>            result = result.replaceAll(<span class="hljs-string">&quot;\\r|\\n&quot;</span>,<span class="hljs-string">&quot;-&quot;</span>).replaceAll(<span class="hljs-string">&quot; &quot;</span>,<span class="hljs-string">&quot;&quot;</span>);<br>            System.out.println(<span class="hljs-string">&quot;识别的结果为：&quot;</span>+result);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="8-4-管理敏感词和图片文字识别集成到文章审核"><a href="#8-4-管理敏感词和图片文字识别集成到文章审核" class="headerlink" title="8.4)管理敏感词和图片文字识别集成到文章审核"></a>8.4)管理敏感词和图片文字识别集成到文章审核</h4><p>①：在heima-leadnews-common中创建工具类，简单封装一下tess4j</p>
<p>需要先导入pom</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>net.sourceforge.tess4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>tess4j<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.1.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>工具类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.common.tess4j;<br><br><span class="hljs-keyword">import</span> lombok.Getter;<br><span class="hljs-keyword">import</span> lombok.Setter;<br><span class="hljs-keyword">import</span> net.sourceforge.tess4j.ITesseract;<br><span class="hljs-keyword">import</span> net.sourceforge.tess4j.Tesseract;<br><span class="hljs-keyword">import</span> net.sourceforge.tess4j.TesseractException;<br><span class="hljs-keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-keyword">import</span> java.awt.image.BufferedImage;<br><br><span class="hljs-meta">@Getter</span><br><span class="hljs-meta">@Setter</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@ConfigurationProperties(prefix = &quot;tess4j&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Tess4jClient</span> &#123;<br><br>    <span class="hljs-keyword">private</span> String dataPath;<br>    <span class="hljs-keyword">private</span> String language;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">doOCR</span><span class="hljs-params">(BufferedImage image)</span> <span class="hljs-keyword">throws</span> TesseractException &#123;<br>        <span class="hljs-comment">//创建Tesseract对象</span><br>        <span class="hljs-type">ITesseract</span> <span class="hljs-variable">tesseract</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Tesseract</span>();<br>        <span class="hljs-comment">//设置字体库路径</span><br>        tesseract.setDatapath(dataPath);<br>        <span class="hljs-comment">//中文识别</span><br>        tesseract.setLanguage(language);<br>        <span class="hljs-comment">//执行ocr识别</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> tesseract.doOCR(image);<br>        <span class="hljs-comment">//替换回车和tal键  使结果为一行</span><br>        result = result.replaceAll(<span class="hljs-string">&quot;\\r|\\n&quot;</span>, <span class="hljs-string">&quot;-&quot;</span>).replaceAll(<span class="hljs-string">&quot; &quot;</span>, <span class="hljs-string">&quot;&quot;</span>);<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>在spring.factories配置中添加该类,完整如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">org.springframework.boot.autoconfigure.EnableAutoConfiguration=\<br>  com.heima.common.exception.ExceptionCatch,\<br>  com.heima.common.swagger.SwaggerConfiguration,\<br>  com.heima.common.swagger.Swagger2Configuration,\<br>  com.heima.common.aliyun.GreenTextScan,\<br>  com.heima.common.aliyun.GreenImageScan,\<br>  com.heima.common.tess4j.Tess4jClient<br></code></pre></td></tr></table></figure>

<p>②：在heima-leadnews-wemedia中的配置中添加两个属性</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">tess4j:</span><br>  <span class="hljs-attr">data-path:</span> <span class="hljs-string">D:\workspace\tessdata</span><br>  <span class="hljs-attr">language:</span> <span class="hljs-string">chi_sim</span><br></code></pre></td></tr></table></figure>

<p>③：在WmNewsAutoScanServiceImpl中的handleImageScan方法上添加如下代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-keyword">for</span> (String image : images) &#123;<br>        <span class="hljs-type">byte</span>[] bytes = fileStorageService.downLoadFile(image);<br><br>        <span class="hljs-comment">//图片识别文字审核---begin-----</span><br><br>        <span class="hljs-comment">//从byte[]转换为butteredImage</span><br>        <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bytes);<br>        <span class="hljs-type">BufferedImage</span> <span class="hljs-variable">imageFile</span> <span class="hljs-operator">=</span> ImageIO.read(in);<br>        <span class="hljs-comment">//识别图片的文字</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> tess4jClient.doOCR(imageFile);<br><br>        <span class="hljs-comment">//审核是否包含自管理的敏感词</span><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">isSensitive</span> <span class="hljs-operator">=</span> handleSensitiveScan(result, wmNews);<br>        <span class="hljs-keyword">if</span>(!isSensitive)&#123;<br>            <span class="hljs-keyword">return</span> isSensitive;<br>        &#125;<br><br>        <span class="hljs-comment">//图片识别文字审核---end-----</span><br><br><br>        imageList.add(bytes);<br><br>    &#125; <br>&#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>    e.printStackTrace();<br>&#125;<br></code></pre></td></tr></table></figure>



<p>最后附上文章审核的完整代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.wemedia.service.impl;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSONArray;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.toolkit.Wrappers;<br><span class="hljs-keyword">import</span> com.heima.apis.article.IArticleClient;<br><span class="hljs-keyword">import</span> com.heima.common.aliyun.GreenImageScan;<br><span class="hljs-keyword">import</span> com.heima.common.aliyun.GreenTextScan;<br><span class="hljs-keyword">import</span> com.heima.common.tess4j.Tess4jClient;<br><span class="hljs-keyword">import</span> com.heima.file.service.FileStorageService;<br><span class="hljs-keyword">import</span> com.heima.model.article.dtos.ArticleDto;<br><span class="hljs-keyword">import</span> com.heima.model.common.dtos.ResponseResult;<br><span class="hljs-keyword">import</span> com.heima.model.wemedia.pojos.WmChannel;<br><span class="hljs-keyword">import</span> com.heima.model.wemedia.pojos.WmNews;<br><span class="hljs-keyword">import</span> com.heima.model.wemedia.pojos.WmSensitive;<br><span class="hljs-keyword">import</span> com.heima.model.wemedia.pojos.WmUser;<br><span class="hljs-keyword">import</span> com.heima.utils.common.SensitiveWordUtil;<br><span class="hljs-keyword">import</span> com.heima.wemedia.mapper.WmChannelMapper;<br><span class="hljs-keyword">import</span> com.heima.wemedia.mapper.WmNewsMapper;<br><span class="hljs-keyword">import</span> com.heima.wemedia.mapper.WmSensitiveMapper;<br><span class="hljs-keyword">import</span> com.heima.wemedia.mapper.WmUserMapper;<br><span class="hljs-keyword">import</span> com.heima.wemedia.service.WmNewsAutoScanService;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.apache.commons.lang3.StringUtils;<br><span class="hljs-keyword">import</span> org.springframework.beans.BeanUtils;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.scheduling.annotation.Async;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><span class="hljs-keyword">import</span> org.springframework.transaction.annotation.Transactional;<br><br><span class="hljs-keyword">import</span> javax.imageio.ImageIO;<br><span class="hljs-keyword">import</span> java.awt.image.BufferedImage;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.util.*;<br><span class="hljs-keyword">import</span> java.util.stream.Collectors;<br><br><br><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Transactional</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WmNewsAutoScanServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WmNewsAutoScanService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> WmNewsMapper wmNewsMapper;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 自媒体文章审核</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> id 自媒体文章id</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-meta">@Async</span>  <span class="hljs-comment">//标明当前方法是一个异步方法</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">autoScanWmNews</span><span class="hljs-params">(Integer id)</span> &#123;<br><br><span class="hljs-comment">//        int a = 1/0;</span><br><br>        <span class="hljs-comment">//1.查询自媒体文章</span><br>        <span class="hljs-type">WmNews</span> <span class="hljs-variable">wmNews</span> <span class="hljs-operator">=</span> wmNewsMapper.selectById(id);<br>        <span class="hljs-keyword">if</span> (wmNews == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;WmNewsAutoScanServiceImpl-文章不存在&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (wmNews.getStatus().equals(WmNews.Status.SUBMIT.getCode())) &#123;<br>            <span class="hljs-comment">//从内容中提取纯文本内容和图片</span><br>            Map&lt;String, Object&gt; textAndImages = handleTextAndImages(wmNews);<br><br>            <span class="hljs-comment">//自管理的敏感词过滤</span><br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">isSensitive</span> <span class="hljs-operator">=</span> handleSensitiveScan((String) textAndImages.get(<span class="hljs-string">&quot;content&quot;</span>), wmNews);<br>            <span class="hljs-keyword">if</span>(!isSensitive) <span class="hljs-keyword">return</span>;<br><br>            <span class="hljs-comment">//2.审核文本内容  阿里云接口</span><br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">isTextScan</span> <span class="hljs-operator">=</span> handleTextScan((String) textAndImages.get(<span class="hljs-string">&quot;content&quot;</span>), wmNews);<br>            <span class="hljs-keyword">if</span> (!isTextScan) <span class="hljs-keyword">return</span>;<br><br>            <span class="hljs-comment">//3.审核图片  阿里云接口</span><br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">isImageScan</span> <span class="hljs-operator">=</span> handleImageScan((List&lt;String&gt;) textAndImages.get(<span class="hljs-string">&quot;images&quot;</span>), wmNews);<br>            <span class="hljs-keyword">if</span> (!isImageScan) <span class="hljs-keyword">return</span>;<br><br>            <span class="hljs-comment">//4.审核成功，保存app端的相关的文章数据</span><br>            <span class="hljs-type">ResponseResult</span> <span class="hljs-variable">responseResult</span> <span class="hljs-operator">=</span> saveAppArticle(wmNews);<br>            <span class="hljs-keyword">if</span> (!responseResult.getCode().equals(<span class="hljs-number">200</span>)) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;WmNewsAutoScanServiceImpl-文章审核，保存app端相关文章数据失败&quot;</span>);<br>            &#125;<br>            <span class="hljs-comment">//回填article_id</span><br>            wmNews.setArticleId((Long) responseResult.getData());<br>            updateWmNews(wmNews, (<span class="hljs-type">short</span>) <span class="hljs-number">9</span>, <span class="hljs-string">&quot;审核成功&quot;</span>);<br><br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> WmSensitiveMapper wmSensitiveMapper;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 自管理的敏感词审核</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> content</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> wmNews</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">handleSensitiveScan</span><span class="hljs-params">(String content, WmNews wmNews)</span> &#123;<br><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br><br>        <span class="hljs-comment">//获取所有的敏感词</span><br>        List&lt;WmSensitive&gt; wmSensitives = wmSensitiveMapper.selectList(Wrappers.&lt;WmSensitive&gt;lambdaQuery().select(WmSensitive::getSensitives));<br>        List&lt;String&gt; sensitiveList = wmSensitives.stream().map(WmSensitive::getSensitives).collect(Collectors.toList());<br><br>        <span class="hljs-comment">//初始化敏感词库</span><br>        SensitiveWordUtil.initMap(sensitiveList);<br><br>        <span class="hljs-comment">//查看文章中是否包含敏感词</span><br>        Map&lt;String, Integer&gt; map = SensitiveWordUtil.matchWords(content);<br>        <span class="hljs-keyword">if</span>(map.size() &gt;<span class="hljs-number">0</span>)&#123;<br>            updateWmNews(wmNews,(<span class="hljs-type">short</span>) <span class="hljs-number">2</span>,<span class="hljs-string">&quot;当前文章中存在违规内容&quot;</span>+map);<br>            flag = <span class="hljs-literal">false</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> flag;<br>    &#125;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> IArticleClient articleClient;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> WmChannelMapper wmChannelMapper;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> WmUserMapper wmUserMapper;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 保存app端相关的文章数据</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> wmNews</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> ResponseResult <span class="hljs-title function_">saveAppArticle</span><span class="hljs-params">(WmNews wmNews)</span> &#123;<br><br>        <span class="hljs-type">ArticleDto</span> <span class="hljs-variable">dto</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArticleDto</span>();<br>        <span class="hljs-comment">//属性的拷贝</span><br>        BeanUtils.copyProperties(wmNews, dto);<br>        <span class="hljs-comment">//文章的布局</span><br>        dto.setLayout(wmNews.getType());<br>        <span class="hljs-comment">//频道</span><br>        <span class="hljs-type">WmChannel</span> <span class="hljs-variable">wmChannel</span> <span class="hljs-operator">=</span> wmChannelMapper.selectById(wmNews.getChannelId());<br>        <span class="hljs-keyword">if</span> (wmChannel != <span class="hljs-literal">null</span>) &#123;<br>            dto.setChannelName(wmChannel.getName());<br>        &#125;<br><br>        <span class="hljs-comment">//作者</span><br>        dto.setAuthorId(wmNews.getUserId().longValue());<br>        <span class="hljs-type">WmUser</span> <span class="hljs-variable">wmUser</span> <span class="hljs-operator">=</span> wmUserMapper.selectById(wmNews.getUserId());<br>        <span class="hljs-keyword">if</span> (wmUser != <span class="hljs-literal">null</span>) &#123;<br>            dto.setAuthorName(wmUser.getName());<br>        &#125;<br><br>        <span class="hljs-comment">//设置文章id</span><br>        <span class="hljs-keyword">if</span> (wmNews.getArticleId() != <span class="hljs-literal">null</span>) &#123;<br>            dto.setId(wmNews.getArticleId());<br>        &#125;<br>        dto.setCreatedTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br><br>        <span class="hljs-type">ResponseResult</span> <span class="hljs-variable">responseResult</span> <span class="hljs-operator">=</span> articleClient.saveArticle(dto);<br>        <span class="hljs-keyword">return</span> responseResult;<br><br>    &#125;<br><br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> FileStorageService fileStorageService;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> GreenImageScan greenImageScan;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> Tess4jClient tess4jClient;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 审核图片</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> images</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> wmNews</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">handleImageScan</span><span class="hljs-params">(List&lt;String&gt; images, WmNews wmNews)</span> &#123;<br><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br><br>        <span class="hljs-keyword">if</span> (images == <span class="hljs-literal">null</span> || images.size() == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">return</span> flag;<br>        &#125;<br><br>        <span class="hljs-comment">//下载图片 minIO</span><br>        <span class="hljs-comment">//图片去重</span><br>        images = images.stream().distinct().collect(Collectors.toList());<br><br>        List&lt;<span class="hljs-type">byte</span>[]&gt; imageList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">for</span> (String image : images) &#123;<br>                <span class="hljs-type">byte</span>[] bytes = fileStorageService.downLoadFile(image);<br><br>                <span class="hljs-comment">//图片识别文字审核---begin-----</span><br><br>                <span class="hljs-comment">//从byte[]转换为butteredImage</span><br>                <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bytes);<br>                <span class="hljs-type">BufferedImage</span> <span class="hljs-variable">imageFile</span> <span class="hljs-operator">=</span> ImageIO.read(in);<br>                <span class="hljs-comment">//识别图片的文字</span><br>                <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> tess4jClient.doOCR(imageFile);<br><br>                <span class="hljs-comment">//审核是否包含自管理的敏感词</span><br>                <span class="hljs-type">boolean</span> <span class="hljs-variable">isSensitive</span> <span class="hljs-operator">=</span> handleSensitiveScan(result, wmNews);<br>                <span class="hljs-keyword">if</span>(!isSensitive)&#123;<br>                    <span class="hljs-keyword">return</span> isSensitive;<br>                &#125;<br><br>                <span class="hljs-comment">//图片识别文字审核---end-----</span><br><br><br>                imageList.add(bytes);<br><br>            &#125;<br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<br><br><br>        <span class="hljs-comment">//审核图片</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> greenImageScan.imageScan(imageList);<br>            <span class="hljs-keyword">if</span> (map != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-comment">//审核失败</span><br>                <span class="hljs-keyword">if</span> (map.get(<span class="hljs-string">&quot;suggestion&quot;</span>).equals(<span class="hljs-string">&quot;block&quot;</span>)) &#123;<br>                    flag = <span class="hljs-literal">false</span>;<br>                    updateWmNews(wmNews, (<span class="hljs-type">short</span>) <span class="hljs-number">2</span>, <span class="hljs-string">&quot;当前文章中存在违规内容&quot;</span>);<br>                &#125;<br><br>                <span class="hljs-comment">//不确定信息  需要人工审核</span><br>                <span class="hljs-keyword">if</span> (map.get(<span class="hljs-string">&quot;suggestion&quot;</span>).equals(<span class="hljs-string">&quot;review&quot;</span>)) &#123;<br>                    flag = <span class="hljs-literal">false</span>;<br>                    updateWmNews(wmNews, (<span class="hljs-type">short</span>) <span class="hljs-number">3</span>, <span class="hljs-string">&quot;当前文章中存在不确定内容&quot;</span>);<br>                &#125;<br>            &#125;<br><br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            flag = <span class="hljs-literal">false</span>;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">return</span> flag;<br>    &#125;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> GreenTextScan greenTextScan;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 审核纯文本内容</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> content</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> wmNews</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">handleTextScan</span><span class="hljs-params">(String content, WmNews wmNews)</span> &#123;<br><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br><br>        <span class="hljs-keyword">if</span> ((wmNews.getTitle() + <span class="hljs-string">&quot;-&quot;</span> + content).length() == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">return</span> flag;<br>        &#125;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> greenTextScan.greeTextScan((wmNews.getTitle() + <span class="hljs-string">&quot;-&quot;</span> + content));<br>            <span class="hljs-keyword">if</span> (map != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-comment">//审核失败</span><br>                <span class="hljs-keyword">if</span> (map.get(<span class="hljs-string">&quot;suggestion&quot;</span>).equals(<span class="hljs-string">&quot;block&quot;</span>)) &#123;<br>                    flag = <span class="hljs-literal">false</span>;<br>                    updateWmNews(wmNews, (<span class="hljs-type">short</span>) <span class="hljs-number">2</span>, <span class="hljs-string">&quot;当前文章中存在违规内容&quot;</span>);<br>                &#125;<br><br>                <span class="hljs-comment">//不确定信息  需要人工审核</span><br>                <span class="hljs-keyword">if</span> (map.get(<span class="hljs-string">&quot;suggestion&quot;</span>).equals(<span class="hljs-string">&quot;review&quot;</span>)) &#123;<br>                    flag = <span class="hljs-literal">false</span>;<br>                    updateWmNews(wmNews, (<span class="hljs-type">short</span>) <span class="hljs-number">3</span>, <span class="hljs-string">&quot;当前文章中存在不确定内容&quot;</span>);<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            flag = <span class="hljs-literal">false</span>;<br>            e.printStackTrace();<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> flag;<br><br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 修改文章内容</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> wmNews</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> status</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> reason</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateWmNews</span><span class="hljs-params">(WmNews wmNews, <span class="hljs-type">short</span> status, String reason)</span> &#123;<br>        wmNews.setStatus(status);<br>        wmNews.setReason(reason);<br>        wmNewsMapper.updateById(wmNews);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 1。从自媒体文章的内容中提取文本和图片</span><br><span class="hljs-comment">     * 2.提取文章的封面图片</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> wmNews</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Map&lt;String, Object&gt; <span class="hljs-title function_">handleTextAndImages</span><span class="hljs-params">(WmNews wmNews)</span> &#123;<br><br>        <span class="hljs-comment">//存储纯文本内容</span><br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">stringBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br><br>        List&lt;String&gt; images = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><br>        <span class="hljs-comment">//1。从自媒体文章的内容中提取文本和图片</span><br>        <span class="hljs-keyword">if</span> (StringUtils.isNotBlank(wmNews.getContent())) &#123;<br>            List&lt;Map&gt; maps = JSONArray.parseArray(wmNews.getContent(), Map.class);<br>            <span class="hljs-keyword">for</span> (Map map : maps) &#123;<br>                <span class="hljs-keyword">if</span> (map.get(<span class="hljs-string">&quot;type&quot;</span>).equals(<span class="hljs-string">&quot;text&quot;</span>)) &#123;<br>                    stringBuilder.append(map.get(<span class="hljs-string">&quot;value&quot;</span>));<br>                &#125;<br><br>                <span class="hljs-keyword">if</span> (map.get(<span class="hljs-string">&quot;type&quot;</span>).equals(<span class="hljs-string">&quot;image&quot;</span>)) &#123;<br>                    images.add((String) map.get(<span class="hljs-string">&quot;value&quot;</span>));<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">//2.提取文章的封面图片</span><br>        <span class="hljs-keyword">if</span> (StringUtils.isNotBlank(wmNews.getImages())) &#123;<br>            String[] split = wmNews.getImages().split(<span class="hljs-string">&quot;,&quot;</span>);<br>            images.addAll(Arrays.asList(split));<br>        &#125;<br><br>        Map&lt;String, Object&gt; resultMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        resultMap.put(<span class="hljs-string">&quot;content&quot;</span>, stringBuilder.toString());<br>        resultMap.put(<span class="hljs-string">&quot;images&quot;</span>, images);<br>        <span class="hljs-keyword">return</span> resultMap;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="9-文章详情-静态文件生成"><a href="#9-文章详情-静态文件生成" class="headerlink" title="9)文章详情-静态文件生成"></a>9)文章详情-静态文件生成</h3><h4 id="9-1-思路分析"><a href="#9-1-思路分析" class="headerlink" title="9.1)思路分析"></a><strong>9.1)思路分析</strong></h4><p>文章端创建app相关文章时，生成文章详情静态页上传到MinIO中</p>
<p><img src="/../images/image-20210709110852966.png" srcset="/img/loading.gif" lazyload alt="image-20210709110852966"></p>
<h4 id="9-2-实现步骤"><a href="#9-2-实现步骤" class="headerlink" title="9.2)实现步骤"></a>9.2)实现步骤</h4><p>1.新建ArticleFreemarkerService创建静态文件并上传到minIO中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.article.service;<br><br><span class="hljs-keyword">import</span> com.heima.model.article.pojos.ApArticle;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ArticleFreemarkerService</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 生成静态文件上传到minIO中</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> apArticle</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> content</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">buildArticleToMinIO</span><span class="hljs-params">(ApArticle apArticle,String content)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.article.service.impl;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSONArray;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.toolkit.Wrappers;<br><span class="hljs-keyword">import</span> com.heima.article.mapper.ApArticleContentMapper;<br><span class="hljs-keyword">import</span> com.heima.article.service.ApArticleService;<br><span class="hljs-keyword">import</span> com.heima.article.service.ArticleFreemarkerService;<br><span class="hljs-keyword">import</span> com.heima.file.service.FileStorageService;<br><span class="hljs-keyword">import</span> com.heima.model.article.pojos.ApArticle;<br><span class="hljs-keyword">import</span> freemarker.template.Configuration;<br><span class="hljs-keyword">import</span> freemarker.template.Template;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.apache.commons.lang3.StringUtils;<br><span class="hljs-keyword">import</span> org.springframework.beans.BeanUtils;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.scheduling.annotation.Async;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><span class="hljs-keyword">import</span> org.springframework.transaction.annotation.Transactional;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.InputStream;<br><span class="hljs-keyword">import</span> java.io.StringWriter;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Transactional</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArticleFreemarkerServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ArticleFreemarkerService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ApArticleContentMapper apArticleContentMapper;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> Configuration configuration;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> FileStorageService fileStorageService;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ApArticleService apArticleService;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 生成静态文件上传到minIO中</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> apArticle</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> content</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Async</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">buildArticleToMinIO</span><span class="hljs-params">(ApArticle apArticle, String content)</span> &#123;<br>        <span class="hljs-comment">//已知文章的id</span><br>        <span class="hljs-comment">//4.1 获取文章内容</span><br>        <span class="hljs-keyword">if</span>(StringUtils.isNotBlank(content))&#123;<br>            <span class="hljs-comment">//4.2 文章内容通过freemarker生成html文件</span><br>            <span class="hljs-type">Template</span> <span class="hljs-variable">template</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>            <span class="hljs-type">StringWriter</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringWriter</span>();<br>            <span class="hljs-keyword">try</span> &#123;<br>                template = configuration.getTemplate(<span class="hljs-string">&quot;article.ftl&quot;</span>);<br>                <span class="hljs-comment">//数据模型</span><br>                Map&lt;String,Object&gt; contentDataModel = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>                contentDataModel.put(<span class="hljs-string">&quot;content&quot;</span>, JSONArray.parseArray(content));<br>                <span class="hljs-comment">//合成</span><br>                template.process(contentDataModel,out);<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                e.printStackTrace();<br>            &#125;<br><br>            <span class="hljs-comment">//4.3 把html文件上传到minio中</span><br>            <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(out.toString().getBytes());<br>            <span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> fileStorageService.uploadHtmlFile(<span class="hljs-string">&quot;&quot;</span>, apArticle.getId() + <span class="hljs-string">&quot;.html&quot;</span>, in);<br><br><br>            <span class="hljs-comment">//4.4 修改ap_article表，保存static_url字段</span><br>            apArticleService.update(Wrappers.&lt;ApArticle&gt;lambdaUpdate().eq(ApArticle::getId,apArticle.getId())<br>                    .set(ApArticle::getStaticUrl,path));<br><br><br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>2.在ApArticleService的saveArticle实现方法中添加调用生成文件的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 保存app端相关文章</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> dto</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">saveArticle</span><span class="hljs-params">(ArticleDto dto)</span> &#123;<br><br>    <span class="hljs-comment">//        try &#123;</span><br>    <span class="hljs-comment">//            Thread.sleep(3000);</span><br>    <span class="hljs-comment">//        &#125; catch (InterruptedException e) &#123;</span><br>    <span class="hljs-comment">//            e.printStackTrace();</span><br>    <span class="hljs-comment">//        &#125;</span><br>    <span class="hljs-comment">//1.检查参数</span><br>    <span class="hljs-keyword">if</span>(dto == <span class="hljs-literal">null</span>)&#123;<br>        <span class="hljs-keyword">return</span> ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID);<br>    &#125;<br><br>    <span class="hljs-type">ApArticle</span> <span class="hljs-variable">apArticle</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApArticle</span>();<br>    BeanUtils.copyProperties(dto,apArticle);<br><br>    <span class="hljs-comment">//2.判断是否存在id</span><br>    <span class="hljs-keyword">if</span>(dto.getId() == <span class="hljs-literal">null</span>)&#123;<br>        <span class="hljs-comment">//2.1 不存在id  保存  文章  文章配置  文章内容</span><br><br>        <span class="hljs-comment">//保存文章</span><br>        save(apArticle);<br><br>        <span class="hljs-comment">//保存配置</span><br>        <span class="hljs-type">ApArticleConfig</span> <span class="hljs-variable">apArticleConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApArticleConfig</span>(apArticle.getId());<br>        apArticleConfigMapper.insert(apArticleConfig);<br><br>        <span class="hljs-comment">//保存 文章内容</span><br>        <span class="hljs-type">ApArticleContent</span> <span class="hljs-variable">apArticleContent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApArticleContent</span>();<br>        apArticleContent.setArticleId(apArticle.getId());<br>        apArticleContent.setContent(dto.getContent());<br>        apArticleContentMapper.insert(apArticleContent);<br><br>    &#125;<span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">//2.2 存在id   修改  文章  文章内容</span><br><br>        <span class="hljs-comment">//修改  文章</span><br>        updateById(apArticle);<br><br>        <span class="hljs-comment">//修改文章内容</span><br>        <span class="hljs-type">ApArticleContent</span> <span class="hljs-variable">apArticleContent</span> <span class="hljs-operator">=</span> apArticleContentMapper.selectOne(Wrappers.&lt;ApArticleContent&gt;lambdaQuery().eq(ApArticleContent::getArticleId, dto.getId()));<br>        apArticleContent.setContent(dto.getContent());<br>        apArticleContentMapper.updateById(apArticleContent);<br>    &#125;<br><br>    <span class="hljs-comment">//异步调用 生成静态文件上传到minio中</span><br>    articleFreemarkerService.buildArticleToMinIO(apArticle,dto.getContent());<br><br><br>    <span class="hljs-comment">//3.结果返回  文章的id</span><br>    <span class="hljs-keyword">return</span> ResponseResult.okResult(apArticle.getId());<br>&#125;<br></code></pre></td></tr></table></figure>

<p>3.文章微服务开启异步调用</p>
<p><img src="/../images/image-20210709111445360.png" srcset="/img/loading.gif" lazyload alt="image-20210709111445360"></p>
<h1 id="5-延迟任务精准发布文章"><a href="#5-延迟任务精准发布文章" class="headerlink" title="5 延迟任务精准发布文章"></a>5 延迟任务精准发布文章</h1><h3 id="1-文章定时发布"><a href="#1-文章定时发布" class="headerlink" title="1)文章定时发布"></a>1)文章定时发布</h3><h3 id="2-延迟任务概述"><a href="#2-延迟任务概述" class="headerlink" title="2)延迟任务概述"></a>2)延迟任务概述</h3><h4 id="2-1-什么是延迟任务"><a href="#2-1-什么是延迟任务" class="headerlink" title="2.1)什么是延迟任务"></a>2.1)什么是延迟任务</h4><ul>
<li>定时任务：有固定周期的，有明确的触发时间</li>
<li>延迟队列：没有固定的开始时间，它常常是由一个事件触发的，而在这个事件触发之后的一段时间内触发另一个事件，任务可以立即执行，也可以延迟</li>
</ul>
<p><img src="/../images/image-20210513145942962.png" srcset="/img/loading.gif" lazyload alt="image-20210513145942962"></p>
<p>应用场景：</p>
<p>场景一：订单下单之后30分钟后，如果用户没有付钱，则系统自动取消订单；如果期间下单成功，任务取消</p>
<p>场景二：接口对接出现网络问题，1分钟后重试，如果失败，2分钟重试，直到出现阈值终止</p>
<h4 id="2-2-技术对比"><a href="#2-2-技术对比" class="headerlink" title="2.2)技术对比"></a>2.2)技术对比</h4><h5 id="2-2-1-DelayQueue"><a href="#2-2-1-DelayQueue" class="headerlink" title="2.2.1)DelayQueue"></a>2.2.1)DelayQueue</h5><p>JDK自带DelayQueue 是一个支持延时获取元素的阻塞队列， 内部采用优先队列 PriorityQueue 存储元素，同时元素必须实现 Delayed 接口；在创建元素时可以指定多久才可以从队列中获取当前元素，只有在延迟期满时才能从队列中提取元素</p>
<p><img src="/../images/image-20210513150058814.png" srcset="/img/loading.gif" lazyload alt="image-20210513150058814"></p>
<p>DelayQueue属于排序队列，它的特殊之处在于队列的元素必须实现Delayed接口，该接口需要实现compareTo和getDelay方法</p>
<p>getDelay方法：获取元素在队列中的剩余时间，只有当剩余时间为0时元素才可以出队列。</p>
<p>compareTo方法：用于排序，确定元素出队列的顺序。</p>
<p><strong>实现：</strong></p>
<p>1：在测试包jdk下创建延迟任务元素对象DelayedTask，实现compareTo和getDelay方法，</p>
<p>2：在main方法中创建DelayQueue并向延迟队列中添加三个延迟任务，</p>
<p>3：循环的从延迟队列中拉取任务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DelayedTask</span>  <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Delayed</span>&#123;<br>    <br>    <span class="hljs-comment">// 任务的执行时间</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">executeTime</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DelayedTask</span><span class="hljs-params">(<span class="hljs-type">int</span> delay)</span>&#123;<br>        <span class="hljs-type">Calendar</span> <span class="hljs-variable">calendar</span> <span class="hljs-operator">=</span> Calendar.getInstance();<br>        calendar.add(Calendar.SECOND,delay);<br>        <span class="hljs-built_in">this</span>.executeTime = (<span class="hljs-type">int</span>)(calendar.getTimeInMillis() /<span class="hljs-number">1000</span> );<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 元素在队列中的剩余时间</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> unit</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">getDelay</span><span class="hljs-params">(TimeUnit unit)</span> &#123;<br>        <span class="hljs-type">Calendar</span> <span class="hljs-variable">calendar</span> <span class="hljs-operator">=</span> Calendar.getInstance();<br>        <span class="hljs-keyword">return</span> executeTime - (calendar.getTimeInMillis()/<span class="hljs-number">1000</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 元素排序</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> o</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">compareTo</span><span class="hljs-params">(Delayed o)</span> &#123;<br>        <span class="hljs-type">long</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getDelay(TimeUnit.NANOSECONDS) - o.getDelay(TimeUnit.NANOSECONDS);<br>        <span class="hljs-keyword">return</span> val == <span class="hljs-number">0</span> ? <span class="hljs-number">0</span> : ( val &lt; <span class="hljs-number">0</span> ? -<span class="hljs-number">1</span>: <span class="hljs-number">1</span> );<br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        DelayQueue&lt;DelayedTask&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DelayQueue</span>&lt;DelayedTask&gt;();<br>        <br>        queue.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DelayedTask</span>(<span class="hljs-number">5</span>));<br>        queue.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DelayedTask</span>(<span class="hljs-number">10</span>));<br>        queue.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DelayedTask</span>(<span class="hljs-number">15</span>));<br><br>        System.out.println(System.currentTimeMillis()/<span class="hljs-number">1000</span>+<span class="hljs-string">&quot; start consume &quot;</span>);<br>        <span class="hljs-keyword">while</span>(queue.size() != <span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-type">DelayedTask</span> <span class="hljs-variable">delayedTask</span> <span class="hljs-operator">=</span> queue.poll();<br>            <span class="hljs-keyword">if</span>(delayedTask !=<span class="hljs-literal">null</span> )&#123;<br>                System.out.println(System.currentTimeMillis()/<span class="hljs-number">1000</span>+<span class="hljs-string">&quot; cosume task&quot;</span>);<br>            &#125;<br>            <span class="hljs-comment">//每隔一秒消费一次</span><br>            <span class="hljs-keyword">try</span> &#123;<br>                Thread.sleep(<span class="hljs-number">1000</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;     <br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>DelayQueue实现完成之后思考一个问题：</p>
<p>使用线程池或者原生DelayQueue程序挂掉之后，任务都是放在内存，需要考虑未处理消息的丢失带来的影响，如何保证数据不丢失，需要持久化（磁盘）</p>
<h5 id="2-2-2-RabbitMQ实现延迟任务"><a href="#2-2-2-RabbitMQ实现延迟任务" class="headerlink" title="2.2.2)RabbitMQ实现延迟任务"></a>2.2.2)RabbitMQ实现延迟任务</h5><ul>
<li><p>TTL：Time To Live (消息存活时间)</p>
</li>
<li><p>死信队列：Dead Letter Exchange(死信交换机)，当消息成为Dead message后，可以重新发送另一个交换机（死信交换机）</p>
</li>
</ul>
<p><img src="/../images/image-20210513150319742.png" srcset="/img/loading.gif" lazyload alt="image-20210513150319742"></p>
<h5 id="2-2-3-redis实现"><a href="#2-2-3-redis实现" class="headerlink" title="2.2.3)redis实现"></a>2.2.3)redis实现</h5><p>zset数据类型的去重有序（分数排序）特点进行延迟。例如：时间戳作为score进行排序</p>
<p><img src="/../images/image-20210513150352211.png" srcset="/img/loading.gif" lazyload alt="image-20210513150352211"></p>
<h3 id="3-redis实现延迟任务"><a href="#3-redis实现延迟任务" class="headerlink" title="3)redis实现延迟任务"></a>3)redis实现延迟任务</h3><p>实现思路</p>
<p><img src="/../images/image-20210513150440342.png" srcset="/img/loading.gif" lazyload alt="image-20210513150440342"></p>
<p>问题思路</p>
<p>1.为什么任务需要存储在数据库中？</p>
<p>延迟任务是一个通用的服务，任何需要延迟得任务都可以调用该服务，需要考虑数据持久化的问题，存储数据库中是一种数据安全的考虑。</p>
<p>2.为什么redis中使用两种数据类型，list和zset？</p>
<p>效率问题，算法的时间复杂度</p>
<p>3.在添加zset数据的时候，为什么不需要预加载？</p>
<p>任务模块是一个通用的模块，项目中任何需要延迟队列的地方，都可以调用这个接口，要考虑到数据量的问题，如果数据量特别大，为了防止阻塞，只需要把未来几分钟要执行的数据存入缓存即可。</p>
<h3 id="4-延迟任务服务实现"><a href="#4-延迟任务服务实现" class="headerlink" title="4)延迟任务服务实现"></a>4)延迟任务服务实现</h3><h4 id="4-1-搭建heima-leadnews-schedule模块"><a href="#4-1-搭建heima-leadnews-schedule模块" class="headerlink" title="4.1)搭建heima-leadnews-schedule模块"></a>4.1)搭建heima-leadnews-schedule模块</h4><p>leadnews-schedule是一个通用的服务，单独创建模块来管理任何类型的延迟任务</p>
<p>①：导入资料文件夹下的heima-leadnews-schedule模块到heima-leadnews-service下，如下图所示：</p>
<p><img src="/../images/image-20210513151649297.png" srcset="/img/loading.gif" lazyload alt="image-20210513151649297"></p>
<p>②：添加bootstrap.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">51701</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">leadnews-schedule</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">discovery:</span><br>        <span class="hljs-attr">server-addr:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.130</span><span class="hljs-string">:8848</span><br>      <span class="hljs-attr">config:</span><br>        <span class="hljs-attr">server-addr:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.130</span><span class="hljs-string">:8848</span><br>        <span class="hljs-attr">file-extension:</span> <span class="hljs-string">yml</span><br></code></pre></td></tr></table></figure>

<p>③：在nacos中添加对应配置，并添加数据库及mybatis-plus的配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">datasource:</span><br>    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.jdbc.Driver</span><br>    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/leadnews_schedule?useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=UTC</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">root</span><br><span class="hljs-comment"># 设置Mapper接口所对应的XML文件位置，如果你在Mapper接口中有自定义方法，需要进行该配置</span><br><span class="hljs-attr">mybatis-plus:</span><br>  <span class="hljs-attr">mapper-locations:</span> <span class="hljs-string">classpath*:mapper/*.xml</span><br>  <span class="hljs-comment"># 设置别名包扫描路径，通过该属性可以给包中的类注册别名</span><br>  <span class="hljs-attr">type-aliases-package:</span> <span class="hljs-string">com.heima.model.schedule.pojos</span><br></code></pre></td></tr></table></figure>

<h4 id="4-2-数据库准备"><a href="#4-2-数据库准备" class="headerlink" title="4.2)数据库准备"></a>4.2)数据库准备</h4><p>导入资料中leadnews_schedule数据库</p>
<p>taskinfo 任务表</p>
<p><img src="/../images/image-20210513151812858.png" srcset="/img/loading.gif" lazyload alt="image-20210513151812858"></p>
<p>实体类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.model.schedule.pojos;<br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.IdType;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.TableField;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.TableId;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.TableName;<br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><span class="hljs-keyword">import</span> java.util.Date;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * &lt;p&gt;</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * &lt;/p&gt;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> itheima</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@TableName(&quot;taskinfo&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Taskinfo</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 任务id</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableId(type = IdType.ID_WORKER)</span><br>    <span class="hljs-keyword">private</span> Long taskId;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 执行时间</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;execute_time&quot;)</span><br>    <span class="hljs-keyword">private</span> Date executeTime;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 参数</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;parameters&quot;)</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">byte</span>[] parameters;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 优先级</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;priority&quot;)</span><br>    <span class="hljs-keyword">private</span> Integer priority;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 任务类型</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;task_type&quot;)</span><br>    <span class="hljs-keyword">private</span> Integer taskType;<br><br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>taskinfo_logs 任务日志表</p>
<p><img src="/../images/image-20210513151835752.png" srcset="/img/loading.gif" lazyload alt="image-20210513151835752"></p>
<p>实体类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.model.schedule.pojos;<br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.*;<br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><span class="hljs-keyword">import</span> java.util.Date;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * &lt;p&gt;</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * &lt;/p&gt;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> itheima</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@TableName(&quot;taskinfo_logs&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TaskinfoLogs</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 任务id</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableId(type = IdType.ID_WORKER)</span><br>    <span class="hljs-keyword">private</span> Long taskId;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 执行时间</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;execute_time&quot;)</span><br>    <span class="hljs-keyword">private</span> Date executeTime;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 参数</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;parameters&quot;)</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">byte</span>[] parameters;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 优先级</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;priority&quot;)</span><br>    <span class="hljs-keyword">private</span> Integer priority;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 任务类型</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;task_type&quot;)</span><br>    <span class="hljs-keyword">private</span> Integer taskType;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 版本号,用乐观锁</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Version</span><br>    <span class="hljs-keyword">private</span> Integer version;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 状态 0=int 1=EXECUTED 2=CANCELLED</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(&quot;status&quot;)</span><br>    <span class="hljs-keyword">private</span> Integer status;<br><br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>乐观锁支持：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * mybatis-plus乐观锁支持</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> MybatisPlusInterceptor <span class="hljs-title function_">optimisticLockerInterceptor</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">MybatisPlusInterceptor</span> <span class="hljs-variable">interceptor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MybatisPlusInterceptor</span>();<br>    interceptor.addInnerInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OptimisticLockerInnerInterceptor</span>());<br>    <span class="hljs-keyword">return</span> interceptor;<br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="4-3-安装redis"><a href="#4-3-安装redis" class="headerlink" title="4.3)安装redis"></a>4.3)安装redis</h4><p>①拉取镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker pull redis<br></code></pre></td></tr></table></figure>

<p>② 创建容器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker run -d --name redis --restart=always -p 6379:6379 redis --requirepass &quot;leadnews&quot;<br></code></pre></td></tr></table></figure>

<p>③链接测试</p>
<p> 打开资料中的Redis Desktop Manager，输入host、port、password链接测试</p>
<p><img src="/../images/image-20210513152138388.png" srcset="/img/loading.gif" lazyload alt="image-20210513152138388"></p>
<p>能链接成功，即可</p>
<h4 id="4-4-项目集成redis"><a href="#4-4-项目集成redis" class="headerlink" title="4.4)项目集成redis"></a>4.4)项目集成redis</h4><p>① 在项目导入redis相关依赖，已经完成</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-comment">&lt;!-- redis依赖commons-pool 这个依赖一定要添加 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.commons<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-pool2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>② 在heima-leadnews-schedule中集成redis,添加以下nacos配置，链接上redis</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">redis:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.130</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">leadnews</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">6379</span><br></code></pre></td></tr></table></figure>

<p>③ 拷贝资料文件夹下的类：CacheService到heima-leadnews-common模块下，并添加自动配置</p>
<p><img src="/../images/image-20210514181214681.png" srcset="/img/loading.gif" lazyload alt="image-20210514181214681"></p>
<p>④：测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.schedule.test;<br><br><br><span class="hljs-keyword">import</span> com.heima.common.redis.CacheService;<br><span class="hljs-keyword">import</span> com.heima.schedule.ScheduleApplication;<br><span class="hljs-keyword">import</span> org.junit.Test;<br><span class="hljs-keyword">import</span> org.junit.runner.RunWith;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;<br><span class="hljs-keyword">import</span> org.springframework.test.context.junit4.SpringRunner;<br><br><span class="hljs-keyword">import</span> java.util.Set;<br><br><br><span class="hljs-meta">@SpringBootTest(classes = ScheduleApplication.class)</span><br><span class="hljs-meta">@RunWith(SpringRunner.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisTest</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> CacheService cacheService;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testList</span><span class="hljs-params">()</span>&#123;<br><br>        <span class="hljs-comment">//在list的左边添加元素</span><br><span class="hljs-comment">//        cacheService.lLeftPush(&quot;list_001&quot;,&quot;hello,redis&quot;);</span><br><br>        <span class="hljs-comment">//在list的右边获取元素，并删除</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">list_001</span> <span class="hljs-operator">=</span> cacheService.lRightPop(<span class="hljs-string">&quot;list_001&quot;</span>);<br>        System.out.println(list_001);<br>    &#125;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testZset</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-comment">//添加数据到zset中  分值</span><br>        <span class="hljs-comment">/*cacheService.zAdd(&quot;zset_key_001&quot;,&quot;hello zset 001&quot;,1000);</span><br><span class="hljs-comment">        cacheService.zAdd(&quot;zset_key_001&quot;,&quot;hello zset 002&quot;,8888);</span><br><span class="hljs-comment">        cacheService.zAdd(&quot;zset_key_001&quot;,&quot;hello zset 003&quot;,7777);</span><br><span class="hljs-comment">        cacheService.zAdd(&quot;zset_key_001&quot;,&quot;hello zset 004&quot;,999999);*/</span><br><br>        <span class="hljs-comment">//按照分值获取数据</span><br>        Set&lt;String&gt; zset_key_001 = cacheService.zRangeByScore(<span class="hljs-string">&quot;zset_key_001&quot;</span>, <span class="hljs-number">0</span>, <span class="hljs-number">8888</span>);<br>        System.out.println(zset_key_001);<br><br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="4-5-添加任务"><a href="#4-5-添加任务" class="headerlink" title="4.5)添加任务"></a>4.5)添加任务</h4><p>①：拷贝mybatis-plus生成的文件，mapper</p>
<p>②：创建task类，用于接收添加任务的参数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.model.schedule.dtos;<br><br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Task</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 任务id</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Long taskId;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 类型</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Integer taskType;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 优先级</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Integer priority;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 执行id</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> executeTime;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * task参数</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">byte</span>[] parameters;<br>    <br>&#125;<br></code></pre></td></tr></table></figure>

<p>③：创建TaskService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.schedule.service;<br><br><span class="hljs-keyword">import</span> com.heima.model.schedule.dtos.Task;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 对外访问接口</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">TaskService</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 添加任务</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> task   任务对象</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span>       任务id</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">addTask</span><span class="hljs-params">(Task task)</span> ;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.schedule.service.impl;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.heima.common.constants.ScheduleConstants;<br><span class="hljs-keyword">import</span> com.heima.common.redis.CacheService;<br><span class="hljs-keyword">import</span> com.heima.model.schedule.dtos.Task;<br><span class="hljs-keyword">import</span> com.heima.model.schedule.pojos.Taskinfo;<br><span class="hljs-keyword">import</span> com.heima.model.schedule.pojos.TaskinfoLogs;<br><span class="hljs-keyword">import</span> com.heima.schedule.mapper.TaskinfoLogsMapper;<br><span class="hljs-keyword">import</span> com.heima.schedule.mapper.TaskinfoMapper;<br><span class="hljs-keyword">import</span> com.heima.schedule.service.TaskService;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.BeanUtils;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><span class="hljs-keyword">import</span> org.springframework.transaction.annotation.Transactional;<br><br><span class="hljs-keyword">import</span> java.util.Calendar;<br><span class="hljs-keyword">import</span> java.util.Date;<br><br><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@Transactional</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TaskServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">TaskService</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 添加延迟任务</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> task</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">addTask</span><span class="hljs-params">(Task task)</span> &#123;<br>        <span class="hljs-comment">//1.添加任务到数据库中</span><br><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> addTaskToDb(task);<br><br>        <span class="hljs-keyword">if</span> (success) &#123;<br>            <span class="hljs-comment">//2.添加任务到redis</span><br>            addTaskToCache(task);<br>        &#125;<br><br><br>        <span class="hljs-keyword">return</span> task.getTaskId();<br>    &#125;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> CacheService cacheService;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 把任务添加到redis中</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> task</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addTaskToCache</span><span class="hljs-params">(Task task)</span> &#123;<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> task.getTaskType() + <span class="hljs-string">&quot;_&quot;</span> + task.getPriority();<br><br>        <span class="hljs-comment">//获取5分钟之后的时间  毫秒值</span><br>        <span class="hljs-type">Calendar</span> <span class="hljs-variable">calendar</span> <span class="hljs-operator">=</span> Calendar.getInstance();<br>        calendar.add(Calendar.MINUTE, <span class="hljs-number">5</span>);<br>        <span class="hljs-type">long</span> <span class="hljs-variable">nextScheduleTime</span> <span class="hljs-operator">=</span> calendar.getTimeInMillis();<br><br>        <span class="hljs-comment">//2.1 如果任务的执行时间小于等于当前时间，存入list</span><br>        <span class="hljs-keyword">if</span> (task.getExecuteTime() &lt;= System.currentTimeMillis()) &#123;<br>            cacheService.lLeftPush(ScheduleConstants.TOPIC + key, JSON.toJSONString(task));<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (task.getExecuteTime() &lt;= nextScheduleTime) &#123;<br>            <span class="hljs-comment">//2.2 如果任务的执行时间大于当前时间 &amp;&amp; 小于等于预设时间（未来5分钟） 存入zset中</span><br>            cacheService.zAdd(ScheduleConstants.FUTURE + key, JSON.toJSONString(task), task.getExecuteTime());<br>        &#125;<br><br><br>    &#125;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> TaskinfoMapper taskinfoMapper;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> TaskinfoLogsMapper taskinfoLogsMapper;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 添加任务到数据库中</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> task</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">addTaskToDb</span><span class="hljs-params">(Task task)</span> &#123;<br><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//保存任务表</span><br>            <span class="hljs-type">Taskinfo</span> <span class="hljs-variable">taskinfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Taskinfo</span>();<br>            BeanUtils.copyProperties(task, taskinfo);<br>            taskinfo.setExecuteTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(task.getExecuteTime()));<br>            taskinfoMapper.insert(taskinfo);<br><br>            <span class="hljs-comment">//设置taskID</span><br>            task.setTaskId(taskinfo.getTaskId());<br><br>            <span class="hljs-comment">//保存任务日志数据</span><br>            <span class="hljs-type">TaskinfoLogs</span> <span class="hljs-variable">taskinfoLogs</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TaskinfoLogs</span>();<br>            BeanUtils.copyProperties(taskinfo, taskinfoLogs);<br>            taskinfoLogs.setVersion(<span class="hljs-number">1</span>);<br>            taskinfoLogs.setStatus(ScheduleConstants.SCHEDULED);<br>            taskinfoLogsMapper.insert(taskinfoLogs);<br><br>            flag = <span class="hljs-literal">true</span>;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> flag;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ScheduleConstants常量类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.common.constants;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ScheduleConstants</span> &#123;<br><br>    <span class="hljs-comment">//task状态</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> SCHEDULED=<span class="hljs-number">0</span>;   <span class="hljs-comment">//初始化状态</span><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> EXECUTED=<span class="hljs-number">1</span>;       <span class="hljs-comment">//已执行状态</span><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> CANCELLED=<span class="hljs-number">2</span>;   <span class="hljs-comment">//已取消状态</span><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String FUTURE=<span class="hljs-string">&quot;future_&quot;</span>;   <span class="hljs-comment">//未来数据key前缀</span><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String TOPIC=<span class="hljs-string">&quot;topic_&quot;</span>;     <span class="hljs-comment">//当前数据key前缀</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>④：测试</p>
<h4 id="4-6-取消任务"><a href="#4-6-取消任务" class="headerlink" title="4.6)取消任务"></a>4.6)取消任务</h4><p>在TaskService中添加方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 取消任务</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> taskId        任务id</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span>              取消结果</span><br><span class="hljs-comment">     */</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">cancelTask</span><span class="hljs-params">(<span class="hljs-type">long</span> taskId)</span>;<br><br></code></pre></td></tr></table></figure>

<p>实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 取消任务</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> taskId</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">cancelTask</span><span class="hljs-params">(<span class="hljs-type">long</span> taskId)</span> &#123;<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br><br>    <span class="hljs-comment">//删除任务，更新日志</span><br>    <span class="hljs-type">Task</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> updateDb(taskId,ScheduleConstants.EXECUTED);<br><br>    <span class="hljs-comment">//删除redis的数据</span><br>    <span class="hljs-keyword">if</span>(task != <span class="hljs-literal">null</span>)&#123;<br>        removeTaskFromCache(task);<br>        flag = <span class="hljs-literal">true</span>;<br>    &#125;<br><br><br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 删除redis中的任务数据</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> task</span><br><span class="hljs-comment">     */</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeTaskFromCache</span><span class="hljs-params">(Task task)</span> &#123;<br><br>    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> task.getTaskType()+<span class="hljs-string">&quot;_&quot;</span>+task.getPriority();<br><br>    <span class="hljs-keyword">if</span>(task.getExecuteTime()&lt;=System.currentTimeMillis())&#123;<br>        cacheService.lRemove(ScheduleConstants.TOPIC+key,<span class="hljs-number">0</span>,JSON.toJSONString(task));<br>    &#125;<span class="hljs-keyword">else</span> &#123;<br>        cacheService.zRemove(ScheduleConstants.FUTURE+key, JSON.toJSONString(task));<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 删除任务，更新任务日志状态</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> taskId</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> status</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br><span class="hljs-keyword">private</span> Task <span class="hljs-title function_">updateDb</span><span class="hljs-params">(<span class="hljs-type">long</span> taskId, <span class="hljs-type">int</span> status)</span> &#123;<br>    <span class="hljs-type">Task</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">//删除任务</span><br>        taskinfoMapper.deleteById(taskId);<br><br>        <span class="hljs-type">TaskinfoLogs</span> <span class="hljs-variable">taskinfoLogs</span> <span class="hljs-operator">=</span> taskinfoLogsMapper.selectById(taskId);<br>        taskinfoLogs.setStatus(status);<br>        taskinfoLogsMapper.updateById(taskinfoLogs);<br><br>        task = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Task</span>();<br>        BeanUtils.copyProperties(taskinfoLogs,task);<br>        task.setExecuteTime(taskinfoLogs.getExecuteTime().getTime());<br>    &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>        log.error(<span class="hljs-string">&quot;task cancel exception taskid=&#123;&#125;&quot;</span>,taskId);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> task;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>测试</p>
<h4 id="4-7-消费任务"><a href="#4-7-消费任务" class="headerlink" title="4.7)消费任务"></a>4.7)消费任务</h4><p>在TaskService中添加方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 按照类型和优先级来拉取任务</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> type</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> priority</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> Task <span class="hljs-title function_">poll</span><span class="hljs-params">(<span class="hljs-type">int</span> type,<span class="hljs-type">int</span> priority)</span>;<br></code></pre></td></tr></table></figure>

<p>实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 按照类型和优先级拉取任务</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Task <span class="hljs-title function_">poll</span><span class="hljs-params">(<span class="hljs-type">int</span> type,<span class="hljs-type">int</span> priority)</span> &#123;<br>    <span class="hljs-type">Task</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> type+<span class="hljs-string">&quot;_&quot;</span>+priority;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">task_json</span> <span class="hljs-operator">=</span> cacheService.lRightPop(ScheduleConstants.TOPIC + key);<br>        <span class="hljs-keyword">if</span>(StringUtils.isNotBlank(task_json))&#123;<br>            task = JSON.parseObject(task_json, Task.class);<br>            <span class="hljs-comment">//更新数据库信息</span><br>            updateDb(task.getTaskId(),ScheduleConstants.EXECUTED);<br>        &#125;<br>    &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>        e.printStackTrace();<br>        log.error(<span class="hljs-string">&quot;poll task exception&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> task;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="4-8-未来数据定时刷新"><a href="#4-8-未来数据定时刷新" class="headerlink" title="4.8)未来数据定时刷新"></a>4.8)未来数据定时刷新</h4><h5 id="4-8-1-reids-key值匹配"><a href="#4-8-1-reids-key值匹配" class="headerlink" title="4.8.1)reids key值匹配"></a>4.8.1)reids key值匹配</h5><p>方案1：keys 模糊匹配</p>
<p>keys的模糊匹配功能很方便也很强大，但是在生产环境需要慎用！开发中使用keys的模糊匹配却发现redis的CPU使用率极高，所以公司的redis生产环境将keys命令禁用了！redis是单线程，会被堵塞</p>
<p><img src="/../images/image-20210515162329679.png" srcset="/img/loading.gif" lazyload alt="image-20210515162329679"></p>
<p>方案2：scan </p>
<p>SCAN 命令是一个基于游标的迭代器，SCAN命令每次被调用之后， 都会向用户返回一个新的游标， 用户在下次迭代时需要使用这个新游标作为SCAN命令的游标参数， 以此来延续之前的迭代过程。</p>
<p><img src="/../images/image-20210515162419548.png" srcset="/img/loading.gif" lazyload alt="image-20210515162419548"></p>
<p>代码案例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testKeys</span><span class="hljs-params">()</span>&#123;<br>    Set&lt;String&gt; keys = cacheService.keys(<span class="hljs-string">&quot;future_*&quot;</span>);<br>    System.out.println(keys);<br><br>    Set&lt;String&gt; scan = cacheService.scan(<span class="hljs-string">&quot;future_*&quot;</span>);<br>    System.out.println(scan);<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="4-8-2-reids管道"><a href="#4-8-2-reids管道" class="headerlink" title="4.8.2)reids管道"></a>4.8.2)reids管道</h5><p>普通redis客户端和服务器交互模式</p>
<p><img src="/../images/image-20210515162537224.png" srcset="/img/loading.gif" lazyload alt="image-20210515162537224"></p>
<p>Pipeline请求模型</p>
<p><img src="/../images/image-20210515162604410.png" srcset="/img/loading.gif" lazyload alt="image-20210515162604410"></p>
<p>官方测试结果数据对比</p>
<p><img src="/../images/image-20210515162621928.png" srcset="/img/loading.gif" lazyload alt="image-20210515162621928"></p>
<p>测试案例对比：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//耗时6151</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">testPiple1</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span>System.currentTimeMillis();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt;<span class="hljs-number">10000</span> ; i++) &#123;<br>        <span class="hljs-type">Task</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Task</span>();<br>        task.setTaskType(<span class="hljs-number">1001</span>);<br>        task.setPriority(<span class="hljs-number">1</span>);<br>        task.setExecuteTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().getTime());<br>        cacheService.lLeftPush(<span class="hljs-string">&quot;1001_1&quot;</span>, JSON.toJSONString(task));<br>    &#125;<br>    System.out.println(<span class="hljs-string">&quot;耗时&quot;</span>+(System.currentTimeMillis()- start));<br>&#125;<br><br><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testPiple2</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">long</span> <span class="hljs-variable">start</span>  <span class="hljs-operator">=</span> System.currentTimeMillis();<br>    <span class="hljs-comment">//使用管道技术</span><br>    List&lt;Object&gt; objectList = cacheService.getstringRedisTemplate().executePipelined(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisCallback</span>&lt;Object&gt;() &#123;<br>        <span class="hljs-meta">@Nullable</span><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">doInRedis</span><span class="hljs-params">(RedisConnection redisConnection)</span> <span class="hljs-keyword">throws</span> DataAccessException &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt;<span class="hljs-number">10000</span> ; i++) &#123;<br>                <span class="hljs-type">Task</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Task</span>();<br>                task.setTaskType(<span class="hljs-number">1001</span>);<br>                task.setPriority(<span class="hljs-number">1</span>);<br>                task.setExecuteTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().getTime());<br>                redisConnection.lPush(<span class="hljs-string">&quot;1001_1&quot;</span>.getBytes(), JSON.toJSONString(task).getBytes());<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;);<br>    System.out.println(<span class="hljs-string">&quot;使用管道技术执行10000次自增操作共耗时:&quot;</span>+(System.currentTimeMillis()-start)+<span class="hljs-string">&quot;毫秒&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>



<h5 id="4-8-3-未来数据定时刷新-功能完成"><a href="#4-8-3-未来数据定时刷新-功能完成" class="headerlink" title="4.8.3)未来数据定时刷新-功能完成"></a>4.8.3)未来数据定时刷新-功能完成</h5><p>在TaskService中添加方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Scheduled(cron = &quot;0 */1 * * * ?&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">refresh</span><span class="hljs-params">()</span> &#123;<br>    System.out.println(System.currentTimeMillis() / <span class="hljs-number">1000</span> + <span class="hljs-string">&quot;执行了定时任务&quot;</span>);<br><br>    <span class="hljs-comment">// 获取所有未来数据集合的key值</span><br>    Set&lt;String&gt; futureKeys = cacheService.scan(ScheduleConstants.FUTURE + <span class="hljs-string">&quot;*&quot;</span>);<span class="hljs-comment">// future_*</span><br>    <span class="hljs-keyword">for</span> (String futureKey : futureKeys) &#123; <span class="hljs-comment">// future_250_250</span><br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">topicKey</span> <span class="hljs-operator">=</span> ScheduleConstants.TOPIC + futureKey.split(ScheduleConstants.FUTURE)[<span class="hljs-number">1</span>];<br>        <span class="hljs-comment">//获取该组key下当前需要消费的任务数据</span><br>        Set&lt;String&gt; tasks = cacheService.zRangeByScore(futureKey, <span class="hljs-number">0</span>, System.currentTimeMillis());<br>        <span class="hljs-keyword">if</span> (!tasks.isEmpty()) &#123;<br>            <span class="hljs-comment">//将这些任务数据添加到消费者队列中</span><br>            cacheService.refreshWithPipeline(futureKey, topicKey, tasks);<br>            System.out.println(<span class="hljs-string">&quot;成功的将&quot;</span> + futureKey + <span class="hljs-string">&quot;下的当前需要执行的任务数据刷新到&quot;</span> + topicKey + <span class="hljs-string">&quot;下&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在引导类中添加开启任务调度注解：<code>@EnableScheduling</code></p>
<h4 id="4-9-分布式锁解决集群下的方法抢占执行"><a href="#4-9-分布式锁解决集群下的方法抢占执行" class="headerlink" title="4.9)分布式锁解决集群下的方法抢占执行"></a>4.9)分布式锁解决集群下的方法抢占执行</h4><h5 id="4-9-1-问题描述"><a href="#4-9-1-问题描述" class="headerlink" title="4.9.1)问题描述"></a>4.9.1)问题描述</h5><p>启动两台heima-leadnews-schedule服务，每台服务都会去执行refresh定时任务方法</p>
<p><img src="/../images/image-20210516112243712.png" srcset="/img/loading.gif" lazyload alt="image-20210516112243712"></p>
<h5 id="4-9-2-分布式锁"><a href="#4-9-2-分布式锁" class="headerlink" title="4.9.2)分布式锁"></a>4.9.2)分布式锁</h5><p>分布式锁：控制分布式系统有序的去对共享资源进行操作，通过互斥来保证数据的一致性。</p>
<p>解决方案：</p>
<p><img src="/../images/image-20210516112457413.png" srcset="/img/loading.gif" lazyload alt="image-20210516112457413"></p>
<h5 id="4-9-3-redis分布式锁"><a href="#4-9-3-redis分布式锁" class="headerlink" title="4.9.3)redis分布式锁"></a>4.9.3)redis分布式锁</h5><p>sexnx （SET if Not eXists） 命令在指定的 key 不存在时，为 key 设置指定的值。</p>
<p><img src="/../images/image-20210516112612399.png" srcset="/img/loading.gif" lazyload alt="image-20210516112612399"></p>
<p>这种加锁的思路是，如果 key 不存在则为 key 设置 value，如果 key 已存在则 SETNX 命令不做任何操作</p>
<ul>
<li>客户端A请求服务器设置key的值，如果设置成功就表示加锁成功</li>
<li>客户端B也去请求服务器设置key的值，如果返回失败，那么就代表加锁失败</li>
<li>客户端A执行代码完成，删除锁</li>
<li>客户端B在等待一段时间后再去请求设置key的值，设置成功</li>
<li>客户端B执行代码完成，删除锁</li>
</ul>
<h5 id="4-9-4-在工具类CacheService中添加方法"><a href="#4-9-4-在工具类CacheService中添加方法" class="headerlink" title="4.9.4)在工具类CacheService中添加方法"></a>4.9.4)在工具类CacheService中添加方法</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 加锁</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> name</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> expire</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">tryLock</span><span class="hljs-params">(String name, <span class="hljs-type">long</span> expire)</span> &#123;<br>    name = name + <span class="hljs-string">&quot;_lock&quot;</span>;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> UUID.randomUUID().toString();<br>    <span class="hljs-type">RedisConnectionFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> stringRedisTemplate.getConnectionFactory();<br>    <span class="hljs-type">RedisConnection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> factory.getConnection();<br>    <span class="hljs-keyword">try</span> &#123;<br><br>        <span class="hljs-comment">//参考redis命令：</span><br>        <span class="hljs-comment">//set key value [EX seconds] [PX milliseconds] [NX|XX]</span><br>        <span class="hljs-type">Boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> conn.set(<br>                name.getBytes(),<br>                token.getBytes(),<br>                Expiration.from(expire, TimeUnit.MILLISECONDS),<br>                RedisStringCommands.SetOption.SET_IF_ABSENT <span class="hljs-comment">//NX</span><br>        );<br>        <span class="hljs-keyword">if</span> (result != <span class="hljs-literal">null</span> &amp;&amp; result)<br>            <span class="hljs-keyword">return</span> token;<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>        RedisConnectionUtils.releaseConnection(conn, factory,<span class="hljs-literal">false</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>修改未来数据定时刷新的方法，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 未来数据定时刷新</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Scheduled(cron = &quot;0 */1 * * * ?&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">refresh</span><span class="hljs-params">()</span>&#123;<br><br>    <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> cacheService.tryLock(<span class="hljs-string">&quot;FUTURE_TASK_SYNC&quot;</span>, <span class="hljs-number">1000</span> * <span class="hljs-number">30</span>);<br>    <span class="hljs-keyword">if</span>(StringUtils.isNotBlank(token))&#123;<br>        log.info(<span class="hljs-string">&quot;未来数据定时刷新---定时任务&quot;</span>);<br><br>        <span class="hljs-comment">//获取所有未来数据的集合key</span><br>        Set&lt;String&gt; futureKeys = cacheService.scan(ScheduleConstants.FUTURE + <span class="hljs-string">&quot;*&quot;</span>);<br>        <span class="hljs-keyword">for</span> (String futureKey : futureKeys) &#123;<span class="hljs-comment">//future_100_50</span><br><br>            <span class="hljs-comment">//获取当前数据的key  topic</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">topicKey</span> <span class="hljs-operator">=</span> ScheduleConstants.TOPIC+futureKey.split(ScheduleConstants.FUTURE)[<span class="hljs-number">1</span>];<br><br>            <span class="hljs-comment">//按照key和分值查询符合条件的数据</span><br>            Set&lt;String&gt; tasks = cacheService.zRangeByScore(futureKey, <span class="hljs-number">0</span>, System.currentTimeMillis());<br><br>            <span class="hljs-comment">//同步数据</span><br>            <span class="hljs-keyword">if</span>(!tasks.isEmpty())&#123;<br>                cacheService.refreshWithPipeline(futureKey,topicKey,tasks);<br>                log.info(<span class="hljs-string">&quot;成功的将&quot;</span>+futureKey+<span class="hljs-string">&quot;刷新到了&quot;</span>+topicKey);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="4-10-数据库同步到redis"><a href="#4-10-数据库同步到redis" class="headerlink" title="4.10)数据库同步到redis"></a>4.10)数据库同步到redis</h4><p><img src="/../images/image-20210721013255332.png" srcset="/img/loading.gif" lazyload alt="image-20210721013255332"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Scheduled(cron = &quot;0 */5 * * * ?&quot;)</span><br><span class="hljs-meta">@PostConstruct</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">reloadData</span><span class="hljs-params">()</span> &#123;<br>    clearCache();<br>    log.info(<span class="hljs-string">&quot;数据库数据同步到缓存&quot;</span>);<br>    <span class="hljs-type">Calendar</span> <span class="hljs-variable">calendar</span> <span class="hljs-operator">=</span> Calendar.getInstance();<br>    calendar.add(Calendar.MINUTE, <span class="hljs-number">5</span>);<br><br>    <span class="hljs-comment">//查看小于未来5分钟的所有任务</span><br>    List&lt;Taskinfo&gt; allTasks = taskinfoMapper.selectList(Wrappers.&lt;Taskinfo&gt;lambdaQuery().lt(Taskinfo::getExecuteTime,calendar.getTime()));<br>    <span class="hljs-keyword">if</span>(allTasks != <span class="hljs-literal">null</span> &amp;&amp; allTasks.size() &gt; <span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-keyword">for</span> (Taskinfo taskinfo : allTasks) &#123;<br>            <span class="hljs-type">Task</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Task</span>();<br>            BeanUtils.copyProperties(taskinfo,task);<br>            task.setExecuteTime(taskinfo.getExecuteTime().getTime());<br>            addTaskToCache(task);<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clearCache</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-comment">// 删除缓存中未来数据集合和当前消费者队列的所有key</span><br>    Set&lt;String&gt; futurekeys = cacheService.scan(ScheduleConstants.FUTURE + <span class="hljs-string">&quot;*&quot;</span>);<span class="hljs-comment">// future_</span><br>    Set&lt;String&gt; topickeys = cacheService.scan(ScheduleConstants.TOPIC + <span class="hljs-string">&quot;*&quot;</span>);<span class="hljs-comment">// topic_</span><br>    cacheService.delete(futurekeys);<br>    cacheService.delete(topickeys);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="5-延迟队列解决精准时间发布文章"><a href="#5-延迟队列解决精准时间发布文章" class="headerlink" title="5)延迟队列解决精准时间发布文章"></a>5)延迟队列解决精准时间发布文章</h3><h5 id="5-1-延迟队列服务提供对外接口"><a href="#5-1-延迟队列服务提供对外接口" class="headerlink" title="5.1)延迟队列服务提供对外接口"></a>5.1)延迟队列服务提供对外接口</h5><p>提供远程的feign接口，在heima-leadnews-feign-api编写类如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.apis.schedule;<br><br><span class="hljs-keyword">import</span> com.heima.model.common.dtos.ResponseResult;<br><span class="hljs-keyword">import</span> com.heima.model.schedule.dtos.Task;<br><span class="hljs-keyword">import</span> org.springframework.cloud.openfeign.FeignClient;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PathVariable;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PostMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestBody;<br><br><span class="hljs-meta">@FeignClient(&quot;leadnews-schedule&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IScheduleClient</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 添加任务</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> task   任务对象</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span>       任务id</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@PostMapping(&quot;/api/v1/task/add&quot;)</span><br>    <span class="hljs-keyword">public</span> ResponseResult  <span class="hljs-title function_">addTask</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> Task task)</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 取消任务</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> taskId        任务id</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span>              取消结果</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@GetMapping(&quot;/api/v1/task/cancel/&#123;taskId&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">cancelTask</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;taskId&quot;)</span> <span class="hljs-type">long</span> taskId)</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 按照类型和优先级来拉取任务</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> type</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> priority</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@GetMapping(&quot;/api/v1/task/poll/&#123;type&#125;/&#123;priority&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">poll</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;type&quot;)</span> <span class="hljs-type">int</span> type,<span class="hljs-meta">@PathVariable(&quot;priority&quot;)</span>  <span class="hljs-type">int</span> priority)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在heima-leadnews-schedule微服务下提供对应的实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.schedule.feign;<br><br><span class="hljs-keyword">import</span> com.heima.apis.schedule.IScheduleClient;<br><span class="hljs-keyword">import</span> com.heima.model.common.dtos.ResponseResult;<br><span class="hljs-keyword">import</span> com.heima.model.schedule.dtos.Task;<br><span class="hljs-keyword">import</span> com.heima.schedule.service.TaskService;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.*;<br><br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ScheduleClient</span>  <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IScheduleClient</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> TaskService taskService;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 添加任务</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> task 任务对象</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 任务id</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@PostMapping(&quot;/api/v1/task/add&quot;)</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">addTask</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> Task task)</span> &#123;<br>        <span class="hljs-keyword">return</span> ResponseResult.okResult(taskService.addTask(task));<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 取消任务</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> taskId 任务id</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 取消结果</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@GetMapping(&quot;/api/v1/task/cancel/&#123;taskId&#125;&quot;)</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">cancelTask</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;taskId&quot;)</span> <span class="hljs-type">long</span> taskId)</span> &#123;<br>        <span class="hljs-keyword">return</span> ResponseResult.okResult(taskService.cancelTask(taskId));<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 按照类型和优先级来拉取任务</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> type</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> priority</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@GetMapping(&quot;/api/v1/task/poll/&#123;type&#125;/&#123;priority&#125;&quot;)</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">poll</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;type&quot;)</span> <span class="hljs-type">int</span> type, <span class="hljs-meta">@PathVariable(&quot;priority&quot;)</span> <span class="hljs-type">int</span> priority)</span> &#123;<br>        <span class="hljs-keyword">return</span> ResponseResult.okResult(taskService.poll(type,priority));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="5-2-发布文章集成添加延迟队列接口"><a href="#5-2-发布文章集成添加延迟队列接口" class="headerlink" title="5.2)发布文章集成添加延迟队列接口"></a>5.2)发布文章集成添加延迟队列接口</h5><p>在创建WmNewsTaskService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.wemedia.service;<br><br><span class="hljs-keyword">import</span> com.heima.model.wemedia.pojos.WmNews;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">WmNewsTaskService</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 添加任务到延迟队列中</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> id  文章的id</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> publishTime  发布的时间  可以做为任务的执行时间</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addNewsToTask</span><span class="hljs-params">(Integer id, Date publishTime)</span>;<br><br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.wemedia.service.impl;<br><br><span class="hljs-keyword">import</span> com.heima.apis.schedule.IScheduleClient;<br><span class="hljs-keyword">import</span> com.heima.model.common.enums.TaskTypeEnum;<br><span class="hljs-keyword">import</span> com.heima.model.schedule.dtos.Task;<br><span class="hljs-keyword">import</span> com.heima.model.wemedia.pojos.WmNews;<br><span class="hljs-keyword">import</span> com.heima.utils.common.ProtostuffUtil;<br><span class="hljs-keyword">import</span> com.heima.wemedia.service.WmNewsTaskService;<br><span class="hljs-keyword">import</span> lombok.SneakyThrows;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.scheduling.annotation.Async;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><br><br><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WmNewsTaskServiceImpl</span>  <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WmNewsTaskService</span> &#123;<br><br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> IScheduleClient scheduleClient;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 添加任务到延迟队列中</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> id          文章的id</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> publishTime 发布的时间  可以做为任务的执行时间</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-meta">@Async</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addNewsToTask</span><span class="hljs-params">(Integer id, Date publishTime)</span> &#123;<br><br>        log.info(<span class="hljs-string">&quot;添加任务到延迟服务中----begin&quot;</span>);<br><br>        <span class="hljs-type">Task</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Task</span>();<br>        task.setExecuteTime(publishTime.getTime());<br>        task.setTaskType(TaskTypeEnum.NEWS_SCAN_TIME.getTaskType());<br>        task.setPriority(TaskTypeEnum.NEWS_SCAN_TIME.getPriority());<br>        <span class="hljs-type">WmNews</span> <span class="hljs-variable">wmNews</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WmNews</span>();<br>        wmNews.setId(id);<br>        task.setParameters(ProtostuffUtil.serialize(wmNews));<br><br>        scheduleClient.addTask(task);<br><br>        log.info(<span class="hljs-string">&quot;添加任务到延迟服务中----end&quot;</span>);<br><br>    &#125;<br>    <br>&#125;<br></code></pre></td></tr></table></figure>



<p>枚举类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.model.common.enums;<br><br><span class="hljs-keyword">import</span> lombok.AllArgsConstructor;<br><span class="hljs-keyword">import</span> lombok.Getter;<br><br><span class="hljs-meta">@Getter</span><br><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">TaskTypeEnum</span> &#123;<br><br>    NEWS_SCAN_TIME(<span class="hljs-number">1001</span>, <span class="hljs-number">1</span>,<span class="hljs-string">&quot;文章定时审核&quot;</span>),<br>    REMOTEERROR(<span class="hljs-number">1002</span>, <span class="hljs-number">2</span>,<span class="hljs-string">&quot;第三方接口调用失败，重试&quot;</span>);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> taskType; <span class="hljs-comment">//对应具体业务</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> priority; <span class="hljs-comment">//业务不同级别</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String desc; <span class="hljs-comment">//描述信息</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>序列化工具对比</p>
<ul>
<li>JdkSerialize：java内置的序列化能将实现了Serilazable接口的对象进行序列化和反序列化， ObjectOutputStream的writeObject()方法可序列化对象生成字节数组</li>
<li>Protostuff：google开源的protostuff采用更为紧凑的二进制数组，表现更加优异，然后使用protostuff的编译工具生成pojo类</li>
</ul>
<p>拷贝资料中的两个类到heima-leadnews-utils下</p>
<p>Protostuff需要引导依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.protostuff<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>protostuff-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.6.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.protostuff<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>protostuff-runtime<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.6.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>



<p>修改发布文章代码：</p>
<p>把之前的异步调用修改为调用延迟任务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> WmNewsTaskService wmNewsTaskService;<br> <br><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 发布修改文章或保存为草稿</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> dto</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">submitNews</span><span class="hljs-params">(WmNewsDto dto)</span> &#123;<br><br>    <span class="hljs-comment">//0.条件判断</span><br>    <span class="hljs-keyword">if</span>(dto == <span class="hljs-literal">null</span> || dto.getContent() == <span class="hljs-literal">null</span>)&#123;<br>        <span class="hljs-keyword">return</span> ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID);<br>    &#125;<br><br>    <span class="hljs-comment">//1.保存或修改文章</span><br><br>    <span class="hljs-type">WmNews</span> <span class="hljs-variable">wmNews</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WmNews</span>();<br>    <span class="hljs-comment">//属性拷贝 属性名词和类型相同才能拷贝</span><br>    BeanUtils.copyProperties(dto,wmNews);<br>    <span class="hljs-comment">//封面图片  list---&gt; string</span><br>    <span class="hljs-keyword">if</span>(dto.getImages() != <span class="hljs-literal">null</span> &amp;&amp; dto.getImages().size() &gt; <span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-comment">//[1dddfsd.jpg,sdlfjldk.jpg]--&gt;   1dddfsd.jpg,sdlfjldk.jpg</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">imageStr</span> <span class="hljs-operator">=</span> StringUtils.join(dto.getImages(), <span class="hljs-string">&quot;,&quot;</span>);<br>        wmNews.setImages(imageStr);<br>    &#125;<br>    <span class="hljs-comment">//如果当前封面类型为自动 -1</span><br>    <span class="hljs-keyword">if</span>(dto.getType().equals(WemediaConstants.WM_NEWS_TYPE_AUTO))&#123;<br>        wmNews.setType(<span class="hljs-literal">null</span>);<br>    &#125;<br><br>    saveOrUpdateWmNews(wmNews);<br><br>    <span class="hljs-comment">//2.判断是否为草稿  如果为草稿结束当前方法</span><br>    <span class="hljs-keyword">if</span>(dto.getStatus().equals(WmNews.Status.NORMAL.getCode()))&#123;<br>        <span class="hljs-keyword">return</span> ResponseResult.okResult(AppHttpCodeEnum.SUCCESS);<br>    &#125;<br><br>    <span class="hljs-comment">//3.不是草稿，保存文章内容图片与素材的关系</span><br>    <span class="hljs-comment">//获取到文章内容中的图片信息</span><br>    List&lt;String&gt; materials =  ectractUrlInfo(dto.getContent());<br>    saveRelativeInfoForContent(materials,wmNews.getId());<br><br>    <span class="hljs-comment">//4.不是草稿，保存文章封面图片与素材的关系，如果当前布局是自动，需要匹配封面图片</span><br>    saveRelativeInfoForCover(dto,wmNews,materials);<br><br>    <span class="hljs-comment">//审核文章</span><br>    <span class="hljs-comment">//        wmNewsAutoScanService.autoScanWmNews(wmNews.getId());</span><br>    wmNewsTaskService.addNewsToTask(wmNews.getId(),wmNews.getPublishTime());<br><br>    <span class="hljs-keyword">return</span> ResponseResult.okResult(AppHttpCodeEnum.SUCCESS);<br><br>&#125;<br></code></pre></td></tr></table></figure>



<h5 id="5-3-消费任务进行审核文章"><a href="#5-3-消费任务进行审核文章" class="headerlink" title="5.3)消费任务进行审核文章"></a>5.3)消费任务进行审核文章</h5><p>WmNewsTaskService中添加方法</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 消费延迟队列数据</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">scanNewsByTask</span>()</span>;<br></code></pre></td></tr></table></figure>

<p>实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> WmNewsAutoScanServiceImpl wmNewsAutoScanService;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 消费延迟队列数据</span><br><span class="hljs-comment">     */</span><br><span class="hljs-meta">@Scheduled(fixedRate = 1000)</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-meta">@SneakyThrows</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">scanNewsByTask</span><span class="hljs-params">()</span> &#123;<br><br>    log.info(<span class="hljs-string">&quot;文章审核---消费任务执行---begin---&quot;</span>);<br><br>    <span class="hljs-type">ResponseResult</span> <span class="hljs-variable">responseResult</span> <span class="hljs-operator">=</span> scheduleClient.poll(TaskTypeEnum.NEWS_SCAN_TIME.getTaskType(), TaskTypeEnum.NEWS_SCAN_TIME.getPriority());<br>    <span class="hljs-keyword">if</span>(responseResult.getCode().equals(<span class="hljs-number">200</span>) &amp;&amp; responseResult.getData() != <span class="hljs-literal">null</span>)&#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">json_str</span> <span class="hljs-operator">=</span> JSON.toJSONString(responseResult.getData());<br>        <span class="hljs-type">Task</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> JSON.parseObject(json_str, Task.class);<br>        <span class="hljs-type">byte</span>[] parameters = task.getParameters();<br>        <span class="hljs-type">WmNews</span> <span class="hljs-variable">wmNews</span> <span class="hljs-operator">=</span> ProtostuffUtil.deserialize(parameters, WmNews.class);<br>        System.out.println(wmNews.getId()+<span class="hljs-string">&quot;-----------&quot;</span>);<br>        wmNewsAutoScanService.autoScanWmNews(wmNews.getId());<br>    &#125;<br>    log.info(<span class="hljs-string">&quot;文章审核---消费任务执行---end---&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在WemediaApplication自媒体的引导类中添加开启任务调度注解<code>@EnableScheduling</code></p>
<h3 id="6-作业"><a href="#6-作业" class="headerlink" title="6)作业"></a>6)作业</h3><h1 id="6-kafka及异步通知文章上下架"><a href="#6-kafka及异步通知文章上下架" class="headerlink" title="6 kafka及异步通知文章上下架"></a>6 kafka及异步通知文章上下架</h1><h3 id="1-自媒体文章上下架"><a href="#1-自媒体文章上下架" class="headerlink" title="1)自媒体文章上下架"></a>1)自媒体文章上下架</h3><p>需求分析</p>
<p><img src="/../images/image-20210525180731705.png" srcset="/img/loading.gif" lazyload alt="image-20210525180731705"></p>
<p><img src="/../images/image-20210525180757907.png" srcset="/img/loading.gif" lazyload alt="image-20210525180757907"></p>
<h3 id="2-kafka概述"><a href="#2-kafka概述" class="headerlink" title="2)kafka概述"></a>2)kafka概述</h3><p>消息中间件对比                              </p>
<table>
<thead>
<tr>
<th>特性</th>
<th>ActiveMQ</th>
<th>RabbitMQ</th>
<th>RocketMQ</th>
<th>Kafka</th>
</tr>
</thead>
<tbody><tr>
<td>开发语言</td>
<td>java</td>
<td>erlang</td>
<td>java</td>
<td>scala</td>
</tr>
<tr>
<td>单机吞吐量</td>
<td>万级</td>
<td>万级</td>
<td>10万级</td>
<td>100万级</td>
</tr>
<tr>
<td>时效性</td>
<td>ms</td>
<td>us</td>
<td>ms</td>
<td>ms级以内</td>
</tr>
<tr>
<td>可用性</td>
<td>高（主从）</td>
<td>高（主从）</td>
<td>非常高（分布式）</td>
<td>非常高（分布式）</td>
</tr>
<tr>
<td>功能特性</td>
<td>成熟的产品、较全的文档、各种协议支持好</td>
<td>并发能力强、性能好、延迟低</td>
<td>MQ功能比较完善，扩展性佳</td>
<td>只支持主要的MQ功能，主要应用于大数据领域</td>
</tr>
</tbody></table>
<p>消息中间件对比-选择建议</p>
<table>
<thead>
<tr>
<th><strong>消息中间件</strong></th>
<th><strong>建议</strong></th>
</tr>
</thead>
<tbody><tr>
<td>Kafka</td>
<td>追求高吞吐量，适合产生大量数据的互联网服务的数据收集业务</td>
</tr>
<tr>
<td>RocketMQ</td>
<td>可靠性要求很高的金融互联网领域,稳定性高，经历了多次阿里双11考验</td>
</tr>
<tr>
<td>RabbitMQ</td>
<td>性能较好，社区活跃度高，数据量没有那么大，优先选择功能比较完备的RabbitMQ</td>
</tr>
</tbody></table>
<p>kafka介绍</p>
<p>Kafka 是一个分布式流媒体平台,类似于消息队列或企业消息传递系统。kafka官网：<a target="_blank" rel="noopener" href="http://kafka.apache.org/">http://kafka.apache.org/</a>  </p>
<p><img src="/../images/image-20210525181028436.png" srcset="/img/loading.gif" lazyload alt="image-20210525181028436"></p>
<p>kafka介绍-名词解释</p>
<p><img src="/../images/image-20210525181100793.png" srcset="/img/loading.gif" lazyload alt="image-20210525181100793"></p>
<ul>
<li><p>producer：发布消息的对象称之为主题生产者（Kafka topic producer）</p>
</li>
<li><p>topic：Kafka将消息分门别类，每一类的消息称之为一个主题（Topic）</p>
</li>
<li><p>consumer：订阅消息并处理发布的消息的对象称之为主题消费者（consumers）</p>
</li>
<li><p>broker：已发布的消息保存在一组服务器中，称之为Kafka集群。集群中的每一个服务器都是一个代理（Broker）。 消费者可以订阅一个或多个主题（topic），并从Broker拉数据，从而消费这些已发布的消息。</p>
</li>
</ul>
<h3 id="3-kafka安装配置"><a href="#3-kafka安装配置" class="headerlink" title="3)kafka安装配置"></a>3)kafka安装配置</h3><p>Kafka对于zookeeper是强依赖，保存kafka相关的节点数据，所以安装Kafka之前必须先安装zookeeper</p>
<ul>
<li>Docker安装zookeeper</li>
</ul>
<p>下载镜像：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker pull zookeeper:3.4.14<br></code></pre></td></tr></table></figure>

<p>创建容器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker run -d --name zookeeper -p 2181:2181 zookeeper:3.4.14<br></code></pre></td></tr></table></figure>

<ul>
<li>Docker安装kafka</li>
</ul>
<p>下载镜像：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker pull wurstmeister/kafka:2.12-2.3.1<br></code></pre></td></tr></table></figure>

<p>创建容器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker run -d --name kafka \<br>--env KAFKA_ADVERTISED_HOST_NAME=192.168.200.130 \<br>--env KAFKA_ZOOKEEPER_CONNECT=192.168.200.130:2181 \<br>--env KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://192.168.200.130:9092 \<br>--env KAFKA_LISTENERS=PLAINTEXT://0.0.0.0:9092 \<br>--env KAFKA_HEAP_OPTS=&quot;-Xmx256M -Xms256M&quot; \<br>--net=host wurstmeister/kafka:2.12-2.3.1<br></code></pre></td></tr></table></figure>

<h3 id="4-kafka入门"><a href="#4-kafka入门" class="headerlink" title="4)kafka入门"></a>4)kafka入门</h3><p><img src="/../images/image-20210525181412230.png" srcset="/img/loading.gif" lazyload alt="image-20210525181412230"></p>
<ul>
<li>生产者发送消息，多个消费者只能有一个消费者接收到消息</li>
<li>生产者发送消息，多个消费者都可以接收到消息</li>
</ul>
<p>（1）创建kafka-demo项目，导入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.kafka<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>kafka-clients<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>（2）生产者发送消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.kafka.sample;<br><br><span class="hljs-keyword">import</span> org.apache.kafka.clients.producer.KafkaProducer;<br><span class="hljs-keyword">import</span> org.apache.kafka.clients.producer.ProducerConfig;<br><span class="hljs-keyword">import</span> org.apache.kafka.clients.producer.ProducerRecord;<br><br><span class="hljs-keyword">import</span> java.util.Properties;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 生产者</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProducerQuickStart</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">//1.kafka的配置信息</span><br>        <span class="hljs-type">Properties</span> <span class="hljs-variable">properties</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();<br>        <span class="hljs-comment">//kafka的连接地址</span><br>        properties.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG,<span class="hljs-string">&quot;192.168.200.130:9092&quot;</span>);<br>        <span class="hljs-comment">//发送失败，失败的重试次数</span><br>        properties.put(ProducerConfig.RETRIES_CONFIG,<span class="hljs-number">5</span>);<br>        <span class="hljs-comment">//消息key的序列化器</span><br>        properties.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG,<span class="hljs-string">&quot;org.apache.kafka.common.serialization.StringSerializer&quot;</span>);<br>        <span class="hljs-comment">//消息value的序列化器</span><br>        properties.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG,<span class="hljs-string">&quot;org.apache.kafka.common.serialization.StringSerializer&quot;</span>);<br><br>        <span class="hljs-comment">//2.生产者对象</span><br>        KafkaProducer&lt;String,String&gt; producer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">KafkaProducer</span>&lt;String, String&gt;(properties);<br><br>        <span class="hljs-comment">//封装发送的消息</span><br>        ProducerRecord&lt;String,String&gt; record = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProducerRecord</span>&lt;String, String&gt;(<span class="hljs-string">&quot;itheima-topic&quot;</span>,<span class="hljs-string">&quot;100001&quot;</span>,<span class="hljs-string">&quot;hello kafka&quot;</span>);<br><br>        <span class="hljs-comment">//3.发送消息</span><br>        producer.send(record);<br><br>        <span class="hljs-comment">//4.关闭消息通道，必须关闭，否则消息发送不成功</span><br>        producer.close();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>



<p>（3）消费者接收消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.kafka.sample;<br><br><span class="hljs-keyword">import</span> org.apache.kafka.clients.consumer.ConsumerConfig;<br><span class="hljs-keyword">import</span> org.apache.kafka.clients.consumer.ConsumerRecord;<br><span class="hljs-keyword">import</span> org.apache.kafka.clients.consumer.ConsumerRecords;<br><span class="hljs-keyword">import</span> org.apache.kafka.clients.consumer.KafkaConsumer;<br><br><span class="hljs-keyword">import</span> java.time.Duration;<br><span class="hljs-keyword">import</span> java.util.Collections;<br><span class="hljs-keyword">import</span> java.util.Properties;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 消费者</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConsumerQuickStart</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">//1.添加kafka的配置信息</span><br>        <span class="hljs-type">Properties</span> <span class="hljs-variable">properties</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();<br>        <span class="hljs-comment">//kafka的连接地址</span><br>        properties.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, <span class="hljs-string">&quot;192.168.200.130:9092&quot;</span>);<br>        <span class="hljs-comment">//消费者组</span><br>        properties.put(ConsumerConfig.GROUP_ID_CONFIG, <span class="hljs-string">&quot;group2&quot;</span>);<br>        <span class="hljs-comment">//消息的反序列化器</span><br>        properties.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, <span class="hljs-string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span>);<br>        properties.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, <span class="hljs-string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span>);<br><br>        <span class="hljs-comment">//2.消费者对象</span><br>        KafkaConsumer&lt;String, String&gt; consumer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">KafkaConsumer</span>&lt;String, String&gt;(properties);<br><br>        <span class="hljs-comment">//3.订阅主题</span><br>        consumer.subscribe(Collections.singletonList(<span class="hljs-string">&quot;itheima-topic&quot;</span>));<br><br>        <span class="hljs-comment">//当前线程一直处于监听状态</span><br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>            <span class="hljs-comment">//4.获取消息</span><br>            ConsumerRecords&lt;String, String&gt; consumerRecords = consumer.poll(Duration.ofMillis(<span class="hljs-number">1000</span>));<br>            <span class="hljs-keyword">for</span> (ConsumerRecord&lt;String, String&gt; consumerRecord : consumerRecords) &#123;<br>                System.out.println(consumerRecord.key());<br>                System.out.println(consumerRecord.value());<br>            &#125;<br>        &#125;<br><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>



<p>总结</p>
<ul>
<li>生产者发送消息，多个消费者订阅同一个主题，只能有一个消费者收到消息（一对一）</li>
<li>生产者发送消息，多个消费者订阅同一个主题，所有消费者都能收到消息（一对多）</li>
</ul>
<h3 id="5-kafka高可用设计"><a href="#5-kafka高可用设计" class="headerlink" title="5)kafka高可用设计"></a>5)kafka高可用设计</h3><h4 id="5-1-集群"><a href="#5-1-集群" class="headerlink" title="5.1)集群"></a>5.1)集群</h4><p><img src="/../images/image-20210530223101568.png" srcset="/img/loading.gif" lazyload alt="image-20210530223101568"></p>
<ul>
<li><p>Kafka 的服务器端由被称为 Broker 的服务进程构成，即一个 Kafka 集群由多个 Broker 组成</p>
</li>
<li><p>这样如果集群中某一台机器宕机，其他机器上的 Broker 也依然能够对外提供服务。这其实就是 Kafka 提供高可用的手段之一</p>
</li>
</ul>
<h4 id="5-2-备份机制-Replication）"><a href="#5-2-备份机制-Replication）" class="headerlink" title="5.2)备份机制(Replication）"></a>5.2)备份机制(Replication）</h4><p><img src="/../images/image-20210530223218580.png" srcset="/img/loading.gif" lazyload alt="image-20210530223218580"></p>
<p>Kafka 中消息的备份又叫做 副本（Replica）</p>
<p>Kafka 定义了两类副本：</p>
<ul>
<li><p>领导者副本（Leader Replica）</p>
</li>
<li><p>追随者副本（Follower Replica）</p>
</li>
</ul>
<p><strong>同步方式</strong></p>
<p><img src="/../images/image-20210530223316815.png" srcset="/img/loading.gif" lazyload alt="image-20210530223316815"></p>
<p>ISR（in-sync replica）需要同步复制保存的follower</p>
<p>如果leader失效后，需要选出新的leader，选举的原则如下：</p>
<p>第一：选举时优先从ISR中选定，因为这个列表中follower的数据是与leader同步的</p>
<p>第二：如果ISR列表中的follower都不行了，就只能从其他follower中选取</p>
<p>极端情况，就是所有副本都失效了，这时有两种方案</p>
<p>第一：等待ISR中的一个活过来，选为Leader，数据可靠，但活过来的时间不确定</p>
<p>第二：选择第一个活过来的Replication，不一定是ISR中的，选为leader，以最快速度恢复可用性，但数据不一定完整</p>
<h3 id="6-kafka生产者详解"><a href="#6-kafka生产者详解" class="headerlink" title="6)kafka生产者详解"></a>6)kafka生产者详解</h3><h4 id="6-1-发送类型"><a href="#6-1-发送类型" class="headerlink" title="6.1)发送类型"></a>6.1)发送类型</h4><ul>
<li><p>同步发送</p>
<p>  使用send()方法发送，它会返回一个Future对象，调用get()方法进行等待，就可以知道消息是否发送成功</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">RecordMetadata</span> <span class="hljs-variable">recordMetadata</span> <span class="hljs-operator">=</span> producer.send(kvProducerRecord).get();<br>System.out.println(recordMetadata.offset());<br></code></pre></td></tr></table></figure>

<ul>
<li><p>异步发送</p>
<p>  调用send()方法，并指定一个回调函数，服务器在返回响应时调用函数</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//异步消息发送</span><br>producer.send(kvProducerRecord, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Callback</span>() &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCompletion</span><span class="hljs-params">(RecordMetadata recordMetadata, Exception e)</span> &#123;<br>        <span class="hljs-keyword">if</span>(e != <span class="hljs-literal">null</span>)&#123;<br>            System.out.println(<span class="hljs-string">&quot;记录异常信息到日志表中&quot;</span>);<br>        &#125;<br>        System.out.println(recordMetadata.offset());<br>    &#125;<br>&#125;);<br></code></pre></td></tr></table></figure>

<h4 id="6-2-参数详解"><a href="#6-2-参数详解" class="headerlink" title="6.2)参数详解"></a>6.2)参数详解</h4><ul>
<li>ack</li>
</ul>
<p><img src="/../images/image-20210530224302935.png" srcset="/img/loading.gif" lazyload alt="image-20210530224302935"></p>
<p>代码的配置方式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//ack配置  消息确认机制</span><br>prop.put(ProducerConfig.ACKS_CONFIG,<span class="hljs-string">&quot;all&quot;</span>);<br></code></pre></td></tr></table></figure>

<p>参数的选择说明</p>
<table>
<thead>
<tr>
<th><strong>确认机制</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>acks=0</td>
<td>生产者在成功写入消息之前不会等待任何来自服务器的响应,消息有丢失的风险，但是速度最快</td>
</tr>
<tr>
<td>acks=1（默认值）</td>
<td>只要集群首领节点收到消息，生产者就会收到一个来自服务器的成功响应</td>
</tr>
<tr>
<td>acks=all</td>
<td>只有当所有参与赋值的节点全部收到消息时，生产者才会收到一个来自服务器的成功响应</td>
</tr>
</tbody></table>
<ul>
<li>retries</li>
</ul>
<p><img src="/../images/image-20210530224406689.png" srcset="/img/loading.gif" lazyload alt="image-20210530224406689"></p>
<p>生产者从服务器收到的错误有可能是临时性错误，在这种情况下，retries参数的值决定了生产者可以重发消息的次数，如果达到这个次数，生产者会放弃重试返回错误，默认情况下，生产者会在每次重试之间等待100ms</p>
<p>代码中配置方式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//重试次数</span><br>prop.put(ProducerConfig.RETRIES_CONFIG,<span class="hljs-number">10</span>);<br></code></pre></td></tr></table></figure>

<ul>
<li>消息压缩</li>
</ul>
<p>默认情况下， 消息发送时不会被压缩。</p>
<p>代码中配置方式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//数据压缩</span><br>prop.put(ProducerConfig.COMPRESSION_TYPE_CONFIG,<span class="hljs-string">&quot;lz4&quot;</span>);<br></code></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th><strong>压缩算法</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>snappy</td>
<td>占用较少的  CPU，  却能提供较好的性能和相当可观的压缩比， 如果看重性能和网络带宽，建议采用</td>
</tr>
<tr>
<td>lz4</td>
<td>占用较少的 CPU， 压缩和解压缩速度较快，压缩比也很客观</td>
</tr>
<tr>
<td>gzip</td>
<td>占用较多的  CPU，但会提供更高的压缩比，网络带宽有限，可以使用这种算法</td>
</tr>
</tbody></table>
<p>使用压缩可以降低网络传输开销和存储开销，而这往往是向 Kafka 发送消息的瓶颈所在。</p>
<h3 id="7-kafka消费者详解"><a href="#7-kafka消费者详解" class="headerlink" title="7)kafka消费者详解"></a>7)kafka消费者详解</h3><h4 id="7-1-消费者组"><a href="#7-1-消费者组" class="headerlink" title="7.1)消费者组"></a>7.1)消费者组</h4><p><img src="/../images/image-20210530224706747.png" srcset="/img/loading.gif" lazyload alt="image-20210530224706747"></p>
<ul>
<li><p>消费者组（Consumer Group） ：指的就是由一个或多个消费者组成的群体</p>
</li>
<li><p>一个发布在Topic上消息被分发给此消费者组中的一个消费者</p>
<ul>
<li><p>所有的消费者都在一个组中，那么这就变成了queue模型</p>
</li>
<li><p>所有的消费者都在不同的组中，那么就完全变成了发布-订阅模型</p>
</li>
</ul>
</li>
</ul>
<h4 id="7-2-消息有序性"><a href="#7-2-消息有序性" class="headerlink" title="7.2)消息有序性"></a>7.2)消息有序性</h4><p>应用场景：</p>
<ul>
<li><p>即时消息中的单对单聊天和群聊，保证发送方消息发送顺序与接收方的顺序一致</p>
</li>
<li><p>充值转账两个渠道在同一个时间进行余额变更，短信通知必须要有顺序</p>
</li>
</ul>
<p><img src="/../images/image-20210530224903891.png" srcset="/img/loading.gif" lazyload alt="image-20210530224903891"></p>
<p>topic分区中消息只能由消费者组中的唯一一个消费者处理，所以消息肯定是按照先后顺序进行处理的。但是它也仅仅是保证Topic的一个分区顺序处理，不能保证跨分区的消息先后处理顺序。 所以，如果你想要顺序的处理Topic的所有消息，那就只提供一个分区。</p>
<h4 id="7-3-提交和偏移量"><a href="#7-3-提交和偏移量" class="headerlink" title="7.3)提交和偏移量"></a>7.3)提交和偏移量</h4><p>kafka不会像其他JMS队列那样需要得到消费者的确认，消费者可以使用kafka来追踪消息在分区的位置（偏移量）</p>
<p>消费者会往一个叫做_consumer_offset的特殊主题发送消息，消息里包含了每个分区的偏移量。如果消费者发生崩溃或有新的消费者加入群组，就会触发再均衡</p>
<p><img src="/../images/image-20210530225021266.png" srcset="/img/loading.gif" lazyload alt="image-20210530225021266"></p>
<p>正常的情况</p>
<p><img src="/../images/image-20210530224959350.png" srcset="/img/loading.gif" lazyload alt="image-20210530224959350"></p>
<p>如果消费者2挂掉以后，会发生再均衡，消费者2负责的分区会被其他消费者进行消费</p>
<p>再均衡后不可避免会出现一些问题</p>
<p>问题一：</p>
<p><img src="/../images/image-20210530225215337.png" srcset="/img/loading.gif" lazyload alt="image-20210530225215337"></p>
<p>如果提交偏移量小于客户端处理的最后一个消息的偏移量，那么处于两个偏移量之间的消息就会被重复处理。</p>
<p>问题二：</p>
<p><img src="/../images/image-20210530225239897.png" srcset="/img/loading.gif" lazyload alt="image-20210530225239897"></p>
<p>如果提交的偏移量大于客户端的最后一个消息的偏移量，那么处于两个偏移量之间的消息将会丢失。</p>
<p>如果想要解决这些问题，还要知道目前kafka提交偏移量的方式：</p>
<p>提交偏移量的方式有两种，分别是自动提交偏移量和手动提交</p>
<ul>
<li>自动提交偏移量</li>
</ul>
<p>当enable.auto.commit被设置为true，提交方式就是让消费者自动提交偏移量，每隔5秒消费者会自动把从poll()方法接收的最大偏移量提交上去</p>
<ul>
<li><p>手动提交 ，当enable.auto.commit被设置为false可以有以下三种提交方式</p>
<ul>
<li><p>提交当前偏移量（同步提交）</p>
</li>
<li><p>异步提交</p>
</li>
<li><p>同步和异步组合提交</p>
</li>
</ul>
</li>
</ul>
<p>1.提交当前偏移量（同步提交）</p>
<p>把<code>enable.auto.commit</code>设置为false,让应用程序决定何时提交偏移量。使用commitSync()提交偏移量，commitSync()将会提交poll返回的最新的偏移量，所以在处理完所有记录后要确保调用了commitSync()方法。否则还是会有消息丢失的风险。</p>
<p>只要没有发生不可恢复的错误，commitSync()方法会一直尝试直至提交成功，如果提交失败也可以记录到错误日志里。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)&#123;<br>    ConsumerRecords&lt;String, String&gt; records = consumer.poll(Duration.ofMillis(<span class="hljs-number">1000</span>));<br>    <span class="hljs-keyword">for</span> (ConsumerRecord&lt;String, String&gt; record : records) &#123;<br>        System.out.println(record.value());<br>        System.out.println(record.key());<br>        <span class="hljs-keyword">try</span> &#123;<br>            consumer.commitSync();<span class="hljs-comment">//同步提交当前最新的偏移量</span><br>        &#125;<span class="hljs-keyword">catch</span> (CommitFailedException e)&#123;<br>            System.out.println(<span class="hljs-string">&quot;记录提交失败的异常：&quot;</span>+e);<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>2.异步提交</p>
<p>手动提交有一个缺点，那就是当发起提交调用时应用会阻塞。当然我们可以减少手动提交的频率，但这个会增加消息重复的概率（和自动提交一样）。另外一个解决办法是，使用异步提交的API。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)&#123;<br>    ConsumerRecords&lt;String, String&gt; records = consumer.poll(Duration.ofMillis(<span class="hljs-number">1000</span>));<br>    <span class="hljs-keyword">for</span> (ConsumerRecord&lt;String, String&gt; record : records) &#123;<br>        System.out.println(record.value());<br>        System.out.println(record.key());<br>    &#125;<br>    consumer.commitAsync(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OffsetCommitCallback</span>() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onComplete</span><span class="hljs-params">(Map&lt;TopicPartition, OffsetAndMetadata&gt; map, Exception e)</span> &#123;<br>            <span class="hljs-keyword">if</span>(e!=<span class="hljs-literal">null</span>)&#123;<br>                System.out.println(<span class="hljs-string">&quot;记录错误的提交偏移量：&quot;</span>+ map+<span class="hljs-string">&quot;,异常信息&quot;</span>+e);<br>            &#125;<br>        &#125;<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>3.同步和异步组合提交</p>
<p>异步提交也有个缺点，那就是如果服务器返回提交失败，异步提交不会进行重试。相比较起来，同步提交会进行重试直到成功或者最后抛出异常给应用。异步提交没有实现重试是因为，如果同时存在多个异步提交，进行重试可能会导致位移覆盖。</p>
<p>举个例子，假如我们发起了一个异步提交commitA，此时的提交位移为2000，随后又发起了一个异步提交commitB且位移为3000；commitA提交失败但commitB提交成功，此时commitA进行重试并成功的话，会将实际上将已经提交的位移从3000回滚到2000，导致消息重复消费。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)&#123;<br>        ConsumerRecords&lt;String, String&gt; records = consumer.poll(Duration.ofMillis(<span class="hljs-number">1000</span>));<br>        <span class="hljs-keyword">for</span> (ConsumerRecord&lt;String, String&gt; record : records) &#123;<br>            System.out.println(record.value());<br>            System.out.println(record.key());<br>        &#125;<br>        consumer.commitAsync();<br>    &#125;<br>&#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;+<br>    e.printStackTrace();<br>    System.out.println(<span class="hljs-string">&quot;记录错误信息：&quot;</span>+e);<br>&#125;<span class="hljs-keyword">finally</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        consumer.commitSync();<br>    &#125;<span class="hljs-keyword">finally</span> &#123;<br>        consumer.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="8-springboot集成kafka"><a href="#8-springboot集成kafka" class="headerlink" title="8)springboot集成kafka"></a>8)springboot集成kafka</h3><h4 id="8-1-入门"><a href="#8-1-入门" class="headerlink" title="8.1)入门"></a>8.1)入门</h4><p>1.导入spring-kafka依赖信息</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- kafkfa --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.kafka<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-kafka<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">exclusions</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">exclusion</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.kafka<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>kafka-clients<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">exclusion</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">exclusions</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.kafka<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>kafka-clients<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>fastjson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>2.在resources下创建文件application.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">9991</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">kafka-demo</span><br>  <span class="hljs-attr">kafka:</span><br>    <span class="hljs-attr">bootstrap-servers:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.130</span><span class="hljs-string">:9092</span><br>    <span class="hljs-attr">producer:</span><br>      <span class="hljs-attr">retries:</span> <span class="hljs-number">10</span><br>      <span class="hljs-attr">key-serializer:</span> <span class="hljs-string">org.apache.kafka.common.serialization.StringSerializer</span><br>      <span class="hljs-attr">value-serializer:</span> <span class="hljs-string">org.apache.kafka.common.serialization.StringSerializer</span><br>    <span class="hljs-attr">consumer:</span><br>      <span class="hljs-attr">group-id:</span> <span class="hljs-string">$&#123;spring.application.name&#125;-test</span><br>      <span class="hljs-attr">key-deserializer:</span> <span class="hljs-string">org.apache.kafka.common.serialization.StringDeserializer</span><br>      <span class="hljs-attr">value-deserializer:</span> <span class="hljs-string">org.apache.kafka.common.serialization.StringDeserializer</span><br></code></pre></td></tr></table></figure>

<p>3.消息生产者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.kafka.controller;<br><br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.kafka.core.KafkaTemplate;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> KafkaTemplate&lt;String,String&gt; kafkaTemplate;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/hello&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">()</span>&#123;<br>        kafkaTemplate.send(<span class="hljs-string">&quot;itcast-topic&quot;</span>,<span class="hljs-string">&quot;黑马程序员&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;ok&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>4.消息消费者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.kafka.listener;<br><br><span class="hljs-keyword">import</span> org.springframework.kafka.annotation.KafkaListener;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><span class="hljs-keyword">import</span> org.springframework.util.StringUtils;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloListener</span> &#123;<br><br>    <span class="hljs-meta">@KafkaListener(topics = &quot;itcast-topic&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onMessage</span><span class="hljs-params">(String message)</span>&#123;<br>        <span class="hljs-keyword">if</span>(!StringUtils.isEmpty(message))&#123;<br>            System.out.println(message);<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="8-2-传递消息为对象"><a href="#8-2-传递消息为对象" class="headerlink" title="8.2)传递消息为对象"></a>8.2)传递消息为对象</h4><p>目前springboot整合后的kafka，因为序列化器是StringSerializer，这个时候如果需要传递对象可以有两种方式</p>
<p>方式一：可以自定义序列化器，对象类型众多，这种方式通用性不强，本章节不介绍</p>
<p>方式二：可以把要传递的对象进行转json字符串，接收消息后再转为对象即可，本项目采用这种方式</p>
<ul>
<li>发送消息</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/hello&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br>    user.setUsername(<span class="hljs-string">&quot;xiaowang&quot;</span>);<br>    user.setAge(<span class="hljs-number">18</span>);<br><br>    kafkaTemplate.send(<span class="hljs-string">&quot;user-topic&quot;</span>, JSON.toJSONString(user));<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;ok&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>接收消息</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.kafka.listener;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.heima.kafka.pojo.User;<br><span class="hljs-keyword">import</span> org.springframework.kafka.annotation.KafkaListener;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><span class="hljs-keyword">import</span> org.springframework.util.StringUtils;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloListener</span> &#123;<br><br>    <span class="hljs-meta">@KafkaListener(topics = &quot;user-topic&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onMessage</span><span class="hljs-params">(String message)</span>&#123;<br>        <span class="hljs-keyword">if</span>(!StringUtils.isEmpty(message))&#123;<br>            <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> JSON.parseObject(message, User.class);<br>            System.out.println(user);<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="9-自媒体文章上下架功能完成"><a href="#9-自媒体文章上下架功能完成" class="headerlink" title="9)自媒体文章上下架功能完成"></a>9)自媒体文章上下架功能完成</h3><h4 id="9-1-需求分析"><a href="#9-1-需求分析" class="headerlink" title="9.1)需求分析"></a>9.1)需求分析</h4><p><img src="/../images/image-20210528111736003.png" srcset="/img/loading.gif" lazyload alt="image-20210528111736003"></p>
<p><img src="/../images/image-20210528111853271.png" srcset="/img/loading.gif" lazyload alt="image-20210528111853271"></p>
<ul>
<li><p>已发表且已上架的文章可以下架</p>
</li>
<li><p>已发表且已下架的文章可以上架</p>
</li>
</ul>
<h4 id="9-2-流程说明"><a href="#9-2-流程说明" class="headerlink" title="9.2)流程说明"></a>9.2)流程说明</h4><p><img src="/../images/image-20210528111956504.png" srcset="/img/loading.gif" lazyload alt="image-20210528111956504"></p>
<h4 id="9-3-接口定义"><a href="#9-3-接口定义" class="headerlink" title="9.3)接口定义"></a>9.3)接口定义</h4><table>
<thead>
<tr>
<th></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>接口路径</td>
<td>/api/v1/news/down_or_up</td>
</tr>
<tr>
<td>请求方式</td>
<td>POST</td>
</tr>
<tr>
<td>参数</td>
<td>DTO</td>
</tr>
<tr>
<td>响应结果</td>
<td>ResponseResult</td>
</tr>
</tbody></table>
<p> DTO  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WmNewsDto</span> &#123;<br>    <br>    <span class="hljs-keyword">private</span> Integer id;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 是否上架  0 下架  1 上架</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-keyword">private</span> Short enable;<br>                       <br>&#125;<br></code></pre></td></tr></table></figure>

<p>ResponseResult  </p>
<p><img src="/../images/image-20210528112150495.png" srcset="/img/loading.gif" lazyload alt="image-20210528112150495"></p>
<h4 id="9-4-自媒体文章上下架-功能实现"><a href="#9-4-自媒体文章上下架-功能实现" class="headerlink" title="9.4)自媒体文章上下架-功能实现"></a>9.4)自媒体文章上下架-功能实现</h4><p>9.4.1)接口定义</p>
<p>在heima-leadnews-wemedia工程下的WmNewsController新增方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@PostMapping(&quot;/down_or_up&quot;)</span><br><span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">downOrUp</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> WmNewsDto dto)</span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在WmNewsDto中新增enable属性 ，完整的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.model.wemedia.dtos;<br><br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.util.Date;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WmNewsDto</span> &#123;<br>    <br>    <span class="hljs-keyword">private</span> Integer id;<br>     <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 标题</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String title;<br>     <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 频道id</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Integer channelId;<br>     <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 标签</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String labels;<br>     <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 发布时间</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Date publishTime;<br>     <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 文章内容</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String content;<br>     <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 文章封面类型  0 无图 1 单图 3 多图 -1 自动</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Short type;<br>     <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 提交时间</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Date submitedTime; <br>     <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 状态 提交为1  草稿为0</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Short status;<br>     <br>     <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 封面图片列表 多张图以逗号隔开</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> List&lt;String&gt; images;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 上下架 0 下架  1 上架</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Short enable;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>9.4.2)业务层编写</p>
<p>在WmNewsService新增方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 文章的上下架</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> dto</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">downOrUp</span><span class="hljs-params">(WmNewsDto dto)</span>;<br></code></pre></td></tr></table></figure>

<p>实现方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 文章的上下架</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> dto</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">downOrUp</span><span class="hljs-params">(WmNewsDto dto)</span> &#123;<br>    <span class="hljs-comment">//1.检查参数</span><br>    <span class="hljs-keyword">if</span>(dto.getId() == <span class="hljs-literal">null</span>)&#123;<br>        <span class="hljs-keyword">return</span> ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID);<br>    &#125;<br><br>    <span class="hljs-comment">//2.查询文章</span><br>    <span class="hljs-type">WmNews</span> <span class="hljs-variable">wmNews</span> <span class="hljs-operator">=</span> getById(dto.getId());<br>    <span class="hljs-keyword">if</span>(wmNews == <span class="hljs-literal">null</span>)&#123;<br>        <span class="hljs-keyword">return</span> ResponseResult.errorResult(AppHttpCodeEnum.DATA_NOT_EXIST,<span class="hljs-string">&quot;文章不存在&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//3.判断文章是否已发布</span><br>    <span class="hljs-keyword">if</span>(!wmNews.getStatus().equals(WmNews.Status.PUBLISHED.getCode()))&#123;<br>        <span class="hljs-keyword">return</span> ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID,<span class="hljs-string">&quot;当前文章不是发布状态，不能上下架&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//4.修改文章enable</span><br>    <span class="hljs-keyword">if</span>(dto.getEnable() != <span class="hljs-literal">null</span> &amp;&amp; dto.getEnable() &gt; -<span class="hljs-number">1</span> &amp;&amp; dto.getEnable() &lt; <span class="hljs-number">2</span>)&#123;<br>        update(Wrappers.&lt;WmNews&gt;lambdaUpdate().set(WmNews::getEnable,dto.getEnable())<br>                .eq(WmNews::getId,wmNews.getId()));<br>    &#125;<br>    <span class="hljs-keyword">return</span> ResponseResult.okResult(AppHttpCodeEnum.SUCCESS);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>9.4.3)控制器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@PostMapping(&quot;/down_or_up&quot;)</span><br><span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">downOrUp</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> WmNewsDto dto)</span>&#123;<br>    <span class="hljs-keyword">return</span> wmNewsService.downOrUp(dto);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>9.4.4)测试</p>
<h4 id="9-5-消息通知article端文章上下架"><a href="#9-5-消息通知article端文章上下架" class="headerlink" title="9.5)消息通知article端文章上下架"></a>9.5)消息通知article端文章上下架</h4><p>9.5.1)在heima-leadnews-common模块下导入kafka依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- kafkfa --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.kafka<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-kafka<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.kafka<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>kafka-clients<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>9.5.2)在自媒体端的nacos配置中心配置kafka的生产者</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">kafka:</span><br>    <span class="hljs-attr">bootstrap-servers:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.130</span><span class="hljs-string">:9092</span><br>    <span class="hljs-attr">producer:</span><br>      <span class="hljs-attr">retries:</span> <span class="hljs-number">10</span><br>      <span class="hljs-attr">key-serializer:</span> <span class="hljs-string">org.apache.kafka.common.serialization.StringSerializer</span><br>      <span class="hljs-attr">value-serializer:</span> <span class="hljs-string">org.apache.kafka.common.serialization.StringSerializer</span><br></code></pre></td></tr></table></figure>

<p>9.5.3)在自媒体端文章上下架后发送消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//发送消息，通知article端修改文章配置</span><br><span class="hljs-keyword">if</span>(wmNews.getArticleId() != <span class="hljs-literal">null</span>)&#123;<br>    Map&lt;String,Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>    map.put(<span class="hljs-string">&quot;articleId&quot;</span>,wmNews.getArticleId());<br>    map.put(<span class="hljs-string">&quot;enable&quot;</span>,dto.getEnable());<br>    kafkaTemplate.send(WmNewsMessageConstants.WM_NEWS_UP_OR_DOWN_TOPIC,JSON.toJSONString(map));<br>&#125;<br></code></pre></td></tr></table></figure>

<p>常量类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WmNewsMessageConstants</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String WM_NEWS_UP_OR_DOWN_TOPIC=<span class="hljs-string">&quot;wm.news.up.or.down.topic&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>9.5.4)在article端的nacos配置中心配置kafka的消费者</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">kafka:</span><br>    <span class="hljs-attr">bootstrap-servers:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.130</span><span class="hljs-string">:9092</span><br>    <span class="hljs-attr">consumer:</span><br>      <span class="hljs-attr">group-id:</span> <span class="hljs-string">$&#123;spring.application.name&#125;</span><br>      <span class="hljs-attr">key-deserializer:</span> <span class="hljs-string">org.apache.kafka.common.serialization.StringDeserializer</span><br>      <span class="hljs-attr">value-deserializer:</span> <span class="hljs-string">org.apache.kafka.common.serialization.StringDeserializer</span><br></code></pre></td></tr></table></figure>

<p>9.5.5)在article端编写监听，接收数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.article.listener;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.heima.article.service.ApArticleConfigService;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.apache.commons.lang3.StringUtils;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.kafka.annotation.KafkaListener;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArtilceIsDownListener</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ApArticleConfigService apArticleConfigService;<br><br>    <span class="hljs-meta">@KafkaListener(topics = WmNewsMessageConstants.WM_NEWS_UP_OR_DOWN_TOPIC)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onMessage</span><span class="hljs-params">(String message)</span>&#123;<br>        <span class="hljs-keyword">if</span>(StringUtils.isNotBlank(message))&#123;<br>            <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> JSON.parseObject(message, Map.class);<br>            apArticleConfigService.updateByMap(map);<br>            log.info(<span class="hljs-string">&quot;article端文章配置修改，articleId=&#123;&#125;&quot;</span>,map.get(<span class="hljs-string">&quot;articleId&quot;</span>));<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>9.5.6)修改ap_article_config表的数据</p>
<p>新建ApArticleConfigService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.article.service;<br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.extension.service.IService;<br><span class="hljs-keyword">import</span> com.heima.model.article.pojos.ApArticleConfig;<br><br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ApArticleConfigService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IService</span>&lt;ApArticleConfig&gt; &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 修改文章配置</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> map</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateByMap</span><span class="hljs-params">(Map map)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>实现类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.article.service.impl;<br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.toolkit.Wrappers;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;<br><span class="hljs-keyword">import</span> com.heima.article.mapper.ApArticleConfigMapper;<br><span class="hljs-keyword">import</span> com.heima.article.service.ApArticleConfigService;<br><span class="hljs-keyword">import</span> com.heima.model.article.pojos.ApArticleConfig;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><span class="hljs-keyword">import</span> org.springframework.transaction.annotation.Transactional;<br><br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Transactional</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApArticleConfigServiceImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ServiceImpl</span>&lt;ApArticleConfigMapper, ApArticleConfig&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ApArticleConfigService</span> &#123;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 修改文章配置</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> map</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateByMap</span><span class="hljs-params">(Map map)</span> &#123;<br>        <span class="hljs-comment">//0 下架 1 上架</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">enable</span> <span class="hljs-operator">=</span> map.get(<span class="hljs-string">&quot;enable&quot;</span>);<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">isDown</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br>        <span class="hljs-keyword">if</span>(enable.equals(<span class="hljs-number">1</span>))&#123;<br>            isDown = <span class="hljs-literal">false</span>;<br>        &#125;<br>        <span class="hljs-comment">//修改文章配置</span><br>        update(Wrappers.&lt;ApArticleConfig&gt;lambdaUpdate().eq(ApArticleConfig::getArticleId,map.get(<span class="hljs-string">&quot;articleId&quot;</span>)).set(ApArticleConfig::getIsDown,isDown));<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>





<h1 id="7-app端文章搜索"><a href="#7-app端文章搜索" class="headerlink" title="7 app端文章搜索"></a>7 app端文章搜索</h1><h2 id="1-今日内容介绍"><a href="#1-今日内容介绍" class="headerlink" title="1) 今日内容介绍"></a>1) 今日内容介绍</h2><h3 id="1-1-App端搜索-效果图"><a href="#1-1-App端搜索-效果图" class="headerlink" title="1.1)App端搜索-效果图"></a>1.1)App端搜索-效果图</h3><p><img src="/../images/image-20210709140539138.png" srcset="/img/loading.gif" lazyload alt="image-20210709140539138"></p>
<h3 id="1-2-今日内容"><a href="#1-2-今日内容" class="headerlink" title="1.2)今日内容"></a>1.2)今日内容</h3><ul>
<li><p>文章搜索</p>
<ul>
<li><p>ElasticSearch环境搭建</p>
</li>
<li><p>索引库创建</p>
</li>
<li><p>文章搜索多条件复合查询</p>
</li>
<li><p>索引数据同步</p>
</li>
</ul>
</li>
<li><p>搜索历史记录</p>
<ul>
<li><p>Mongodb环境搭建</p>
</li>
<li><p>异步保存搜索历史</p>
</li>
<li><p>查看搜索历史列表</p>
</li>
<li><p>删除搜索历史</p>
</li>
</ul>
</li>
<li><p>联想词查询</p>
<ul>
<li><p>联想词的来源</p>
</li>
<li><p>联想词功能实现</p>
</li>
</ul>
</li>
</ul>
<h2 id="2-搭建ElasticSearch环境"><a href="#2-搭建ElasticSearch环境" class="headerlink" title="2) 搭建ElasticSearch环境"></a>2) 搭建ElasticSearch环境</h2><h3 id="2-1-拉取镜像"><a href="#2-1-拉取镜像" class="headerlink" title="2.1) 拉取镜像"></a>2.1) 拉取镜像</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker pull elasticsearch:7.4.0<br></code></pre></td></tr></table></figure>

<h3 id="2-2-创建容器"><a href="#2-2-创建容器" class="headerlink" title="2.2) 创建容器"></a>2.2) 创建容器</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker run -id --name elasticsearch -d --restart=always -p 9200:9200 -p 9300:9300 -v /usr/share/elasticsearch/plugins:/usr/share/elasticsearch/plugins -e &quot;discovery.type=single-node&quot; elasticsearch:7.4.0<br></code></pre></td></tr></table></figure>

<h3 id="2-3-配置中文分词器-ik"><a href="#2-3-配置中文分词器-ik" class="headerlink" title="2.3) 配置中文分词器 ik"></a>2.3) 配置中文分词器 ik</h3><p>因为在创建elasticsearch容器的时候，映射了目录，所以可以在宿主机上进行配置ik中文分词器</p>
<p>在去选择ik分词器的时候，需要与elasticsearch的版本好对应上</p>
<p>把资料中的<code>elasticsearch-analysis-ik-7.4.0.zip</code>上传到服务器上,放到对应目录（plugins）解压</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">切换目录</span><br>cd /usr/share/elasticsearch/plugins<br><span class="hljs-meta prompt_">#</span><span class="language-bash">新建目录</span><br>mkdir analysis-ik<br>cd analysis-ik<br><span class="hljs-meta prompt_">#</span><span class="language-bash">root根目录中拷贝文件</span><br>mv elasticsearch-analysis-ik-7.4.0.zip /usr/share/elasticsearch/plugins/analysis-ik<br><span class="hljs-meta prompt_">#</span><span class="language-bash">解压文件</span><br>cd /usr/share/elasticsearch/plugins/analysis-ik<br>unzip elasticsearch-analysis-ik-7.4.0.zip<br></code></pre></td></tr></table></figure>

<h3 id="2-4-使用postman测试"><a href="#2-4-使用postman测试" class="headerlink" title="2.4) 使用postman测试"></a>2.4) 使用postman测试</h3><p><img src="/../images/image-20210709140935410.png" srcset="/img/loading.gif" lazyload alt="image-20210709140935410"></p>
<h2 id="3-app端文章搜索"><a href="#3-app端文章搜索" class="headerlink" title="3) app端文章搜索"></a>3) app端文章搜索</h2><h3 id="3-1-需求分析"><a href="#3-1-需求分析" class="headerlink" title="3.1) 需求分析"></a>3.1) 需求分析</h3><ul>
<li><p>用户输入关键可搜索文章列表</p>
</li>
<li><p>关键词高亮显示</p>
</li>
<li><p>文章列表展示与home展示一样，当用户点击某一篇文章，可查看文章详情</p>
</li>
</ul>
<p><img src="/../images/image-20210709141502366.png" srcset="/img/loading.gif" lazyload alt="image-20210709141502366"></p>
<h3 id="3-2-思路分析"><a href="#3-2-思路分析" class="headerlink" title="3.2) 思路分析"></a>3.2) 思路分析</h3><p>为了加快检索的效率，在查询的时候不会直接从数据库中查询文章，需要在elasticsearch中进行高速检索。</p>
<p><img src="/../images/image-20210709141558811.png" srcset="/img/loading.gif" lazyload alt="image-20210709141558811"></p>
<h3 id="3-3-创建索引和映射"><a href="#3-3-创建索引和映射" class="headerlink" title="3.3) 创建索引和映射"></a>3.3) 创建索引和映射</h3><p>使用postman添加映射</p>
<p>put请求 ： <a target="_blank" rel="noopener" href="http://192.168.200.130:9200/app_info_article">http://192.168.200.130:9200/app_info_article</a></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;mappings&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;properties&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;long&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;publishTime&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;date&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;layout&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;integer&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;images&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;keyword&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;staticUrl&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;keyword&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;authorId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;long&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;authorName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;text&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;text&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;analyzer&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;ik_smart&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;content&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;text&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;analyzer&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;ik_smart&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p><img src="/../images/1606653927638.png" srcset="/img/loading.gif" lazyload alt="1606653927638"></p>
<p>GET请求查询映射：<a target="_blank" rel="noopener" href="http://192.168.200.130:9200/app_info_article">http://192.168.200.130:9200/app_info_article</a></p>
<p>DELETE请求，删除索引及映射：<a target="_blank" rel="noopener" href="http://192.168.200.130:9200/app_info_article">http://192.168.200.130:9200/app_info_article</a></p>
<p>GET请求，查询所有文档：<a target="_blank" rel="noopener" href="http://192.168.200.130:9200/app_info_article/_search">http://192.168.200.130:9200/app_info_article/_search</a></p>
<h3 id="3-4-数据初始化到索引库"><a href="#3-4-数据初始化到索引库" class="headerlink" title="3.4) 数据初始化到索引库"></a>3.4) 数据初始化到索引库</h3><h4 id="3-4-1-导入es-init到heima-leadnews-test工程下"><a href="#3-4-1-导入es-init到heima-leadnews-test工程下" class="headerlink" title="3.4.1)导入es-init到heima-leadnews-test工程下"></a>3.4.1)导入es-init到heima-leadnews-test工程下</h4><p><img src="/../images/image-20210709142215818.png" srcset="/img/loading.gif" lazyload alt="image-20210709142215818"></p>
<h4 id="3-4-1-查询所有的文章信息，批量导入到es索引库中"><a href="#3-4-1-查询所有的文章信息，批量导入到es索引库中" class="headerlink" title="3.4.1)查询所有的文章信息，批量导入到es索引库中"></a>3.4.1)查询所有的文章信息，批量导入到es索引库中</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.es;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.heima.es.mapper.ApArticleMapper;<br><span class="hljs-keyword">import</span> com.heima.es.pojo.SearchArticleVo;<br><span class="hljs-keyword">import</span> org.elasticsearch.action.bulk.BulkRequest;<br><span class="hljs-keyword">import</span> org.elasticsearch.action.index.IndexRequest;<br><span class="hljs-keyword">import</span> org.elasticsearch.client.RequestOptions;<br><span class="hljs-keyword">import</span> org.elasticsearch.client.RestHighLevelClient;<br><span class="hljs-keyword">import</span> org.elasticsearch.common.xcontent.XContentType;<br><span class="hljs-keyword">import</span> org.junit.Test;<br><span class="hljs-keyword">import</span> org.junit.runner.RunWith;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;<br><span class="hljs-keyword">import</span> org.springframework.test.context.junit4.SpringRunner;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><br><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-meta">@RunWith(SpringRunner.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApArticleTest</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ApArticleMapper apArticleMapper;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RestHighLevelClient restHighLevelClient;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 注意：数据量的导入，如果数据量过大，需要分页导入</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-comment">//1.查询所有符合条件的文章数据</span><br>        List&lt;SearchArticleVo&gt; searchArticleVos = apArticleMapper.loadArticleList();<br><br>        <span class="hljs-comment">//2.批量导入到es索引库</span><br><br>        <span class="hljs-type">BulkRequest</span> <span class="hljs-variable">bulkRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BulkRequest</span>(<span class="hljs-string">&quot;app_info_article&quot;</span>);<br><br>        <span class="hljs-keyword">for</span> (SearchArticleVo searchArticleVo : searchArticleVos) &#123;<br><br>            <span class="hljs-type">IndexRequest</span> <span class="hljs-variable">indexRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IndexRequest</span>().id(searchArticleVo.getId().toString())<br>                    .source(JSON.toJSONString(searchArticleVo), XContentType.JSON);<br><br>            <span class="hljs-comment">//批量添加数据</span><br>            bulkRequest.add(indexRequest);<br><br>        &#125;<br>        restHighLevelClient.bulk(bulkRequest, RequestOptions.DEFAULT);<br><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="3-4-3-测试"><a href="#3-4-3-测试" class="headerlink" title="3.4.3)测试"></a>3.4.3)测试</h4><p>postman查询所有的es中数据   GET请求： <a target="_blank" rel="noopener" href="http://192.168.200.130:9200/app_info_article/_search">http://192.168.200.130:9200/app_info_article/_search</a></p>
<p><img src="/../images/image-20210709142339535.png" srcset="/img/loading.gif" lazyload alt="image-20210709142339535"></p>
<h3 id="3-5-文章搜索功能实现"><a href="#3-5-文章搜索功能实现" class="headerlink" title="3.5) 文章搜索功能实现"></a>3.5) 文章搜索功能实现</h3><h4 id="3-5-1-搭建搜索微服务"><a href="#3-5-1-搭建搜索微服务" class="headerlink" title="3.5.1)搭建搜索微服务"></a>3.5.1)搭建搜索微服务</h4><p>（1）导入  heima-leadnews-search</p>
<p><img src="/../images/image-20210709142616797.png" srcset="/img/loading.gif" lazyload alt="image-20210709142616797"></p>
<p>（2）在heima-leadnews-service的pom中添加依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--elasticsearch--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.elasticsearch.client<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>elasticsearch-rest-high-level-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>7.4.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.elasticsearch.client<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>elasticsearch-rest-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>7.4.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.elasticsearch<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>elasticsearch<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>7.4.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>（3）nacos配置中心leadnews-search</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">autoconfigure:</span><br>    <span class="hljs-attr">exclude:</span> <span class="hljs-string">org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration</span><br><span class="hljs-attr">elasticsearch:</span><br>  <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.130</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">9200</span><br></code></pre></td></tr></table></figure>

<h4 id="3-5-2-搜索接口定义"><a href="#3-5-2-搜索接口定义" class="headerlink" title="3.5.2) 搜索接口定义"></a>3.5.2) 搜索接口定义</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.search.controller.v1;<br><br><span class="hljs-keyword">import</span> com.heima.model.common.dtos.ResponseResult;<br><span class="hljs-keyword">import</span> com.heima.model.search.dtos.UserSearchDto;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PostMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestBody;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/api/v1/article/search&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArticleSearchController</span> &#123;<br><br><br>    <span class="hljs-meta">@PostMapping(&quot;/search&quot;)</span><br>    <span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">search</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> UserSearchDto dto)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>UserSearchDto</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.model.search.dtos;<br><br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.util.Date;<br><br><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserSearchDto</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 搜索关键字</span><br><span class="hljs-comment">    */</span><br>    String searchWords;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 当前页</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-type">int</span> pageNum;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 分页条数</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-type">int</span> pageSize;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 最小时间</span><br><span class="hljs-comment">    */</span><br>    Date minBehotTime;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getFromIndex</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-built_in">this</span>.pageNum&lt;<span class="hljs-number">1</span>)<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-built_in">this</span>.pageSize&lt;<span class="hljs-number">1</span>) <span class="hljs-built_in">this</span>.pageSize = <span class="hljs-number">10</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.pageSize * (pageNum-<span class="hljs-number">1</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="3-5-3-业务层实现"><a href="#3-5-3-业务层实现" class="headerlink" title="3.5.3) 业务层实现"></a>3.5.3) 业务层实现</h4><p>创建业务层接口：ApArticleSearchService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.search.service;<br><br><span class="hljs-keyword">import</span> com.heima.model.search.dtos.UserSearchDto;<br><span class="hljs-keyword">import</span> com.heima.model.common.dtos.ResponseResult;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ArticleSearchService</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     ES文章分页搜索</span><br><span class="hljs-comment">     <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    ResponseResult <span class="hljs-title function_">search</span><span class="hljs-params">(UserSearchDto userSearchDto)</span> <span class="hljs-keyword">throws</span> IOException;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>实现类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.search.service.impl;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.heima.model.common.dtos.ResponseResult;<br><span class="hljs-keyword">import</span> com.heima.model.common.enums.AppHttpCodeEnum;<br><span class="hljs-keyword">import</span> com.heima.model.search.dtos.UserSearchDto;<br><span class="hljs-keyword">import</span> com.heima.model.user.pojos.ApUser;<br><span class="hljs-keyword">import</span> com.heima.search.service.ArticleSearchService;<br><span class="hljs-keyword">import</span> com.heima.utils.thread.AppThreadLocalUtil;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.apache.commons.lang3.StringUtils;<br><span class="hljs-keyword">import</span> org.elasticsearch.action.search.SearchRequest;<br><span class="hljs-keyword">import</span> org.elasticsearch.action.search.SearchResponse;<br><span class="hljs-keyword">import</span> org.elasticsearch.client.RequestOptions;<br><span class="hljs-keyword">import</span> org.elasticsearch.client.RestHighLevelClient;<br><span class="hljs-keyword">import</span> org.elasticsearch.common.text.Text;<br><span class="hljs-keyword">import</span> org.elasticsearch.index.query.*;<br><span class="hljs-keyword">import</span> org.elasticsearch.search.SearchHit;<br><span class="hljs-keyword">import</span> org.elasticsearch.search.builder.SearchSourceBuilder;<br><span class="hljs-keyword">import</span> org.elasticsearch.search.fetch.subphase.highlight.HighlightBuilder;<br><span class="hljs-keyword">import</span> org.elasticsearch.search.sort.SortOrder;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArticleSearchServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ArticleSearchService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RestHighLevelClient restHighLevelClient;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * es文章分页检索</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> dto</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">search</span><span class="hljs-params">(UserSearchDto dto)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br><br>        <span class="hljs-comment">//1.检查参数</span><br>        <span class="hljs-keyword">if</span>(dto == <span class="hljs-literal">null</span> || StringUtils.isBlank(dto.getSearchWords()))&#123;<br>            <span class="hljs-keyword">return</span> ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID);<br>        &#125;<br><br>        <span class="hljs-comment">//2.设置查询条件</span><br>        <span class="hljs-type">SearchRequest</span> <span class="hljs-variable">searchRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchRequest</span>(<span class="hljs-string">&quot;app_info_article&quot;</span>);<br>        <span class="hljs-type">SearchSourceBuilder</span> <span class="hljs-variable">searchSourceBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchSourceBuilder</span>();<br><br>        <span class="hljs-comment">//布尔查询</span><br>        <span class="hljs-type">BoolQueryBuilder</span> <span class="hljs-variable">boolQueryBuilder</span> <span class="hljs-operator">=</span> QueryBuilders.boolQuery();<br><br>        <span class="hljs-comment">//关键字的分词之后查询</span><br>        <span class="hljs-type">QueryStringQueryBuilder</span> <span class="hljs-variable">queryStringQueryBuilder</span> <span class="hljs-operator">=</span> QueryBuilders.queryStringQuery(dto.getSearchWords()).field(<span class="hljs-string">&quot;title&quot;</span>).field(<span class="hljs-string">&quot;content&quot;</span>).defaultOperator(Operator.OR);<br>        boolQueryBuilder.must(queryStringQueryBuilder);<br><br>        <span class="hljs-comment">//查询小于mindate的数据</span><br>        <span class="hljs-type">RangeQueryBuilder</span> <span class="hljs-variable">rangeQueryBuilder</span> <span class="hljs-operator">=</span> QueryBuilders.rangeQuery(<span class="hljs-string">&quot;publishTime&quot;</span>).lt(dto.getMinBehotTime().getTime());<br>        boolQueryBuilder.filter(rangeQueryBuilder);<br><br>        <span class="hljs-comment">//分页查询</span><br>        searchSourceBuilder.from(<span class="hljs-number">0</span>);<br>        searchSourceBuilder.size(dto.getPageSize());<br><br>        <span class="hljs-comment">//按照发布时间倒序查询</span><br>        searchSourceBuilder.sort(<span class="hljs-string">&quot;publishTime&quot;</span>, SortOrder.DESC);<br><br>        <span class="hljs-comment">//设置高亮  title</span><br>        <span class="hljs-type">HighlightBuilder</span> <span class="hljs-variable">highlightBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HighlightBuilder</span>();<br>        highlightBuilder.field(<span class="hljs-string">&quot;title&quot;</span>);<br>        highlightBuilder.preTags(<span class="hljs-string">&quot;&lt;font style=&#x27;color: red; font-size: inherit;&#x27;&gt;&quot;</span>);<br>        highlightBuilder.postTags(<span class="hljs-string">&quot;&lt;/font&gt;&quot;</span>);<br>        searchSourceBuilder.highlighter(highlightBuilder);<br><br><br>        searchSourceBuilder.query(boolQueryBuilder);<br>        searchRequest.source(searchSourceBuilder);<br>        <span class="hljs-type">SearchResponse</span> <span class="hljs-variable">searchResponse</span> <span class="hljs-operator">=</span> restHighLevelClient.search(searchRequest, RequestOptions.DEFAULT);<br><br><br>        <span class="hljs-comment">//3.结果封装返回</span><br><br>        List&lt;Map&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><br>        SearchHit[] hits = searchResponse.getHits().getHits();<br>        <span class="hljs-keyword">for</span> (SearchHit hit : hits) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> hit.getSourceAsString();<br>            <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> JSON.parseObject(json, Map.class);<br>            <span class="hljs-comment">//处理高亮</span><br>            <span class="hljs-keyword">if</span>(hit.getHighlightFields() != <span class="hljs-literal">null</span> &amp;&amp; hit.getHighlightFields().size() &gt; <span class="hljs-number">0</span>)&#123;<br>                Text[] titles = hit.getHighlightFields().get(<span class="hljs-string">&quot;title&quot;</span>).getFragments();<br>                <span class="hljs-type">String</span> <span class="hljs-variable">title</span> <span class="hljs-operator">=</span> StringUtils.join(titles);<br>                <span class="hljs-comment">//高亮标题</span><br>                map.put(<span class="hljs-string">&quot;h_title&quot;</span>,title);<br>            &#125;<span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">//原始标题</span><br>                map.put(<span class="hljs-string">&quot;h_title&quot;</span>,map.get(<span class="hljs-string">&quot;title&quot;</span>));<br>            &#125;<br>            list.add(map);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> ResponseResult.okResult(list);<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="3-5-4-控制层实现"><a href="#3-5-4-控制层实现" class="headerlink" title="3.5.4) 控制层实现"></a>3.5.4) 控制层实现</h4><p>新建控制器ArticleSearchController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.search.controller.v1;<br><br><span class="hljs-keyword">import</span> com.heima.model.common.dtos.ResponseResult;<br><span class="hljs-keyword">import</span> com.heima.model.search.dtos.UserSearchDto;<br><span class="hljs-keyword">import</span> com.heima.search.service.ArticleSearchService;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PostMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestBody;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/api/v1/article/search&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArticleSearchController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ArticleSearchService articleSearchService;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/search&quot;)</span><br>    <span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">search</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> UserSearchDto dto)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-keyword">return</span> articleSearchService.search(dto);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="3-5-5-测试"><a href="#3-5-5-测试" class="headerlink" title="3.5.5) 测试"></a>3.5.5) 测试</h4><p>需要在app的网关中添加搜索微服务的路由配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">#搜索微服务</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">leadnews-search</span><br> <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://leadnews-search</span><br> <span class="hljs-attr">predicates:</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/search/**</span><br> <span class="hljs-attr">filters:</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">StripPrefix=</span> <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure>

<p>启动项目进行测试，至少要启动文章微服务，用户微服务，搜索微服务，app网关微服务，app前端工程</p>
<h3 id="3-6-文章自动审核构建索引"><a href="#3-6-文章自动审核构建索引" class="headerlink" title="3.6) 文章自动审核构建索引"></a>3.6) 文章自动审核构建索引</h3><h4 id="3-6-1-思路分析"><a href="#3-6-1-思路分析" class="headerlink" title="3.6.1)思路分析"></a>3.6.1)思路分析</h4><p><img src="/../images/image-20210709143151781.png" srcset="/img/loading.gif" lazyload alt="image-20210709143151781"></p>
<h4 id="3-6-2-文章微服务发送消息"><a href="#3-6-2-文章微服务发送消息" class="headerlink" title="3.6.2)文章微服务发送消息"></a>3.6.2)文章微服务发送消息</h4><p>1.把SearchArticleVo放到model工程下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.model.search.vos;<br><br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.util.Date;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SearchArticleVo</span> &#123;<br><br>    <span class="hljs-comment">// 文章id</span><br>    <span class="hljs-keyword">private</span> Long id;<br>    <span class="hljs-comment">// 文章标题</span><br>    <span class="hljs-keyword">private</span> String title;<br>    <span class="hljs-comment">// 文章发布时间</span><br>    <span class="hljs-keyword">private</span> Date publishTime;<br>    <span class="hljs-comment">// 文章布局</span><br>    <span class="hljs-keyword">private</span> Integer layout;<br>    <span class="hljs-comment">// 封面</span><br>    <span class="hljs-keyword">private</span> String images;<br>    <span class="hljs-comment">// 作者id</span><br>    <span class="hljs-keyword">private</span> Long authorId;<br>    <span class="hljs-comment">// 作者名词</span><br>    <span class="hljs-keyword">private</span> String authorName;<br>    <span class="hljs-comment">//静态url</span><br>    <span class="hljs-keyword">private</span> String staticUrl;<br>    <span class="hljs-comment">//文章内容</span><br>    <span class="hljs-keyword">private</span> String content;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>2.文章微服务的ArticleFreemarkerService中的buildArticleToMinIO方法中收集数据并发送消息</p>
<p>完整代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.article.service.impl;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSONArray;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.toolkit.Wrappers;<br><span class="hljs-keyword">import</span> com.heima.article.mapper.ApArticleContentMapper;<br><span class="hljs-keyword">import</span> com.heima.article.service.ApArticleService;<br><span class="hljs-keyword">import</span> com.heima.article.service.ArticleFreemarkerService;<br><span class="hljs-keyword">import</span> com.heima.common.constants.ArticleConstants;<br><span class="hljs-keyword">import</span> com.heima.file.service.FileStorageService;<br><span class="hljs-keyword">import</span> com.heima.model.article.pojos.ApArticle;<br><span class="hljs-keyword">import</span> com.heima.model.search.vos.SearchArticleVo;<br><span class="hljs-keyword">import</span> freemarker.template.Configuration;<br><span class="hljs-keyword">import</span> freemarker.template.Template;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.apache.commons.lang3.StringUtils;<br><span class="hljs-keyword">import</span> org.springframework.beans.BeanUtils;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.kafka.core.KafkaTemplate;<br><span class="hljs-keyword">import</span> org.springframework.scheduling.annotation.Async;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><span class="hljs-keyword">import</span> org.springframework.transaction.annotation.Transactional;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.InputStream;<br><span class="hljs-keyword">import</span> java.io.StringWriter;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Transactional</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArticleFreemarkerServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ArticleFreemarkerService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ApArticleContentMapper apArticleContentMapper;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> Configuration configuration;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> FileStorageService fileStorageService;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ApArticleService apArticleService;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 生成静态文件上传到minIO中</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> apArticle</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> content</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Async</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">buildArticleToMinIO</span><span class="hljs-params">(ApArticle apArticle, String content)</span> &#123;<br>        <span class="hljs-comment">//已知文章的id</span><br>        <span class="hljs-comment">//4.1 获取文章内容</span><br>        <span class="hljs-keyword">if</span>(StringUtils.isNotBlank(content))&#123;<br>            <span class="hljs-comment">//4.2 文章内容通过freemarker生成html文件</span><br>            <span class="hljs-type">Template</span> <span class="hljs-variable">template</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>            <span class="hljs-type">StringWriter</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringWriter</span>();<br>            <span class="hljs-keyword">try</span> &#123;<br>                template = configuration.getTemplate(<span class="hljs-string">&quot;article.ftl&quot;</span>);<br>                <span class="hljs-comment">//数据模型</span><br>                Map&lt;String,Object&gt; contentDataModel = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>                contentDataModel.put(<span class="hljs-string">&quot;content&quot;</span>, JSONArray.parseArray(content));<br>                <span class="hljs-comment">//合成</span><br>                template.process(contentDataModel,out);<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                e.printStackTrace();<br>            &#125;<br><br><br>            <span class="hljs-comment">//4.3 把html文件上传到minio中</span><br>            <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(out.toString().getBytes());<br>            <span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> fileStorageService.uploadHtmlFile(<span class="hljs-string">&quot;&quot;</span>, apArticle.getId() + <span class="hljs-string">&quot;.html&quot;</span>, in);<br><br><br>            <span class="hljs-comment">//4.4 修改ap_article表，保存static_url字段</span><br>            apArticleService.update(Wrappers.&lt;ApArticle&gt;lambdaUpdate().eq(ApArticle::getId,apArticle.getId())<br>                    .set(ApArticle::getStaticUrl,path));<br><br>            <span class="hljs-comment">//发送消息，创建索引</span><br>            createArticleESIndex(apArticle,content,path);<br><br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> KafkaTemplate&lt;String,String&gt; kafkaTemplate;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 送消息，创建索引</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> apArticle</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> content</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> path</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createArticleESIndex</span><span class="hljs-params">(ApArticle apArticle, String content, String path)</span> &#123;<br>        <span class="hljs-type">SearchArticleVo</span> <span class="hljs-variable">vo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchArticleVo</span>();<br>        BeanUtils.copyProperties(apArticle,vo);<br>        vo.setContent(content);<br>        vo.setStaticUrl(path);<br><br>        kafkaTemplate.send(ArticleConstants.ARTICLE_ES_SYNC_TOPIC, JSON.toJSONString(vo));<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>在ArticleConstants类中添加新的常量，完整代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.common.constants;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArticleConstants</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Short</span> <span class="hljs-variable">LOADTYPE_LOAD_MORE</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Short</span> <span class="hljs-variable">LOADTYPE_LOAD_NEW</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_TAG</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;__all__&quot;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ARTICLE_ES_SYNC_TOPIC</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;article.es.sync.topic&quot;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Integer</span> <span class="hljs-variable">HOT_ARTICLE_LIKE_WEIGHT</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Integer</span> <span class="hljs-variable">HOT_ARTICLE_COMMENT_WEIGHT</span> <span class="hljs-operator">=</span> <span class="hljs-number">5</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Integer</span> <span class="hljs-variable">HOT_ARTICLE_COLLECTION_WEIGHT</span> <span class="hljs-operator">=</span> <span class="hljs-number">8</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">HOT_ARTICLE_FIRST_PAGE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;hot_article_first_page_&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>3.文章微服务集成kafka发送消息</p>
<p>在文章微服务的nacos的配置中心添加如下配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">kafka:</span><br>    <span class="hljs-attr">bootstrap-servers:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.130</span><span class="hljs-string">:9092</span><br>    <span class="hljs-attr">producer:</span><br>      <span class="hljs-attr">retries:</span> <span class="hljs-number">10</span><br>      <span class="hljs-attr">key-serializer:</span> <span class="hljs-string">org.apache.kafka.common.serialization.StringSerializer</span><br>      <span class="hljs-attr">value-serializer:</span> <span class="hljs-string">org.apache.kafka.common.serialization.StringSerializer</span><br></code></pre></td></tr></table></figure>

<h4 id="3-6-3-搜索微服务接收消息并创建索引"><a href="#3-6-3-搜索微服务接收消息并创建索引" class="headerlink" title="3.6.3)搜索微服务接收消息并创建索引"></a>3.6.3)搜索微服务接收消息并创建索引</h4><p>1.搜索微服务中添加kafka的配置,nacos配置如下</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">kafka:</span><br>    <span class="hljs-attr">bootstrap-servers:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.130</span><span class="hljs-string">:9092</span><br>    <span class="hljs-attr">consumer:</span><br>      <span class="hljs-attr">group-id:</span> <span class="hljs-string">$&#123;spring.application.name&#125;</span><br>      <span class="hljs-attr">key-deserializer:</span> <span class="hljs-string">org.apache.kafka.common.serialization.StringDeserializer</span><br>      <span class="hljs-attr">value-deserializer:</span> <span class="hljs-string">org.apache.kafka.common.serialization.StringDeserializer</span><br></code></pre></td></tr></table></figure>

<p>2.定义监听接收消息,保存索引数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.search.listener;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.heima.common.constants.ArticleConstants;<br><span class="hljs-keyword">import</span> com.heima.model.search.vos.SearchArticleVo;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.apache.commons.lang3.StringUtils;<br><span class="hljs-keyword">import</span> org.elasticsearch.action.index.IndexRequest;<br><span class="hljs-keyword">import</span> org.elasticsearch.client.RequestOptions;<br><span class="hljs-keyword">import</span> org.elasticsearch.client.RestHighLevelClient;<br><span class="hljs-keyword">import</span> org.elasticsearch.common.xcontent.XContentType;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.kafka.annotation.KafkaListener;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SyncArticleListener</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RestHighLevelClient restHighLevelClient;<br><br>    <span class="hljs-meta">@KafkaListener(topics = ArticleConstants.ARTICLE_ES_SYNC_TOPIC)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onMessage</span><span class="hljs-params">(String message)</span>&#123;<br>        <span class="hljs-keyword">if</span>(StringUtils.isNotBlank(message))&#123;<br><br>            log.info(<span class="hljs-string">&quot;SyncArticleListener,message=&#123;&#125;&quot;</span>,message);<br><br>            <span class="hljs-type">SearchArticleVo</span> <span class="hljs-variable">searchArticleVo</span> <span class="hljs-operator">=</span> JSON.parseObject(message, SearchArticleVo.class);<br>            <span class="hljs-type">IndexRequest</span> <span class="hljs-variable">indexRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IndexRequest</span>(<span class="hljs-string">&quot;app_info_article&quot;</span>);<br>            indexRequest.id(searchArticleVo.getId().toString());<br>            indexRequest.source(message, XContentType.JSON);<br>            <span class="hljs-keyword">try</span> &#123;<br>                restHighLevelClient.index(indexRequest, RequestOptions.DEFAULT);<br>            &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                e.printStackTrace();<br>                log.error(<span class="hljs-string">&quot;sync es error=&#123;&#125;&quot;</span>,e);<br>            &#125;<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="4-app端搜索-搜索记录"><a href="#4-app端搜索-搜索记录" class="headerlink" title="4) app端搜索-搜索记录"></a>4) app端搜索-搜索记录</h2><h3 id="4-1-需求分析-1"><a href="#4-1-需求分析-1" class="headerlink" title="4.1) 需求分析"></a>4.1) 需求分析</h3><p><img src="/../images/1587366878895.png" srcset="/img/loading.gif" lazyload alt="1587366878895"></p>
<ul>
<li>展示用户的搜索记录10条，按照搜索关键词的时间倒序</li>
<li>可以删除搜索记录</li>
<li>保存历史记录，保存10条，多余的则删除最久的历史记录</li>
</ul>
<h3 id="4-2-数据存储说明"><a href="#4-2-数据存储说明" class="headerlink" title="4.2)数据存储说明"></a>4.2)数据存储说明</h3><p>用户的搜索记录，需要给每一个用户都保存一份，数据量较大，要求加载速度快，通常这样的数据存储到mongodb更合适，不建议直接存储到关系型数据库中</p>
<p><img src="/../images/image-20210709153428259.png" srcset="/img/loading.gif" lazyload alt="image-20210709153428259"></p>
<h3 id="4-3-MongoDB安装及集成"><a href="#4-3-MongoDB安装及集成" class="headerlink" title="4.3)MongoDB安装及集成"></a>4.3)MongoDB安装及集成</h3><h4 id="4-3-1-安装MongoDB"><a href="#4-3-1-安装MongoDB" class="headerlink" title="4.3.1)安装MongoDB"></a>4.3.1)安装MongoDB</h4><p>拉取镜像</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">docker pull mongo</span><br></code></pre></td></tr></table></figure>

<p>创建容器</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">docker run -di <span class="hljs-params">--name</span> mongo-service <span class="hljs-params">--restart=always</span> -p 27017<span class="hljs-function">:27017</span> -v ~<span class="hljs-string">/data/mongodata</span>:<span class="hljs-string">/data</span> mongo<br></code></pre></td></tr></table></figure>

<h4 id="4-3-2-导入资料中的mongo-demo项目到heima-leadnews-test中"><a href="#4-3-2-导入资料中的mongo-demo项目到heima-leadnews-test中" class="headerlink" title="4.3.2)导入资料中的mongo-demo项目到heima-leadnews-test中"></a>4.3.2)导入资料中的mongo-demo项目到heima-leadnews-test中</h4><p>其中有三项配置比较关键：</p>
<p>第一：mongo依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-mongodb<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>第二：mongo配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">9998</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">data:</span><br>    <span class="hljs-attr">mongodb:</span><br>      <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.130</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">27017</span><br>      <span class="hljs-attr">database:</span> <span class="hljs-string">leadnews-history</span><br></code></pre></td></tr></table></figure>

<p>第三：映射</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.itheima.mongo.pojo;<br><br><span class="hljs-keyword">import</span> lombok.Data;<br><span class="hljs-keyword">import</span> org.springframework.data.mongodb.core.mapping.Document;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><span class="hljs-keyword">import</span> java.util.Date;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * &lt;p&gt;</span><br><span class="hljs-comment"> * 联想词表</span><br><span class="hljs-comment"> * &lt;/p&gt;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> itheima</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@Document(&quot;ap_associate_words&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApAssociateWords</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;<br><br>    <span class="hljs-keyword">private</span> String id;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 联想词</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String associateWords;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 创建时间</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Date createdTime;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="4-3-3-核心方法"><a href="#4-3-3-核心方法" class="headerlink" title="4.3.3)核心方法"></a>4.3.3)核心方法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.itheima.mongo.test;<br><br><br><span class="hljs-keyword">import</span> com.itheima.mongo.MongoApplication;<br><span class="hljs-keyword">import</span> com.itheima.mongo.pojo.ApAssociateWords;<br><span class="hljs-keyword">import</span> org.junit.Test;<br><span class="hljs-keyword">import</span> org.junit.runner.RunWith;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;<br><span class="hljs-keyword">import</span> org.springframework.data.domain.Sort;<br><span class="hljs-keyword">import</span> org.springframework.data.mongodb.core.MongoTemplate;<br><span class="hljs-keyword">import</span> org.springframework.data.mongodb.core.query.Criteria;<br><span class="hljs-keyword">import</span> org.springframework.data.mongodb.core.query.Query;<br><span class="hljs-keyword">import</span> org.springframework.test.context.junit4.SpringRunner;<br><br><span class="hljs-keyword">import</span> java.util.Date;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-meta">@SpringBootTest(classes = MongoApplication.class)</span><br><span class="hljs-meta">@RunWith(SpringRunner.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MongoTest</span> &#123;<br><br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> MongoTemplate mongoTemplate;<br><br>    <span class="hljs-comment">//保存</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveTest</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-comment">/*for (int i = 0; i &lt; 10; i++) &#123;</span><br><span class="hljs-comment">            ApAssociateWords apAssociateWords = new ApAssociateWords();</span><br><span class="hljs-comment">            apAssociateWords.setAssociateWords(&quot;黑马头条&quot;);</span><br><span class="hljs-comment">            apAssociateWords.setCreatedTime(new Date());</span><br><span class="hljs-comment">            mongoTemplate.save(apAssociateWords);</span><br><span class="hljs-comment">        &#125;*/</span><br>        <span class="hljs-type">ApAssociateWords</span> <span class="hljs-variable">apAssociateWords</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApAssociateWords</span>();<br>        apAssociateWords.setAssociateWords(<span class="hljs-string">&quot;黑马直播&quot;</span>);<br>        apAssociateWords.setCreatedTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>        mongoTemplate.save(apAssociateWords);<br><br>    &#125;<br><br>    <span class="hljs-comment">//查询一个</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveFindOne</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">ApAssociateWords</span> <span class="hljs-variable">apAssociateWords</span> <span class="hljs-operator">=</span> mongoTemplate.findById(<span class="hljs-string">&quot;60bd973eb0c1d430a71a7928&quot;</span>, ApAssociateWords.class);<br>        System.out.println(apAssociateWords);<br>    &#125;<br><br>    <span class="hljs-comment">//条件查询</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testQuery</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">Query</span> <span class="hljs-variable">query</span> <span class="hljs-operator">=</span> Query.query(Criteria.where(<span class="hljs-string">&quot;associateWords&quot;</span>).is(<span class="hljs-string">&quot;黑马头条&quot;</span>))<br>                .with(Sort.by(Sort.Direction.DESC,<span class="hljs-string">&quot;createdTime&quot;</span>));<br>        List&lt;ApAssociateWords&gt; apAssociateWordsList = mongoTemplate.find(query, ApAssociateWords.class);<br>        System.out.println(apAssociateWordsList);<br>    &#125;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testDel</span><span class="hljs-params">()</span>&#123;<br>        mongoTemplate.remove(Query.query(Criteria.where(<span class="hljs-string">&quot;associateWords&quot;</span>).is(<span class="hljs-string">&quot;黑马头条&quot;</span>)),ApAssociateWords.class);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="4-4-保存搜索记录"><a href="#4-4-保存搜索记录" class="headerlink" title="4.4)保存搜索记录"></a>4.4)保存搜索记录</h3><h4 id="4-4-1-实现思路"><a href="#4-4-1-实现思路" class="headerlink" title="4.4.1)实现思路"></a>4.4.1)实现思路</h4><p><img src="/../images/image-20210709153935904.png" srcset="/img/loading.gif" lazyload alt="image-20210709153935904"></p>
<p>用户输入关键字进行搜索的异步记录关键字</p>
<p><img src="/../images/image-20210709154053892.png" srcset="/img/loading.gif" lazyload alt="image-20210709154053892"></p>
<p>用户搜索记录对应的集合，对应实体类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.search.pojos;<br><br><span class="hljs-keyword">import</span> lombok.Data;<br><span class="hljs-keyword">import</span> org.springframework.data.mongodb.core.mapping.Document;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><span class="hljs-keyword">import</span> java.util.Date;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * &lt;p&gt;</span><br><span class="hljs-comment"> * APP用户搜索信息表</span><br><span class="hljs-comment"> * &lt;/p&gt;</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> itheima</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@Document(&quot;ap_user_search&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApUserSearch</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 主键</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String id;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 用户ID</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Integer userId;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 搜索词</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String keyword;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 创建时间</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Date createdTime;<br><br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="4-4-2-实现步骤"><a href="#4-4-2-实现步骤" class="headerlink" title="4.4.2)实现步骤"></a>4.4.2)实现步骤</h4><p>1.搜索微服务集成mongodb</p>
<p>①：pom依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-mongodb<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>②：nacos配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">data:</span><br>   <span class="hljs-attr">mongodb:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.130</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">27017</span><br>    <span class="hljs-attr">database:</span> <span class="hljs-string">leadnews-history</span><br></code></pre></td></tr></table></figure>

<p>③：在当天资料中找到对应的实体类拷贝到搜索微服务下</p>
<p>2.创建ApUserSearchService新增insert方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ApUserSearchService</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 保存用户搜索历史记录</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> keyword</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> userId</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insert</span><span class="hljs-params">(String keyword,Integer userId)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>实现类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApUserSearchServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ApUserSearchService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> MongoTemplate mongoTemplate;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 保存用户搜索历史记录</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> keyword</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> userId</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-meta">@Async</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insert</span><span class="hljs-params">(String keyword, Integer userId)</span> &#123;<br>        <span class="hljs-comment">//1.查询当前用户的搜索关键词</span><br>        <span class="hljs-type">Query</span> <span class="hljs-variable">query</span> <span class="hljs-operator">=</span> Query.query(Criteria.where(<span class="hljs-string">&quot;userId&quot;</span>).is(userId).and(<span class="hljs-string">&quot;keyword&quot;</span>).is(keyword));<br>        <span class="hljs-type">ApUserSearch</span> <span class="hljs-variable">apUserSearch</span> <span class="hljs-operator">=</span> mongoTemplate.findOne(query, ApUserSearch.class);<br><br>        <span class="hljs-comment">//2.存在 更新创建时间</span><br>        <span class="hljs-keyword">if</span>(apUserSearch != <span class="hljs-literal">null</span>)&#123;<br>            apUserSearch.setCreatedTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>            mongoTemplate.save(apUserSearch);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        <span class="hljs-comment">//3.不存在，判断当前历史记录总数量是否超过10</span><br>        apUserSearch = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApUserSearch</span>();<br>        apUserSearch.setUserId(userId);<br>        apUserSearch.setKeyword(keyword);<br>        apUserSearch.setCreatedTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br><br>        <span class="hljs-type">Query</span> <span class="hljs-variable">query1</span> <span class="hljs-operator">=</span> Query.query(Criteria.where(<span class="hljs-string">&quot;userId&quot;</span>).is(userId));<br>        query1.with(Sort.by(Sort.Direction.DESC,<span class="hljs-string">&quot;createdTime&quot;</span>));<br>        List&lt;ApUserSearch&gt; apUserSearchList = mongoTemplate.find(query1, ApUserSearch.class);<br><br>        <span class="hljs-keyword">if</span>(apUserSearchList == <span class="hljs-literal">null</span> || apUserSearchList.size() &lt; <span class="hljs-number">10</span>)&#123;<br>            mongoTemplate.save(apUserSearch);<br>        &#125;<span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-type">ApUserSearch</span> <span class="hljs-variable">lastUserSearch</span> <span class="hljs-operator">=</span> apUserSearchList.get(apUserSearchList.size() - <span class="hljs-number">1</span>);<br>            mongoTemplate.findAndReplace(Query.query(Criteria.where(<span class="hljs-string">&quot;id&quot;</span>).is(lastUserSearch.getId())),apUserSearch);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>3.参考自媒体相关微服务，在搜索微服务中获取当前登录的用户</p>
<p>4.在ArticleSearchService的search方法中调用保存历史记录</p>
<p>完整代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.search.service.impl;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.heima.model.common.dtos.ResponseResult;<br><span class="hljs-keyword">import</span> com.heima.model.common.enums.AppHttpCodeEnum;<br><span class="hljs-keyword">import</span> com.heima.model.search.dtos.UserSearchDto;<br><span class="hljs-keyword">import</span> com.heima.model.user.pojos.ApUser;<br><span class="hljs-keyword">import</span> com.heima.search.service.ApUserSearchService;<br><span class="hljs-keyword">import</span> com.heima.search.service.ArticleSearchService;<br><span class="hljs-keyword">import</span> com.heima.utils.thread.AppThreadLocalUtil;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.apache.commons.lang3.StringUtils;<br><span class="hljs-keyword">import</span> org.elasticsearch.action.search.SearchRequest;<br><span class="hljs-keyword">import</span> org.elasticsearch.action.search.SearchResponse;<br><span class="hljs-keyword">import</span> org.elasticsearch.client.RequestOptions;<br><span class="hljs-keyword">import</span> org.elasticsearch.client.RestHighLevelClient;<br><span class="hljs-keyword">import</span> org.elasticsearch.common.text.Text;<br><span class="hljs-keyword">import</span> org.elasticsearch.index.query.*;<br><span class="hljs-keyword">import</span> org.elasticsearch.search.SearchHit;<br><span class="hljs-keyword">import</span> org.elasticsearch.search.builder.SearchSourceBuilder;<br><span class="hljs-keyword">import</span> org.elasticsearch.search.fetch.subphase.highlight.HighlightBuilder;<br><span class="hljs-keyword">import</span> org.elasticsearch.search.sort.SortOrder;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArticleSearchServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ArticleSearchService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RestHighLevelClient restHighLevelClient;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ApUserSearchService apUserSearchService;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * es文章分页检索</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> dto</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">search</span><span class="hljs-params">(UserSearchDto dto)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br><br>        <span class="hljs-comment">//1.检查参数</span><br>        <span class="hljs-keyword">if</span>(dto == <span class="hljs-literal">null</span> || StringUtils.isBlank(dto.getSearchWords()))&#123;<br>            <span class="hljs-keyword">return</span> ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID);<br>        &#125;<br><br>        <span class="hljs-type">ApUser</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> AppThreadLocalUtil.getUser();<br><br>        <span class="hljs-comment">//异步调用 保存搜索记录</span><br>        <span class="hljs-keyword">if</span>(user != <span class="hljs-literal">null</span> &amp;&amp; dto.getFromIndex() == <span class="hljs-number">0</span>)&#123;<br>            apUserSearchService.insert(dto.getSearchWords(), user.getId());<br>        &#125;<br><br><br>        <span class="hljs-comment">//2.设置查询条件</span><br>        <span class="hljs-type">SearchRequest</span> <span class="hljs-variable">searchRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchRequest</span>(<span class="hljs-string">&quot;app_info_article&quot;</span>);<br>        <span class="hljs-type">SearchSourceBuilder</span> <span class="hljs-variable">searchSourceBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchSourceBuilder</span>();<br><br>        <span class="hljs-comment">//布尔查询</span><br>        <span class="hljs-type">BoolQueryBuilder</span> <span class="hljs-variable">boolQueryBuilder</span> <span class="hljs-operator">=</span> QueryBuilders.boolQuery();<br><br>        <span class="hljs-comment">//关键字的分词之后查询</span><br>        <span class="hljs-type">QueryStringQueryBuilder</span> <span class="hljs-variable">queryStringQueryBuilder</span> <span class="hljs-operator">=</span> QueryBuilders.queryStringQuery(dto.getSearchWords()).field(<span class="hljs-string">&quot;title&quot;</span>).field(<span class="hljs-string">&quot;content&quot;</span>).defaultOperator(Operator.OR);<br>        boolQueryBuilder.must(queryStringQueryBuilder);<br><br>        <span class="hljs-comment">//查询小于mindate的数据</span><br>        <span class="hljs-type">RangeQueryBuilder</span> <span class="hljs-variable">rangeQueryBuilder</span> <span class="hljs-operator">=</span> QueryBuilders.rangeQuery(<span class="hljs-string">&quot;publishTime&quot;</span>).lt(dto.getMinBehotTime().getTime());<br>        boolQueryBuilder.filter(rangeQueryBuilder);<br><br>        <span class="hljs-comment">//分页查询</span><br>        searchSourceBuilder.from(<span class="hljs-number">0</span>);<br>        searchSourceBuilder.size(dto.getPageSize());<br><br>        <span class="hljs-comment">//按照发布时间倒序查询</span><br>        searchSourceBuilder.sort(<span class="hljs-string">&quot;publishTime&quot;</span>, SortOrder.DESC);<br><br>        <span class="hljs-comment">//设置高亮  title</span><br>        <span class="hljs-type">HighlightBuilder</span> <span class="hljs-variable">highlightBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HighlightBuilder</span>();<br>        highlightBuilder.field(<span class="hljs-string">&quot;title&quot;</span>);<br>        highlightBuilder.preTags(<span class="hljs-string">&quot;&lt;font style=&#x27;color: red; font-size: inherit;&#x27;&gt;&quot;</span>);<br>        highlightBuilder.postTags(<span class="hljs-string">&quot;&lt;/font&gt;&quot;</span>);<br>        searchSourceBuilder.highlighter(highlightBuilder);<br><br><br>        searchSourceBuilder.query(boolQueryBuilder);<br>        searchRequest.source(searchSourceBuilder);<br>        <span class="hljs-type">SearchResponse</span> <span class="hljs-variable">searchResponse</span> <span class="hljs-operator">=</span> restHighLevelClient.search(searchRequest, RequestOptions.DEFAULT);<br><br><br>        <span class="hljs-comment">//3.结果封装返回</span><br><br>        List&lt;Map&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><br>        SearchHit[] hits = searchResponse.getHits().getHits();<br>        <span class="hljs-keyword">for</span> (SearchHit hit : hits) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> hit.getSourceAsString();<br>            <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> JSON.parseObject(json, Map.class);<br>            <span class="hljs-comment">//处理高亮</span><br>            <span class="hljs-keyword">if</span>(hit.getHighlightFields() != <span class="hljs-literal">null</span> &amp;&amp; hit.getHighlightFields().size() &gt; <span class="hljs-number">0</span>)&#123;<br>                Text[] titles = hit.getHighlightFields().get(<span class="hljs-string">&quot;title&quot;</span>).getFragments();<br>                <span class="hljs-type">String</span> <span class="hljs-variable">title</span> <span class="hljs-operator">=</span> StringUtils.join(titles);<br>                <span class="hljs-comment">//高亮标题</span><br>                map.put(<span class="hljs-string">&quot;h_title&quot;</span>,title);<br>            &#125;<span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">//原始标题</span><br>                map.put(<span class="hljs-string">&quot;h_title&quot;</span>,map.get(<span class="hljs-string">&quot;title&quot;</span>));<br>            &#125;<br>            list.add(map);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> ResponseResult.okResult(list);<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>5.保存历史记录中开启异步调用，添加注解@Async</p>
<p>6.在搜索微服务引导类上开启异步调用</p>
<p><img src="/../images/image-20210709154841113.png" srcset="/img/loading.gif" lazyload alt="image-20210709154841113"></p>
<p>7.测试，搜索后查看结果</p>
<h3 id="4-5-加载搜索记录列表"><a href="#4-5-加载搜索记录列表" class="headerlink" title="4.5) 加载搜索记录列表"></a>4.5) 加载搜索记录列表</h3><h4 id="4-5-1-思路分析"><a href="#4-5-1-思路分析" class="headerlink" title="4.5.1) 思路分析"></a>4.5.1) 思路分析</h4><p>按照当前用户，按照时间倒序查询</p>
<table>
<thead>
<tr>
<th></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>接口路径</td>
<td>/api/v1/history/load</td>
</tr>
<tr>
<td>请求方式</td>
<td>POST</td>
</tr>
<tr>
<td>参数</td>
<td>无</td>
</tr>
<tr>
<td>响应结果</td>
<td>ResponseResult</td>
</tr>
</tbody></table>
<h4 id="4-5-2-接口定义"><a href="#4-5-2-接口定义" class="headerlink" title="4.5.2) 接口定义"></a>4.5.2) 接口定义</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * &lt;p&gt;</span><br><span class="hljs-comment"> * APP用户搜索信息表 前端控制器</span><br><span class="hljs-comment"> * &lt;/p&gt;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> itheima</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/api/v1/history&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApUserSearchController</span>&#123;<br><br><br>    <span class="hljs-meta">@PostMapping(&quot;/load&quot;)</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">findUserSearch</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="4-5-3-mapper"><a href="#4-5-3-mapper" class="headerlink" title="4.5.3) mapper"></a>4.5.3) mapper</h4><p>已定义</p>
<h4 id="4-5-4-业务层"><a href="#4-5-4-业务层" class="headerlink" title="4.5.4) 业务层"></a>4.5.4) 业务层</h4><p>在ApUserSearchService中新增方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     查询搜索历史</span><br><span class="hljs-comment">     <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>ResponseResult <span class="hljs-title function_">findUserSearch</span><span class="hljs-params">()</span>;<br></code></pre></td></tr></table></figure>

<p>实现方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"> <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 查询搜索历史</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">findUserSearch</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">//获取当前用户</span><br>    <span class="hljs-type">ApUser</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> AppThreadLocalUtil.getUser();<br>    <span class="hljs-keyword">if</span>(user == <span class="hljs-literal">null</span>)&#123;<br>        <span class="hljs-keyword">return</span> ResponseResult.errorResult(AppHttpCodeEnum.NEED_LOGIN);<br>    &#125;<br><br>    <span class="hljs-comment">//根据用户查询数据，按照时间倒序</span><br>    List&lt;ApUserSearch&gt; apUserSearches = mongoTemplate.find(Query.query(Criteria.where(<span class="hljs-string">&quot;userId&quot;</span>).is(user.getId())).with(Sort.by(Sort.Direction.DESC, <span class="hljs-string">&quot;createdTime&quot;</span>)), ApUserSearch.class);<br>    <span class="hljs-keyword">return</span> ResponseResult.okResult(apUserSearches);<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="4-5-5-控制器"><a href="#4-5-5-控制器" class="headerlink" title="4.5.5) 控制器"></a>4.5.5) 控制器</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * &lt;p&gt;</span><br><span class="hljs-comment"> * APP用户搜索信息表 前端控制器</span><br><span class="hljs-comment"> * &lt;/p&gt;</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> itheima</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/api/v1/history&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApUserSearchController</span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ApUserSearchService apUserSearchService;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/load&quot;)</span><br>    <span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">findUserSearch</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> apUserSearchService.findUserSearch();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="4-5-6-测试"><a href="#4-5-6-测试" class="headerlink" title="4.5.6) 测试"></a>4.5.6) 测试</h4><p>打开app的搜索页面，可以查看搜索记录列表</p>
<h3 id="4-6-删除搜索记录"><a href="#4-6-删除搜索记录" class="headerlink" title="4.6) 删除搜索记录"></a>4.6) 删除搜索记录</h3><h4 id="4-6-1-思路分析"><a href="#4-6-1-思路分析" class="headerlink" title="4.6.1) 思路分析"></a>4.6.1) 思路分析</h4><p>按照搜索历史id删除</p>
<table>
<thead>
<tr>
<th></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>接口路径</td>
<td>/api/v1/history/del</td>
</tr>
<tr>
<td>请求方式</td>
<td>POST</td>
</tr>
<tr>
<td>参数</td>
<td>HistorySearchDto</td>
</tr>
<tr>
<td>响应结果</td>
<td>ResponseResult</td>
</tr>
</tbody></table>
<h4 id="4-6-2-接口定义"><a href="#4-6-2-接口定义" class="headerlink" title="4.6.2) 接口定义"></a>4.6.2) 接口定义</h4><p>在ApUserSearchController接口新增方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@PostMapping(&quot;/del&quot;)</span><br><span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">delUserSearch</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> HistorySearchDto historySearchDto)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>HistorySearchDto</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HistorySearchDto</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 接收搜索历史记录id</span><br><span class="hljs-comment">    */</span><br>    String id;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="4-6-3-业务层"><a href="#4-6-3-业务层" class="headerlink" title="4.6.3) 业务层"></a>4.6.3) 业务层</h4><p>在ApUserSearchService中新增方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"> <span class="hljs-comment">/**</span><br><span class="hljs-comment">     删除搜索历史</span><br><span class="hljs-comment">     <span class="hljs-doctag">@param</span> historySearchDto</span><br><span class="hljs-comment">     <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>ResponseResult <span class="hljs-title function_">delUserSearch</span><span class="hljs-params">(HistorySearchDto historySearchDto)</span>;<br></code></pre></td></tr></table></figure>

<p>实现方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 删除历史记录</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> dto</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">delUserSearch</span><span class="hljs-params">(HistorySearchDto dto)</span> &#123;<br>    <span class="hljs-comment">//1.检查参数</span><br>    <span class="hljs-keyword">if</span>(dto.getId() == <span class="hljs-literal">null</span>)&#123;<br>        <span class="hljs-keyword">return</span> ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID);<br>    &#125;<br><br>    <span class="hljs-comment">//2.判断是否登录</span><br>    <span class="hljs-type">ApUser</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> AppThreadLocalUtil.getUser();<br>    <span class="hljs-keyword">if</span>(user == <span class="hljs-literal">null</span>)&#123;<br>        <span class="hljs-keyword">return</span> ResponseResult.errorResult(AppHttpCodeEnum.NEED_LOGIN);<br>    &#125;<br><br>    <span class="hljs-comment">//3.删除</span><br>    mongoTemplate.remove(Query.query(Criteria.where(<span class="hljs-string">&quot;userId&quot;</span>).is(user.getId()).and(<span class="hljs-string">&quot;id&quot;</span>).is(dto.getId())),ApUserSearch.class);<br>    <span class="hljs-keyword">return</span> ResponseResult.okResult(AppHttpCodeEnum.SUCCESS);<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="4-6-4-控制器"><a href="#4-6-4-控制器" class="headerlink" title="4.6.4) 控制器"></a>4.6.4) 控制器</h4><p>修改ApUserSearchController，补全方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@PostMapping(&quot;/del&quot;)</span><br><span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">delUserSearch</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> HistorySearchDto historySearchDto)</span> &#123;<br>    <span class="hljs-keyword">return</span> apUserSearchService.delUserSearch(historySearchDto);<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="4-6-5-测试"><a href="#4-6-5-测试" class="headerlink" title="4.6.5) 测试"></a>4.6.5) 测试</h4><p>打开app可以删除搜索记录</p>
<h2 id="5-app端搜索-关键字联想词"><a href="#5-app端搜索-关键字联想词" class="headerlink" title="5) app端搜索-关键字联想词"></a>5) app端搜索-关键字联想词</h2><h3 id="5-1-需求分析"><a href="#5-1-需求分析" class="headerlink" title="5.1 需求分析"></a>5.1 需求分析</h3><p><img src="/../images/1587366921085.png" srcset="/img/loading.gif" lazyload alt="1587366921085"></p>
<ul>
<li>根据用户输入的关键字展示联想词</li>
</ul>
<p>对应实体类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.search.pojos;<br><br><span class="hljs-keyword">import</span> lombok.Data;<br><span class="hljs-keyword">import</span> org.springframework.data.mongodb.core.mapping.Document;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><span class="hljs-keyword">import</span> java.util.Date;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * &lt;p&gt;</span><br><span class="hljs-comment"> * 联想词表</span><br><span class="hljs-comment"> * &lt;/p&gt;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> itheima</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@Document(&quot;ap_associate_words&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApAssociateWords</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;<br><br>    <span class="hljs-keyword">private</span> String id;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 联想词</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String associateWords;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 创建时间</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Date createdTime;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="5-2-搜索词-数据来源"><a href="#5-2-搜索词-数据来源" class="headerlink" title="5.2)搜索词-数据来源"></a>5.2)搜索词-数据来源</h3><p>通常是网上搜索频率比较高的一些词，通常在企业中有两部分来源：</p>
<p>第一：自己维护搜索词</p>
<p>通过分析用户搜索频率较高的词，按照排名作为搜索词</p>
<p>第二：第三方获取</p>
<p>关键词规划师（百度）、5118、爱站网</p>
<p><img src="/../images/image-20210709160036983.png" srcset="/img/loading.gif" lazyload alt="image-20210709160036983"></p>
<p>导入资料中的ap_associate_words.js脚本到mongo中</p>
<h3 id="5-3-功能实现"><a href="#5-3-功能实现" class="headerlink" title="5.3 功能实现"></a>5.3 功能实现</h3><h4 id="5-3-1-接口定义"><a href="#5-3-1-接口定义" class="headerlink" title="5.3.1 接口定义"></a>5.3.1 接口定义</h4><table>
<thead>
<tr>
<th></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>接口路径</td>
<td>/api/v1/associate/search</td>
</tr>
<tr>
<td>请求方式</td>
<td>POST</td>
</tr>
<tr>
<td>参数</td>
<td>UserSearchDto</td>
</tr>
<tr>
<td>响应结果</td>
<td>ResponseResult</td>
</tr>
</tbody></table>
<p>新建接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.search.controller.v1;<br><br><span class="hljs-keyword">import</span> com.heima.model.common.dtos.ResponseResult;<br><span class="hljs-keyword">import</span> com.heima.model.search.dtos.UserSearchDto;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PostMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestBody;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/api/v1/associate&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApAssociateWordsController</span> &#123;<br><br><br>    <span class="hljs-meta">@PostMapping(&quot;/search&quot;)</span><br>    <span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">search</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> UserSearchDto userSearchDto)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h4 id="5-3-3-业务层"><a href="#5-3-3-业务层" class="headerlink" title="5.3.3 业务层"></a>5.3.3 业务层</h4><p>新建联想词业务层接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.search.service;<br><br><span class="hljs-keyword">import</span> com.heima.model.common.dtos.ResponseResult;<br><span class="hljs-keyword">import</span> com.heima.model.search.dtos.UserSearchDto;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * &lt;p&gt;</span><br><span class="hljs-comment"> * 联想词表 服务类</span><br><span class="hljs-comment"> * &lt;/p&gt;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> itheima</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ApAssociateWordsService</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     联想词</span><br><span class="hljs-comment">     <span class="hljs-doctag">@param</span> userSearchDto</span><br><span class="hljs-comment">     <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    ResponseResult <span class="hljs-title function_">findAssociate</span><span class="hljs-params">(UserSearchDto userSearchDto)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.search.service.impl;<br><br><span class="hljs-keyword">import</span> com.heima.model.common.dtos.ResponseResult;<br><span class="hljs-keyword">import</span> com.heima.model.common.enums.AppHttpCodeEnum;<br><span class="hljs-keyword">import</span> com.heima.model.search.dtos.UserSearchDto;<br><span class="hljs-keyword">import</span> com.heima.search.pojos.ApAssociateWords;<br><span class="hljs-keyword">import</span> com.heima.search.service.ApAssociateWordsService;<br><span class="hljs-keyword">import</span> org.apache.commons.lang3.StringUtils;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.data.mongodb.core.MongoTemplate;<br><span class="hljs-keyword">import</span> org.springframework.data.mongodb.core.query.Criteria;<br><span class="hljs-keyword">import</span> org.springframework.data.mongodb.core.query.Query;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span>:</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Version</span>: V1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApAssociateWordsServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ApAssociateWordsService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    MongoTemplate mongoTemplate;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 联想词</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> userSearchDto</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">findAssociate</span><span class="hljs-params">(UserSearchDto userSearchDto)</span> &#123;<br>        <span class="hljs-comment">//1 参数检查</span><br>        <span class="hljs-keyword">if</span>(userSearchDto == <span class="hljs-literal">null</span> || StringUtils.isBlank(userSearchDto.getSearchWords()))&#123;<br>            <span class="hljs-keyword">return</span> ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID);<br>        &#125;<br>        <span class="hljs-comment">//分页检查</span><br>        <span class="hljs-keyword">if</span> (userSearchDto.getPageSize() &gt; <span class="hljs-number">20</span>) &#123;<br>            userSearchDto.setPageSize(<span class="hljs-number">20</span>);<br>        &#125;<br><br>        <span class="hljs-comment">//3 执行查询 模糊查询</span><br>        <span class="hljs-type">Query</span> <span class="hljs-variable">query</span> <span class="hljs-operator">=</span> Query.query(Criteria.where(<span class="hljs-string">&quot;associateWords&quot;</span>).regex(<span class="hljs-string">&quot;.*?\\&quot;</span> + userSearchDto.getSearchWords() + <span class="hljs-string">&quot;.*&quot;</span>));<br>        query.limit(userSearchDto.getPageSize());<br>        List&lt;ApAssociateWords&gt; wordsList = mongoTemplate.find(query, ApAssociateWords.class);<br><br>        <span class="hljs-keyword">return</span> ResponseResult.okResult(wordsList);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="5-3-4-控制器"><a href="#5-3-4-控制器" class="headerlink" title="5.3.4  控制器"></a>5.3.4  控制器</h4><p>新建联想词控制器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.search.controller.v1;<br><br><span class="hljs-keyword">import</span> com.heima.model.common.dtos.ResponseResult;<br><span class="hljs-keyword">import</span> com.heima.model.search.dtos.UserSearchDto;<br><span class="hljs-keyword">import</span> com.heima.search.service.ApAssociateWordsService;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PostMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestBody;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * &lt;p&gt;</span><br><span class="hljs-comment"> * 联想词表 前端控制器</span><br><span class="hljs-comment"> * &lt;/p&gt;</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> itheima</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/api/v1/associate&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApAssociateWordsController</span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ApAssociateWordsService apAssociateWordsService;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/search&quot;)</span><br>    <span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">findAssociate</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> UserSearchDto userSearchDto)</span> &#123;<br>        <span class="hljs-keyword">return</span> apAssociateWordsService.findAssociate(userSearchDto);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="5-3-5-测试"><a href="#5-3-5-测试" class="headerlink" title="5.3.5 测试"></a>5.3.5 测试</h4><p>同样，打开前端联调测试效果</p>
<h1 id="8-xxl-Job分布式任务调度"><a href="#8-xxl-Job分布式任务调度" class="headerlink" title="8 xxl-Job分布式任务调度"></a>8 xxl-Job分布式任务调度</h1><h2 id="1-今日内容"><a href="#1-今日内容" class="headerlink" title="1 今日内容"></a>1 今日内容</h2><h3 id="1-1-需求分析-1"><a href="#1-1-需求分析-1" class="headerlink" title="1.1 需求分析"></a>1.1 需求分析</h3><p><img src="/../images/image-20210729224950851.png" srcset="/img/loading.gif" lazyload alt="image-20210729224950851"></p>
<p>目前实现的思路：从数据库直接按照发布时间倒序查询</p>
<ul>
<li><p>问题1：</p>
<p>  如何访问量较大，直接查询数据库，压力较大</p>
</li>
<li><p>问题2：</p>
<p>  新发布的文章会展示在前面，并不是热点文章</p>
</li>
</ul>
<h3 id="1-2-实现思路"><a href="#1-2-实现思路" class="headerlink" title="1.2 实现思路"></a>1.2 实现思路</h3><p>把热点数据存入redis进行展示</p>
<p>判断文章是否是热点，有几项标准： 点赞数量，评论数量，阅读数量，收藏数量</p>
<p>计算文章热度，有两种方案：</p>
<ul>
<li><p>定时计算文章热度</p>
</li>
<li><p>实时计算文章热度</p>
</li>
</ul>
<h3 id="1-3-定时计算"><a href="#1-3-定时计算" class="headerlink" title="1.3 定时计算"></a>1.3 定时计算</h3><p><img src="/../images/image-20210729225206299.png" srcset="/img/loading.gif" lazyload alt="image-20210729225206299"></p>
<ul>
<li><p>根据文章的行为（点赞、评论、阅读、收藏）计算文章的分值，利用定时任务每天完成一次计算</p>
</li>
<li><p>把分值较大的文章数据存入到redis中</p>
</li>
<li><p>App端用户查询文章列表的时候，优先从redis中查询热度较高的文章数据</p>
</li>
</ul>
<h3 id="1-4-定时任务框架-xxljob"><a href="#1-4-定时任务框架-xxljob" class="headerlink" title="1.4 定时任务框架-xxljob"></a>1.4 定时任务框架-xxljob</h3><p>spring传统的定时任务@Scheduled，但是这样存在这一些问题 ：</p>
<ul>
<li><p>做集群任务的重复执行问题</p>
</li>
<li><p>cron表达式定义在代码之中，修改不方便</p>
</li>
<li><p>定时任务失败了，无法重试也没有统计</p>
</li>
<li><p>如果任务量过大，不能有效的分片执行</p>
</li>
</ul>
<p>解决这些问题的方案为：</p>
<p>xxl-job 分布式任务调度框架</p>
<h3 id="1-5-学习目录"><a href="#1-5-学习目录" class="headerlink" title="1.5 学习目录"></a>1.5 学习目录</h3><ul>
<li><p>xxl-job概述</p>
</li>
<li><p>xxl-job入门案例</p>
</li>
<li><p>xxl-job高级部分</p>
</li>
<li><p>热点文章定时计算</p>
</li>
<li><p>查询文章接口改造</p>
</li>
</ul>
<h2 id="2-分布式任务调度"><a href="#2-分布式任务调度" class="headerlink" title="2.分布式任务调度"></a>2.分布式任务调度</h2><h3 id="2-1-什么是分布式任务调度"><a href="#2-1-什么是分布式任务调度" class="headerlink" title="2.1 什么是分布式任务调度"></a>2.1 什么是分布式任务调度</h3><p>当前软件的架构已经开始向分布式架构转变，将单体结构拆分为若干服务，服务之间通过网络交互来完成业务处理。在分布式架构下，一个服务往往会部署多个实例来运行我们的业务，如果在这种分布式系统环境下运行任务调度，我们称之为<strong>分布式任务调度</strong>。</p>
<p><img src="/../images/image-20210729230059884.png" srcset="/img/loading.gif" lazyload alt="image-20210729230059884"></p>
<p>将任务调度程序分布式构建，这样就可以具有分布式系统的特点，并且提高任务的调度处理能力：</p>
<p>1、并行任务调度</p>
<p>并行任务调度实现靠多线程，如果有大量任务需要调度，此时光靠多线程就会有瓶颈了，因为一台计算机CPU的处理能力是有限的。</p>
<p>如果将任务调度程序分布式部署，每个结点还可以部署为集群，这样就可以让多台计算机共同去完成任务调度，我们可以将任务分割为若干个分片，由不同的实例并行执行，来提高任务调度的处理效率。</p>
<p>2、高可用</p>
<p>若某一个实例宕机，不影响其他实例来执行任务。</p>
<p>3、弹性扩容</p>
<p>当集群中增加实例就可以提高并执行任务的处理效率。</p>
<p>4、任务管理与监测</p>
<p>对系统中存在的所有定时任务进行统一的管理及监测。让开发人员及运维人员能够时刻了解任务执行情况，从而做出快速的应急处理响应。</p>
<p><strong>分布式任务调度面临的问题：</strong></p>
<p>当任务调度以集群方式部署，同一个任务调度可能会执行多次，例如：电商系统定期发放优惠券，就可能重复发放优惠券，对公司造成损失，信用卡还款提醒就会重复执行多次，给用户造成烦恼，所以我们需要控制相同的任务在多个运行实例上只执行一次。常见解决方案：</p>
<ul>
<li>分布式锁，多个实例在任务执行前首先需要获取锁，如果获取失败那么就证明有其他服务已经在运行，如果获取成功那么证明没有服务在运行定时任务，那么就可以执行。</li>
<li>ZooKeeper选举，利用ZooKeeper对Leader实例执行定时任务，执行定时任务的时候判断自己是否是Leader，如果不是则不执行，如果是则执行业务逻辑，这样也能达到目的。</li>
</ul>
<h3 id="2-2-xxl-Job简介"><a href="#2-2-xxl-Job简介" class="headerlink" title="2.2 xxl-Job简介"></a>2.2 xxl-Job简介</h3><p>针对分布式任务调度的需求，市场上出现了很多的产品：</p>
<p>1） TBSchedule：淘宝推出的一款非常优秀的高性能分布式调度框架，目前被应用于阿里、京东、支付宝、国美等很多互联网企业的流程调度系统中。但是已经多年未更新，文档缺失严重，缺少维护。</p>
<p>2） XXL-Job：大众点评的分布式任务调度平台，是一个轻量级分布式任务调度平台, 其核心设计目标是开发迅速、学习简单、轻量级、易扩展。现已开放源代码并接入多家公司线上产品线，开箱即用。</p>
<p>3）Elastic-job：当当网借鉴TBSchedule并基于quartz 二次开发的弹性分布式任务调度系统，功能丰富强大，采用zookeeper实现分布式协调，具有任务高可用以及分片功能。</p>
<p>4）Saturn： 唯品会开源的一个分布式任务调度平台，基于Elastic-job，可以全域统一配置，统一监<br>控，具有任务高可用以及分片功能。 </p>
<p>XXL-JOB是一个分布式任务调度平台，其核心设计目标是开发迅速、学习简单、轻量级、易扩展。现已开放源代码并接入多家公司线上产品线，开箱即用。</p>
<p>源码地址：<a target="_blank" rel="noopener" href="https://gitee.com/xuxueli0323/xxl-job">https://gitee.com/xuxueli0323/xxl-job</a></p>
<p>文档地址：<a target="_blank" rel="noopener" href="https://www.xuxueli.com/xxl-job/">https://www.xuxueli.com/xxl-job/</a></p>
<p><strong>特性</strong></p>
<ul>
<li><strong>简单灵活</strong><br>  提供Web页面对任务进行管理，管理系统支持用户管理、权限控制；<br>  支持容器部署；<br>  支持通过通用HTTP提供跨平台任务调度；</li>
<li><strong>丰富的任务管理功能</strong><br>  支持页面对任务CRUD操作；<br>  支持在页面编写脚本任务、命令行任务、Java代码任务并执行；<br>  支持任务级联编排，父任务执行结束后触发子任务执行；<br>  支持设置指定任务执行节点路由策略，包括轮询、随机、广播、故障转移、忙碌转移等；<br>  支持Cron方式、任务依赖、调度中心API接口方式触发任务执行</li>
<li><strong>高性能</strong><br>  任务调度流程全异步化设计实现，如异步调度、异步运行、异步回调等，有效对密集调度进行流量削峰；</li>
<li><strong>高可用</strong><br>  任务调度中心、任务执行节点均 集群部署，支持动态扩展、故障转移<br>  支持任务配置路由故障转移策略，执行器节点不可用是自动转移到其他节点执行<br>  支持任务超时控制、失败重试配置<br>  支持任务处理阻塞策略：调度当任务执行节点忙碌时来不及执行任务的处理策略，包括：串行、抛弃、覆盖策略</li>
<li><strong>易于监控运维</strong><br>  支持设置任务失败邮件告警，预留接口支持短信、钉钉告警；<br>  支持实时查看任务执行运行数据统计图表、任务进度监控数据、任务完整执行日志；</li>
</ul>
<h3 id="2-3-XXL-Job-环境搭建"><a href="#2-3-XXL-Job-环境搭建" class="headerlink" title="2.3 XXL-Job-环境搭建"></a>2.3 XXL-Job-环境搭建</h3><h4 id="2-3-1-调度中心环境要求"><a href="#2-3-1-调度中心环境要求" class="headerlink" title="2.3.1 调度中心环境要求"></a>2.3.1 调度中心环境要求</h4><ul>
<li>Maven3+</li>
<li>Jdk1.8+</li>
<li>Mysql5.7+</li>
</ul>
<h4 id="2-3-2-源码仓库地址"><a href="#2-3-2-源码仓库地址" class="headerlink" title="2.3.2 源码仓库地址"></a>2.3.2 源码仓库地址</h4><table>
<thead>
<tr>
<th align="left">源码仓库地址</th>
<th align="left">Release Download</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><a target="_blank" rel="noopener" href="https://github.com/xuxueli/xxl-job">https://github.com/xuxueli/xxl-job</a></td>
<td align="left"><a target="_blank" rel="noopener" href="https://github.com/xuxueli/xxl-job/releases">Download</a></td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://gitee.com/xuxueli0323/xxl-job">http://gitee.com/xuxueli0323/xxl-job</a></td>
<td align="left"><a target="_blank" rel="noopener" href="http://gitee.com/xuxueli0323/xxl-job/releases">Download</a></td>
</tr>
</tbody></table>
<p>也可以使用资料文件夹中的源码</p>
<h4 id="2-3-3-初始化“调度数据库”"><a href="#2-3-3-初始化“调度数据库”" class="headerlink" title="2.3.3 初始化“调度数据库”"></a>2.3.3 初始化“调度数据库”</h4><p>请下载项目源码并解压，获取 “调度数据库初始化SQL脚本” 并执行即可。</p>
<p>位置：<code>/xxl-job/doc/db/tables_xxl_job.sql</code>  共8张表</p>
<p><img src="/../images/image-20210730001433997.png" srcset="/img/loading.gif" lazyload alt="image-20210730001433997"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">- xxl_job_lock：任务调度锁表；<br>- xxl_job_group：执行器信息表，维护任务执行器信息；<br>- xxl_job_info：调度扩展信息表： 用于保存XXL-JOB调度任务的扩展信息，如任务分组、任务名、机器地址、执行器、执行入参和报警邮件等等；<br>- xxl_job_log：调度日志表： 用于保存XXL-JOB任务调度的历史信息，如调度结果、执行结果、调度入参、调度机器和执行器等等；<br>- xxl_job_logglue：任务GLUE日志：用于保存GLUE更新历史，用于支持GLUE的版本回溯功能；<br>- xxl_job_registry：执行器注册表，维护在线的执行器和调度中心机器地址信息；<br>- xxl_job_user：系统用户表；<br></code></pre></td></tr></table></figure>

<p>调度中心支持集群部署，集群情况下各节点务必连接同一个mysql实例;</p>
<p>如果mysql做主从,调度中心集群节点务必强制走主库;</p>
<h4 id="2-3-4-编译源码"><a href="#2-3-4-编译源码" class="headerlink" title="2.3.4 编译源码"></a>2.3.4 编译源码</h4><p>解压源码,按照maven格式将源码导入IDE, 使用maven进行编译即可，源码结构如下：</p>
<p><img src="/../images/image-20210729230502703.png" srcset="/img/loading.gif" lazyload alt="image-20210729230502703"></p>
<h4 id="2-3-5-配置部署“调度中心”"><a href="#2-3-5-配置部署“调度中心”" class="headerlink" title="2.3.5 配置部署“调度中心”"></a>2.3.5 配置部署“调度中心”</h4><p>调度中心项目：xxl-job-admin</p>
<p>作用：统一管理任务调度平台上调度任务，负责触发调度执行，并且提供任务管理平台。</p>
<p>步骤一：调度中心配置</p>
<p>调度中心配置文件地址：<code>/xxl-job/xxl-job-admin/src/main/resources/application.properties</code></p>
<p>数据库的连接信息修改为自己的数据库</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment">### web</span><br><span class="hljs-attr">server.port</span>=<span class="hljs-string">8888</span><br><span class="hljs-attr">server.servlet.context-path</span>=<span class="hljs-string">/xxl-job-admin</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">### actuator</span><br><span class="hljs-attr">management.server.servlet.context-path</span>=<span class="hljs-string">/actuator</span><br><span class="hljs-attr">management.health.mail.enabled</span>=<span class="hljs-string">false</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">### resources</span><br><span class="hljs-attr">spring.mvc.servlet.load-on-startup</span>=<span class="hljs-string">0</span><br><span class="hljs-attr">spring.mvc.static-path-pattern</span>=<span class="hljs-string">/static/**</span><br><span class="hljs-attr">spring.resources.static-locations</span>=<span class="hljs-string">classpath:/static/</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">### freemarker</span><br><span class="hljs-attr">spring.freemarker.templateLoaderPath</span>=<span class="hljs-string">classpath:/templates/</span><br><span class="hljs-attr">spring.freemarker.suffix</span>=<span class="hljs-string">.ftl</span><br><span class="hljs-attr">spring.freemarker.charset</span>=<span class="hljs-string">UTF-8</span><br><span class="hljs-attr">spring.freemarker.request-context-attribute</span>=<span class="hljs-string">request</span><br><span class="hljs-attr">spring.freemarker.settings.number_format</span>=<span class="hljs-string">0.##########</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">### mybatis</span><br><span class="hljs-attr">mybatis.mapper-locations</span>=<span class="hljs-string">classpath:/mybatis-mapper/*Mapper.xml</span><br><span class="hljs-comment">#mybatis.type-aliases-package=com.xxl.job.admin.core.model</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">### xxl-job, datasource</span><br><span class="hljs-attr">spring.datasource.url</span>=<span class="hljs-string">jdbc:mysql://127.0.0.1:3306/xxl_job?Unicode=true&amp;serverTimezone=Asia/Shanghai&amp;characterEncoding=UTF-8</span><br><span class="hljs-attr">spring.datasource.username</span>=<span class="hljs-string">root</span><br><span class="hljs-attr">spring.datasource.password</span>=<span class="hljs-string">root</span><br><span class="hljs-attr">spring.datasource.driver-class-name</span>=<span class="hljs-string">com.mysql.cj.jdbc.Driver</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">### datasource-pool</span><br><span class="hljs-attr">spring.datasource.type</span>=<span class="hljs-string">com.zaxxer.hikari.HikariDataSource</span><br><span class="hljs-attr">spring.datasource.hikari.minimum-idle</span>=<span class="hljs-string">10</span><br><span class="hljs-attr">spring.datasource.hikari.maximum-pool-size</span>=<span class="hljs-string">30</span><br><span class="hljs-attr">spring.datasource.hikari.auto-commit</span>=<span class="hljs-string">true</span><br><span class="hljs-attr">spring.datasource.hikari.idle-timeout</span>=<span class="hljs-string">30000</span><br><span class="hljs-attr">spring.datasource.hikari.pool-name</span>=<span class="hljs-string">HikariCP</span><br><span class="hljs-attr">spring.datasource.hikari.max-lifetime</span>=<span class="hljs-string">900000</span><br><span class="hljs-attr">spring.datasource.hikari.connection-timeout</span>=<span class="hljs-string">10000</span><br><span class="hljs-attr">spring.datasource.hikari.connection-test-query</span>=<span class="hljs-string">SELECT 1</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">### xxl-job, email</span><br><span class="hljs-attr">spring.mail.host</span>=<span class="hljs-string">smtp.qq.com</span><br><span class="hljs-attr">spring.mail.port</span>=<span class="hljs-string">25</span><br><span class="hljs-attr">spring.mail.username</span>=<span class="hljs-string">xxx@qq.com</span><br><span class="hljs-attr">spring.mail.password</span>=<span class="hljs-string">xxx</span><br><span class="hljs-attr">spring.mail.properties.mail.smtp.auth</span>=<span class="hljs-string">true</span><br><span class="hljs-attr">spring.mail.properties.mail.smtp.starttls.enable</span>=<span class="hljs-string">true</span><br><span class="hljs-attr">spring.mail.properties.mail.smtp.starttls.required</span>=<span class="hljs-string">true</span><br><span class="hljs-attr">spring.mail.properties.mail.smtp.socketFactory.class</span>=<span class="hljs-string">javax.net.ssl.SSLSocketFactory</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">### xxl-job, access token</span><br><span class="hljs-attr">xxl.job.accessToken</span>=<span class="hljs-string"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">### xxl-job, i18n (default is zh_CN, and you can choose &quot;zh_CN&quot;, &quot;zh_TC&quot; and &quot;en&quot;)</span><br><span class="hljs-attr">xxl.job.i18n</span>=<span class="hljs-string">zh_CN</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">## xxl-job, triggerpool max size</span><br><span class="hljs-attr">xxl.job.triggerpool.fast.max</span>=<span class="hljs-string">200</span><br><span class="hljs-attr">xxl.job.triggerpool.slow.max</span>=<span class="hljs-string">100</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">### xxl-job, log retention days</span><br><span class="hljs-attr">xxl.job.logretentiondays</span>=<span class="hljs-string">30</span><br></code></pre></td></tr></table></figure>

<p>启动调度中心，默认登录账号 “admin/123456”, 登录后运行界面如下图所示。</p>
<p><img src="/../images/image-20210729230630495.png" srcset="/img/loading.gif" lazyload alt="image-20210729230630495"></p>
<h3 id="2-4-配置部署调度中心-docker安装"><a href="#2-4-配置部署调度中心-docker安装" class="headerlink" title="2.4 配置部署调度中心-docker安装"></a>2.4 配置部署调度中心-docker安装</h3><p>1.创建mysql容器，初始化xxl-job的SQL脚本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker run -p 3306:3306 --name mysql57 \<br>-v /opt/mysql/conf:/etc/mysql \<br>-v /opt/mysql/logs:/var/log/mysql \<br>-v /opt/mysql/data:/var/lib/mysql \<br>-e MYSQL_ROOT_PASSWORD=root \<br>-d mysql:5.7<br></code></pre></td></tr></table></figure>

<p>2.拉取镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker pull xuxueli/xxl-job-admin:2.3.0<br></code></pre></td></tr></table></figure>

<p>3.创建容器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker run -e PARAMS=&quot;--spring.datasource.url=jdbc:mysql://192.168.200.130:3306/xxl_job?Unicode=true&amp;characterEncoding=UTF-8 \<br>--spring.datasource.username=root \<br>--spring.datasource.password=root&quot; \<br>-p 8888:8080 -v /tmp:/data/applogs \<br>--name xxl-job-admin --restart=always  -d xuxueli/xxl-job-admin:2.3.0<br></code></pre></td></tr></table></figure>

<h3 id="2-5-xxl-job入门案例编写"><a href="#2-5-xxl-job入门案例编写" class="headerlink" title="2.5 xxl-job入门案例编写"></a>2.5 xxl-job入门案例编写</h3><h4 id="2-5-1-登录调度中心，点击下图所示“新建任务”按钮，新建示例任务"><a href="#2-5-1-登录调度中心，点击下图所示“新建任务”按钮，新建示例任务" class="headerlink" title="2.5.1 登录调度中心，点击下图所示“新建任务”按钮，新建示例任务"></a>2.5.1 登录调度中心，点击下图所示“新建任务”按钮，新建示例任务</h4><p><img src="/../images/image-20210729232146585.png" srcset="/img/loading.gif" lazyload alt="image-20210729232146585"></p>
<h4 id="2-5-2-创建xxljob-demo项目，导入依赖"><a href="#2-5-2-创建xxljob-demo项目，导入依赖" class="headerlink" title="2.5.2 创建xxljob-demo项目，导入依赖"></a>2.5.2 创建xxljob-demo项目，导入依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!--xxl-job--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.xuxueli<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>xxl-job-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.3.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h4 id="2-5-3-application-yml配置"><a href="#2-5-3-application-yml配置" class="headerlink" title="2.5.3 application.yml配置"></a>2.5.3 application.yml配置</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8881</span><br><br><br><span class="hljs-attr">xxl:</span><br>  <span class="hljs-attr">job:</span><br>    <span class="hljs-attr">admin:</span><br>      <span class="hljs-attr">addresses:</span> <span class="hljs-string">http://192.168.200.130:8888/xxl-job-admin</span><br>    <span class="hljs-attr">executor:</span><br>      <span class="hljs-attr">appname:</span> <span class="hljs-string">xxl-job-executor-sample</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">9999</span><br><br></code></pre></td></tr></table></figure>

<h4 id="2-5-4-新建配置类"><a href="#2-5-4-新建配置类" class="headerlink" title="2.5.4 新建配置类"></a>2.5.4 新建配置类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.xxljob.config;<br><br><span class="hljs-keyword">import</span> com.xxl.job.core.executor.impl.XxlJobSpringExecutor;<br><span class="hljs-keyword">import</span> org.slf4j.Logger;<br><span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * xxl-job config</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> xuxueli 2017-04-28</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">XxlJobConfig</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(XxlJobConfig.class);<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;xxl.job.admin.addresses&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String adminAddresses;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;xxl.job.executor.appname&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String appname;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;xxl.job.executor.port&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> port;<br><br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> XxlJobSpringExecutor <span class="hljs-title function_">xxlJobExecutor</span><span class="hljs-params">()</span> &#123;<br>        logger.info(<span class="hljs-string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job config init.&quot;</span>);<br>        <span class="hljs-type">XxlJobSpringExecutor</span> <span class="hljs-variable">xxlJobSpringExecutor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XxlJobSpringExecutor</span>();<br>        xxlJobSpringExecutor.setAdminAddresses(adminAddresses);<br>        xxlJobSpringExecutor.setAppname(appname);<br>        xxlJobSpringExecutor.setPort(port);<br>        <span class="hljs-keyword">return</span> xxlJobSpringExecutor;<br>    &#125;<br><br><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="2-5-4-任务代码，重要注解-XxlJob-“JobHandler”"><a href="#2-5-4-任务代码，重要注解-XxlJob-“JobHandler”" class="headerlink" title="2.5.4 任务代码，重要注解:@XxlJob(“JobHandler”)"></a>2.5.4 任务代码，重要注解:@XxlJob(“<strong>JobHandler</strong>”)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.xxljob.job;<br><br><span class="hljs-keyword">import</span> com.xxl.job.core.handler.annotation.XxlJob;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloJob</span> &#123;<br><br><br>    <span class="hljs-meta">@XxlJob(&quot;demoJobHandler&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">helloJob</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;简单任务执行了。。。。&quot;</span>);<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="2-5-5-测试-单节点"><a href="#2-5-5-测试-单节点" class="headerlink" title="2.5.5 测试-单节点"></a>2.5.5 测试-单节点</h4><ul>
<li><p>启动微服务</p>
</li>
<li><p>在xxl-job的调度中心中启动任务</p>
</li>
</ul>
<h3 id="2-6-任务详解-执行器"><a href="#2-6-任务详解-执行器" class="headerlink" title="2.6 任务详解-执行器"></a>2.6 任务详解-执行器</h3><ul>
<li><p>执行器：任务的绑定的执行器，任务触发调度时将会自动发现注册成功的执行器, 实现任务自动发现功能; </p>
</li>
<li><p>另一方面也可以方便的进行任务分组。每个任务必须绑定一个执行器</p>
</li>
</ul>
<p><img src="/../images/image-20210729232926534.png" srcset="/img/loading.gif" lazyload alt="image-20210729232926534"></p>
<p><img src="/../images/image-20210729232825564.png" srcset="/img/loading.gif" lazyload alt="image-20210729232825564"></p>
<p> 以下是执行器的属性说明：</p>
<table>
<thead>
<tr>
<th>属性名称</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>AppName</td>
<td>是每个执行器集群的唯一标示AppName, 执行器会周期性以AppName为对象进行自动注册。可通过该配置自动发现注册成功的执行器, 供任务调度时使用;</td>
</tr>
<tr>
<td>名称</td>
<td>执行器的名称, 因为AppName限制字母数字等组成,可读性不强, 名称为了提高执行器的可读性;</td>
</tr>
<tr>
<td>排序</td>
<td>执行器的排序, 系统中需要执行器的地方,如任务新增, 将会按照该排序读取可用的执行器列表;</td>
</tr>
<tr>
<td>注册方式</td>
<td>调度中心获取执行器地址的方式；</td>
</tr>
<tr>
<td>机器地址</td>
<td>注册方式为”手动录入”时有效，支持人工维护执行器的地址信息；</td>
</tr>
</tbody></table>
<p>自动注册和手动注册的区别和配置</p>
<p><img src="/../images/image-20210729233016355.png" srcset="/img/loading.gif" lazyload alt="image-20210729233016355"></p>
<h3 id="2-7-任务详解-基础配置"><a href="#2-7-任务详解-基础配置" class="headerlink" title="2.7 任务详解-基础配置"></a>2.7 任务详解-基础配置</h3><p><img src="/../images/image-20210729233926457.png" srcset="/img/loading.gif" lazyload alt="image-20210729233926457"></p>
<p><strong>基础配置</strong></p>
<ul>
<li><p>执行器：每个任务必须绑定一个执行器, 方便给任务进行分组</p>
</li>
<li><p>任务描述：任务的描述信息，便于任务管理；</p>
</li>
<li><p>负责人：任务的负责人；</p>
</li>
<li><p>报警邮件：任务调度失败时邮件通知的邮箱地址，支持配置多邮箱地址，配置多个邮箱地址时用逗号分隔</p>
</li>
</ul>
<p><img src="/../images/image-20210729234009010.png" srcset="/img/loading.gif" lazyload alt="image-20210729234009010"></p>
<p><strong>调度配置</strong></p>
<ul>
<li>调度类型：<ul>
<li>无：该类型不会主动触发调度；</li>
<li>CRON：该类型将会通过CRON，触发任务调度；</li>
<li>固定速度：该类型将会以固定速度，触发任务调度；按照固定的间隔时间，周期性触发；</li>
</ul>
</li>
</ul>
<p><img src="/../images/image-20210729234114283.png" srcset="/img/loading.gif" lazyload alt="image-20210729234114283"></p>
<p><strong>任务配置</strong></p>
<ul>
<li>运行模式：</li>
</ul>
<p>​    BEAN模式：任务以JobHandler方式维护在执行器端；需要结合 “JobHandler” 属性匹配执行器中任务；</p>
<ul>
<li><p>JobHandler：运行模式为 “BEAN模式” 时生效，对应执行器中新开发的JobHandler类“@JobHandler”注解自定义的value值；</p>
</li>
<li><p>执行参数：任务执行所需的参数；</p>
</li>
</ul>
<p><img src="/../images/image-20210729234219162.png" srcset="/img/loading.gif" lazyload alt="image-20210729234219162"></p>
<p><strong>阻塞处理策略</strong></p>
<p>阻塞处理策略：调度过于密集执行器来不及处理时的处理策略；</p>
<ul>
<li><p>单机串行（默认）：调度请求进入单机执行器后，调度请求进入FIFO(First Input First Output)队列并以串行方式运行；</p>
</li>
<li><p>丢弃后续调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，本次请求将会被丢弃并标记为失败；</p>
</li>
<li><p>覆盖之前调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，将会终止运行中的调度任务并清空队列，然后运行本地调度任务；</p>
</li>
</ul>
<p><img src="/../images/image-20210729234256062.png" srcset="/img/loading.gif" lazyload alt="image-20210729234256062"></p>
<p><strong>路由策略</strong></p>
<p>当执行器集群部署时，提供丰富的路由策略，包括；</p>
<ul>
<li><p>FIRST（第一个）：固定选择第一个机器；</p>
</li>
<li><p>LAST（最后一个）：固定选择最后一个机器；</p>
</li>
<li><p><strong>ROUND（轮询）</strong></p>
</li>
<li><p>RANDOM（随机）：随机选择在线的机器；</p>
</li>
<li><p>CONSISTENT_HASH（一致性HASH）：每个任务按照Hash算法固定选择某一台机器，且所有任务均匀散列在不同机器上。</p>
</li>
<li><p>LEAST_FREQUENTLY_USED（最不经常使用）：使用频率最低的机器优先被选举；</p>
</li>
<li><p>LEAST_RECENTLY_USED（最近最久未使用）：最久未使用的机器优先被选举；</p>
</li>
<li><p>FAILOVER（故障转移）：按照顺序依次进行心跳检测，第一个心跳检测成功的机器选定为目标执行器并发起调度；</p>
</li>
<li><p>BUSYOVER（忙碌转移）：按照顺序依次进行空闲检测，第一个空闲检测成功的机器选定为目标执行器并发起调度；</p>
</li>
<li><p><strong>SHARDING_BROADCAST(分片广播)：广播触发对应集群中所有机器执行一次任务，同时系统自动传递分片参数；可根据分片参数开发分片任务；</strong></p>
</li>
</ul>
<p><img src="/../images/image-20210729234409132.png" srcset="/img/loading.gif" lazyload alt="image-20210729234409132"></p>
<h3 id="2-8-路由策略-轮询-案例"><a href="#2-8-路由策略-轮询-案例" class="headerlink" title="2.8 路由策略(轮询)-案例"></a>2.8 路由策略(轮询)-案例</h3><p>1.修改任务为轮询</p>
<p><img src="/../images/image-20210729234513775.png" srcset="/img/loading.gif" lazyload alt="image-20210729234513775"></p>
<p>2.启动多个微服务</p>
<p><img src="/../images/image-20210729234536483.png" srcset="/img/loading.gif" lazyload alt="image-20210729234536483"></p>
<p>修改yml配置文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-string">$&#123;port:8881&#125;</span><br><br><br><span class="hljs-attr">xxl:</span><br>  <span class="hljs-attr">job:</span><br>    <span class="hljs-attr">admin:</span><br>      <span class="hljs-attr">addresses:</span> <span class="hljs-string">http://192.168.200.130:8888/xxl-job-admin</span><br>    <span class="hljs-attr">executor:</span><br>      <span class="hljs-attr">appname:</span> <span class="hljs-string">xxl-job-executor-sample</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-string">$&#123;executor.port:9999&#125;</span><br></code></pre></td></tr></table></figure>

<p>3.启动多个微服务</p>
<p>每个微服务轮询的去执行任务</p>
<h3 id="2-9-路由策略-分片广播"><a href="#2-9-路由策略-分片广播" class="headerlink" title="2.9 路由策略(分片广播)"></a>2.9 路由策略(分片广播)</h3><h4 id="2-9-1-分片逻辑"><a href="#2-9-1-分片逻辑" class="headerlink" title="2.9.1 分片逻辑"></a>2.9.1 分片逻辑</h4><p>执行器集群部署时，任务路由策略选择”分片广播”情况下，一次任务调度将会广播触发对应集群中所有执行器执行一次任务</p>
<p><img src="/../images/image-20210729234756221.png" srcset="/img/loading.gif" lazyload alt="image-20210729234756221"></p>
<p>执行器集群部署时，任务路由策略选择”分片广播”情况下，一次任务调度将会广播触发对应集群中所有执行器执行一次任务</p>
<p><img src="/../images/image-20210729234822935.png" srcset="/img/loading.gif" lazyload alt="image-20210729234822935"></p>
<h4 id="2-9-2-路由策略-分片广播-案例"><a href="#2-9-2-路由策略-分片广播-案例" class="headerlink" title="2.9.2 路由策略(分片广播)-案例"></a>2.9.2 路由策略(分片广播)-案例</h4><p>需求：让两个节点同时执行10000个任务，每个节点分别执行5000个任务</p>
<p>①：创建分片执行器</p>
<p><img src="/../images/image-20210729234930218.png" srcset="/img/loading.gif" lazyload alt="image-20210729234930218"></p>
<p>②：创建任务，路由策略为分片广播</p>
<p><img src="/../images/image-20210729234948571.png" srcset="/img/loading.gif" lazyload alt="image-20210729234948571"></p>
<p>③：分片广播代码</p>
<p>   分片参数</p>
<p>​     index：当前分片序号(从0开始)，执行器集群列表中当前执行器的序号；</p>
<p>​     total：总分片数，执行器集群的总机器数量；</p>
<p>修改yml配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-string">$&#123;port:8881&#125;</span><br><br><br><span class="hljs-attr">xxl:</span><br>  <span class="hljs-attr">job:</span><br>    <span class="hljs-attr">admin:</span><br>      <span class="hljs-attr">addresses:</span> <span class="hljs-string">http://192.168.200.130:8888/xxl-job-admin</span><br>    <span class="hljs-attr">executor:</span><br>      <span class="hljs-attr">appname:</span> <span class="hljs-string">xxl-job-sharding-executor</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-string">$&#123;executor.port:9999&#125;</span><br></code></pre></td></tr></table></figure>

<p>代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.xxljob.job;<br><br><span class="hljs-keyword">import</span> com.xxl.job.core.context.XxlJobHelper;<br><span class="hljs-keyword">import</span> com.xxl.job.core.handler.annotation.XxlJob;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloJob</span> &#123;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String port;<br><br><br>    <span class="hljs-meta">@XxlJob(&quot;demoJobHandler&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">helloJob</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;简单任务执行了。。。。&quot;</span>+port);<br><br>    &#125;<br><br>    <span class="hljs-meta">@XxlJob(&quot;shardingJobHandler&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">shardingJobHandler</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-comment">//分片的参数</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">shardIndex</span> <span class="hljs-operator">=</span> XxlJobHelper.getShardIndex();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">shardTotal</span> <span class="hljs-operator">=</span> XxlJobHelper.getShardTotal();<br><br>        <span class="hljs-comment">//业务逻辑</span><br>        List&lt;Integer&gt; list = getList();<br>        <span class="hljs-keyword">for</span> (Integer integer : list) &#123;<br>            <span class="hljs-keyword">if</span>(integer % shardTotal == shardIndex)&#123;<br>                System.out.println(<span class="hljs-string">&quot;当前第&quot;</span>+shardIndex+<span class="hljs-string">&quot;分片执行了，任务项为：&quot;</span>+integer);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> List&lt;Integer&gt; <span class="hljs-title function_">getList</span><span class="hljs-params">()</span>&#123;<br>        List&lt;Integer&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000</span>; i++) &#123;<br>            list.add(i);<br>        &#125;<br>        <span class="hljs-keyword">return</span> list;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>④：测试</p>
<p>启动多个微服务测试，一次执行可以执行多个任务</p>
<h2 id="3-热点文章-定时计算"><a href="#3-热点文章-定时计算" class="headerlink" title="3.热点文章-定时计算"></a>3.热点文章-定时计算</h2><h3 id="3-1-需求分析-1"><a href="#3-1-需求分析-1" class="headerlink" title="3.1 需求分析"></a>3.1 需求分析</h3><p>需求：为每个频道缓存热度较高的30条文章优先展示</p>
<p><img src="/../images/image-20210729235644605.png" srcset="/img/loading.gif" lazyload alt="image-20210729235644605"></p>
<p>判断文章热度较高的标准是什么？</p>
<p>文章：阅读，点赞，评论，收藏</p>
<h3 id="3-2-实现思路"><a href="#3-2-实现思路" class="headerlink" title="3.2 实现思路"></a>3.2 实现思路</h3><p><img src="/../images/image-20210729235731309.png" srcset="/img/loading.gif" lazyload alt="image-20210729235731309"></p>
<h3 id="3-3-实现步骤"><a href="#3-3-实现步骤" class="headerlink" title="3.3 实现步骤"></a>3.3 实现步骤</h3><p>分值计算不涉及到前端工程，也无需提供api接口，是一个纯后台的功能的开发。</p>
<h4 id="3-3-1-频道列表远程接口准备"><a href="#3-3-1-频道列表远程接口准备" class="headerlink" title="3.3.1 频道列表远程接口准备"></a>3.3.1 频道列表远程接口准备</h4><p>计算完成新热数据后，需要给每个频道缓存一份数据，所以需要查询所有频道信息</p>
<p>① 在heima-leadnews-feign-api定义远程接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.apis.wemedia;<br><br><span class="hljs-keyword">import</span> com.heima.model.common.dtos.ResponseResult;<br><span class="hljs-keyword">import</span> org.springframework.cloud.openfeign.FeignClient;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><br><span class="hljs-meta">@FeignClient(&quot;leadnews-wemedia&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IWemediaClient</span> &#123;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/api/v1/channel/list&quot;)</span><br>    <span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">getChannels</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>② heima-leadnews-wemedia端提供接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.wemedia.feign;<br><br><span class="hljs-keyword">import</span> com.heima.apis.wemedia.IWemediaClient;<br><span class="hljs-keyword">import</span> com.heima.model.common.dtos.ResponseResult;<br><span class="hljs-keyword">import</span> com.heima.wemedia.service.WmChannelService;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WemediaClient</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IWemediaClient</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> WmChannelService wmChannelService;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/api/v1/channel/list&quot;)</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">getChannels</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> wmChannelService.findAll();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在ApArticleMapper.xml新增方法</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;findArticleListByLast5days&quot;</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">&quot;resultMap&quot;</span>&gt;</span><br>    SELECT<br>    aa.*<br>    FROM<br>    `ap_article` aa<br>    LEFT JOIN ap_article_config aac ON aa.id = aac.article_id<br>    <span class="hljs-tag">&lt;<span class="hljs-name">where</span>&gt;</span><br>        and aac.is_delete != 1<br>        and aac.is_down != 1<br>        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;dayParam != null&quot;</span>&gt;</span><br>            and aa.publish_time &lt;![CDATA[&gt;=]]&gt; #&#123;dayParam&#125;<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">where</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>修改ApArticleMapper类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.article.mapper;<br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.mapper.BaseMapper;<br><span class="hljs-keyword">import</span> com.heima.model.article.dtos.ArticleHomeDto;<br><span class="hljs-keyword">import</span> com.heima.model.article.pojos.ApArticle;<br><span class="hljs-keyword">import</span> org.apache.ibatis.annotations.Mapper;<br><span class="hljs-keyword">import</span> org.apache.ibatis.annotations.Param;<br><br><span class="hljs-keyword">import</span> java.util.Date;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-meta">@Mapper</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ApArticleMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseMapper</span>&lt;ApArticle&gt; &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 加载文章列表</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> dto</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> type  1  加载更多   2记载最新</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> List&lt;ApArticle&gt; <span class="hljs-title function_">loadArticleList</span><span class="hljs-params">(ArticleHomeDto dto,Short type)</span>;<br><br>    <span class="hljs-keyword">public</span> List&lt;ApArticle&gt; <span class="hljs-title function_">findArticleListByLast5days</span><span class="hljs-params">(<span class="hljs-meta">@Param(&quot;dayParam&quot;)</span> Date dayParam)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="3-3-2-热文章业务层"><a href="#3-3-2-热文章业务层" class="headerlink" title="3.3.2 热文章业务层"></a>3.3.2 热文章业务层</h4><p>定义业务层接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.article.service;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">HotArticleService</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 计算热点文章</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">computeHotArticle</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>修改ArticleConstans</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.common.constants;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArticleConstants</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Short</span> <span class="hljs-variable">LOADTYPE_LOAD_MORE</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Short</span> <span class="hljs-variable">LOADTYPE_LOAD_NEW</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_TAG</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;__all__&quot;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ARTICLE_ES_SYNC_TOPIC</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;article.es.sync.topic&quot;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Integer</span> <span class="hljs-variable">HOT_ARTICLE_LIKE_WEIGHT</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Integer</span> <span class="hljs-variable">HOT_ARTICLE_COMMENT_WEIGHT</span> <span class="hljs-operator">=</span> <span class="hljs-number">5</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Integer</span> <span class="hljs-variable">HOT_ARTICLE_COLLECTION_WEIGHT</span> <span class="hljs-operator">=</span> <span class="hljs-number">8</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">HOT_ARTICLE_FIRST_PAGE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;hot_article_first_page_&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>创建一个vo接收计算分值后的对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.model.article.vos;<br><br><span class="hljs-keyword">import</span> com.heima.model.article.pojos.ApArticle;<br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HotArticleVo</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ApArticle</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 文章分值</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Integer score;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>业务层实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.article.service.impl;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.heima.apis.wemedia.IWemediaClient;<br><span class="hljs-keyword">import</span> com.heima.article.mapper.ApArticleMapper;<br><span class="hljs-keyword">import</span> com.heima.article.service.HotArticleService;<br><span class="hljs-keyword">import</span> com.heima.common.constants.ArticleConstants;<br><span class="hljs-keyword">import</span> com.heima.common.redis.CacheService;<br><span class="hljs-keyword">import</span> com.heima.model.article.pojos.ApArticle;<br><span class="hljs-keyword">import</span> com.heima.model.article.vos.HotArticleVo;<br><span class="hljs-keyword">import</span> com.heima.model.common.dtos.ResponseResult;<br><span class="hljs-keyword">import</span> com.heima.model.wemedia.pojos.WmChannel;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.joda.time.DateTime;<br><span class="hljs-keyword">import</span> org.springframework.beans.BeanUtils;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><span class="hljs-keyword">import</span> org.springframework.transaction.annotation.Transactional;<br><br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.Comparator;<br><span class="hljs-keyword">import</span> java.util.Date;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.stream.Collectors;<br><br><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Transactional</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HotArticleServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HotArticleService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ApArticleMapper apArticleMapper;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 计算热点文章</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">computeHotArticle</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">//1.查询前5天的文章数据</span><br>        <span class="hljs-type">Date</span> <span class="hljs-variable">dateParam</span> <span class="hljs-operator">=</span> DateTime.now().minusDays(<span class="hljs-number">50</span>).toDate();<br>        List&lt;ApArticle&gt; apArticleList = apArticleMapper.findArticleListByLast5days(dateParam);<br><br>        <span class="hljs-comment">//2.计算文章的分值</span><br>        List&lt;HotArticleVo&gt; hotArticleVoList = computeHotArticle(apArticleList);<br><br>        <span class="hljs-comment">//3.为每个频道缓存30条分值较高的文章</span><br>        cacheTagToRedis(hotArticleVoList);<br><br>    &#125;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> IWemediaClient wemediaClient;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> CacheService cacheService;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 为每个频道缓存30条分值较高的文章</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> hotArticleVoList</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cacheTagToRedis</span><span class="hljs-params">(List&lt;HotArticleVo&gt; hotArticleVoList)</span> &#123;<br>        <span class="hljs-comment">//每个频道缓存30条分值较高的文章</span><br>        <span class="hljs-type">ResponseResult</span> <span class="hljs-variable">responseResult</span> <span class="hljs-operator">=</span> wemediaClient.getChannels();<br>        <span class="hljs-keyword">if</span>(responseResult.getCode().equals(<span class="hljs-number">200</span>))&#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">channelJson</span> <span class="hljs-operator">=</span> JSON.toJSONString(responseResult.getData());<br>            List&lt;WmChannel&gt; wmChannels = JSON.parseArray(channelJson, WmChannel.class);<br>            <span class="hljs-comment">//检索出每个频道的文章</span><br>            <span class="hljs-keyword">if</span>(wmChannels != <span class="hljs-literal">null</span> &amp;&amp; wmChannels.size() &gt; <span class="hljs-number">0</span>)&#123;<br>                <span class="hljs-keyword">for</span> (WmChannel wmChannel : wmChannels) &#123;<br>                    List&lt;HotArticleVo&gt; hotArticleVos = hotArticleVoList.stream().filter(x -&gt; x.getChannelId().equals(wmChannel.getId())).collect(Collectors.toList());<br>                    <span class="hljs-comment">//给文章进行排序，取30条分值较高的文章存入redis  key：频道id   value：30条分值较高的文章</span><br>                    sortAndCache(hotArticleVos, ArticleConstants.HOT_ARTICLE_FIRST_PAGE + wmChannel.getId());<br>                &#125;<br>            &#125;<br>        &#125;<br><br><br>        <span class="hljs-comment">//设置推荐数据</span><br>        <span class="hljs-comment">//给文章进行排序，取30条分值较高的文章存入redis  key：频道id   value：30条分值较高的文章</span><br>        sortAndCache(hotArticleVoList, ArticleConstants.HOT_ARTICLE_FIRST_PAGE+ArticleConstants.DEFAULT_TAG);<br><br><br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 排序并且缓存数据</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> hotArticleVos</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> key</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sortAndCache</span><span class="hljs-params">(List&lt;HotArticleVo&gt; hotArticleVos, String key)</span> &#123;<br>        hotArticleVos = hotArticleVos.stream().sorted(Comparator.comparing(HotArticleVo::getScore).reversed()).collect(Collectors.toList());<br>        <span class="hljs-keyword">if</span> (hotArticleVos.size() &gt; <span class="hljs-number">30</span>) &#123;<br>            hotArticleVos = hotArticleVos.subList(<span class="hljs-number">0</span>, <span class="hljs-number">30</span>);<br>        &#125;<br>        cacheService.set(key, JSON.toJSONString(hotArticleVos));<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 计算文章分值</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> apArticleList</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> List&lt;HotArticleVo&gt; <span class="hljs-title function_">computeHotArticle</span><span class="hljs-params">(List&lt;ApArticle&gt; apArticleList)</span> &#123;<br><br>        List&lt;HotArticleVo&gt; hotArticleVoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><br>        <span class="hljs-keyword">if</span>(apArticleList != <span class="hljs-literal">null</span> &amp;&amp; apArticleList.size() &gt; <span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-keyword">for</span> (ApArticle apArticle : apArticleList) &#123;<br>                <span class="hljs-type">HotArticleVo</span> <span class="hljs-variable">hot</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HotArticleVo</span>();<br>                BeanUtils.copyProperties(apArticle,hot);<br>                <span class="hljs-type">Integer</span> <span class="hljs-variable">score</span> <span class="hljs-operator">=</span> computeScore(apArticle);<br>                hot.setScore(score);<br>                hotArticleVoList.add(hot);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> hotArticleVoList;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 计算文章的具体分值</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> apArticle</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Integer <span class="hljs-title function_">computeScore</span><span class="hljs-params">(ApArticle apArticle)</span> &#123;<br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">scere</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span>(apArticle.getLikes() != <span class="hljs-literal">null</span>)&#123;<br>            scere += apArticle.getLikes() * ArticleConstants.HOT_ARTICLE_LIKE_WEIGHT;<br>        &#125;<br>        <span class="hljs-keyword">if</span>(apArticle.getViews() != <span class="hljs-literal">null</span>)&#123;<br>            scere += apArticle.getViews();<br>        &#125;<br>        <span class="hljs-keyword">if</span>(apArticle.getComment() != <span class="hljs-literal">null</span>)&#123;<br>            scere += apArticle.getComment() * ArticleConstants.HOT_ARTICLE_COMMENT_WEIGHT;<br>        &#125;<br>        <span class="hljs-keyword">if</span>(apArticle.getCollection() != <span class="hljs-literal">null</span>)&#123;<br>            scere += apArticle.getCollection() * ArticleConstants.HOT_ARTICLE_COLLECTION_WEIGHT;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> scere;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在ArticleApplication的引导类中添加以下注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@EnableFeignClients(basePackages = &quot;com.heima.apis&quot;)</span><br></code></pre></td></tr></table></figure>

<p>现在数据库中准备点数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.article.service.impl;<br><br><span class="hljs-keyword">import</span> com.heima.article.ArticleApplication;<br><span class="hljs-keyword">import</span> com.heima.article.service.HotArticleService;<br><span class="hljs-keyword">import</span> org.junit.Test;<br><span class="hljs-keyword">import</span> org.junit.runner.RunWith;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;<br><span class="hljs-keyword">import</span> org.springframework.test.context.junit4.SpringRunner;<br><br><span class="hljs-meta">@SpringBootTest(classes = ArticleApplication.class)</span><br><span class="hljs-meta">@RunWith(SpringRunner.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HotArticleServiceImplTest</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> HotArticleService hotArticleService;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">computeHotArticle</span><span class="hljs-params">()</span> &#123;<br>        hotArticleService.computeHotArticle();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="3-3-3-xxl-job定时计算-步骤"><a href="#3-3-3-xxl-job定时计算-步骤" class="headerlink" title="3.3.3 xxl-job定时计算-步骤"></a>3.3.3 xxl-job定时计算-步骤</h4><p>①：在heima-leadnews-article中的pom文件中新增依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--xxl-job--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.xuxueli<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>xxl-job-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.3.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>② 在xxl-job-admin中新建执行器和任务</p>
<p>新建执行器：leadnews-hot-article-executor</p>
<p><img src="/../images/image-20210730000549587.png" srcset="/img/loading.gif" lazyload alt="image-20210730000549587"></p>
<p>新建任务：路由策略为轮询，Cron表达式：0 0 2 * * ? </p>
<p><img src="/../images/image-20210730000626824.png" srcset="/img/loading.gif" lazyload alt="image-20210730000626824"></p>
<p>③ leadnews-article中集成xxl-job</p>
<p>XxlJobConfig</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.article.config;<br><br><span class="hljs-keyword">import</span> com.xxl.job.core.executor.impl.XxlJobSpringExecutor;<br><span class="hljs-keyword">import</span> org.slf4j.Logger;<br><span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * xxl-job config</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> xuxueli 2017-04-28</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">XxlJobConfig</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(XxlJobConfig.class);<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;xxl.job.admin.addresses&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String adminAddresses;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;xxl.job.executor.appname&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String appname;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;xxl.job.executor.port&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> port;<br><br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> XxlJobSpringExecutor <span class="hljs-title function_">xxlJobExecutor</span><span class="hljs-params">()</span> &#123;<br>        logger.info(<span class="hljs-string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job config init.&quot;</span>);<br>        <span class="hljs-type">XxlJobSpringExecutor</span> <span class="hljs-variable">xxlJobSpringExecutor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XxlJobSpringExecutor</span>();<br>        xxlJobSpringExecutor.setAdminAddresses(adminAddresses);<br>        xxlJobSpringExecutor.setAppname(appname);<br>        xxlJobSpringExecutor.setPort(port);<br>        <span class="hljs-keyword">return</span> xxlJobSpringExecutor;<br>    &#125;<br><br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>在nacos配置新增配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">xxl:</span><br>  <span class="hljs-attr">job:</span><br>    <span class="hljs-attr">admin:</span><br>      <span class="hljs-attr">addresses:</span> <span class="hljs-string">http://192.168.200.130:8888/xxl-job-admin</span><br>    <span class="hljs-attr">executor:</span><br>      <span class="hljs-attr">appname:</span> <span class="hljs-string">leadnews-hot-article-executor</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">9999</span><br></code></pre></td></tr></table></figure>

<p>④：在article微服务中新建任务类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.article.job;<br><br><span class="hljs-keyword">import</span> com.heima.article.service.HotArticleService;<br><span class="hljs-keyword">import</span> com.xxl.job.core.handler.annotation.XxlJob;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ComputeHotArticleJob</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> HotArticleService hotArticleService;<br><br>    <span class="hljs-meta">@XxlJob(&quot;computeHotArticleJob&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handle</span><span class="hljs-params">()</span>&#123;<br>        log.info(<span class="hljs-string">&quot;热文章分值计算调度任务开始执行...&quot;</span>);<br>        hotArticleService.computeHotArticle();<br>        log.info(<span class="hljs-string">&quot;热文章分值计算调度任务结束...&quot;</span>);<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="4-查询文章接口改造"><a href="#4-查询文章接口改造" class="headerlink" title="4.查询文章接口改造"></a>4.查询文章接口改造</h2><h3 id="4-1-思路分析"><a href="#4-1-思路分析" class="headerlink" title="4.1 思路分析"></a>4.1 思路分析</h3><p><img src="/../images/image-20210613110712894.png" srcset="/img/loading.gif" lazyload alt="image-20210613110712894"></p>
<h3 id="4-2-功能实现"><a href="#4-2-功能实现" class="headerlink" title="4.2 功能实现"></a>4.2 功能实现</h3><h4 id="4-2-1-在ApArticleService中新增方法"><a href="#4-2-1-在ApArticleService中新增方法" class="headerlink" title="4.2.1 在ApArticleService中新增方法"></a>4.2.1 在ApArticleService中新增方法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 加载文章列表</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> dto</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> type  1 加载更多   2 加载最新</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> firstPage  true  是首页  flase 非首页</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br><span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">load2</span><span class="hljs-params">(ArticleHomeDto dto,Short type,<span class="hljs-type">boolean</span> firstPage)</span>;<br></code></pre></td></tr></table></figure>

<p>实现方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 加载文章列表</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> dto</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> type      1 加载更多   2 加载最新</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> firstPage true  是首页  flase 非首页</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">load2</span><span class="hljs-params">(ArticleHomeDto dto, Short type, <span class="hljs-type">boolean</span> firstPage)</span> &#123;<br>    <span class="hljs-keyword">if</span>(firstPage)&#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">jsonStr</span> <span class="hljs-operator">=</span> cacheService.get(ArticleConstants.HOT_ARTICLE_FIRST_PAGE + dto.getTag());<br>        <span class="hljs-keyword">if</span>(StringUtils.isNotBlank(jsonStr))&#123;<br>            List&lt;HotArticleVo&gt; hotArticleVoList = JSON.parseArray(jsonStr, HotArticleVo.class);<br>            <span class="hljs-type">ResponseResult</span> <span class="hljs-variable">responseResult</span> <span class="hljs-operator">=</span> ResponseResult.okResult(hotArticleVoList);<br>            <span class="hljs-keyword">return</span> responseResult;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> load(type,dto);<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="4-2-2-修改控制器"><a href="#4-2-2-修改控制器" class="headerlink" title="4.2.2 修改控制器"></a>4.2.2 修改控制器</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 加载首页</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> dto</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br><span class="hljs-meta">@PostMapping(&quot;/load&quot;)</span><br><span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">load</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> ArticleHomeDto dto)</span>&#123;<br>    <span class="hljs-comment">//        return apArticleService.load(dto, ArticleConstants.LOADTYPE_LOAD_MORE);</span><br>    <span class="hljs-keyword">return</span> apArticleService.load2(dto, ArticleConstants.LOADTYPE_LOAD_MORE,<span class="hljs-literal">true</span>);<br>&#125;<br></code></pre></td></tr></table></figure>





<h1 id="9-热点文章-实时计算"><a href="#9-热点文章-实时计算" class="headerlink" title="9 热点文章-实时计算"></a>9 热点文章-实时计算</h1><h2 id="1-今日内容-1"><a href="#1-今日内容-1" class="headerlink" title="1 今日内容"></a>1 今日内容</h2><h3 id="1-1-定时计算与实时计算"><a href="#1-1-定时计算与实时计算" class="headerlink" title="1.1 定时计算与实时计算"></a>1.1 定时计算与实时计算</h3><p><img src="/../images/image-20210730201509223.png" srcset="/img/loading.gif" lazyload alt="image-20210730201509223"></p>
<h3 id="1-2-今日内容-1"><a href="#1-2-今日内容-1" class="headerlink" title="1.2 今日内容"></a>1.2 今日内容</h3><p>kafkaStream</p>
<ul>
<li><p>什么是流式计算</p>
</li>
<li><p>kafkaStream概述</p>
</li>
<li><p>kafkaStream入门案例</p>
</li>
<li><p>Springboot集成kafkaStream</p>
</li>
</ul>
<p>实时计算</p>
<ul>
<li><p>用户行为发送消息</p>
</li>
<li><p>kafkaStream聚合处理消息</p>
</li>
<li><p>更新文章行为数量</p>
</li>
<li><p>替换热点文章数据</p>
</li>
</ul>
<h2 id="2-实时流式计算"><a href="#2-实时流式计算" class="headerlink" title="2 实时流式计算"></a>2 实时流式计算</h2><h3 id="2-1-概念"><a href="#2-1-概念" class="headerlink" title="2.1 概念"></a>2.1 概念</h3><p>一般流式计算会与批量计算相比较。在流式计算模型中，输入是持续的，可以认为在时间上是无界的，也就意味着，永远拿不到全量数据去做计算。同时，计算结果是持续输出的，也即计算结果在时间上也是无界的。流式计算一般对实时性要求较高，同时一般是先定义目标计算，然后数据到来之后将计算逻辑应用于数据。同时为了提高计算效率，往往尽可能采用增量计算代替全量计算。</p>
<p><img src="/../images/image-20210731090637590.png" srcset="/img/loading.gif" lazyload alt="image-20210731090637590"></p>
<p>流式计算就相当于上图的右侧扶梯，是可以源源不断的产生数据，源源不断的接收数据，没有边界。</p>
<h3 id="2-2-应用场景"><a href="#2-2-应用场景" class="headerlink" title="2.2 应用场景"></a>2.2 应用场景</h3><ul>
<li><p>日志分析</p>
<p>  网站的用户访问日志进行实时的分析，计算访问量，用户画像，留存率等等，实时的进行数据分析，帮助企业进行决策</p>
</li>
<li><p>大屏看板统计</p>
<p>  可以实时的查看网站注册数量，订单数量，购买数量，金额等。</p>
</li>
<li><p>公交实时数据</p>
<p>  可以随时更新公交车方位，计算多久到达站牌等</p>
</li>
<li><p>实时文章分值计算</p>
<p>  头条类文章的分值计算，通过用户的行为实时文章的分值，分值越高就越被推荐。</p>
</li>
</ul>
<h3 id="2-3-技术方案选型"><a href="#2-3-技术方案选型" class="headerlink" title="2.3 技术方案选型"></a>2.3 技术方案选型</h3><ul>
<li><p>Hadoop </p>
<p>  <img src="/../images/image-20210731090700382.png" srcset="/img/loading.gif" lazyload alt="image-20210731090700382"></p>
</li>
<li><p>Apche Storm</p>
<p>  Storm 是一个分布式实时大数据处理系统，可以帮助我们方便地处理海量数据，具有高可靠、高容错、高扩展的特点。是流式框架，有很高的数据吞吐能力。</p>
</li>
<li><p>Kafka Stream </p>
<p>  可以轻松地将其嵌入任何Java应用程序中，并与用户为其流应用程序所拥有的任何现有打包，部署和操作工具集成。</p>
</li>
</ul>
<h2 id="3-Kafka-Stream"><a href="#3-Kafka-Stream" class="headerlink" title="3 Kafka Stream"></a>3 Kafka Stream</h2><h3 id="3-1-概述"><a href="#3-1-概述" class="headerlink" title="3.1 概述"></a>3.1 概述</h3><p>Kafka Stream是Apache Kafka从0.10版本引入的一个新Feature。它是提供了对存储于Kafka内的数据进行流式处理和分析的功能。</p>
<p>Kafka Stream的特点如下：</p>
<ul>
<li>Kafka Stream提供了一个非常简单而轻量的Library，它可以非常方便地嵌入任意Java应用中，也可以任意方式打包和部署</li>
<li>除了Kafka外，无任何外部依赖</li>
<li>充分利用Kafka分区机制实现水平扩展和顺序性保证</li>
<li>通过可容错的state store实现高效的状态操作（如windowed join和aggregation）</li>
<li>支持正好一次处理语义</li>
<li>提供记录级的处理能力，从而实现毫秒级的低延迟</li>
<li>支持基于事件时间的窗口操作，并且可处理晚到的数据（late arrival of records）</li>
<li>同时提供底层的处理原语Processor（类似于Storm的spout和bolt），以及高层抽象的DSL（类似于Spark的map/group/reduce）</li>
</ul>
<p><img src="/../images/image-20210730201706437.png" srcset="/img/loading.gif" lazyload alt="image-20210730201706437"></p>
<h3 id="3-2-Kafka-Streams的关键概念"><a href="#3-2-Kafka-Streams的关键概念" class="headerlink" title="3.2 Kafka Streams的关键概念"></a>3.2 Kafka Streams的关键概念</h3><ul>
<li><strong>源处理器（Source Processor）</strong>：源处理器是一个没有任何上游处理器的特殊类型的流处理器。它从一个或多个kafka主题生成输入流。通过消费这些主题的消息并将它们转发到下游处理器。</li>
<li><strong>Sink处理器</strong>：sink处理器是一个没有下游流处理器的特殊类型的流处理器。它接收上游流处理器的消息发送到一个指定的<strong>Kafka主题</strong>。</li>
</ul>
<p><img src="/../images/image-20210731090727323.png" srcset="/img/loading.gif" lazyload alt="image-20210731090727323"></p>
<h3 id="3-3-KStream"><a href="#3-3-KStream" class="headerlink" title="3.3 KStream"></a>3.3 KStream</h3><p>（1）数据结构类似于map,如下图，key-value键值对</p>
<p><img src="/../images/image-20210731090746415.png" srcset="/img/loading.gif" lazyload alt="image-20210731090746415"></p>
<p>（2）KStream</p>
<p><img src="/../images/image-20210730201817959.png" srcset="/img/loading.gif" lazyload alt="image-20210730201817959"></p>
<p><strong>KStream</strong>数据流（data stream），即是一段顺序的，可以无限长，不断更新的数据集。<br>数据流中比较常记录的是事件，这些事件可以是一次鼠标点击（click），一次交易，或是传感器记录的位置数据。</p>
<p>KStream负责抽象的，就是数据流。与Kafka自身topic中的数据一样，类似日志，每一次操作都是<strong>向其中插入（insert）新数据。</strong></p>
<p>为了说明这一点，让我们想象一下以下两个数据记录正在发送到流中：</p>
<p>（“ alice”，1）-&gt;（“” alice“，3）</p>
<p>如果您的流处理应用是要总结每个用户的价值，它将返回<code>4</code>了<code>alice</code>。为什么？因为第二条数据记录将不被视为先前记录的更新。（insert）新数据</p>
<h3 id="3-4-Kafka-Stream入门案例编写"><a href="#3-4-Kafka-Stream入门案例编写" class="headerlink" title="3.4 Kafka Stream入门案例编写"></a>3.4 Kafka Stream入门案例编写</h3><p>（1）需求分析，求单词个数（word count）</p>
<p><img src="/../images/image-20210730201911566.png" srcset="/img/loading.gif" lazyload alt="image-20210730201911566"></p>
<p>（2）引入依赖</p>
<p>在之前的kafka-demo工程的pom文件中引入</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.kafka<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>kafka-streams<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">exclusions</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">exclusion</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>connect-json<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.kafka<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">exclusion</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">exclusion</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.kafka<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>kafka-clients<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">exclusion</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">exclusions</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>(3)创建原生的kafka staream入门案例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.kafka.sample;<br><br><span class="hljs-keyword">import</span> org.apache.kafka.common.serialization.Serdes;<br><span class="hljs-keyword">import</span> org.apache.kafka.streams.KafkaStreams;<br><span class="hljs-keyword">import</span> org.apache.kafka.streams.KeyValue;<br><span class="hljs-keyword">import</span> org.apache.kafka.streams.StreamsBuilder;<br><span class="hljs-keyword">import</span> org.apache.kafka.streams.StreamsConfig;<br><span class="hljs-keyword">import</span> org.apache.kafka.streams.kstream.KStream;<br><span class="hljs-keyword">import</span> org.apache.kafka.streams.kstream.TimeWindows;<br><span class="hljs-keyword">import</span> org.apache.kafka.streams.kstream.ValueMapper;<br><br><span class="hljs-keyword">import</span> java.time.Duration;<br><span class="hljs-keyword">import</span> java.util.Arrays;<br><span class="hljs-keyword">import</span> java.util.Properties;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 流式处理</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KafkaStreamQuickStart</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br><br>        <span class="hljs-comment">//kafka的配置信心</span><br>        <span class="hljs-type">Properties</span> <span class="hljs-variable">prop</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();<br>        prop.put(StreamsConfig.BOOTSTRAP_SERVERS_CONFIG,<span class="hljs-string">&quot;192.168.200.130:9092&quot;</span>);<br>        prop.put(StreamsConfig.DEFAULT_KEY_SERDE_CLASS_CONFIG, Serdes.String().getClass());<br>        prop.put(StreamsConfig.DEFAULT_VALUE_SERDE_CLASS_CONFIG, Serdes.String().getClass());<br>        prop.put(StreamsConfig.APPLICATION_ID_CONFIG,<span class="hljs-string">&quot;streams-quickstart&quot;</span>);<br><br>        <span class="hljs-comment">//stream 构建器</span><br>        <span class="hljs-type">StreamsBuilder</span> <span class="hljs-variable">streamsBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StreamsBuilder</span>();<br><br>        <span class="hljs-comment">//流式计算</span><br>        streamProcessor(streamsBuilder);<br><br><br>        <span class="hljs-comment">//创建kafkaStream对象</span><br>        <span class="hljs-type">KafkaStreams</span> <span class="hljs-variable">kafkaStreams</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">KafkaStreams</span>(streamsBuilder.build(),prop);<br>        <span class="hljs-comment">//开启流式计算</span><br>        kafkaStreams.start();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 流式计算</span><br><span class="hljs-comment">     * 消息的内容：hello kafka  hello itcast</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> streamsBuilder</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">streamProcessor</span><span class="hljs-params">(StreamsBuilder streamsBuilder)</span> &#123;<br>        <span class="hljs-comment">//创建kstream对象，同时指定从那个topic中接收消息</span><br>        KStream&lt;String, String&gt; stream = streamsBuilder.stream(<span class="hljs-string">&quot;itcast-topic-input&quot;</span>);<br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 处理消息的value</span><br><span class="hljs-comment">         */</span><br>        stream.flatMapValues(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ValueMapper</span>&lt;String, Iterable&lt;String&gt;&gt;() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> Iterable&lt;String&gt; <span class="hljs-title function_">apply</span><span class="hljs-params">(String value)</span> &#123;<br>                <span class="hljs-keyword">return</span> Arrays.asList(value.split(<span class="hljs-string">&quot; &quot;</span>));<br>            &#125;<br>        &#125;)<br>                <span class="hljs-comment">//按照value进行聚合处理</span><br>                .groupBy((key,value)-&gt;value)<br>                <span class="hljs-comment">//时间窗口</span><br>                .windowedBy(TimeWindows.of(Duration.ofSeconds(<span class="hljs-number">10</span>)))<br>                <span class="hljs-comment">//统计单词的个数</span><br>                .count()<br>                <span class="hljs-comment">//转换为kStream</span><br>                .toStream()<br>                .map((key,value)-&gt;&#123;<br>                    System.out.println(<span class="hljs-string">&quot;key:&quot;</span>+key+<span class="hljs-string">&quot;,vlaue:&quot;</span>+value);<br>                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">KeyValue</span>&lt;&gt;(key.key().toString(),value.toString());<br>                &#125;)<br>                <span class="hljs-comment">//发送消息</span><br>                .to(<span class="hljs-string">&quot;itcast-topic-out&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>(4)测试准备</p>
<ul>
<li><p>使用生产者在topic为：itcast_topic_input中发送多条消息</p>
</li>
<li><p>使用消费者接收topic为：itcast_topic_out</p>
</li>
</ul>
<p>结果：</p>
<ul>
<li>通过流式计算，会把生产者的多条消息汇总成一条发送到消费者中输出</li>
</ul>
<h3 id="3-5-SpringBoot集成Kafka-Stream"><a href="#3-5-SpringBoot集成Kafka-Stream" class="headerlink" title="3.5 SpringBoot集成Kafka Stream"></a>3.5 SpringBoot集成Kafka Stream</h3><p>（1）自定配置参数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.kafka.config;<br><br><span class="hljs-keyword">import</span> lombok.Getter;<br><span class="hljs-keyword">import</span> lombok.Setter;<br><span class="hljs-keyword">import</span> org.apache.kafka.clients.consumer.ConsumerConfig;<br><span class="hljs-keyword">import</span> org.apache.kafka.common.serialization.Serdes;<br><span class="hljs-keyword">import</span> org.apache.kafka.streams.StreamsConfig;<br><span class="hljs-keyword">import</span> org.apache.kafka.streams.Topology;<br><span class="hljs-keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.kafka.annotation.EnableKafkaStreams;<br><span class="hljs-keyword">import</span> org.springframework.kafka.annotation.KafkaStreamsDefaultConfiguration;<br><span class="hljs-keyword">import</span> org.springframework.kafka.config.KafkaStreamsConfiguration;<br><br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 通过重新注册KafkaStreamsConfiguration对象，设置自定配置参数</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-meta">@Setter</span><br><span class="hljs-meta">@Getter</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableKafkaStreams</span><br><span class="hljs-meta">@ConfigurationProperties(prefix=&quot;kafka&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KafkaStreamConfig</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">MAX_MESSAGE_SIZE</span> <span class="hljs-operator">=</span> <span class="hljs-number">16</span>* <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br>    <span class="hljs-keyword">private</span> String hosts;<br>    <span class="hljs-keyword">private</span> String group;<br>    <span class="hljs-meta">@Bean(name = KafkaStreamsDefaultConfiguration.DEFAULT_STREAMS_CONFIG_BEAN_NAME)</span><br>    <span class="hljs-keyword">public</span> KafkaStreamsConfiguration <span class="hljs-title function_">defaultKafkaStreamsConfig</span><span class="hljs-params">()</span> &#123;<br>        Map&lt;String, Object&gt; props = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        props.put(StreamsConfig.BOOTSTRAP_SERVERS_CONFIG, hosts);<br>        props.put(StreamsConfig.APPLICATION_ID_CONFIG, <span class="hljs-built_in">this</span>.getGroup()+<span class="hljs-string">&quot;_stream_aid&quot;</span>);<br>        props.put(StreamsConfig.CLIENT_ID_CONFIG, <span class="hljs-built_in">this</span>.getGroup()+<span class="hljs-string">&quot;_stream_cid&quot;</span>);<br>        props.put(StreamsConfig.RETRIES_CONFIG, <span class="hljs-number">10</span>);<br>        props.put(StreamsConfig.DEFAULT_KEY_SERDE_CLASS_CONFIG, Serdes.String().getClass());<br>        props.put(StreamsConfig.DEFAULT_VALUE_SERDE_CLASS_CONFIG, Serdes.String().getClass());<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">KafkaStreamsConfiguration</span>(props);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>修改application.yml文件，在最下方添加自定义配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">kafka:</span><br>  <span class="hljs-attr">hosts:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.130</span><span class="hljs-string">:9092</span><br>  <span class="hljs-attr">group:</span> <span class="hljs-string">$&#123;spring.application.name&#125;</span><br></code></pre></td></tr></table></figure>

<p>(2)新增配置类，创建KStream对象，进行聚合</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.kafka.stream;<br><br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.apache.kafka.streams.KeyValue;<br><span class="hljs-keyword">import</span> org.apache.kafka.streams.StreamsBuilder;<br><span class="hljs-keyword">import</span> org.apache.kafka.streams.kstream.KStream;<br><span class="hljs-keyword">import</span> org.apache.kafka.streams.kstream.TimeWindows;<br><span class="hljs-keyword">import</span> org.apache.kafka.streams.kstream.ValueMapper;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><br><span class="hljs-keyword">import</span> java.time.Duration;<br><span class="hljs-keyword">import</span> java.util.Arrays;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KafkaStreamHelloListener</span> &#123;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> KStream&lt;String,String&gt; <span class="hljs-title function_">kStream</span><span class="hljs-params">(StreamsBuilder streamsBuilder)</span>&#123;<br>        <span class="hljs-comment">//创建kstream对象，同时指定从那个topic中接收消息</span><br>        KStream&lt;String, String&gt; stream = streamsBuilder.stream(<span class="hljs-string">&quot;itcast-topic-input&quot;</span>);<br>        stream.flatMapValues(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ValueMapper</span>&lt;String, Iterable&lt;String&gt;&gt;() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> Iterable&lt;String&gt; <span class="hljs-title function_">apply</span><span class="hljs-params">(String value)</span> &#123;<br>                <span class="hljs-keyword">return</span> Arrays.asList(value.split(<span class="hljs-string">&quot; &quot;</span>));<br>            &#125;<br>        &#125;)<br>                <span class="hljs-comment">//根据value进行聚合分组</span><br>                .groupBy((key,value)-&gt;value)<br>                <span class="hljs-comment">//聚合计算时间间隔</span><br>                .windowedBy(TimeWindows.of(Duration.ofSeconds(<span class="hljs-number">10</span>)))<br>                <span class="hljs-comment">//求单词的个数</span><br>                .count()<br>                .toStream()<br>                <span class="hljs-comment">//处理后的结果转换为string字符串</span><br>                .map((key,value)-&gt;&#123;<br>                    System.out.println(<span class="hljs-string">&quot;key:&quot;</span>+key+<span class="hljs-string">&quot;,value:&quot;</span>+value);<br>                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">KeyValue</span>&lt;&gt;(key.key().toString(),value.toString());<br>                &#125;)<br>                <span class="hljs-comment">//发送消息</span><br>                .to(<span class="hljs-string">&quot;itcast-topic-out&quot;</span>);<br>        <span class="hljs-keyword">return</span> stream;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>测试：</p>
<p>​    启动微服务，正常发送消息，可以正常接收到消息</p>
<h2 id="3-app端热点文章计算"><a href="#3-app端热点文章计算" class="headerlink" title="3 app端热点文章计算"></a>3 app端热点文章计算</h2><h3 id="3-1-思路说明"><a href="#3-1-思路说明" class="headerlink" title="3.1 思路说明"></a>3.1 思路说明</h3><p><img src="/../images/image-20210621235620854.png" srcset="/img/loading.gif" lazyload alt="image-20210621235620854"></p>
<h3 id="3-2-功能实现"><a href="#3-2-功能实现" class="headerlink" title="3.2 功能实现"></a>3.2 功能实现</h3><h4 id="3-2-1-用户行为（阅读量，评论，点赞，收藏）发送消息，以阅读和点赞为例"><a href="#3-2-1-用户行为（阅读量，评论，点赞，收藏）发送消息，以阅读和点赞为例" class="headerlink" title="3.2.1 用户行为（阅读量，评论，点赞，收藏）发送消息，以阅读和点赞为例"></a>3.2.1 用户行为（阅读量，评论，点赞，收藏）发送消息，以阅读和点赞为例</h4><p>①在heima-leadnews-behavior微服务中集成kafka生产者配置</p>
<p>修改nacos，新增内容</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">leadnews-behavior</span><br>  <span class="hljs-attr">kafka:</span><br>    <span class="hljs-attr">bootstrap-servers:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.130</span><span class="hljs-string">:9092</span><br>    <span class="hljs-attr">producer:</span><br>      <span class="hljs-attr">retries:</span> <span class="hljs-number">10</span><br>      <span class="hljs-attr">key-serializer:</span> <span class="hljs-string">org.apache.kafka.common.serialization.StringSerializer</span><br>      <span class="hljs-attr">value-serializer:</span> <span class="hljs-string">org.apache.kafka.common.serialization.StringSerializer</span><br></code></pre></td></tr></table></figure>

<p>②修改ApLikesBehaviorServiceImpl新增发送消息</p>
<p>定义消息发送封装类：UpdateArticleMess</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.model.mess;<br><br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UpdateArticleMess</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 修改文章的字段类型</span><br><span class="hljs-comment">      */</span><br>    <span class="hljs-keyword">private</span> UpdateArticleType type;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 文章ID</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Long articleId;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 修改数据的增量，可为正负</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Integer add;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">UpdateArticleType</span>&#123;<br>        COLLECTION,COMMENT,LIKES,VIEWS;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>topic常量类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.common.constants;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HotArticleConstants</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String HOT_ARTICLE_SCORE_TOPIC=<span class="hljs-string">&quot;hot.article.score.topic&quot;</span>;<br>   <br>&#125;<br></code></pre></td></tr></table></figure>

<p>完整代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.behavior.service.impl;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.heima.behavior.service.ApLikesBehaviorService;<br><span class="hljs-keyword">import</span> com.heima.common.constants.BehaviorConstants;<br><span class="hljs-keyword">import</span> com.heima.common.constants.HotArticleConstants;<br><span class="hljs-keyword">import</span> com.heima.common.redis.CacheService;<br><span class="hljs-keyword">import</span> com.heima.model.behavior.dtos.LikesBehaviorDto;<br><span class="hljs-keyword">import</span> com.heima.model.common.dtos.ResponseResult;<br><span class="hljs-keyword">import</span> com.heima.model.common.enums.AppHttpCodeEnum;<br><span class="hljs-keyword">import</span> com.heima.model.mess.UpdateArticleMess;<br><span class="hljs-keyword">import</span> com.heima.model.user.pojos.ApUser;<br><span class="hljs-keyword">import</span> com.heima.utils.thread.AppThreadLocalUtil;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.kafka.core.KafkaTemplate;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><span class="hljs-keyword">import</span> org.springframework.transaction.annotation.Transactional;<br><br><br><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@Transactional</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApLikesBehaviorServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ApLikesBehaviorService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> CacheService cacheService;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> KafkaTemplate&lt;String,String&gt; kafkaTemplate;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">like</span><span class="hljs-params">(LikesBehaviorDto dto)</span> &#123;<br><br>        <span class="hljs-comment">//1.检查参数</span><br>        <span class="hljs-keyword">if</span> (dto == <span class="hljs-literal">null</span> || dto.getArticleId() == <span class="hljs-literal">null</span> || checkParam(dto)) &#123;<br>            <span class="hljs-keyword">return</span> ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID);<br>        &#125;<br><br>        <span class="hljs-comment">//2.是否登录</span><br>        <span class="hljs-type">ApUser</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> AppThreadLocalUtil.getUser();<br>        <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> ResponseResult.errorResult(AppHttpCodeEnum.NEED_LOGIN);<br>        &#125;<br><br>        <span class="hljs-type">UpdateArticleMess</span> <span class="hljs-variable">mess</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UpdateArticleMess</span>();<br>        mess.setArticleId(dto.getArticleId());<br>        mess.setType(UpdateArticleMess.UpdateArticleType.LIKES);<br><br>        <span class="hljs-comment">//3.点赞  保存数据</span><br>        <span class="hljs-keyword">if</span> (dto.getOperation() == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> cacheService.hGet(BehaviorConstants.LIKE_BEHAVIOR + dto.getArticleId().toString(), user.getId().toString());<br>            <span class="hljs-keyword">if</span> (obj != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">return</span> ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID, <span class="hljs-string">&quot;已点赞&quot;</span>);<br>            &#125;<br>            <span class="hljs-comment">// 保存当前key</span><br>            log.info(<span class="hljs-string">&quot;保存当前key:&#123;&#125; ,&#123;&#125;, &#123;&#125;&quot;</span>, dto.getArticleId(), user.getId(), dto);<br>            cacheService.hPut(BehaviorConstants.LIKE_BEHAVIOR + dto.getArticleId().toString(), user.getId().toString(), JSON.toJSONString(dto));<br>            mess.setAdd(<span class="hljs-number">1</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// 删除当前key</span><br>            log.info(<span class="hljs-string">&quot;删除当前key:&#123;&#125;, &#123;&#125;&quot;</span>, dto.getArticleId(), user.getId());<br>            cacheService.hDelete(BehaviorConstants.LIKE_BEHAVIOR + dto.getArticleId().toString(), user.getId().toString());<br>            mess.setAdd(-<span class="hljs-number">1</span>);<br>        &#125;<br><br>        <span class="hljs-comment">//发送消息，数据聚合</span><br>        kafkaTemplate.send(HotArticleConstants.HOT_ARTICLE_SCORE_TOPIC,JSON.toJSONString(mess));<br><br><br>        <span class="hljs-keyword">return</span> ResponseResult.okResult(AppHttpCodeEnum.SUCCESS);<br><br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 检查参数</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">checkParam</span><span class="hljs-params">(LikesBehaviorDto dto)</span> &#123;<br>        <span class="hljs-keyword">if</span> (dto.getType() &gt; <span class="hljs-number">2</span> || dto.getType() &lt; <span class="hljs-number">0</span> || dto.getOperation() &gt; <span class="hljs-number">1</span> || dto.getOperation() &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>③修改阅读行为的类ApReadBehaviorServiceImpl发送消息</p>
<p>完整代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.behavior.service.impl;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.heima.behavior.service.ApReadBehaviorService;<br><span class="hljs-keyword">import</span> com.heima.common.constants.BehaviorConstants;<br><span class="hljs-keyword">import</span> com.heima.common.constants.HotArticleConstants;<br><span class="hljs-keyword">import</span> com.heima.common.redis.CacheService;<br><span class="hljs-keyword">import</span> com.heima.model.behavior.dtos.ReadBehaviorDto;<br><span class="hljs-keyword">import</span> com.heima.model.common.dtos.ResponseResult;<br><span class="hljs-keyword">import</span> com.heima.model.common.enums.AppHttpCodeEnum;<br><span class="hljs-keyword">import</span> com.heima.model.mess.UpdateArticleMess;<br><span class="hljs-keyword">import</span> com.heima.model.user.pojos.ApUser;<br><span class="hljs-keyword">import</span> com.heima.utils.thread.AppThreadLocalUtil;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.apache.commons.lang3.StringUtils;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.kafka.core.KafkaTemplate;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><span class="hljs-keyword">import</span> org.springframework.transaction.annotation.Transactional;<br><br><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@Transactional</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApReadBehaviorServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ApReadBehaviorService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> CacheService cacheService;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> KafkaTemplate&lt;String,String&gt; kafkaTemplate;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">readBehavior</span><span class="hljs-params">(ReadBehaviorDto dto)</span> &#123;<br>        <span class="hljs-comment">//1.检查参数</span><br>        <span class="hljs-keyword">if</span> (dto == <span class="hljs-literal">null</span> || dto.getArticleId() == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID);<br>        &#125;<br><br>        <span class="hljs-comment">//2.是否登录</span><br>        <span class="hljs-type">ApUser</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> AppThreadLocalUtil.getUser();<br>        <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> ResponseResult.errorResult(AppHttpCodeEnum.NEED_LOGIN);<br>        &#125;<br>        <span class="hljs-comment">//更新阅读次数</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">readBehaviorJson</span> <span class="hljs-operator">=</span> (String) cacheService.hGet(BehaviorConstants.READ_BEHAVIOR + dto.getArticleId().toString(), user.getId().toString());<br>        <span class="hljs-keyword">if</span> (StringUtils.isNotBlank(readBehaviorJson)) &#123;<br>            <span class="hljs-type">ReadBehaviorDto</span> <span class="hljs-variable">readBehaviorDto</span> <span class="hljs-operator">=</span> JSON.parseObject(readBehaviorJson, ReadBehaviorDto.class);<br>            dto.setCount((<span class="hljs-type">short</span>) (readBehaviorDto.getCount() + dto.getCount()));<br>        &#125;<br>        <span class="hljs-comment">// 保存当前key</span><br>        log.info(<span class="hljs-string">&quot;保存当前key:&#123;&#125; &#123;&#125; &#123;&#125;&quot;</span>, dto.getArticleId(), user.getId(), dto);<br>        cacheService.hPut(BehaviorConstants.READ_BEHAVIOR + dto.getArticleId().toString(), user.getId().toString(), JSON.toJSONString(dto));<br><br>        <span class="hljs-comment">//发送消息，数据聚合</span><br>        <span class="hljs-type">UpdateArticleMess</span> <span class="hljs-variable">mess</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UpdateArticleMess</span>();<br>        mess.setArticleId(dto.getArticleId());<br>        mess.setType(UpdateArticleMess.UpdateArticleType.VIEWS);<br>        mess.setAdd(<span class="hljs-number">1</span>);<br>        kafkaTemplate.send(HotArticleConstants.HOT_ARTICLE_SCORE_TOPIC,JSON.toJSONString(mess));<br>        <br>        <br>        <span class="hljs-keyword">return</span> ResponseResult.okResult(AppHttpCodeEnum.SUCCESS);<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="3-2-2-使用kafkaStream实时接收消息，聚合内容"><a href="#3-2-2-使用kafkaStream实时接收消息，聚合内容" class="headerlink" title="3.2.2 使用kafkaStream实时接收消息，聚合内容"></a>3.2.2 使用kafkaStream实时接收消息，聚合内容</h4><p>①在leadnews-article微服务中集成kafkaStream (参考kafka-demo)</p>
<p>②定义实体类，用于聚合之后的分值封装</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.model.article.mess;<br><br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArticleVisitStreamMess</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 文章id</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Long articleId;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 阅读</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> view;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 收藏</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> collect;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 评论</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> comment;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 点赞</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> like;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>修改常量类：增加常量</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.common.constans;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HotArticleConstants</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String HOT_ARTICLE_SCORE_TOPIC=<span class="hljs-string">&quot;hot.article.score.topic&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String HOT_ARTICLE_INCR_HANDLE_TOPIC=<span class="hljs-string">&quot;hot.article.incr.handle.topic&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>③ 定义stream,接收消息并聚合</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.article.stream;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.heima.common.constants.HotArticleConstants;<br><span class="hljs-keyword">import</span> com.heima.model.mess.ArticleVisitStreamMess;<br><span class="hljs-keyword">import</span> com.heima.model.mess.UpdateArticleMess;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.apache.commons.lang3.StringUtils;<br><span class="hljs-keyword">import</span> org.apache.kafka.streams.KeyValue;<br><span class="hljs-keyword">import</span> org.apache.kafka.streams.StreamsBuilder;<br><span class="hljs-keyword">import</span> org.apache.kafka.streams.kstream.*;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><br><span class="hljs-keyword">import</span> java.time.Duration;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HotArticleStreamHandler</span> &#123;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> KStream&lt;String,String&gt; <span class="hljs-title function_">kStream</span><span class="hljs-params">(StreamsBuilder streamsBuilder)</span>&#123;<br>        <span class="hljs-comment">//接收消息</span><br>        KStream&lt;String,String&gt; stream = streamsBuilder.stream(HotArticleConstants.HOT_ARTICLE_SCORE_TOPIC);<br>        <span class="hljs-comment">//聚合流式处理</span><br>        stream.map((key,value)-&gt;&#123;<br>            <span class="hljs-type">UpdateArticleMess</span> <span class="hljs-variable">mess</span> <span class="hljs-operator">=</span> JSON.parseObject(value, UpdateArticleMess.class);<br>            <span class="hljs-comment">//重置消息的key:1234343434   和  value: likes:1</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">KeyValue</span>&lt;&gt;(mess.getArticleId().toString(),mess.getType().name()+<span class="hljs-string">&quot;:&quot;</span>+mess.getAdd());<br>        &#125;)<br>                <span class="hljs-comment">//按照文章id进行聚合</span><br>                .groupBy((key,value)-&gt;key)<br>                <span class="hljs-comment">//时间窗口</span><br>                .windowedBy(TimeWindows.of(Duration.ofSeconds(<span class="hljs-number">10</span>)))<br>                <span class="hljs-comment">/**</span><br><span class="hljs-comment">                 * 自行的完成聚合的计算</span><br><span class="hljs-comment">                 */</span><br>                .aggregate(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Initializer</span>&lt;String&gt;() &#123;<br>                    <span class="hljs-comment">/**</span><br><span class="hljs-comment">                     * 初始方法，返回值是消息的value</span><br><span class="hljs-comment">                     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">                     */</span><br>                    <span class="hljs-meta">@Override</span><br>                    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">apply</span><span class="hljs-params">()</span> &#123;<br>                        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;COLLECTION:0,COMMENT:0,LIKES:0,VIEWS:0&quot;</span>;<br>                    &#125;<br>                    <span class="hljs-comment">/**</span><br><span class="hljs-comment">                     * 真正的聚合操作，返回值是消息的value</span><br><span class="hljs-comment">                     */</span><br>                &#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Aggregator</span>&lt;String, String, String&gt;() &#123;<br>                    <span class="hljs-meta">@Override</span><br>                    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">apply</span><span class="hljs-params">(String key, String value, String aggValue)</span> &#123;<br>                        <span class="hljs-keyword">if</span>(StringUtils.isBlank(value))&#123;<br>                            <span class="hljs-keyword">return</span> aggValue;<br>                        &#125;<br>                        String[] aggAry = aggValue.split(<span class="hljs-string">&quot;,&quot;</span>);<br>                        <span class="hljs-type">int</span> <span class="hljs-variable">col</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>,com=<span class="hljs-number">0</span>,lik=<span class="hljs-number">0</span>,vie=<span class="hljs-number">0</span>;<br>                        <span class="hljs-keyword">for</span> (String agg : aggAry) &#123;<br>                            String[] split = agg.split(<span class="hljs-string">&quot;:&quot;</span>);<br>                            <span class="hljs-comment">/**</span><br><span class="hljs-comment">                             * 获得初始值，也是时间窗口内计算之后的值</span><br><span class="hljs-comment">                             */</span><br>                            <span class="hljs-keyword">switch</span> (UpdateArticleMess.UpdateArticleType.valueOf(split[<span class="hljs-number">0</span>]))&#123;<br>                                <span class="hljs-keyword">case</span> COLLECTION:<br>                                    col = Integer.parseInt(split[<span class="hljs-number">1</span>]);<br>                                    <span class="hljs-keyword">break</span>;<br>                                <span class="hljs-keyword">case</span> COMMENT:<br>                                    com = Integer.parseInt(split[<span class="hljs-number">1</span>]);<br>                                    <span class="hljs-keyword">break</span>;<br>                                <span class="hljs-keyword">case</span> LIKES:<br>                                    lik = Integer.parseInt(split[<span class="hljs-number">1</span>]);<br>                                    <span class="hljs-keyword">break</span>;<br>                                <span class="hljs-keyword">case</span> VIEWS:<br>                                    vie = Integer.parseInt(split[<span class="hljs-number">1</span>]);<br>                                    <span class="hljs-keyword">break</span>;<br>                            &#125;<br>                        &#125;<br>                        <span class="hljs-comment">/**</span><br><span class="hljs-comment">                         * 累加操作</span><br><span class="hljs-comment">                         */</span><br>                        String[] valAry = value.split(<span class="hljs-string">&quot;:&quot;</span>);<br>                        <span class="hljs-keyword">switch</span> (UpdateArticleMess.UpdateArticleType.valueOf(valAry[<span class="hljs-number">0</span>]))&#123;<br>                            <span class="hljs-keyword">case</span> COLLECTION:<br>                                col += Integer.parseInt(valAry[<span class="hljs-number">1</span>]);<br>                                <span class="hljs-keyword">break</span>;<br>                            <span class="hljs-keyword">case</span> COMMENT:<br>                                com += Integer.parseInt(valAry[<span class="hljs-number">1</span>]);<br>                                <span class="hljs-keyword">break</span>;<br>                            <span class="hljs-keyword">case</span> LIKES:<br>                                lik += Integer.parseInt(valAry[<span class="hljs-number">1</span>]);<br>                                <span class="hljs-keyword">break</span>;<br>                            <span class="hljs-keyword">case</span> VIEWS:<br>                                vie += Integer.parseInt(valAry[<span class="hljs-number">1</span>]);<br>                                <span class="hljs-keyword">break</span>;<br>                        &#125;<br><br>                        <span class="hljs-type">String</span> <span class="hljs-variable">formatStr</span> <span class="hljs-operator">=</span> String.format(<span class="hljs-string">&quot;COLLECTION:%d,COMMENT:%d,LIKES:%d,VIEWS:%d&quot;</span>, col, com, lik, vie);<br>                        System.out.println(<span class="hljs-string">&quot;文章的id:&quot;</span>+key);<br>                        System.out.println(<span class="hljs-string">&quot;当前时间窗口内的消息处理结果：&quot;</span>+formatStr);<br>                        <span class="hljs-keyword">return</span> formatStr;<br>                    &#125;<br>                &#125;, Materialized.as(<span class="hljs-string">&quot;hot-atricle-stream-count-001&quot;</span>))<br>                .toStream()<br>                .map((key,value)-&gt;&#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">KeyValue</span>&lt;&gt;(key.key().toString(),formatObj(key.key().toString(),value));<br>                &#125;)<br>                <span class="hljs-comment">//发送消息</span><br>                .to(HotArticleConstants.HOT_ARTICLE_INCR_HANDLE_TOPIC);<br><br>        <span class="hljs-keyword">return</span> stream;<br><br><br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 格式化消息的value数据</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> articleId</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> value</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">formatObj</span><span class="hljs-params">(String articleId,String value)</span>&#123;<br>        <span class="hljs-type">ArticleVisitStreamMess</span> <span class="hljs-variable">mess</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArticleVisitStreamMess</span>();<br>        mess.setArticleId(Long.valueOf(articleId));<br>        <span class="hljs-comment">//COLLECTION:0,COMMENT:0,LIKES:0,VIEWS:0</span><br>        String[] valAry = value.split(<span class="hljs-string">&quot;,&quot;</span>);<br>        <span class="hljs-keyword">for</span> (String val : valAry) &#123;<br>            String[] split = val.split(<span class="hljs-string">&quot;:&quot;</span>);<br>            <span class="hljs-keyword">switch</span> (UpdateArticleMess.UpdateArticleType.valueOf(split[<span class="hljs-number">0</span>]))&#123;<br>                <span class="hljs-keyword">case</span> COLLECTION:<br>                    mess.setCollect(Integer.parseInt(split[<span class="hljs-number">1</span>]));<br>                    <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">case</span> COMMENT:<br>                    mess.setComment(Integer.parseInt(split[<span class="hljs-number">1</span>]));<br>                    <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">case</span> LIKES:<br>                    mess.setLike(Integer.parseInt(split[<span class="hljs-number">1</span>]));<br>                    <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">case</span> VIEWS:<br>                    mess.setView(Integer.parseInt(split[<span class="hljs-number">1</span>]));<br>                    <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>        log.info(<span class="hljs-string">&quot;聚合消息处理之后的结果为:&#123;&#125;&quot;</span>,JSON.toJSONString(mess));<br>        <span class="hljs-keyword">return</span> JSON.toJSONString(mess);<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="3-2-3-重新计算文章的分值，更新到数据库和缓存中"><a href="#3-2-3-重新计算文章的分值，更新到数据库和缓存中" class="headerlink" title="3.2.3 重新计算文章的分值，更新到数据库和缓存中"></a>3.2.3 重新计算文章的分值，更新到数据库和缓存中</h4><p>①在ApArticleService添加方法，用于更新数据库中的文章分值</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 更新文章的分值  同时更新缓存中的热点文章数据</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> mess</span><br><span class="hljs-comment">     */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateScore</span><span class="hljs-params">(ArticleVisitStreamMess mess)</span>;<br></code></pre></td></tr></table></figure>

<p>实现类方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 更新文章的分值  同时更新缓存中的热点文章数据</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> mess</span><br><span class="hljs-comment">     */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateScore</span><span class="hljs-params">(ArticleVisitStreamMess mess)</span> &#123;<br>    <span class="hljs-comment">//1.更新文章的阅读、点赞、收藏、评论的数量</span><br>    <span class="hljs-type">ApArticle</span> <span class="hljs-variable">apArticle</span> <span class="hljs-operator">=</span> updateArticle(mess);<br>    <span class="hljs-comment">//2.计算文章的分值</span><br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">score</span> <span class="hljs-operator">=</span> computeScore(apArticle);<br>    score = score * <span class="hljs-number">3</span>;<br><br>    <span class="hljs-comment">//3.替换当前文章对应频道的热点数据</span><br>    replaceDataToRedis(apArticle, score, ArticleConstants.HOT_ARTICLE_FIRST_PAGE + apArticle.getChannelId());<br><br>    <span class="hljs-comment">//4.替换推荐对应的热点数据</span><br>    replaceDataToRedis(apArticle, score, ArticleConstants.HOT_ARTICLE_FIRST_PAGE + ArticleConstants.DEFAULT_TAG);<br><br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 替换数据并且存入到redis</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> apArticle</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> score</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> s</span><br><span class="hljs-comment">     */</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">replaceDataToRedis</span><span class="hljs-params">(ApArticle apArticle, Integer score, String s)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">articleListStr</span> <span class="hljs-operator">=</span> cacheService.get(s);<br>    <span class="hljs-keyword">if</span> (StringUtils.isNotBlank(articleListStr)) &#123;<br>        List&lt;HotArticleVo&gt; hotArticleVoList = JSON.parseArray(articleListStr, HotArticleVo.class);<br><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br><br>        <span class="hljs-comment">//如果缓存中存在该文章，只更新分值</span><br>        <span class="hljs-keyword">for</span> (HotArticleVo hotArticleVo : hotArticleVoList) &#123;<br>            <span class="hljs-keyword">if</span> (hotArticleVo.getId().equals(apArticle.getId())) &#123;<br>                hotArticleVo.setScore(score);<br>                flag = <span class="hljs-literal">false</span>;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">//如果缓存中不存在，查询缓存中分值最小的一条数据，进行分值的比较，如果当前文章的分值大于缓存中的数据，就替换</span><br>        <span class="hljs-keyword">if</span> (flag) &#123;<br>            <span class="hljs-keyword">if</span> (hotArticleVoList.size() &gt;= <span class="hljs-number">30</span>) &#123;<br>                hotArticleVoList = hotArticleVoList.stream().sorted(Comparator.comparing(HotArticleVo::getScore).reversed()).collect(Collectors.toList());<br>                <span class="hljs-type">HotArticleVo</span> <span class="hljs-variable">lastHot</span> <span class="hljs-operator">=</span> hotArticleVoList.get(hotArticleVoList.size() - <span class="hljs-number">1</span>);<br>                <span class="hljs-keyword">if</span> (lastHot.getScore() &lt; score) &#123;<br>                    hotArticleVoList.remove(lastHot);<br>                    <span class="hljs-type">HotArticleVo</span> <span class="hljs-variable">hot</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HotArticleVo</span>();<br>                    BeanUtils.copyProperties(apArticle, hot);<br>                    hot.setScore(score);<br>                    hotArticleVoList.add(hot);<br>                &#125;<br><br><br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-type">HotArticleVo</span> <span class="hljs-variable">hot</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HotArticleVo</span>();<br>                BeanUtils.copyProperties(apArticle, hot);<br>                hot.setScore(score);<br>                hotArticleVoList.add(hot);<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">//缓存到redis</span><br>        hotArticleVoList = hotArticleVoList.stream().sorted(Comparator.comparing(HotArticleVo::getScore).reversed()).collect(Collectors.toList());<br>        cacheService.set(s, JSON.toJSONString(hotArticleVoList));<br><br>    &#125;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 更新文章行为数量</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> mess</span><br><span class="hljs-comment">     */</span><br><span class="hljs-keyword">private</span> ApArticle <span class="hljs-title function_">updateArticle</span><span class="hljs-params">(ArticleVisitStreamMess mess)</span> &#123;<br>    <span class="hljs-type">ApArticle</span> <span class="hljs-variable">apArticle</span> <span class="hljs-operator">=</span> getById(mess.getArticleId());<br>    apArticle.setCollection(apArticle.getCollection()==<span class="hljs-literal">null</span>?<span class="hljs-number">0</span>:apArticle.getCollection()+mess.getCollect());<br>    apArticle.setComment(apArticle.getComment()==<span class="hljs-literal">null</span>?<span class="hljs-number">0</span>:apArticle.getComment()+mess.getComment());<br>    apArticle.setLikes(apArticle.getLikes()==<span class="hljs-literal">null</span>?<span class="hljs-number">0</span>:apArticle.getLikes()+mess.getLike());<br>    apArticle.setViews(apArticle.getViews()==<span class="hljs-literal">null</span>?<span class="hljs-number">0</span>:apArticle.getViews()+mess.getView());<br>    updateById(apArticle);<br>    <span class="hljs-keyword">return</span> apArticle;<br><br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 计算文章的具体分值</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> apArticle</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br><span class="hljs-keyword">private</span> Integer <span class="hljs-title function_">computeScore</span><span class="hljs-params">(ApArticle apArticle)</span> &#123;<br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">score</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span>(apArticle.getLikes() != <span class="hljs-literal">null</span>)&#123;<br>        score += apArticle.getLikes() * ArticleConstants.HOT_ARTICLE_LIKE_WEIGHT;<br>    &#125;<br>    <span class="hljs-keyword">if</span>(apArticle.getViews() != <span class="hljs-literal">null</span>)&#123;<br>        score += apArticle.getViews();<br>    &#125;<br>    <span class="hljs-keyword">if</span>(apArticle.getComment() != <span class="hljs-literal">null</span>)&#123;<br>        score += apArticle.getComment() * ArticleConstants.HOT_ARTICLE_COMMENT_WEIGHT;<br>    &#125;<br>    <span class="hljs-keyword">if</span>(apArticle.getCollection() != <span class="hljs-literal">null</span>)&#123;<br>        score += apArticle.getCollection() * ArticleConstants.HOT_ARTICLE_COLLECTION_WEIGHT;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> score;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>②定义监听，接收聚合之后的数据，文章的分值重新进行计算</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.article.listener;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.heima.article.service.ApArticleService;<br><span class="hljs-keyword">import</span> com.heima.common.constants.HotArticleConstants;<br><span class="hljs-keyword">import</span> com.heima.model.mess.ArticleVisitStreamMess;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.apache.commons.lang3.StringUtils;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.kafka.annotation.KafkaListener;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArticleIncrHandleListener</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ApArticleService apArticleService;<br><br>    <span class="hljs-meta">@KafkaListener(topics = HotArticleConstants.HOT_ARTICLE_INCR_HANDLE_TOPIC)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onMessage</span><span class="hljs-params">(String mess)</span>&#123;<br>        <span class="hljs-keyword">if</span>(StringUtils.isNotBlank(mess))&#123;<br>            <span class="hljs-type">ArticleVisitStreamMess</span> <span class="hljs-variable">articleVisitStreamMess</span> <span class="hljs-operator">=</span> JSON.parseObject(mess, ArticleVisitStreamMess.class);<br>            apArticleService.updateScore(articleVisitStreamMess);<br><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>









<h1 id="10-项目部署-持续集成"><a href="#10-项目部署-持续集成" class="headerlink" title="10 项目部署_持续集成"></a>10 项目部署_持续集成</h1><h2 id="1-今日内容介绍-1"><a href="#1-今日内容介绍-1" class="headerlink" title="1 今日内容介绍"></a>1 今日内容介绍</h2><h3 id="1-1-什么是持续集成"><a href="#1-1-什么是持续集成" class="headerlink" title="1.1 什么是持续集成"></a>1.1 什么是持续集成</h3><p>持续集成（ Continuous integration ， 简称 CI ）指的是，频繁地（一天多次）将代码集成到主干</p>
<p><img src="/../images/image-20210802000658790.png" srcset="/img/loading.gif" lazyload alt="image-20210802000658790"></p>
<p><strong>持续集成的组成要素</strong></p>
<p>一个自动构建过程， 从检出代码、 编译构建、 运行测试、 结果记录、 测试统计等都是自动完成的， 无需人工干预。</p>
<p>一个代码存储库，即需要版本控制软件来保障代码的可维护性，同时作为构建过程的素材库，一般使用SVN或Git。</p>
<p>一个持续集成服务器， Jenkins 就是一个配置简单和使用方便的持续集成服务器。</p>
<h3 id="1-2-持续集成的好处"><a href="#1-2-持续集成的好处" class="headerlink" title="1.2 持续集成的好处"></a>1.2 持续集成的好处</h3><p>1、降低风险，由于持续集成不断去构建，编译和测试，可以很早期发现问题，所以修复的代价就少；<br>2、对系统健康持续检查，减少发布风险带来的问题；<br>3、减少重复性工作；<br>4、持续部署，提供可部署单元包；<br>5、持续交付可供使用的版本；<br>6、增强团队信心；</p>
<h3 id="1-3-今日内容"><a href="#1-3-今日内容" class="headerlink" title="1.3 今日内容"></a>1.3 今日内容</h3><p><img src="/../images/image-20210802000829722.png" srcset="/img/loading.gif" lazyload alt="image-20210802000829722"></p>
<h2 id="2-软件开发模式"><a href="#2-软件开发模式" class="headerlink" title="2 软件开发模式"></a>2 软件开发模式</h2><h3 id="2-1-软件开发生命周期"><a href="#2-1-软件开发生命周期" class="headerlink" title="2.1 软件开发生命周期"></a>2.1 软件开发生命周期</h3><p>软件开发生命周期又叫做SDLC（Software Development Life Cycle），它是集合了计划、开发、测试和部署过程的集合。如下图所示 ：</p>
<p><img src="/../images/image-20210802011508487.png" srcset="/img/loading.gif" lazyload alt="image-20210802011508487"></p>
<ul>
<li><p>需求分析</p>
<p>  这是生命周期的第一阶段，根据项目需求，团队执行一个可行性计划的分析。项目需求可能是公司内部或者客户提出的。这阶段主要是对信息的收集，也有可能是对现有项目的改善和重新做一个新的项目。还要分析项目的预算多长，可以从哪方面受益及布局，这也是项目创建的目标。</p>
</li>
<li><p>设计</p>
<p>  第二阶段就是设计阶段，系统架构和满意状态（就是要做成什么样子，有什么功能），和创建一个项目计划。计划可以使用图表，布局设计或者文字的方式呈现。</p>
</li>
<li><p>实现</p>
<p>  第三阶段就是实现阶段，项目经理创建和分配工作给开者，开发者根据任务和在设计阶段定义的目标进行开发代码。依据项目的大小和复杂程度，可以需要数月或更长时间才能完成。</p>
</li>
<li><p>测试</p>
<p>  测试人员进行代码测试 ，包括功能测试、代码测试、压力测试等。</p>
</li>
<li><p>进化</p>
<p>  最后进阶段就是对产品不断的进化改进和维护阶段，根据用户的使用情况，可能需要对某功能进行修改，bug修复，功能增加等。</p>
</li>
</ul>
<h3 id="2-2-软件开发瀑布模型"><a href="#2-2-软件开发瀑布模型" class="headerlink" title="2.2 软件开发瀑布模型"></a>2.2 软件开发瀑布模型</h3><p>瀑布模型是最著名和最常使用的软件开发模型。瀑布模型就是一系列的软件开发过程。它是由制造业繁衍出来的。一个高度化的结构流程在一个方向上流动，有点像生产线一样。在瀑布模型创建之初，没有其它开发的模型，有很多东西全靠开发人员去猜测，去开发。这样的模型仅适用于那些简单的软件开发， 但是已经不适合现在的开发了。</p>
<p>下图对软件开发模型的一个阐述。</p>
<p><img src="/../images/image-20210802011525024.png" srcset="/img/loading.gif" lazyload alt="image-20210802011525024"></p>
<table>
<thead>
<tr>
<th>优势</th>
<th>劣势</th>
</tr>
</thead>
<tbody><tr>
<td>简单易用和理解</td>
<td>各个阶段的划分完全固定，阶段之间产生大量的文档，极大地增加了工作量。</td>
</tr>
<tr>
<td>当前一阶段完成后，您只需要去关注后续阶段。</td>
<td>由于开发模型是线性的，用户只有等到整个过程的末期才能见到开发成果，从而增加了开发风险。</td>
</tr>
<tr>
<td>为项目提供了按阶段划分的检查节点</td>
<td>瀑布模型的突出缺点是不适应用户需求的变化。</td>
</tr>
</tbody></table>
<h3 id="2-3-软件的敏捷开发"><a href="#2-3-软件的敏捷开发" class="headerlink" title="2.3 软件的敏捷开发"></a>2.3 软件的敏捷开发</h3><ul>
<li><p>什么是敏捷开发？</p>
<p>  敏捷开发（Agile Development） 的核心是迭代开发（Iterative Development） 与 增量开发（Incremental Development）。</p>
</li>
<li><p>何为迭代开发？</p>
<p>  对于大型软件项目，传统的开发方式是采用一个大周期（比如一年）进行开发，整个过程就是一次”大开发”；迭代开发的方式则不一样，它将开发过程拆分成多个小周期，即一次”大开发”变成多次”小开发”，每次小开发都是同样的流程，所以看上去就好像重复在做同样的步骤。</p>
<p>  举例来说，SpaceX 公司想造一个大推力火箭，将人类送到火星。但是，它不是一开始就造大火箭，而是先造一个最简陋的小火箭 Falcon 1。结果，第一次发射就爆炸了，直到第四次发射，才成功进入轨道。然后，开发了中型火箭 Falcon 9，九年中发射了70次。最后，才开发 Falcon 重型火箭。如果SpaceX 不采用迭代开发，它可能直到现在还无法上天。</p>
</li>
<li><p>何为增量开发？</p>
<p>  软件的每个版本，都会新增一个用户可以感知的完整功能。也就是说，按照新增功能来划分迭代。</p>
<p>  举例来说，房产公司开发一个10栋楼的小区。如果采用增量开发的模式，该公司第一个迭代就是交付一号楼，第二个迭代交付二号楼……每个迭代都是完成一栋完整的楼。而不是第一个迭代挖好10栋楼的地基，第二个迭代建好每栋楼的骨架，第三个迭代架设屋顶……</p>
</li>
<li><p>敏捷开发如何迭代？</p>
<p>  虽然敏捷开发将软件开发分成多个迭代，但是也要求，每次迭代都是一个完整的软件开发周期，必须按照软件工程的方法论，进行正规的流程管理。</p>
</li>
</ul>
<p><img src="/../images/image-20210802011540379.png" srcset="/img/loading.gif" lazyload alt="image-20210802011540379"></p>
<ul>
<li><p>敏捷开发有什么好处？</p>
<ul>
<li><p>早期交付</p>
<p>  敏捷开发的第一个好处，就是早期交付，从而大大降低成本。 还是以上一节的房产公司为例，如果按照传统的”瀑布开发模式”，先挖10栋楼的地基、再盖骨架、然后架设屋顶，每个阶段都等到前一个阶段完成后开始，可能需要两年才能一次性交付10栋楼。也就是说，如果不考虑预售，该项目必须等到两年后才能回款。 敏捷开发是六个月后交付一号楼，后面每两个月交付一栋楼。因此，半年就能回款10%，后面每个月都会有现金流，资金压力就大大减轻了。</p>
</li>
<li><p>降低风险</p>
<p>  敏捷开发的第二个好处是，及时了解市场需求，降低产品不适用的风险。 请想一想，哪一种情况损失比较小：10栋楼都造好以后，才发现卖不出去，还是造好第一栋楼，就发现卖不出去，从而改进或停建后面9栋楼？</p>
</li>
</ul>
</li>
</ul>
<h2 id="3-Jenkins安装配置"><a href="#3-Jenkins安装配置" class="headerlink" title="3 Jenkins安装配置"></a>3 Jenkins安装配置</h2><h3 id="3-1-Jenkins介绍"><a href="#3-1-Jenkins介绍" class="headerlink" title="3.1 Jenkins介绍"></a>3.1 Jenkins介绍</h3><p><img src="/../images/image-20210802011553923.png" srcset="/img/loading.gif" lazyload alt="image-20210802011553923"></p>
<p>Jenkins  是一款流行的开源持续集成（Continuous Integration）工具，广泛用于项目开发，具有自动化构建、测试和部署等功能。官网：  <a target="_blank" rel="noopener" href="http://jenkins-ci.org/%E3%80%82">http://jenkins-ci.org/。</a></p>
<p>Jenkins的特征：</p>
<ul>
<li>开源的 Java语言开发持续集成工具，支持持续集成，持续部署。</li>
<li>易于安装部署配置：可通过 yum安装,或下载war包以及通过docker容器等快速实现安装部署，可方便web界面配置管理。</li>
<li>消息通知及测试报告：集成 RSS/E-mail通过RSS发布构建结果或当构建完成时通过e-mail通知，生成JUnit/TestNG测试报告。</li>
<li>分布式构建：支持 Jenkins能够让多台计算机一起构建/测试。</li>
<li>文件识别： Jenkins能够跟踪哪次构建生成哪些jar，哪次构建使用哪个版本的jar等。</li>
<li>丰富的插件支持：支持扩展插件，你可以开发适合自己团队使用的工具，如 git，svn，maven，docker等。</li>
</ul>
<p>Jenkins安装和持续集成环境配置</p>
<p><img src="/../images/image-20210802011607894.png" srcset="/img/loading.gif" lazyload alt="image-20210802011607894"></p>
<p>1 ）首先，开发人员每天进行代码提交，提交到Git仓库</p>
<p>2）然后，Jenkins作为持续集成工具，使用Git工具到Git仓库拉取代码到集成服务器，再配合JDK，Maven等软件完成代码编译，代码测试与审查，测试，打包等工作，在这个过程中每一步出错，都重新再执行一次整个流程。</p>
<p>3）最后，Jenkins把生成的jar或war包分发到测试服务器或者生产服务器，测试人员或用户就可以访问应用。</p>
<h3 id="3-2-Jenkins环境搭建"><a href="#3-2-Jenkins环境搭建" class="headerlink" title="3.2 Jenkins环境搭建"></a>3.2 Jenkins环境搭建</h3><h4 id="3-2-1-Jenkins安装配置"><a href="#3-2-1-Jenkins安装配置" class="headerlink" title="3.2.1  Jenkins安装配置"></a>3.2.1  Jenkins安装配置</h4><p>可以导入资料中的镜像：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">服务器用户名：root   密码：itcast<br><br>jenkins  用户名：itcast   密码：itcast<br></code></pre></td></tr></table></figure>



<ol>
<li><p>采用YUM方式安装</p>
<p> 加入jenkins安装源：</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">sudo wget -O /etc/yum.repos.d/jenkins.repo https://pkg.jenkins.io/redhat-stable/jenkins.repo --no-check-certificate<br><br>sudo rpm --import https://pkg.jenkins.io/redhat-stable/jenkins.io.key<br></code></pre></td></tr></table></figure>

<p> 执行yum命令安装：</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">yum -y install jenkins<br></code></pre></td></tr></table></figure></li>
<li><p>采用RPM安装包方式</p>
<p> <a target="_blank" rel="noopener" href="https://pkg.jenkins.io/redhat-stable/">Jenkins安装包下载地址</a></p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">wget https://pkg.jenkins.io/redhat-stable/jenkins-2.190.1-1.1.noarch.rpm<br></code></pre></td></tr></table></figure>

<p> 执行安装：</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">rpm -ivh jenkins-2.190.1-1.1.noarch.rpm<br></code></pre></td></tr></table></figure></li>
<li><p>配置：</p>
<p> 修改配置文件：</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">vi /etc/sysconfig/jenkins<br></code></pre></td></tr></table></figure>

<p> 修改内容：</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 修改为对应的目标用户， 这里使用的是root</span><br><span class="hljs-variable">$JENKINS_USER</span>=<span class="hljs-string">&quot;root&quot;</span><br><span class="hljs-comment"># 服务监听端口</span><br>JENKINS_PORT=<span class="hljs-string">&quot;16060&quot;</span><br></code></pre></td></tr></table></figure>

<p> 目录权限：</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">chown</span> -R root:root /var/lib/jenkins<br><span class="hljs-built_in">chown</span> -R root:root /var/cache/jenkins<br><span class="hljs-built_in">chown</span> -R root:root /var/log/jenkins<br></code></pre></td></tr></table></figure>

<p> 重启：</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">systemctl restart jenkins<br></code></pre></td></tr></table></figure>

<p> 如果启动失败， 出现错误信息：</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">Starting Jenkins bash: /usr/bin/java: No such file or directory<br></code></pre></td></tr></table></figure>

<p> 创建JAVA环境的软链接：</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">ln</span> -s /usr/local/jdk/bin/java /usr/bin/java<br></code></pre></td></tr></table></figure></li>
<li><p>管理后台初始化设置</p>
<p> <a target="_blank" rel="noopener" href="http://192.168.200.100:16060/">http://192.168.200.100:16060/</a></p>
<p> 需要输入管理密码， 在以下位置查看：</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">cat</span> /var/lib/jenkins/secrets/initialAdminPassword<br></code></pre></td></tr></table></figure>

<p> <img src="/../images/image-20210802011625800.png" srcset="/img/loading.gif" lazyload alt="image-20210802011625800"></p>
<p> 按默认设置，把建议的插件都安装上</p>
<p> <img src="/../images/image-20210802011638639.png" srcset="/img/loading.gif" lazyload alt="image-20210802011638639"></p>
<p> 这一步等待时间较长， 安装完成之后， 创建管理员用户：</p>
<p> <img src="/../images/image-20210802011653454.png" srcset="/img/loading.gif" lazyload alt="image-20210802011653454"></p>
</li>
</ol>
<p>配置访问地址：</p>
<p><img src="/../images/image-20210802011707013.png" srcset="/img/loading.gif" lazyload alt="image-20210802011707013"></p>
<p>配置完成之后， 会进行重启， 之后可以看到管理后台：</p>
<p><img src="/../images/image-20210802011723835.png" srcset="/img/loading.gif" lazyload alt="image-20210802011723835"></p>
<h4 id="3-2-2-Jenkins插件安装"><a href="#3-2-2-Jenkins插件安装" class="headerlink" title="3.2.2  Jenkins插件安装"></a>3.2.2  Jenkins插件安装</h4><p>在实现持续集成之前， 需要确保以下插件安装成功。</p>
<ul>
<li>Maven Integration plugin： Maven 集成管理插件。</li>
<li>Docker plugin： Docker集成插件。</li>
<li>GitLab Plugin： GitLab集成插件。</li>
<li>Publish Over SSH：远程文件发布插件。</li>
<li>SSH: 远程脚本执行插件。</li>
</ul>
<p>安装方法：</p>
<ol>
<li><p>进入【系统管理】-【插件管理】</p>
</li>
<li><p>点击标签页的【可选插件】</p>
<p> 在过滤框中搜索插件名称</p>
<p> <img src="/../images/image-20210802011740056.png" srcset="/img/loading.gif" lazyload alt="image-20210802011740056"></p>
</li>
<li><p>勾选插件， 点击直接安装即可。</p>
</li>
</ol>
<blockquote>
<p>注意，如果没有安装按钮，需要更改配置</p>
<p>在安装插件的高级配置中，修改升级站点的连接为：<a target="_blank" rel="noopener" href="http://updates.jenkins.io/update-center.json">http://updates.jenkins.io/update-center.json</a>   保存</p>
<p><img src="/../images/image-20210802011758588.png" srcset="/img/loading.gif" lazyload alt="image-20210802011758588"></p>
</blockquote>
<h4 id="3-2-3-Git安装配置"><a href="#3-2-3-Git安装配置" class="headerlink" title="3.2.3  Git安装配置"></a>3.2.3  Git安装配置</h4><ol>
<li><p>yum 安装方式</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">yum -y install git<br></code></pre></td></tr></table></figure></li>
<li><p>采用源码包方式安装</p>
<ul>
<li><p>安装依赖包</p>
  <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">yum -y install curl-devel expat-devel gettext-devel openssl-devel zlib-devel<br>yum -y install gcc perl-ExtUtils-MakeMaker<br></code></pre></td></tr></table></figure></li>
<li><p>如果之前有安装旧版本， 先做卸载， 没有安装则忽略</p>
  <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">yum remove git<br></code></pre></td></tr></table></figure></li>
<li><p>下载源码包</p>
  <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">cd</span> /usr/local<br>wget https://mirrors.edge.kernel.org/pub/software/scm/git/git-1.8.3.1.tar.gz<br>tar -xvf git-1.8.3.1.tar.gz<br></code></pre></td></tr></table></figure>

<p>  也可以安装其他版本， 地址：<a target="_blank" rel="noopener" href="https://mirrors.edge.kernel.org/pub/software/scm/git/">https://mirrors.edge.kernel.org/pub/software/scm/git/</a></p>
</li>
<li><p>编译安装</p>
  <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">cd</span> git-1.8.3.1<br>make prefix=/usr/local/git all<br>make prefix=/usr/local/git install<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;export PATH=<span class="hljs-variable">$PATH</span>:/usr/local/git/bin&quot;</span> &gt;&gt; /etc/bashrc<br><span class="hljs-built_in">source</span> /etc/bashrc<br></code></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>检查git版本</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@localhost jenkins]<span class="hljs-comment"># git version</span><br>git version 1.8.3.1<br></code></pre></td></tr></table></figure></li>
</ol>
<h4 id="3-2-4-Maven安装配置"><a href="#3-2-4-Maven安装配置" class="headerlink" title="3.2.4  Maven安装配置"></a>3.2.4  Maven安装配置</h4><ol>
<li><p>下载安装包</p>
<p> 下载地址： <a target="_blank" rel="noopener" href="https://maven.apache.org/download.cgi">https://maven.apache.org/download.cgi</a></p>
</li>
<li><p>解压安装包</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">cd</span> /usr/local<br>unzip -o apache-maven-3.6.1.zip <br></code></pre></td></tr></table></figure>

<p> 上传本地仓库并解压</p>
<p> <img src="/../images/image-20210802013808080.png" srcset="/img/loading.gif" lazyload alt="image-20210802013808080"></p>
</li>
<li><p>配置</p>
<p> 环境变量配置</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">vi /etc/profile<br></code></pre></td></tr></table></figure>

<p> 增加：</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">export</span> MAVEN_HOME=/usr/local/maven/apache-maven-3.6.1<br><span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$PATH</span>:<span class="hljs-variable">$MAVEN_HOME</span>/bin<br></code></pre></td></tr></table></figure>

<p> 如果权限不够，则需要增加当前目录的权限</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">chmod 777 /usr/local/maven/apache-maven-3.6.1/bin/mvn<br></code></pre></td></tr></table></figure>

<p> 修改镜像仓库配置：</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">vi /usr/local/maven/apache-maven-3.6.1/conf/settings.xml<br></code></pre></td></tr></table></figure>

<p> 需要把本机的仓库打包上传到服务器上（不上传会自动下载）</p>
<p> 然后指定上传后的仓库配置</p>
<p> <img src="/../images/image-20210802013533421.png" srcset="/img/loading.gif" lazyload alt="image-20210802013533421"></p>
</li>
</ol>
<h4 id="3-2-5-Docker安装配置"><a href="#3-2-5-Docker安装配置" class="headerlink" title="3.2.5  Docker安装配置"></a>3.2.5  Docker安装配置</h4><ol>
<li><p>更新软件包版本</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">yum -y update<br></code></pre></td></tr></table></figure></li>
<li><p>卸载旧版本</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">yum -y remove docker  docker-common docker-selinux docker-engine<br></code></pre></td></tr></table></figure></li>
<li><p>安装软件依赖包</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">yum install -y yum-utils device-mapper-persistent-data lvm2<br></code></pre></td></tr></table></figure></li>
<li><p>设置yum源为阿里云</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">sudo yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo<br></code></pre></td></tr></table></figure></li>
<li><p>安装后查看docker版本</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">docker -v<br></code></pre></td></tr></table></figure></li>
<li><p>启动</p>
<p> 设置开机启动：</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">systemctl <span class="hljs-built_in">enable</span> docker<br></code></pre></td></tr></table></figure>

<p> 启动docker</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">systemctl start docker<br></code></pre></td></tr></table></figure></li>
</ol>
<h4 id="3-2-6-Docker-Registry私有仓库安装配置"><a href="#3-2-6-Docker-Registry私有仓库安装配置" class="headerlink" title="3.2.6  Docker Registry私有仓库安装配置"></a>3.2.6  Docker Registry私有仓库安装配置</h4><h3 id="3-3-Jenkins工具配置"><a href="#3-3-Jenkins工具配置" class="headerlink" title="3.3 Jenkins工具配置"></a>3.3 Jenkins工具配置</h3><ol>
<li><p>进入【系统管理】–&gt; 【全局工具配置】</p>
<p> <img src="/../images/image-20210802011944005.png" srcset="/img/loading.gif" lazyload alt="image-20210802011944005"></p>
</li>
<li><p>MAVEN配置全局设置</p>
<p> <img src="/../images/image-20210802011956261.png" srcset="/img/loading.gif" lazyload alt="image-20210802011956261"></p>
</li>
<li><p>指定JDK配置</p>
<p> <img src="/../images/image-20210802012010244.png" srcset="/img/loading.gif" lazyload alt="image-20210802012010244"></p>
</li>
</ol>
<ol start="4">
<li><p>指定MAVEN 目录</p>
<p> <img src="/../images/image-20210802012026476.png" srcset="/img/loading.gif" lazyload alt="image-20210802012026476"></p>
</li>
<li><p>指定DOCKER目录</p>
<p> <img src="/../images/image-20210802012038581.png" srcset="/img/loading.gif" lazyload alt="image-20210802012038581"></p>
<p> 如果不清楚docker的安装的目录，可以使用<code>whereis docker</code> 命令查看docker的安装的目录</p>
</li>
</ol>
<h2 id="4-后端项目部署"><a href="#4-后端项目部署" class="headerlink" title="4 后端项目部署"></a>4 后端项目部署</h2><h3 id="4-1-多环境切换"><a href="#4-1-多环境切换" class="headerlink" title="4.1 多环境切换"></a>4.1 多环境切换</h3><p>在项目开发部署的过程中，一般都会有三套项目环境</p>
<ul>
<li><p>Development ：开发环境</p>
</li>
<li><p>Production ：生产环境</p>
</li>
<li><p>Test ：测试环境</p>
</li>
</ul>
<p>例如：开发环境的mysql连接的是本地，生产环境需要连接线上的mysql环境</p>
<h3 id="4-2-多环境切换-微服务中多环境配置"><a href="#4-2-多环境切换-微服务中多环境配置" class="headerlink" title="4.2 多环境切换-微服务中多环境配置"></a>4.2 多环境切换-微服务中多环境配置</h3><p>1.在微服务中的bootstrap.yml中新增配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">51801</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">leadnews-user</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">discovery:</span><br>        <span class="hljs-attr">server-addr:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.130</span><span class="hljs-string">:8848</span><br>      <span class="hljs-attr">config:</span><br>        <span class="hljs-attr">server-addr:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.130</span><span class="hljs-string">:8848</span><br>        <span class="hljs-attr">file-extension:</span> <span class="hljs-string">yml</span><br>  <span class="hljs-attr">profiles:</span><br>    <span class="hljs-attr">active:</span> <span class="hljs-string">dev</span><br></code></pre></td></tr></table></figure>

<p>2.在nacos的配置中心中新增各个环境的配置文件，例如user微服务中新增</p>
<p>修改bootstrap.yml 添加内容</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">spring</span>:<span class="hljs-string"></span><br>  <span class="hljs-attr">profiles</span>:<span class="hljs-string"></span><br>    <span class="hljs-attr">active</span>: <span class="hljs-string">dev</span><br></code></pre></td></tr></table></figure>

<p>创建对应的nacos的多环境配置：</p>
<p><img src="/../images/image-20210623143417530.png" srcset="/img/loading.gif" lazyload alt="image-20210623143417530"></p>
<p><img src="/../images/image-20210623143557710.png" srcset="/img/loading.gif" lazyload alt="image-20210623143557710"></p>
<p>注意事项：</p>
<p>其中DataID属性命名有规范：</p>
<ul>
<li>prefix，默认使用${spring.application.name}，也可以通过spring.cloud.nacos.config.prefix来配置。</li>
<li>spring.profile.active，即为当前环境对应的 profile，详情可以参考 Spring Boot文档。 注意：当 spring.profile.active 为空时，对应的连接符 - 也将不存在，dataId 的拼接格式变成 ${prefix}.${file-extension}</li>
<li>file-exetension，为配置内容的数据格式，可以通过配置项 spring.cloud.nacos.config.file-extension 来配置。目前只支持 properties 和 yaml 类型。</li>
</ul>
<h3 id="4-3-整体思路"><a href="#4-3-整体思路" class="headerlink" title="4.3 整体思路"></a>4.3 整体思路</h3><p>目标：把黑马头条的app端相关的微服务部署到192.168.200.100这台服务器上</p>
<p><img src="/../images/image-20210802003955971.png" srcset="/img/loading.gif" lazyload alt="image-20210802003955971"></p>
<p><img src="/../images/image-20210802004007699.png" srcset="/img/loading.gif" lazyload alt="image-20210802004007699"></p>
<h3 id="4-4-服务集成Docker配置"><a href="#4-4-服务集成Docker配置" class="headerlink" title="4.4 服务集成Docker配置"></a>4.4 服务集成Docker配置</h3><p>目标：部署的每一个微服务都是先创建docker镜像后创建对应容器启动</p>
<p>方式一：本地微服务打包以后上传到服务器，编写Dockerfile文件完成。</p>
<p>方式二：使用dockerfile-maven-plugin插件，可以直接把微服务创建为镜像使用（更省事）</p>
<p><strong>服务集成Docker配置</strong></p>
<p><img src="/../images/image-20210802004133439.png" srcset="/img/loading.gif" lazyload alt="image-20210802004133439"></p>
<p>每个微服务都引入该依赖,以heima-leadnews-user微服务为例</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>heima-leadnews-service<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.heima<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>heima-leadnews-user<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.source</span>&gt;</span>8<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.source</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.target</span>&gt;</span>8<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.target</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">docker.image</span>&gt;</span>docker_storage<span class="hljs-tag">&lt;/<span class="hljs-name">docker.image</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">finalName</span>&gt;</span>heima-leadnews-user<span class="hljs-tag">&lt;/<span class="hljs-name">finalName</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">executions</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">execution</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">goals</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">goal</span>&gt;</span>repackage<span class="hljs-tag">&lt;/<span class="hljs-name">goal</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">goals</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">execution</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">executions</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.7.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">source</span>&gt;</span>$&#123;java.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">source</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">target</span>&gt;</span>$&#123;java.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">target</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.spotify<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>dockerfile-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.3.6<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">repository</span>&gt;</span>$&#123;docker.image&#125;/$&#123;project.artifactId&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">repository</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">buildArgs</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">JAR_FILE</span>&gt;</span>target/$&#123;project.build.finalName&#125;.jar<span class="hljs-tag">&lt;/<span class="hljs-name">JAR_FILE</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">buildArgs</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p><strong>服务集成Dockerfile文件</strong></p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-comment"># 设置JAVA版本</span><br><span class="hljs-keyword">FROM</span> java:<span class="hljs-number">8</span><br><span class="hljs-comment"># 指定存储卷, 任何向/tmp写入的信息都不会记录到容器存储层</span><br><span class="hljs-keyword">VOLUME</span><span class="language-bash"> /tmp</span><br><span class="hljs-comment"># 拷贝运行JAR包</span><br><span class="hljs-keyword">ARG</span> JAR_FILE<br><span class="hljs-keyword">COPY</span><span class="language-bash"> <span class="hljs-variable">$&#123;JAR_FILE&#125;</span> app.jar</span><br><span class="hljs-comment"># 设置JVM运行参数， 这里限定下内存大小，减少开销</span><br><span class="hljs-keyword">ENV</span> JAVA_OPTS=<span class="hljs-string">&quot;\</span><br><span class="hljs-string">-server \</span><br><span class="hljs-string">-Xms256m \</span><br><span class="hljs-string">-Xmx512m \</span><br><span class="hljs-string">-XX:MetaspaceSize=256m \</span><br><span class="hljs-string">-XX:MaxMetaspaceSize=512m&quot;</span><br><span class="hljs-comment">#空参数，方便创建容器时传参</span><br><span class="hljs-keyword">ENV</span> PARAMS=<span class="hljs-string">&quot;&quot;</span><br><span class="hljs-comment"># 入口点， 执行JAVA运行命令</span><br><span class="hljs-keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="hljs-string">&quot;sh&quot;</span>,<span class="hljs-string">&quot;-c&quot;</span>,<span class="hljs-string">&quot;java -jar <span class="hljs-variable">$JAVA_OPTS</span> /app.jar <span class="hljs-variable">$PARAMS</span>&quot;</span>]</span><br></code></pre></td></tr></table></figure>

<h3 id="4-5-jenkins基础依赖打包配置"><a href="#4-5-jenkins基础依赖打包配置" class="headerlink" title="4.5 jenkins基础依赖打包配置"></a>4.5 jenkins基础依赖打包配置</h3><p>在微服务运行之前需要在本地仓库中先去install所依赖的jar包，所以第一步应该是从git中拉取代码，并且把基础的依赖部分安装到仓库中</p>
<p>1，父工程heima-leadnews</p>
<p><img src="/../images/image-20210802004744531.png" srcset="/img/loading.gif" lazyload alt="image-20210802004744531"></p>
<p>2，找到自己指定的git仓库，设置用户名和密码</p>
<p><img src="/../images/image-20210802004803711.png" srcset="/img/loading.gif" lazyload alt="image-20210802004803711"></p>
<p>3，把基础依赖信息安装到服务器上的本地仓库</p>
<p><img src="/../images/image-20210802004818581.png" srcset="/img/loading.gif" lazyload alt="image-20210802004818581"></p>
<p>4，执行</p>
<p>执行日志，部分截图，下面是从git中拉取代码</p>
<p><img src="/../images/image-20210802004838998.png" srcset="/img/loading.gif" lazyload alt="image-20210802004838998"></p>
<p>执行日志，部分截图，编译打包</p>
<p><img src="/../images/image-20210802004858057.png" srcset="/img/loading.gif" lazyload alt="image-20210802004858057"></p>
<p>执行日志，部分截图，执行成功</p>
<p><img src="/../images/image-20210802004915042.png" srcset="/img/loading.gif" lazyload alt="image-20210802004915042"></p>
<h3 id="4-6-jenkins微服务打包配置"><a href="#4-6-jenkins微服务打包配置" class="headerlink" title="4.6 jenkins微服务打包配置"></a>4.6 jenkins微服务打包配置</h3><p>所有微服务打包的方式类似，以heima-leadnews-user微服务为例</p>
<p>1，新建任务</p>
<p><img src="/../images/image-20210802004942366.png" srcset="/img/loading.gif" lazyload alt="image-20210802004942366"></p>
<p>2，找到自己指定的git仓库，设置用户名和密码</p>
<p><img src="/../images/image-20210802005000376.png" srcset="/img/loading.gif" lazyload alt="image-20210802005000376"></p>
<p>3，执行maven命令</p>
<p><img src="/../images/image-20210802005018020.png" srcset="/img/loading.gif" lazyload alt="image-20210802005018020"></p>
<p><img src="/../images/image-20210802005027229.png" srcset="/img/loading.gif" lazyload alt="image-20210802005027229"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">clean install -Dmaven.test.skip=<span class="hljs-literal">true</span>  dockerfile:build -f heima-leadnews/heima-leadnews-service/heima-leadnews-user/pom.xml<br></code></pre></td></tr></table></figure>

<p><font color='red'>注意：根据自己的实际代码路径配置</font></p>
<p>-Dmaven.test.skip=true  跳过测试</p>
<p>dockerfile:build 启动dockerfile插件构建容器</p>
<p>-f heima-leadnews-user/pom.xml 指定需要构建的文件（必须是pom）</p>
<p>4，并执行shell脚本</p>
<p><img src="/../images/image-20210802005318464.png" srcset="/img/loading.gif" lazyload alt="image-20210802005318464"></p>
<p><img src="/../images/image-20210802005329034.png" srcset="/img/loading.gif" lazyload alt="image-20210802005329034"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> [ -n  <span class="hljs-string">&quot;$(docker ps -a -f  name=$JOB_NAME  --format &#x27;&#123;&#123;.ID&#125;&#125;&#x27; )&quot;</span> ]<br> then<br> #删除之前的容器<br> docker rm -f $(docker ps -a -f  name=$JOB_NAME  --format <span class="hljs-string">&#x27;&#123;&#123;.ID&#125;&#125;&#x27;</span> )<br>fi<br> # 清理镜像<br>docker image prune -f <br> # 启动docker服务<br>docker run -d --net=host -e PARAMS=<span class="hljs-string">&quot;--spring.profiles.active=prod&quot;</span>  --name $JOB_NAME docker_storage/$JOB_NAME<br></code></pre></td></tr></table></figure>

<p>5，执行日志</p>
<p>拉取代码</p>
<p><img src="/../images/image-20210802005404751.png" srcset="/img/loading.gif" lazyload alt="image-20210802005404751"></p>
<p>编译打包</p>
<p><img src="/../images/image-20210802005417489.png" srcset="/img/loading.gif" lazyload alt="image-20210802005417489"></p>
<p>构建镜像</p>
<p><img src="/../images/image-20210802005438400.png" srcset="/img/loading.gif" lazyload alt="image-20210802005438400"></p>
<p>清理容器，创建新的容器</p>
<p><img src="/../images/image-20210802005452184.png" srcset="/img/loading.gif" lazyload alt="image-20210802005452184"></p>
<h3 id="4-7-部署服务到远程服务器上"><a href="#4-7-部署服务到远程服务器上" class="headerlink" title="4.7 部署服务到远程服务器上"></a>4.7 部署服务到远程服务器上</h3><p>目标：使用jenkins（192.168.200.100）把微服务打包部署到192.168.200.130服务器上</p>
<p><img src="/../images/image-20210802005538404.png" srcset="/img/loading.gif" lazyload alt="image-20210802005538404"></p>
<h4 id="4-7-1-安装配置私有仓库"><a href="#4-7-1-安装配置私有仓库" class="headerlink" title="4.7.1 安装配置私有仓库"></a>4.7.1 安装配置私有仓库</h4><p>对于持续集成环境的配置，Jenkins会发布大量的微服务， 要与多台机器进行交互， 可以采用docker镜像的保存与导出功能结合SSH实现， 但这样交互繁琐，稳定性差， 而且不便管理， 这里我们通过搭建Docker的私有仓库来实现， 这个有点类似GIT仓库， 集中统一管理资源， 由客户端拉取或更新。</p>
<ol>
<li><p>下载最新Registry镜像</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">docker pull registry:latest<br></code></pre></td></tr></table></figure></li>
<li><p>启动Registry镜像服务</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">docker run -d -p 5000:5000 --name registry -v /usr/local/docker/registry:/var/lib/registry registry:latest<br></code></pre></td></tr></table></figure>

<p> 映射5000端口； -v是将Registry内的镜像数据卷与本地文件关联， 便于管理和维护Registry内的数据。</p>
</li>
<li><p>查看仓库资源</p>
<p> 访问地址：<a target="_blank" rel="noopener" href="http://192.168.200.100:5000/v2/_catalog">http://192.168.200.100:5000/v2/_catalog</a></p>
<p> 启动正常， 可以看到返回：</p>
 <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;repositories&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p> 目前并没有上传镜像， 显示空数据。</p>
<p> 如果上传成功， 可以看到数据:<br> <img src="/../images/image-20210802005839314.png" srcset="/img/loading.gif" lazyload alt="image-20210802005839314"></p>
</li>
<li><p>配置Docker客户端</p>
<p> 正常生产环境中使用， 要配置HTTPS服务， 确保安全，内部开发或测试集成的局域网环境，可以采用简便的方式， 不做安全控制。</p>
<p> 先确保持续集成环境的机器已安装好Docker客户端， 然后做以下修改：</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">vi /lib/systemd/system/docker.service<br></code></pre></td></tr></table></figure>

<p> 修改内容：</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">ExecStart=/usr/bin/dockerd --insecure-registry 192.168.200.100:5000<br></code></pre></td></tr></table></figure>

<p> 指向安装Registry的服务IP与端口。</p>
<p> 重启生效：</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">systemctl daemon-reolad<br>systemctl restart docker.service<br></code></pre></td></tr></table></figure></li>
</ol>
<h4 id="4-7-2-jenkins中安装插件"><a href="#4-7-2-jenkins中安装插件" class="headerlink" title="4.7.2 jenkins中安装插件"></a>4.7.2 jenkins中安装插件</h4><p><img src="/../images/image-20210802005913026.png" srcset="/img/loading.gif" lazyload alt="image-20210802005913026"></p>
<h4 id="4-7-3-jenkins系统配置远程服务器链接"><a href="#4-7-3-jenkins系统配置远程服务器链接" class="headerlink" title="4.7.3 jenkins系统配置远程服务器链接"></a>4.7.3 jenkins系统配置远程服务器链接</h4><p>位置：Manage Jenkins–&gt;Configure System</p>
<p><img src="/../images/image-20210802005937966.png" srcset="/img/loading.gif" lazyload alt="image-20210802005937966"></p>
<p>需要添加凭证</p>
<p>位置：Manage Jenkins–&gt;Manage CreDentials</p>
<p><img src="/../images/image-20210802010324224.png" srcset="/img/loading.gif" lazyload alt="image-20210802010324224"></p>
<p>添加链接到130服务器的用户名和密码</p>
<p><img src="/../images/image-20210802010525665.png" srcset="/img/loading.gif" lazyload alt="image-20210802010525665"></p>
<p><img src="/../images/image-20210802010429136.png" srcset="/img/loading.gif" lazyload alt="image-20210802010429136"></p>
<p><img src="/../images/image-20210802010201146.png" srcset="/img/loading.gif" lazyload alt="image-20210802010201146"></p>
<h4 id="4-7-4-jenkins项目创建与其他微服务相同"><a href="#4-7-4-jenkins项目创建与其他微服务相同" class="headerlink" title="4.7.4 jenkins项目创建与其他微服务相同"></a>4.7.4 jenkins项目创建与其他微服务相同</h4><p>创建项目参考之前创建过的用户微服务</p>
<h4 id="4-7-5-设置参数"><a href="#4-7-5-设置参数" class="headerlink" title="4.7.5 设置参数"></a>4.7.5 设置参数</h4><p><img src="/../images/image-20210802010650039.png" srcset="/img/loading.gif" lazyload alt="image-20210802010650039"></p>
<h4 id="4-7-6-构建执行Execute-shell"><a href="#4-7-6-构建执行Execute-shell" class="headerlink" title="4.7.6 构建执行Execute shell"></a>4.7.6 构建执行Execute shell</h4><p><img src="/../images/image-20210802010720937.png" srcset="/img/loading.gif" lazyload alt="image-20210802010720937"></p>
<p>maven命令</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">clean install -Dmaven.test.skip=<span class="hljs-literal">true</span> dockerfile:build -f heima-leadnews/heima-leadnews-service/heima-leadnews-article/pom.xml<br></code></pre></td></tr></table></figure>

<p>shell脚本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs shell">image_tag=$docker_registry/docker_storage/$JOB_NAME<br>echo &#x27;================docker镜像清理================&#x27;<br>if [ -n  &quot;$(docker ps -a -f  name=$JOB_NAME  --format &#x27;&#123;&#123;.ID&#125;&#125;&#x27; )&quot; ]<br> then<br><span class="hljs-meta prompt_"> #</span><span class="language-bash">删除之前的容器</span><br> docker rm -f $(docker ps -a -f  name=$JOB_NAME  --format &#x27;&#123;&#123;.ID&#125;&#125;&#x27; )<br>fi<br><span class="hljs-meta prompt_"> # </span><span class="language-bash">清理镜像</span><br>docker image prune -f <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">创建TAG</span><br>docker tag docker_storage/$JOB_NAME $image_tag<br>echo &#x27;================docker镜像推送================&#x27;<br><span class="hljs-meta prompt_"># </span><span class="language-bash">推送镜像</span><br>docker push $image_tag<br><span class="hljs-meta prompt_"># </span><span class="language-bash">删除TAG</span><br>docker rmi $image_tag<br>echo &#x27;================docker tag 清理 ================&#x27;<br></code></pre></td></tr></table></figure>

<h4 id="4-7-7-在远程服务器上执行脚本"><a href="#4-7-7-在远程服务器上执行脚本" class="headerlink" title="4.7.7 在远程服务器上执行脚本"></a>4.7.7 在远程服务器上执行脚本</h4><p><img src="/../images/image-20210802010750809.png" srcset="/img/loading.gif" lazyload alt="image-20210802010750809"></p>
<p>远程服务器执行的shell脚本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs shell">echo &#x27;================拉取最新镜像================&#x27;<br>docker pull $docker_registry/docker_storage/$JOB_NAME<br><br>echo &#x27;================删除清理容器镜像================&#x27;<br>if [ -n  &quot;$(docker ps -a -f  name=$JOB_NAME  --format &#x27;&#123;&#123;.ID&#125;&#125;&#x27; )&quot; ]<br> then<br><span class="hljs-meta prompt_"> #</span><span class="language-bash">删除之前的容器</span><br> docker rm -f $(docker ps -a -f  name=$JOB_NAME  --format &#x27;&#123;&#123;.ID&#125;&#125;&#x27; )<br>fi<br><span class="hljs-meta prompt_"> # </span><span class="language-bash">清理镜像</span><br>docker image prune -f <br><br>echo &#x27;===============启动容器================&#x27;<br>docker run -d   --net=host -e PARAMS=&quot;--spring.profiles.active=prod&quot; --name $JOB_NAME $docker_registry/docker_storage/$JOB_NAME<br></code></pre></td></tr></table></figure>

<h4 id="4-7-8-构建完成以后，可以登录130服务器，查看是否有相关的镜像和容器"><a href="#4-7-8-构建完成以后，可以登录130服务器，查看是否有相关的镜像和容器" class="headerlink" title="4.7.8 构建完成以后，可以登录130服务器，查看是否有相关的镜像和容器"></a>4.7.8 构建完成以后，可以登录130服务器，查看是否有相关的镜像和容器</h4><p>镜像</p>
<p><img src="/../images/image-20210802010824088.png" srcset="/img/loading.gif" lazyload alt="image-20210802010824088"></p>
<p>容器</p>
<p><img src="/../images/image-20210802010835702.png" srcset="/img/loading.gif" lazyload alt="image-20210802010835702"></p>
<h3 id="4-8-联调测试"><a href="#4-8-联调测试" class="headerlink" title="4.8 联调测试"></a>4.8 联调测试</h3><p>1.参考jenkins中heima-leadnews-user微服务把app端网关部署起来</p>
<p>2.修改本地nginx中的配置反向代理地址为100这台服务器：heima-leadnews-app.conf</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs html">upstream  heima-app-gateway&#123;<br>	server 192.168.200.100:51601;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>3.启动nginx，打开页面进行测试</p>
<h2 id="5-jenkins触发器配置"><a href="#5-jenkins触发器配置" class="headerlink" title="5 jenkins触发器配置"></a>5 jenkins触发器配置</h2><h3 id="5-1-URL触发远程构建"><a href="#5-1-URL触发远程构建" class="headerlink" title="5.1 URL触发远程构建"></a>5.1 URL触发远程构建</h3><p>触发远程构建，修改jenkins的配置，如下</p>
<p><img src="/../images/image-20210802011202642.png" srcset="/img/loading.gif" lazyload alt="image-20210802011202642"></p>
<p>触发构建url： <a target="_blank" rel="noopener" href="http://192.168.200.100:16060/job/leadnews-admin/build?token=88888888">http://192.168.200.100:16060/job/leadnews-admin/build?token=88888888</a></p>
<h3 id="5-2-其他工程构建后触发"><a href="#5-2-其他工程构建后触发" class="headerlink" title="5.2 其他工程构建后触发"></a>5.2 其他工程构建后触发</h3><p>配置需要触发的工程</p>
<p><img src="/../images/image-20210802011225737.png" srcset="/img/loading.gif" lazyload alt="image-20210802011225737"></p>
<h3 id="5-3-定时构建"><a href="#5-3-定时构建" class="headerlink" title="5.3 定时构建"></a>5.3 定时构建</h3><p>定时构建（ Build periodically）</p>
<p><img src="/../images/image-20210802011245118.png" srcset="/img/loading.gif" lazyload alt="image-20210802011245118"></p>
<p>定时字符串从左往右分别为： 分 时 日 月 周</p>
<p><strong>定时构建-定时表达式</strong></p>
<p>定时字符串从左往右分别为： 分 时 日 月 周</p>
<table>
<thead>
<tr>
<th>组成部分</th>
<th>含义</th>
<th>取值范围</th>
</tr>
</thead>
<tbody><tr>
<td>第一部分</td>
<td>minute (分)</td>
<td>0~59</td>
</tr>
<tr>
<td>第二部分</td>
<td>hour(小时)</td>
<td>0~23</td>
</tr>
<tr>
<td>第三部分</td>
<td>day(天)</td>
<td>1~31</td>
</tr>
<tr>
<td>第四部分</td>
<td>month(月)</td>
<td>1~12</td>
</tr>
<tr>
<td>第五部分</td>
<td>week(周)</td>
<td>0~7，0 和 7 都是表示星期天</td>
</tr>
</tbody></table>
<ul>
<li><p>符号H 表示一个随机数</p>
</li>
<li><p>符号*  取值范围的任意值</p>
</li>
</ul>
<p>案例：</p>
<ul>
<li><p>每30分钟构建一次：H/30 * * * * 10:02 10:32</p>
</li>
<li><p>每2个小时构建一次: H H/2 * * *</p>
</li>
<li><p>每天的8点，12点，22点，一天构建3次： (多个时间点中间用逗号隔开) 0 8,12,22 * * *</p>
</li>
<li><p>每天中午12点定时构建一次 H 12 * * *</p>
</li>
<li><p>每天下午18点定时构建一次 H 18 * * *</p>
</li>
</ul>
<h3 id="5-4-轮询"><a href="#5-4-轮询" class="headerlink" title="5.4 轮询"></a>5.4 轮询</h3><p>轮询 SCM（Poll SCM）</p>
<p>轮询SCM，是指定时扫描本地代码仓库的代码是否有变更，如果代码有变更就触发项目构建。</p>
<p><img src="/../images/image-20210802011431941.png" srcset="/img/loading.gif" lazyload alt="image-20210802011431941"></p>
<p>Jenkins会定时扫描本地整个项目的代码，增大系统的开销，不建议使用。</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E9%A1%B9%E7%9B%AE/" class="category-chain-item">项目</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E9%BB%91%E9%A9%AC%E5%A4%B4%E6%9D%A1/">#黑马头条</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>《黑马头条》微服务项目手册</div>
      <div>http://example.com/2024/02/27/《黑马头条》微服务项目手册/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Peter Xu</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2024年2月27日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2024/02/27/Java%E9%9B%86%E5%90%88%E6%A6%82%E5%86%B5/" title="Java集合概况">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Java集合概况</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/02/20/%E6%A0%88%E4%B8%8E%E9%98%9F%E5%88%97/" title="栈与队列">
                        <span class="hidden-mobile">栈与队列</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
